<?php
$questionResults = [];
if (isset($this->result) && !empty($this->result)) {
    foreach ($this->result as $key => $row) {
        $questionResults[$row['question_id']] = $row;
    }
}
?>
<style>
    .dropdown-menu.open {
        width: 100%;
        overflow: auto;
    }

    .dropdown-menu.open li {
        text-wrap: wrap;
    }

    .selected i.glyphicon.glyphicon-ok.icon-ok.check-mark {
        display: contents !important;
    }
</style>
<link rel="stylesheet" type="text/css" href="<?php echo $this->baseUrl('css/bootstrap-select.min.css'); ?>" />
<link rel="stylesheet" href="<?php echo $this->baseUrl('/css/bootstrap-wysihtml5/bootstrap3-wysihtml5.min.css'); ?>" type="text/css" />
<link href="<?php echo $this->baseUrl('css/select2.css'); ?>" rel="stylesheet" />
<div class="well">
    <form name="addFeedbackQuestionsForm" id="addFeedbackQuestionsForm" method="post" action="<?php echo $this->url(array("module" => "admin", "controller" => "feedback-responses", "action" => "feedback-form"), 'default', true) ?>" class="form-horizontal bs-example" role="form" enctype="multipart/form-data" onsubmit="validateNow();return false;">
        <fieldset>
            <?php if (isset($this->type) && !empty($this->type) && $this->type == 'clone') { ?>
                <legend><?= $this->translate->_("Clone Feedback Form"); ?></legend>
            <?php } else { ?>
                <legend><?= $this->translate->_("New Feedback Form"); ?></legend>
            <?php  } ?>
            <div class="row">
                <div class="col-lg-6">
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="control-label" for="shipmentId"><?= $this->translate->_("Select shipment to fetch questions"); ?> <span class="mandatory">*</span></label>
                    <div class="col-lg-12">
                        <select id="shipmentId" name="shipmentId" class="select2 form-control isRequired" title="Please select the shipment" onchange="loadQuestions(this.value);">
                            <option value="">--<?= $this->translate->_("Select"); ?>--</option>
                            <?php if (isset($this->shipments) && !empty($this->shipments)) {
                                foreach ($this->shipments as $key => $row) { ?>
                                    <option value="<?php echo $row['shipment_id']; ?>" <?php echo (isset($this->sid) && !empty($this->sid) && $this->sid == $row['shipment_id']) ? 'selected="selected"' : ''; ?>><?php echo $row['shipment_code']; ?></option>
                            <?php }
                            } ?>
                        </select>
                    </div>
                </div>
                <div class="col-lg-6">
                    &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="control-label" for="formTo"><?= $this->translate->_("Show feedback form to"); ?></label>
                    <div class="col-lg-12">
                        <select class="select2 form-control" id="formTo" name="formTo" title="Please select where we show the forms">
                            <option value=""><?= $this->translate->_("--Select--"); ?></option>
                            <option value="all-participants" <?php echo (isset($this->result['feedback_form_results']['form_show_to']) && !empty($this->result['feedback_form_results']['form_show_to']) && $this->result['feedback_form_results']['form_show_to'] == 'all-participants') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("All Participants"); ?></option>
                            <option value="passing-participants" <?php echo (isset($this->result['feedback_form_results']['form_show_to']) && !empty($this->result['feedback_form_results']['form_show_to']) && $this->result['feedback_form_results']['form_show_to'] == 'passing-participants') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Only Passing Participants"); ?></option>
                            <option value="failing-participants" <?php echo (isset($this->result['feedback_form_results']['form_show_to']) && !empty($this->result['feedback_form_results']['form_show_to']) && $this->result['feedback_form_results']['form_show_to'] == 'failing-participants') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Only Failing Participants"); ?></option>
                        </select>
                    </div>
                </div>
            </div>
            <br>
            <div class="form-group col-lg-12">
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="control-label" for="formContent"><?= $this->translate->_("Enter feedback form content"); ?></label>
                <div class="col-lg-12">
                    <textarea id="formContent" class="form-control richtextarea" name="formContent"><?php echo $this->result['feedback_form_results']['form_content']; ?></textarea>
                </div>
            </div>
            <div class="form-group col-lg-12 text-center">
                <table class="table table-bordered table-striped" style="text-align:center;margin: auto;width: 97%;">
                    <thead>
                        <tr>
                            <th style="width:40%;">Upload one or more files</th>
                            <th style="width:30%;">File Name</th>
                            <th style="width:20%;">Sort Order</th>
                            <th style="width:10%;">Action</th>
                        </tr>
                    </thead>
                    <tbody id="formRow">
                        <?php if (isset($this->result['feedback_form_files_results']) && !empty($this->result['feedback_form_files_results'])) {
                            foreach ($this->result['feedback_form_files_results'] as $key => $row) { ?>
                                <tr>
                                    <td>
                                        <?php if (isset($row['feedback_file']) && !empty($row['feedback_file']) && file_exists(UPLOAD_PATH . DIRECTORY_SEPARATOR . 'feedback-forms' . DIRECTORY_SEPARATOR . $row['shipment_id'] . DIRECTORY_SEPARATOR . $row['feedback_file'])) { ?>
                                            <a href="/uploads/feedback-forms/<?php echo $row['shipment_id']; ?>/<?php echo $row['feedback_file']; ?>" target="_blank">Download</a>
                                        <?php } else { ?>
                                            <input type="file" id="formFiles<?php echo ($key + 1); ?>" name="formFiles[files][<?php echo ($key + 1); ?>]" class="form-control option" placeholder="Select the form file" title="Please select the form file">
                                        <?php } ?>
                                    </td>
                                    <td><input type="text" id="formFilesName<?php echo ($key + 1); ?>" value="<?php echo $row['file_name']; ?>" name="formFiles[name][<?php echo ($key + 1); ?>]" class="form-control option" placeholder="Enter the file name" title="Please enter the file name"></td>
                                    <td><input type="text" id="formFilesSort<?php echo ($key + 1); ?>" value="<?php echo $row['sort_order']; ?>" name="formFiles[sort][<?php echo ($key + 1); ?>]" class="form-control option" placeholder="Enter the sort order" title="Please enter the sort order"></td>
                                    <td style=" vertical-align: middle; text-align:center; "><a href="javascript:void(0);" onclick="addRow(this);" class="btn btn-xs btn-info"><i class="icon-plus"></i></a></td>
                                </tr>
                            <?php }
                        } else { ?>
                            <tr>
                                <td><input type="file" id="formFiles1" name="formFiles[files][]" class="form-control option" placeholder="Select the form file" title="Please select the form file"></td>
                                <td><input type="text" id="formFilesName1" name="formFiles[name][]" class="form-control option" placeholder="Enter the file name" title="Please enter the file name"></td>
                                <td><input type="text" id="formFilesSort1" name="formFiles[sort][]" class="form-control option" placeholder="Enter the sort order" title="Please enter the sort order"></td>
                                <td style=" vertical-align: middle; text-align:center; "><a href="javascript:void(0);" onclick="addRow(this);" class="btn btn-xs btn-info"><i class="icon-plus"></i></a></td>
                            </tr>
                        <?php } ?>
                    </tbody>
                </table>
            </div>
            <div class="<?php echo (isset($this->result['feedback_form_question_results']) && !empty($this->result['feedback_form_question_results'])) ? '' : 'hide'; ?> show-questions form-group col-lg-12" id="load-question">
                &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<label class="control-label" for="shipmentId"><?= $this->translate->_("Select the available question"); ?> <span class="mandatory">*</span></label>
                <div class="col-lg-12">
                    <select id="question" multiple="multiple" name="question[]" class="select2 form-control" title="Please select the available question" onchange="loadQuestion()">
                        <?php if (isset($this->result['feedback_form_question_results']) && !empty($this->result['feedback_form_question_results'])) {
                            foreach ($this->result['feedback_form_question_results'] as $key => $row) { ?>
                                <option value="<?php echo $row['question_id']; ?>" selected="selected"><?php echo $row['question_text'] . '(' . $row['question_code'] . ')'; ?></option>
                        <?php }
                        } ?>
                        <?php if (isset($this->questions) && !empty($this->questions)) {
                            foreach ($this->questions as $key => $row) { ?>
                                <option value="<?php echo $row['question_id']; ?>"><?php echo $row['question_text'] . '(' . $row['question_code'] . ')'; ?></option>
                        <?php }
                        } ?>
                    </select>
                </div>
            </div>
            <div class="<?php echo (isset($this->result['feedback_form_question_results']) && !empty($this->result['feedback_form_question_results'])) ? '' : 'hide'; ?> form-group col-lg-12" id="questionTable">
                <table class="table table-bordered table-striped" border="1" style="text-align:center;margin: auto;width: 95%;">
                    <thead>
                        <tr>
                            <th style="width:80%;text-align:left !important;">Question</th>
                            <th style="width:10%;text-align:center;">Mandatory</th>
                            <th style="width:10%;text-align:center;">Sort Order</th>
                        </tr>
                    </thead>
                    <tbody id="questionRow">
                        <?php if (isset($this->result['feedback_form_question_results']) && !empty($this->result['feedback_form_question_results'])) {
                            foreach ($this->result['feedback_form_question_results'] as $key => $row) { ?>
                                <tr>
                                    <td style="text-align:left !important;"><?php echo $row['question_text']; ?></td>
                                    <td><input type="checkbox" <?php echo (isset($row['is_response_mandatory']) && !empty($row['is_response_mandatory']) && $row['is_response_mandatory'] == 'yes') ? 'checked' : ''; ?> name="mandatory[<?php echo $row['question_id']; ?>]" id="mandatory<?php echo $row['question_id']; ?>" title="Please select the mandatory or not" value="yes" /></td>
                                    <td><input type="type" value="<?php echo $row['sort_order'] ?? null; ?>" class="form-control" name="sortOrder[<?php echo $row['question_id']; ?>]" id="sortOrder'+val+'" title="Please enter the sort order" placeholder="Enter the sort order" /></td>
                                </tr>
                        <?php }
                        } ?>
                    </tbody>
                </table>
            </div>

            <div id="respond" style="margin: 0px auto 0px auto; text-align: center;" class="<?php echo (isset($this->result) && !empty($this->result)) ? '' : 'hide'; ?> show-questions form-group col-lg-11" align="center">
                <?php if ($this->result['feedback_form_results']['rpff_id']) { ?>
                    <input type="hidden" name="rfId" value="<?php echo base64_encode($this->result['feedback_form_results']['rpff_id']); ?>" />
                <?php } ?>
                <input name="submitbtn" class="btn btn-primary" type="submit" tabindex="7" value="<?= $this->translate->_("Submit"); ?>" />
                <input class="btn btn-danger" type="button" onclick="window.location.href = '/admin/feedback-responses/shipment-questions';" tabindex="8" value="<?= $this->translate->_("Cancel"); ?>" />
            </div>
        </fieldset>
    </form>
</div>
<script type="text/javascript" src="<?php echo $this->baseUrl('js/bootstrap-select.min.js'); ?>"></script>
<script type="text/javascript" src="<?php echo $this->baseUrl('js/select2.min.js'); ?>"></script>
<script src="<?php echo $this->baseUrl('/js/bootstrap-wysihtml5/bootstrap3-wysihtml5.all.min.js'); ?>" type="text/javascript"></script>
<script type="text/javascript">
    var duplicated = false;
    var tableRow = 1;

    $(document).ready(function() {
        $("#shipmentId").select2({
            placeholder: 'Select shipment to fetch questions',
            allowClear: true,
        });
        $("#formTo").select2({
            placeholder: 'Select form to show',
            allowClear: true,
        });
        $('#question').selectpicker();
        $("#formContent").wysihtml5();
    });

    function checkDuplicate(tableName, fieldName, obj, fnct, msg) {
        $.post("<?php echo $this->url(array('module' => 'default', 'controller' => 'common', 'action' => 'check-duplicate')); ?>", {
                tableName: tableName,
                fieldName: fieldName,
                value: obj.value,
                fnct: fnct,
                format: "html"
            },
            function(data) {
                if (data > 0) {
                    alert(msg, "err");
                    duplicated = true;
                    obj.focus();
                } else {
                    duplicated = false;
                }
            });
    }

    function validateNow() {
        $("#formContent").val($("#formContentEditor").summernote('code'));
        flag = deforayValidator.init({
            formId: 'addFeedbackQuestionsForm'
        });
        if (flag && !duplicated) {
            $.blockUI();
            document.getElementById('addFeedbackQuestionsForm').submit();
        }
    }

    function loadQuestions(id) {
        <?php if (!isset($this->type) || empty($this->type) || $this->type != 'clone') { ?>
            if (id != '') {
                $.post("<?php echo $this->url(array('module' => 'admin', 'controller' => 'feedback-responses', 'action' => 'get-questions'), 'default', true); ?>", {
                        sid: id
                    },
                    function(data) {
                        if (data != '' && data != undefined && data != null) {
                            $('.show-questions').removeClass("hide");
                            $("#question").html(data);
                            $('#question').selectpicker();
                            $('#question').selectpicker('refresh');
                        }
                    })
            }
        <?php } ?>
    }

    function checkType(value) {
        if (value == 'dropdown') {
            $('#optionTaple').removeClass('hide');
        } else {
            $('#optionTaple').addClass('hide');
        }
    }

    function loadQuestion() {
        var html = '';
        $('#questionTable').removeClass('hide');
        $('#question > option:selected').each(function() {
            let text = $(this).text();
            let val = $(this).val();

            html += '<tr> \
                    <td style="text-align:left !important;">' + text + '</td>\
                    <td><input type="checkbox" name="mandatory[' + val + ']" id="mandatory' + val + '" title="Please select the mandatory or not" value="yes"/></td>\
                    <td><input type="type" class="form-control" name="sortOrder[' + val + ']" id="sortOrder' + val + '" title="Please enter the sort order" placeholder="Enter the sort order"/></td>\
                </tr>';
        });
        $('#questionRow').html(html);
    }

    function addRow() {
        tableRow++;
        $('#formRow').append(
            '<tr> \
                <td><input type="file" id="formFiles{{tableRow}}" name="formFiles[files][]" class="form-control option" placeholder="Select the form file" title="Please select the form file"></td>\
                <td><input type="text" id="formFilesName{{tableRow}}" name="formFiles[name][]" class="form-control option" placeholder="Enter the file name" title="Please enter the file name"></td>\
                <td><input type="text" id="formFilesSort{{tableRow}}" name="formFiles[sort][]" class="form-control option" placeholder="Enter the sort order" title="Please enter the sort order"></td>\
                <td style=" vertical-align: middle; text-align:center; "><a href="javascript:void(0);" onclick="addRow(this);" class="btn btn-xs btn-info"><i class="icon-plus"></i></a>&nbsp;&nbsp;<a  href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger"  title="Remove this row completely" alt="Remove this row completely"><i class="icon-minus"></i></a></td>\
            </tr>'
        );
    }

    function removeRow(obj) {
        $(obj.parentNode.parentNode).fadeOut("normal", function() {
            $(this).remove();
        });
        if ($("#formRow tr").length == 1) {
            addRow();
        }
    }
</script>