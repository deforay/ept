<?php
$ct = $this->certificateTemplates;
$baseUrl = $this->baseUrl();
$downloadUrl = $this->url(array('module' => 'admin', 'controller' => 'certificate-templates', 'action' => 'download'), 'default', true);
$uploadUrl = $this->url(array('module' => 'admin', 'controller' => 'certificate-templates', 'action' => 'upload'), 'default', true);
$removeUrl = $this->url(array('module' => 'admin', 'controller' => 'certificate-templates', 'action' => 'remove'), 'default', true);
$validateUrl = $this->url(array('module' => 'admin', 'controller' => 'certificate-templates', 'action' => 'validate'), 'default', true);
?>
<style>
    .template-card {
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
        padding: 15px;
        margin-bottom: 10px;
    }
    .template-card.has-template {
        border-left: 4px solid #5cb85c;
    }
    .template-card.no-template {
        border-left: 4px solid #f0ad4e;
    }
    .template-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 10px;
    }
    .template-type {
        font-weight: bold;
        color: #555;
    }
    .template-actions {
        display: flex;
        gap: 5px;
    }
    .template-info {
        font-size: 13px;
        color: #777;
    }
    .template-filename {
        font-family: monospace;
        background: #f5f5f5;
        padding: 2px 6px;
        border-radius: 3px;
    }
    .detected-fields {
        margin-top: 8px;
        padding: 8px;
        background: #f9f9f9;
        border-radius: 3px;
        font-size: 12px;
    }
    .detected-fields .label {
        margin-right: 4px;
        margin-bottom: 4px;
        display: inline-block;
    }
    .upload-zone {
        border: 2px dashed #ccc;
        border-radius: 4px;
        padding: 20px;
        text-align: center;
        background: #fafafa;
        cursor: pointer;
        transition: all 0.2s;
    }
    .upload-zone:hover {
        border-color: #999;
        background: #f5f5f5;
    }
    .upload-zone.dragover {
        border-color: #337ab7;
        background: #e8f4fc;
    }
    .upload-zone input[type="file"] {
        display: none;
    }
    .upload-progress {
        display: none;
        margin-top: 10px;
    }
    .upload-progress .progress {
        margin-bottom: 5px;
    }
    .validation-result {
        margin-top: 10px;
        padding: 10px;
        border-radius: 4px;
        display: none;
    }
    .validation-result.success {
        background: #dff0d8;
        border: 1px solid #d6e9c6;
        color: #3c763d;
    }
    .validation-result.error {
        background: #f2dede;
        border: 1px solid #ebccd1;
        color: #a94442;
    }
    .scheme-section {
        margin-bottom: 30px;
        padding: 20px;
        background: #fff;
        border: 1px solid #ddd;
        border-radius: 4px;
    }
    .scheme-title {
        font-size: 18px;
        font-weight: bold;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
    }
    .template-row {
        display: flex;
        gap: 20px;
    }
    .template-col {
        flex: 1;
    }
    .no-template-msg {
        color: #8a6d3b;
        font-style: italic;
    }
    .btn-xs {
        padding: 2px 8px;
        font-size: 12px;
    }

    /* Help Modal Styling */
    #helpModal {
        z-index: 1060 !important;
    }
    #helpModal .modal-dialog {
        width: 800px;
        max-width: 90%;
        z-index: 1061;
    }
    #helpModal .modal-content {
        background: #fff;
        border-radius: 6px;
        box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        position: relative;
        z-index: 1062;
    }
    #helpModal .modal-header {
        background: linear-gradient(135deg, #4a6fa5 0%, #3a5a8a 100%);
        color: #fff;
        border-radius: 4px 4px 0 0;
    }
    #helpModal .modal-header .close {
        color: #fff;
        opacity: 0.8;
    }
    #helpModal .modal-body h4 {
        margin-top: 20px;
        color: #333;
        border-bottom: 1px solid #eee;
        padding-bottom: 8px;
    }
    #helpModal .modal-body h5 {
        margin-top: 15px;
        color: #555;
    }
</style>

<h4 style="width:100%;height:50px;border-bottom:1px solid #777;">
    <div style="font-size:22.5px;line-height:36px;color:#333;float:left;">
        <?= $this->translate->_("Certificate Templates"); ?>
    </div>
    <button type="button" class="btn btn-default btn-sm" onclick="$('#helpModal').modal('show');" style="float: right; margin-top: 3px;">
        <i class="icon-question-sign"></i> <?= $this->translate->_("How to Create Templates"); ?>
    </button>
</h4>

<div class="alert alert-info">
    <strong><?= $this->translate->_("Note:"); ?></strong>
    <?= $this->translate->_("Certificate templates must be PDF files with AcroForm fields. Required field: at least one of"); ?>
    <code>participant_name</code>, <code>labname</code>, <code>participantname</code>, <?= $this->translate->_("or"); ?> <code>participant</code>.
</div>

<?php foreach ($this->schemes as $scheme): ?>
    <?php
    // scheme_id is the scheme type string (e.g., 'dts', 'vl', 'eid')
    $schemeType = $scheme['scheme_id'];
    $schemeName = $scheme['scheme_name'];
    $pCert = $ct[$schemeType]['participation_certificate'] ?? null;
    $eCert = $ct[$schemeType]['excellence_certificate'] ?? null;
    $pFields = !empty($ct[$schemeType]['p_detected_fields']) ? json_decode($ct[$schemeType]['p_detected_fields'], true) : [];
    $eFields = !empty($ct[$schemeType]['e_detected_fields']) ? json_decode($ct[$schemeType]['e_detected_fields'], true) : [];
    // Check if files exist - either from DB record or by convention ({schemeType}-p.pdf / {schemeType}-e.pdf)
    $templateDir = SCHEDULED_JOBS_FOLDER . DIRECTORY_SEPARATOR . 'certificate-templates' . DIRECTORY_SEPARATOR;
    $pExists = (!empty($pCert) && file_exists($templateDir . $pCert)) || file_exists($templateDir . $schemeType . '-p.pdf');
    $eExists = (!empty($eCert) && file_exists($templateDir . $eCert)) || file_exists($templateDir . $schemeType . '-e.pdf');
    // Use standard filename
    if ($pExists && empty($pCert)) $pCert = $schemeType . '-p.pdf';
    if ($eExists && empty($eCert)) $eCert = $schemeType . '-e.pdf';
    ?>
    <div class="scheme-section">
        <div class="scheme-title"><?= htmlspecialchars($schemeName); ?></div>
        <div class="template-row">
            <!-- Participation Certificate -->
            <div class="template-col">
                <div class="template-card <?= $pExists ? 'has-template' : 'no-template'; ?>" id="template-<?= $schemeType; ?>-participation">
                    <div class="template-header">
                        <span class="template-type"><?= $this->translate->_("Participation Certificate"); ?></span>
                        <div class="template-actions">
                            <?php if ($pExists): ?>
                                <a href="<?= $downloadUrl; ?>?scheme=<?= $schemeType; ?>&type=participation" target="_blank" class="btn btn-info btn-xs" title="<?= $this->translate->_("View PDF"); ?>">
                                    <i class="icon-eye-open"></i> <?= $this->translate->_("View"); ?>
                                </a>
                                <button type="button" class="btn btn-warning btn-xs btn-replace" data-scheme="<?= $schemeType; ?>" data-type="participation" title="<?= $this->translate->_("Replace Template"); ?>">
                                    <i class="icon-refresh"></i> <?= $this->translate->_("Replace"); ?>
                                </button>
                                <button type="button" class="btn btn-danger btn-xs btn-remove" data-scheme="<?= $schemeType; ?>" data-type="participation" title="<?= $this->translate->_("Remove Template"); ?>">
                                    <i class="icon-trash"></i>
                                </button>
                            <?php else: ?>
                                <button type="button" class="btn btn-success btn-xs btn-upload-trigger" data-scheme="<?= $schemeType; ?>" data-type="participation">
                                    <i class="icon-upload"></i> <?= $this->translate->_("Upload"); ?>
                                </button>
                            <?php endif; ?>
                        </div>
                    </div>
                    <div class="template-info">
                        <?php if ($pExists): ?>
                            <span class="template-filename"><?= htmlspecialchars($pCert); ?></span>
                            <?php if (!empty($pFields)): ?>
                                <div class="detected-fields">
                                    <strong><?= $this->translate->_("Detected Fields:"); ?></strong>
                                    <?php foreach ($pFields as $field): ?>
                                        <span class="label label-default"><?= htmlspecialchars($field); ?></span>
                                    <?php endforeach; ?>
                                </div>
                            <?php endif; ?>
                        <?php else: ?>
                            <span class="no-template-msg"><?= $this->translate->_("No template uploaded"); ?></span>
                        <?php endif; ?>
                    </div>
                    <div class="upload-container" id="upload-<?= $schemeType; ?>-participation" style="display: none;">
                        <div class="upload-zone" data-scheme="<?= $schemeType; ?>" data-type="participation">
                            <i class="icon-cloud-upload" style="font-size: 24px;"></i>
                            <p><?= $this->translate->_("Drag and drop PDF file here or click to browse"); ?></p>
                            <input type="file" accept=".pdf,application/pdf" />
                        </div>
                        <div class="upload-progress">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped active" role="progressbar" style="width: 0%"></div>
                            </div>
                            <span class="progress-text"><?= $this->translate->_("Uploading..."); ?></span>
                        </div>
                        <div class="validation-result"></div>
                    </div>
                </div>
            </div>

            <!-- Excellence Certificate -->
            <div class="template-col">
                <div class="template-card <?= $eExists ? 'has-template' : 'no-template'; ?>" id="template-<?= $schemeType; ?>-excellence">
                    <div class="template-header">
                        <span class="template-type"><?= $this->translate->_("Excellence Certificate"); ?></span>
                        <div class="template-actions">
                            <?php if ($eExists): ?>
                                <a href="<?= $downloadUrl; ?>?scheme=<?= $schemeType; ?>&type=excellence" target="_blank" class="btn btn-info btn-xs" title="<?= $this->translate->_("View PDF"); ?>">
                                    <i class="icon-eye-open"></i> <?= $this->translate->_("View"); ?>
                                </a>
                                <button type="button" class="btn btn-warning btn-xs btn-replace" data-scheme="<?= $schemeType; ?>" data-type="excellence" title="<?= $this->translate->_("Replace Template"); ?>">
                                    <i class="icon-refresh"></i> <?= $this->translate->_("Replace"); ?>
                                </button>
                                <button type="button" class="btn btn-danger btn-xs btn-remove" data-scheme="<?= $schemeType; ?>" data-type="excellence" title="<?= $this->translate->_("Remove Template"); ?>">
                                    <i class="icon-trash"></i>
                                </button>
                            <?php else: ?>
                                <button type="button" class="btn btn-success btn-xs btn-upload-trigger" data-scheme="<?= $schemeType; ?>" data-type="excellence">
                                    <i class="icon-upload"></i> <?= $this->translate->_("Upload"); ?>
                                </button>
                            <?php endif; ?>
                        </div>
                    </div>
                    <div class="template-info">
                        <?php if ($eExists): ?>
                            <span class="template-filename"><?= htmlspecialchars($eCert); ?></span>
                            <?php if (!empty($eFields)): ?>
                                <div class="detected-fields">
                                    <strong><?= $this->translate->_("Detected Fields:"); ?></strong>
                                    <?php foreach ($eFields as $field): ?>
                                        <span class="label label-default"><?= htmlspecialchars($field); ?></span>
                                    <?php endforeach; ?>
                                </div>
                            <?php endif; ?>
                        <?php else: ?>
                            <span class="no-template-msg"><?= $this->translate->_("No template uploaded"); ?></span>
                        <?php endif; ?>
                    </div>
                    <div class="upload-container" id="upload-<?= $schemeType; ?>-excellence" style="display: none;">
                        <div class="upload-zone" data-scheme="<?= $schemeType; ?>" data-type="excellence">
                            <i class="icon-cloud-upload" style="font-size: 24px;"></i>
                            <p><?= $this->translate->_("Drag and drop PDF file here or click to browse"); ?></p>
                            <input type="file" accept=".pdf,application/pdf" />
                        </div>
                        <div class="upload-progress">
                            <div class="progress">
                                <div class="progress-bar progress-bar-striped active" role="progressbar" style="width: 0%"></div>
                            </div>
                            <span class="progress-text"><?= $this->translate->_("Uploading..."); ?></span>
                        </div>
                        <div class="validation-result"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
<?php endforeach; ?>

<script type="text/javascript">
$(document).ready(function() {
    var uploadUrl = '<?= $uploadUrl; ?>';
    var removeUrl = '<?= $removeUrl; ?>';

    // Show upload zone when clicking Upload or Replace button
    $('.btn-upload-trigger, .btn-replace').on('click', function() {
        var scheme = $(this).data('scheme');
        var type = $(this).data('type');
        var container = $('#upload-' + scheme + '-' + type);
        container.slideToggle();
    });

    // Click on upload zone triggers file input
    $('.upload-zone').on('click', function(e) {
        if (e.target.tagName !== 'INPUT') {
            $(this).find('input[type="file"]').click();
        }
    });

    // Drag and drop handling
    $('.upload-zone').on('dragover dragenter', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).addClass('dragover');
    }).on('dragleave drop', function(e) {
        e.preventDefault();
        e.stopPropagation();
        $(this).removeClass('dragover');
    }).on('drop', function(e) {
        var files = e.originalEvent.dataTransfer.files;
        if (files.length > 0) {
            var scheme = $(this).data('scheme');
            var type = $(this).data('type');
            uploadFile(files[0], scheme, type);
        }
    });

    // File input change
    $('.upload-zone input[type="file"]').on('change', function() {
        if (this.files.length > 0) {
            var zone = $(this).closest('.upload-zone');
            var scheme = zone.data('scheme');
            var type = zone.data('type');
            uploadFile(this.files[0], scheme, type);
        }
    });

    // Upload file function
    function uploadFile(file, scheme, type) {
        var container = $('#upload-' + scheme + '-' + type);
        var progressBar = container.find('.progress-bar');
        var progressContainer = container.find('.upload-progress');
        var resultContainer = container.find('.validation-result');

        // Validate file type
        if (file.type !== 'application/pdf' && !file.name.toLowerCase().endsWith('.pdf')) {
            showResult(resultContainer, false, '<?= $this->translate->_("Please upload a PDF file"); ?>');
            return;
        }

        // Show progress
        progressContainer.show();
        progressBar.css('width', '0%');
        resultContainer.hide();

        var formData = new FormData();
        formData.append('template', file);
        formData.append('scheme', scheme);
        formData.append('type', type);

        $.ajax({
            url: uploadUrl,
            type: 'POST',
            data: formData,
            processData: false,
            contentType: false,
            xhr: function() {
                var xhr = new window.XMLHttpRequest();
                xhr.upload.addEventListener('progress', function(e) {
                    if (e.lengthComputable) {
                        var percent = Math.round((e.loaded / e.total) * 100);
                        progressBar.css('width', percent + '%');
                    }
                }, false);
                return xhr;
            },
            success: function(response) {
                progressContainer.hide();
                if (response.success) {
                    var fieldsHtml = '';
                    if (response.fields && response.fields.length > 0) {
                        fieldsHtml = '<br><strong><?= $this->translate->_("Detected Fields:"); ?></strong> ' + response.fields.join(', ');
                    }
                    showResult(resultContainer, true, response.message + fieldsHtml);
                    // Reload page after short delay to show updated template
                    setTimeout(function() {
                        location.reload();
                    }, 1500);
                } else {
                    showResult(resultContainer, false, response.message);
                }
            },
            error: function(xhr, status, error) {
                progressContainer.hide();
                showResult(resultContainer, false, '<?= $this->translate->_("Upload failed:"); ?> ' + error);
            }
        });
    }

    // Show validation result
    function showResult(container, success, message) {
        container.removeClass('success error').addClass(success ? 'success' : 'error').html(message).show();
    }

    // Remove template
    $('.btn-remove').on('click', function() {
        var scheme = $(this).data('scheme');
        var type = $(this).data('type');
        var typeName = type === 'participation' ? '<?= $this->translate->_("participation"); ?>' : '<?= $this->translate->_("excellence"); ?>';

        if (confirm('<?= $this->translate->_("Are you sure you want to remove this"); ?> ' + typeName + ' <?= $this->translate->_("certificate template?"); ?>')) {
            $.ajax({
                url: removeUrl,
                type: 'POST',
                data: {
                    scheme: scheme,
                    type: type
                },
                success: function(response) {
                    if (response.success) {
                        location.reload();
                    } else {
                        alert(response.message || '<?= $this->translate->_("Failed to remove template"); ?>');
                    }
                },
                error: function() {
                    alert('<?= $this->translate->_("Failed to remove template"); ?>');
                }
            });
        }
    });
});
</script>

<!-- Help Modal -->
<div class="modal" id="helpModal" tabindex="-1" role="dialog" aria-labelledby="helpModalLabel">
    <div class="modal-dialog modal-lg" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="helpModalLabel"><i class="icon-question-sign"></i> <?= $this->translate->_("How to Create PDF Form Templates"); ?></h4>
            </div>
            <div class="modal-body">
                <p><?= $this->translate->_("Certificate templates must be PDF files with <strong>fillable form fields</strong>. The system will automatically populate these fields with participant data."); ?></p>

                <h5><?= $this->translate->_("Required Field"); ?></h5>
                <p><?= $this->translate->_("Your template must have at least one of these fields for the participant name:"); ?></p>
                <ul>
                    <li><code>participant_name</code></li>
                    <li><code>labname</code></li>
                    <li><code>participantname</code></li>
                    <li><code>participant</code></li>
                </ul>

                <h5><?= $this->translate->_("Optional Fields"); ?></h5>
                <table class="table table-bordered table-condensed">
                    <thead>
                        <tr><th><?= $this->translate->_("Field Name"); ?></th><th><?= $this->translate->_("Data"); ?></th></tr>
                    </thead>
                    <tbody>
                        <tr><td><code>city</code></td><td><?= $this->translate->_("Participant's city"); ?></td></tr>
                        <tr><td><code>country</code></td><td><?= $this->translate->_("Participant's country"); ?></td></tr>
                        <tr><td><code>shipment_year</code> <?= $this->translate->_("or"); ?> <code>shipmentyear</code></td><td><?= $this->translate->_("Year of the shipment"); ?></td></tr>
                        <tr><td><code>assay</code> <?= $this->translate->_("or"); ?> <code>assayname</code></td><td><?= $this->translate->_("Assay/Platform (VL/EID only)"); ?></td></tr>
                    </tbody>
                </table>

                <hr>

                <h4><?= $this->translate->_("Option A: Using LibreOffice (Free)"); ?></h4>
                <ol>
                    <li><?= $this->translate->_("Download and install"); ?> <a href="https://www.libreoffice.org" target="_blank">LibreOffice</a> (<?= $this->translate->_("free"); ?>)</li>
                    <li><?= $this->translate->_("Open LibreOffice Writer and design your certificate (add logo, text, borders)"); ?></li>
                    <li><?= $this->translate->_("Go to"); ?> <strong>View &rarr; Toolbars &rarr; Form Controls</strong></li>
                    <li><?= $this->translate->_("Click the"); ?> <strong>Text Box</strong> <?= $this->translate->_("icon in the Form Controls toolbar"); ?></li>
                    <li><?= $this->translate->_("Draw a text box where you want each field"); ?></li>
                    <li><?= $this->translate->_("Right-click the text box &rarr;"); ?> <strong>Control Properties</strong></li>
                    <li><?= $this->translate->_("Set the"); ?> <strong>Name</strong> <?= $this->translate->_("field to match the field names above (e.g.,"); ?> <code>participant_name</code>)</li>
                    <li><?= $this->translate->_("Repeat for each field you want"); ?></li>
                    <li><?= $this->translate->_("Go to"); ?> <strong>File &rarr; Export as PDF</strong></li>
                    <li><?= $this->translate->_("Check"); ?> <strong>&quot;Create PDF form&quot;</strong> <?= $this->translate->_("and select"); ?> <strong>FDF</strong> <?= $this->translate->_("format"); ?></li>
                    <li><?= $this->translate->_("Click Export and save the PDF"); ?></li>
                    <li><?= $this->translate->_("Upload the PDF here"); ?></li>
                </ol>

                <hr>

                <h4><?= $this->translate->_("Option B: Using Microsoft Word + PDFescape (Free)"); ?></h4>
                <ol>
                    <li><?= $this->translate->_("Design your certificate in Microsoft Word"); ?></li>
                    <li><?= $this->translate->_("Save as PDF:"); ?> <strong>File &rarr; Save As &rarr; PDF</strong></li>
                    <li><?= $this->translate->_("Go to"); ?> <a href="https://www.pdfescape.com" target="_blank">PDFescape.com</a> (<?= $this->translate->_("free account"); ?>)</li>
                    <li><?= $this->translate->_("Upload your PDF"); ?></li>
                    <li><?= $this->translate->_("Click"); ?> <strong>Form Field &rarr; Text</strong></li>
                    <li><?= $this->translate->_("Draw a text field where you want each data field"); ?></li>
                    <li><?= $this->translate->_("Click on the field and set its"); ?> <strong>Name</strong> <?= $this->translate->_("in the properties panel"); ?></li>
                    <li><?= $this->translate->_("Repeat for each field"); ?></li>
                    <li><?= $this->translate->_("Download the form-enabled PDF"); ?></li>
                    <li><?= $this->translate->_("Upload the PDF here"); ?></li>
                </ol>

                <hr>

                <div class="alert alert-warning">
                    <strong><?= $this->translate->_("Important:"); ?></strong>
                    <?= $this->translate->_("The PDF must have AcroForm fields, not XFA forms. LibreOffice and PDFescape create compatible AcroForm PDFs."); ?>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal"><?= $this->translate->_("Close"); ?></button>
            </div>
        </div>
    </div>
</div>
