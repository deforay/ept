<?php
$jsonConfig = Zend_Json_Decoder::decode($this->result['schemeResult']['user_test_config'], true);
$qualitativeRows = [];
foreach ($this->result['possibleResult'] as $key => $row) {
	$qualitativeRows[$row['sub_scheme']][] = $row;
}
// Sort each sub_scheme group: Test Results (TEST) first, then Final Interpretations (FINAL)
foreach ($qualitativeRows as $subScheme => &$rows) {
	usort($rows, function ($a, $b) {
		$order = ['TEST' => 0, 'FINAL' => 1];
		$aOrder = $order[$a['scheme_sub_group']] ?? 2;
		$bOrder = $order[$b['scheme_sub_group']] ?? 2;
		if ($aOrder !== $bOrder) {
			return $aOrder - $bOrder;
		}
		// Secondary sort by sort_order if available
		return ($a['sort_order'] ?? 0) - ($b['sort_order'] ?? 0);
	});
}
unset($rows);
?>
<style>
	.result-type {
		background-color: #f9f9f9;
		margin-bottom: 30px !important;
		display: table;
		width: 100%;
	}
</style>
<link rel="stylesheet" type="text/css" href="<?php echo $this->baseUrl('css/bootstrap-select.min.css'); ?>" />
<link rel="stylesheet" type="text/css" href="<?php echo $this->baseUrl('css/multi-select.css'); ?>" />
<link href="<?php echo $this->baseUrl('css/select2.css'); ?>" rel="stylesheet" />
<div class="well">
	<form name="editGenericTestForm" id="editGenericTestForm" method="post" action="<?php echo $this->url(array("module" => "admin", "controller" => "custom-test", "action" => "edit"), 'default', true) ?>" class="form-horizontal bs-example" role="form" onsubmit="validateNow();return false;">
		<fieldset>
			<legend><?= $this->translate->_("Update Custom Test"); ?></legend>
			<div class="row">
				<div class="col-lg-6">
					<label class="control-label" for="schemeName"><?= $this->translate->_("Custom Test Name"); ?> <span class="mandatory">*</span></label>
					<input type="text" value="<?php echo $this->result['schemeResult']['scheme_name'] ?? null; ?>" id="schemeName" name="schemeName" size="50" maxlength="255" class="isRequired form-control" title="Please enter the custom test name" placeholder="Enter the custom test name" onblur="checkDuplicate('scheme_list', 'scheme_name', this, '<?php echo "scheme_id##" . $this->result['schemeResult']['scheme_id']; ?>'', 'This name already exists. Please try something else.')" />
				</div>

				<div class="col-lg-6">
					<label class="control-label" for="schemeCode"><?= $this->translate->_("Custom Test Code"); ?> <span class="mandatory">*</span></label>
					<input type="text" value="<?php echo $this->result['schemeResult']['scheme_id'] ?? null; ?>" id="schemeCode" name="schemeCode" size="50" maxlength="255" class="form-control isRequired" title="Please enter the custom test code" placeholder="Enter the custom test code" onblur="checkDuplicate('scheme_list', 'scheme_id', this, '<?php echo "scheme_id##" . $this->result['schemeResult']['scheme_id']; ?>'', 'This code already exists. Please try something else.')" />
				</div>
			</div>
			<div class="row">
				<div class="col-lg-6">
					<label class="control-label" for="numberOfTests"><?= $this->translate->_("Number of Tests"); ?></label>
					<select id="numberOfTests" name="genericConfig[numberOfTests]" class="form-control" title="Please select the number of tests">
						<option value="">--<?= $this->translate->_("Select"); ?>--</option>
						<option value="1" <?php echo (isset($jsonConfig['numberOfTests']) && $jsonConfig['numberOfTests'] == 1) ? 'selected="selected"' : null; ?>>1</option>
						<option value="2" <?php echo (isset($jsonConfig['numberOfTests']) && $jsonConfig['numberOfTests'] == 2) ? 'selected="selected"' : null; ?>>2</option>
						<option value="3" <?php echo (isset($jsonConfig['numberOfTests']) && $jsonConfig['numberOfTests'] == 3) ? 'selected="selected"' : null; ?>>3</option>
					</select>
				</div>
				<div class="col-lg-6">
					<label class="control-label" for="status"><?= $this->translate->_("Status"); ?></label>
					<select id="status" name="status" class="form-control" title="Please select the status">
						<option value="">-- <?= $this->translate->_("Select"); ?> --</option>
						<option value="active" <?php echo (isset($this->result['schemeResult']['status']) && $this->result['schemeResult']['status'] == 'active') ? 'selected="selected"' : null; ?>>Active</option>
						<option value="inactive" <?php echo (isset($this->result['schemeResult']['status']) && $this->result['schemeResult']['status'] == 'inactive') ? 'selected="selected"' : null; ?>>Inactive</option>
					</select>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-6">
					<label class="control-label" for="passingScore"><?= $this->translate->_("Passing Score"); ?></label>
					<input type="text" value="<?php echo $this->passingScore ?? ''; ?>" id="passingScore" name="genericConfig[passingScore]" class="form-control" title="Please enter the passing score" placeholder="Enter the passing score" />
				</div>
				<div class="col-lg-6">
					<label for="disableOtherTestkit" class="control-label"><?= $this->translate->_("Disable Other Test Kit"); ?> <span class="mandatory">*</span></label>
					<input type="radio" class="" name="genericConfig[disableOtherTestkit]" id="disableOtherTestkitYes" <?php echo (isset($this->disableOtherTestkit) && $this->disableOtherTestkit == "yes") ? " checked='checked' " : ""; ?> value="yes" title="Please select whether to disable other test kits" /> <?= $this->translate->_("Yes"); ?>
					&nbsp;<input type="radio" class="isRequired" name="genericConfig[disableOtherTestkit]" id="disableOtherTestkitNo" <?php echo (!isset($this->disableOtherTestkit) || $this->disableOtherTestkit == "no") ? " checked='checked' " : ""; ?> value="no" title="Please select whether to disable other test kits" /> <?= $this->translate->_("No"); ?>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-6">
					<label for="testkit1" class="control-label"><?= $this->translate->_("Enforce these Test kits"); ?></label>
					<select name="customTestkit[]" id="customTestkit" class="form-control" multiple="multiple" title="Please Choose Test Kit" style="width: 100%;">
						<?php foreach ($this->allTestKits as $key => $testkit) { ?>
							<option value="<?php echo $testkit['TESTKITNAMEID'] ?>" <?php echo (isset($this->customTestsRecommendedTestkits) && in_array($testkit['TESTKITNAMEID'], $this->customTestsRecommendedTestkits)) ? 'selected' : ''; ?>><?php echo $testkit['TESTKITNAME'] ?></option>
						<?php } ?>
					</select>
				</div>
				<div class="col-lg-6">
					<label for="reportVersion" class="control-label"><?= $this->translate->_("Report Version"); ?></label>
					<input value="<?php echo $this->reportVersion ?? null; ?>" type="text" name="genericConfig[reportVersion]" id="reportVersion" class="form-control" placeholder="Enter the report version" title="Please enter the report version">
				</div>
			</div>
			<div class="row">
				<div class="col-md-6">
					<label for="reportEffectiveDate" class="control-label"><?= $this->translate->_("Report Effective Date"); ?></label>
					<input value="<?php echo $this->reportEffectiveDate ?? null; ?>" type="text" id="reportEffectiveDate" name="genericConfig[reportEffectiveDate]" class="form-control datepicker" placeholder="Select the report effective date" title="<?= $this->translate->_('Please select the report effective date'); ?>" value="<?php echo $tb['reportEffectiveDate'] ?? null; ?>" />
					<small class="text-muted"><?= $this->translate->_("Please select the report effective date that shows in the report PDF footer."); ?></small>
				</div>
				<div class="col-lg-6">
					<label class="control-label" for="captureAdditionalDetails"><?= $this->translate->_("Capture Additional Detail"); ?></label>
					<select id="captureAdditionalDetails" name="genericConfig[captureAdditionalDetails]" class="form-control" title="Please select whether to capture additional details">
						<option value="">-- <?= $this->translate->_("Select"); ?> --</option>
						<option value="yes" <?php echo (isset($jsonConfig['captureAdditionalDetails']) && $jsonConfig['captureAdditionalDetails'] == 'yes') ? 'selected="selected"' : null; ?>>Yes</option>
						<option value="no" <?php echo (isset($jsonConfig['captureAdditionalDetails']) && $jsonConfig['captureAdditionalDetails'] == 'no') ? 'selected="selected"' : null; ?>>No</option>
					</select>
				</div>
			</div>
			<div class="row">
				<div class="col-lg-6" id="additionalDetailLabelGroup" style="<?php echo (isset($jsonConfig['captureAdditionalDetails']) && $jsonConfig['captureAdditionalDetails'] == 'yes') ? '' : 'display: none;'; ?>">
					<label class="control-label" for="additionalDetailLabel"><?= $this->translate->_("Additional Detail Label"); ?></label>
					<input type="text" value="<?php echo $jsonConfig['additionalDetailLabel'] ?? null; ?>" id="additionalDetailLabel" name="genericConfig[additionalDetailLabel]" class="form-control <?php echo (isset($jsonConfig['captureAdditionalDetails']) && $jsonConfig['captureAdditionalDetails'] == 'yes') ? 'isRequired' : ''; ?>" title="Please enter the label for additional details" placeholder="Enter the label for additional details" />
				</div>
			</div>
			<hr>
			<table style="width: 100%;margin: 0 auto;" border="1" class="table table-bordered table-striped clearfix" id="vlSampleTable">
				<tbody>
					<?php if (isset($this->result['possibleResult']) && sizeof($this->result['possibleResult']) > 0) {
						$label = [];
						foreach ($this->result['possibleResult'] as $key => $row) {
							$rowCount = ($key + 1);
							if (!in_array($row['sub_scheme'], $label)) {
								$label[] = $row['sub_scheme'] ?>
								<tr class="result-type">
									<td>
										<table style="width: 100%;margin: 0 auto;" border="1" class="table table-bordered table-striped clearfix">
											<tr>
												<td class="<?php echo (isset($row['sub_scheme']) && !empty($row['sub_scheme'])) ? '' : 'hide'; ?> firstSubTest" style="width:20%;">
													<lable for="resultSubGroup<?php echo $rowCount; ?>" class="form-label-control"><?= $this->translate->_("Enter the test name"); ?></lable>
												</td>
												<td class="<?php echo (isset($row['sub_scheme']) && !empty($row['sub_scheme'])) ? '' : 'hide'; ?> firstSubTest" style="width:30%;">
													<input type="text" name="resultSubGroup[<?php echo $rowCount; ?>]" id="resultSubGroup<?php echo $rowCount; ?>" value="<?php echo (isset($row['sub_scheme']) && !empty($row['sub_scheme'])) ? $row['sub_scheme'] : ''; ?>" class="form-control input-sm" placeholder="Enter the sub test name" title="Please enter the sub test name for <?php echo $rowCount; ?> row" />
												</td>
												<td style="width:20%;">
													<lable for="testType<?php echo $rowCount; ?>" class="form-label-control"><?= $this->translate->_("Select Test Format"); ?></lable>
												</td>
												<td style="width:30%;">
													<select type="text" name="testType[<?php echo $rowCount; ?>]" id="testType<?php echo $rowCount; ?>" class="form-control test-type input-sm" title="Please select the test format" onchange="setTestFormatType(this.value, <?php echo $rowCount; ?>)">
														<option value=""> -- <?= $this->translate->_("Select"); ?> -- </option>
														<option value="qualitative" <?php echo (isset($row['result_type']) && !empty($row['result_type']) && $row['result_type'] == 'qualitative') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Qualitative"); ?></option>
														<option value="quantitative" <?php echo (isset($row['result_type']) && !empty($row['result_type']) && $row['result_type'] == 'quantitative') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Quantitative"); ?></option>
													</select>
												</td>
											</tr>
											<tr class="qualitative-div <?php echo (isset($row['result_type']) && !empty($row['result_type']) && $row['result_type'] == 'qualitative') ? '' : 'hide'; ?>" id="qualitativeRow<?php echo $rowCount; ?>">
												<td colspan="4">
													<table style="width:100%;">
														<tr>
															<th><?= $this->translate->_("Expected Result"); ?></th>
															<th><?= $this->translate->_("Result Code"); ?></th>
															<th><?= $this->translate->_("Result Type"); ?></th>
															<th><?= $this->translate->_("Displayed To"); ?></th>
															<th><?= $this->translate->_("Sort Order"); ?></th>
															<th><?= $this->translate->_("Action"); ?></th>
														</tr>
														<?php if (isset($qualitativeRows[$row['sub_scheme']]) && !empty($qualitativeRows[$row['sub_scheme']])) {
															$n = count($qualitativeRows[$row['sub_scheme']]);
															foreach ($qualitativeRows[$row['sub_scheme']] as $ikey => $value) {
																$innerCount = ($ikey + 1); ?>
																<tr>
																	<td>
																		<input type="text" value="<?php echo $value['response'] ?? null; ?>" name="qualitative[expectedResult][<?php echo $rowCount; ?>][<?php echo $innerCount; ?>]" class="form-control qualitative-input-<?php echo $rowCount; ?><?php echo $innerCount; ?> input-sm" placeholder="Enter the expected result" title="Please enter the expected result" />
																	</td>
																	<td>
																		<input type="text" value="<?php echo $value['result_code'] ?? null; ?>" name="qualitative[resultCode][<?php echo $rowCount; ?>][<?php echo $innerCount; ?>]" class="form-control qualitative-input-<?php echo $rowCount; ?><?php echo $innerCount; ?> input-sm resultCodeInput" placeholder="Enter the result code" title="Please enter the result code" onchange="resultCodeChange(this);" />
																	</td>
																	<td>
																		<select id="resultType<?php echo $rowCount . $innerCount; ?>" name="qualitative[resultType][<?php echo $rowCount; ?>][<?php echo $innerCount; ?>]" class="form-control qualitative-input-<?php echo $rowCount; ?><?php echo $innerCount; ?> input-sm resultTypeInput" placeholder="Select the result type" title="Please select the result type" onchange="resultTypeChange(<?php echo $rowCount . ', ' .  $innerCount; ?>)">
																			<option value="">-- <?= $this->translate->_("Select"); ?> --</option>
																			<option value="test-result" <?php echo (isset($value['scheme_sub_group']) && $value['scheme_sub_group'] == 'TEST') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Test Result"); ?></option>
																			<option value="final-interpretation" <?php echo (isset($value['scheme_sub_group']) && $value['scheme_sub_group'] == 'FINAL') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Final Interpretation"); ?></option>
																		</select>
																	</td>
																	<td>
																		<select id="displayContext<?php echo $rowCount . $innerCount; ?>" name="qualitative[displayContext][<?php echo $rowCount; ?>][<?php echo $innerCount; ?>]" class="form-control qualitative-input-11 input-sm" title="Please select the displayed context">
																			<option value=""> -- <?= $this->translate->_("Select"); ?> -- </option>
																			<option value="participant" <?php echo (isset($value['display_context']) && !empty($value['display_context']) && $value['display_context'] == 'participant') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Participant"); ?></option>
																			<option value="admin" <?php echo (isset($value['display_context']) && !empty($value['display_context']) && $value['display_context'] == 'admin') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Admin"); ?></option>
																			<option value="all" <?php echo (isset($value['display_context']) && !empty($value['display_context']) && $value['display_context'] == 'all') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("All"); ?></option>
																		</select>
																	</td>
																	<td>
																		<input type="text" value="<?php echo $value['sort_order'] ?? null; ?>" name="qualitative[sortOrder][<?php echo $rowCount; ?>][<?php echo $innerCount; ?>]" class="form-control qualitative-input-<?php echo $rowCount; ?><?php echo $innerCount; ?> input-sm" placeholder="Enter the sort order" title="Please enter the sort order" />
																	</td>
																	<td style="text-align:center;">
																		<a href="javascript:void(0);" onclick="addQualitativeRow(this, <?php echo $rowCount; ?>,<?php echo ($innerCount + 1); ?>);" <?php echo ($innerCount == $n) ? '' : 'disabled="disabled"'; ?> class="btn btn-xs btn-info qualitative-insrow-<?php echo $rowCount; ?><?php echo $innerCount; ?>"><i class="icon-plus"></i></a>&nbsp;&nbsp;<a href="javascript:void(0);" onclick="removeQualitativeRow(this, <?php echo $rowCount; ?>, <?php echo ($innerCount + 1); ?>)" class="btn btn-xs btn-danger" title="Remove this row completely" alt="Remove this row completely"><i class="icon-minus"></i></a>
																	</td>
												</td>
											</tr>
									<?php
															}
														} ?>
										</table>
									</td>
								</tr>
								<tr class="quantitative-div <?php echo (isset($row['sub_scheme']) && !empty($row['sub_scheme']) && $row['result_type'] == 'quantitative') ? '' : 'hide'; ?>" id="quantitativeRow<?php echo $rowCount; ?>">
									<td colspan="4">
										<table style="width:100%;">
											<tr>
												<th><?= $this->translate->_("High Range"); ?></th>
												<th><?= $this->translate->_("Threshold Range"); ?></th>
												<th><?= $this->translate->_("Low Range"); ?></th>
												<th><?= $this->translate->_("SD Scaling Factor"); ?></th>
												<th><?= $this->translate->_("Uncertainty Scaling Factor"); ?></th>
												<th><?= $this->translate->_("Uncertainty Threshold"); ?></th>
												<th><?= $this->translate->_("Minimum Number of Responses"); ?></th>
											</tr>
											<tr>
												<td>
													<input type="text" value="<?php echo $row['high_range'] ?? null; ?>" name="quantitative[highValue][<?php echo $rowCount; ?>]" class="form-control quantitative-input-<?php echo $rowCount; ?>1 input-sm" placeholder="Enter the high value" title="Please enter the high value" />
												</td>
												<td>
													<input type="text" value="<?php echo $row['threshold_range'] ?? null; ?>" name="quantitative[thresholdValue][<?php echo $rowCount; ?>]" class="form-control quantitative-input-<?php echo $rowCount; ?>1 input-sm" placeholder="Enter the threshold value" title="Please enter the threshold value" />
												</td>
												<td>
													<input type="text" value="<?php echo $row['low_range'] ?? null; ?>" name="quantitative[lowValue][<?php echo $rowCount; ?>]" class="form-control quantitative-input-<?php echo $rowCount; ?>1 input-sm" placeholder="Enter the low value" title="Please enter the low value" />
												</td>
												<td>
													<input type="text" value="<?php echo $row['sd_scaling_factor'] ?? null; ?>" name="quantitative[SDScalingFactor][<?php echo $rowCount; ?>]" class="form-control quantitative-input-11 input-sm" placeholder="Enter the SD scaling factor" title="Please enter the SD scaling factor" />
												</td>
												<td>
													<input type="text" value="<?php echo $row['uncertainy_scaling_factor'] ?? null; ?>" name="quantitative[uncertainyScalingFactor][<?php echo $rowCount; ?>]" class="form-control quantitative-input-11 input-sm" placeholder="Enter the uncertainy scaling factor" title="Please enter the uncertainy scaling factor" />
												</td>
												<td>
													<input type="text" value="<?php echo $row['uncertainy_threshold'] ?? null; ?>" name="quantitative[uncertainyThreshold][<?php echo $rowCount; ?>]" class="form-control quantitative-input-11 input-sm" placeholder="Enter the uncertainty threshold" title="Please enter the uncertainty threshold" />
												</td>
												<td>
													<input type="text" value="<?php echo $row['minimum_number_of_responses'] ?? null; ?>" name="quantitative[minNumberOfResponses][<?php echo $rowCount; ?>]" class="form-control quantitative-input-11 input-sm" placeholder="Enter the minimum number of response" title="Please enter the minimum number of response" />
												</td>
											</tr>
										</table>
									</td>
								</tr>
								<tr class="quantitative-warning <?php echo (isset($row['sub_scheme']) && !empty($row['sub_scheme']) && $row['result_type'] == 'quantitative') ? '' : 'hide'; ?>" id="quantitativeWarning<?php echo $rowCount; ?>">
									<td colspan="4">
										<div class="alert alert-warning" style="margin-top: 10px;">
											<i class="icon-warning-sign"></i> <strong><?= $this->translate->_("Note:"); ?></strong> <?= $this->translate->_("Quantitative is under active development and may have limited functionality."); ?>
										</div>
									</td>
								</tr>
			</table>
			</td>
			<!-- TODO: Multiple sub-tests feature hidden until evaluation logic supports it -->
			<td style="text-align:center;vertical-align: middle; display:none;" class="add-subtest-btn">
				<a href="javascript:void(0);" onclick="addNewRow(this);" class="btn btn-xs btn-info"><i class="icon-plus"></i></a>&nbsp;&nbsp;<a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger" title="Remove this row completely" alt="Remove this row completely"><i class="icon-minus"></i></a>
			</td>
			</tr>
	<?php }
						}
					} else { ?>
	<tr class="result-type">
		<td>
			<table style="width: 100%;margin: 0 auto;" border="1" class="table table-bordered table-striped clearfix">
				<tr>
					<td class="hide firstSubTest" style="width:20%;">
						<lable for="resultSubGroup1" class="form-label-control">Enter the test name</lable>
					</td>
					<td class="hide firstSubTest" style="width:30%;">
						<input type="text" name="resultSubGroup[1]" id="resultSubGroup1" class="form-control input-sm" placeholder="Enter the sub test name" title="Please enter the sub test name for 1st row" />
					</td>
					<td style="width:20%;">
						<lable for="testType1" class="form-label-control">Select Test Format</lable>
					</td>
					<td style="width:30%;">
						<select type="text" name="testType[1]" id="testType1" class="form-control test-type input-sm" title="Please select the test format" onchange="setTestFormatType(this.value, 1)">
							<option value=""> -- <?= $this->translate->_("Select"); ?> -- </option>
							<option value="qualitative"><?= $this->translate->_("Qualitative"); ?></option>
							<option value="quantitative"><?= $this->translate->_("Quantitative"); ?></option>
						</select>
					</td>
				</tr>
				<tr class="qualitative-div hide" id="qualitativeRow1">
					<td colspan="4">
						<table style="width:100%;">
							<tr>
								<th><?= $this->translate->_("Expected Result"); ?></th>
								<th><?= $this->translate->_("Result Code"); ?></th>
								<th><?= $this->translate->_("Result Type"); ?></th>
								<th><?= $this->translate->_("Displayed To"); ?></th>
								<th><?= $this->translate->_("Sort Order"); ?></th>
								<th><?= $this->translate->_("Action"); ?></th>
							</tr>
							<tr>
								<td>
									<input type="text" name="qualitative[expectedResult][1][1]" class="form-control qualitative-input-11 input-sm" placeholder="Enter the expected result" title="Please enter the expected result" />
								</td>
								<td>
									<input type="text" name="qualitative[resultCode][1][1]" class="form-control qualitative-input-11 input-sm resultCodeInput" placeholder="Enter the result code" title="Please enter the result code" onchange="resultCodeChange(this);" />
								</td>
								<td>
									<select id="resultType11" name="qualitative[resultType][1][1]" class="form-control qualitative-input-11 input-sm resultTypeInput" placeholder="Select the result type" title="Please select the result type" onchange="resultTypeChange(1, 1)">
										<option value="">-- <?= $this->translate->_("Select"); ?> --</option>
										<option value="test-result"><?= $this->translate->_("Test Result"); ?></option>
										<option value="final-interpretation"><?= $this->translate->_("Final Interpretation"); ?></option>
									</select>
								</td>
								<td>
									<select id="displayContext11" name="qualitative[displayContext][1][1]" class="form-control qualitative-input-11 input-sm" title="Please select the displayed context">
										<option value=""> -- <?= $this->translate->_("Select"); ?> -- </option>
										<option value="participant"><?= $this->translate->_("Participant"); ?></option>
										<option value="admin"><?= $this->translate->_("Admin"); ?></option>
										<option value="all"><?= $this->translate->_("All"); ?></option>
									</select>
								</td>
								<td>
									<input type="text" name="qualitative[sortOrder][1][1]" class="form-control qualitative-input-11 input-sm" placeholder="Enter the sort order" title="Please enter the sort order" />
								</td>
								<td style="text-align:center;">
									<a href="javascript:void(0);" onclick="addQualitativeRow(this, 1,2);" class="btn btn-xs btn-info qualitative-insrow-11"><i class="icon-plus"></i></a>
								</td>
							</tr>
						</table>
					</td>
				</tr>
				<tr class="quantitative-div hide" id="quantitativeRow1">
					<td colspan="4">
						<table style="width:100%;">
							<tr>
								<th><?= $this->translate->_("High Range"); ?></th>
								<th><?= $this->translate->_("Threshold Range"); ?></th>
								<th><?= $this->translate->_("Low Range"); ?></th>
								<th><?= $this->translate->_("SD Scaling Factor"); ?></th>
								<th><?= $this->translate->_("Uncertainty Scaling Factor"); ?></th>
								<th><?= $this->translate->_("Uncertainty Threshold"); ?></th>
								<th><?= $this->translate->_("Minimum Number of Responses"); ?></th>
							</tr>
							<tr>
								<td>
									<input type="text" name="quantitative[highValue][1]" class="form-control quantitative-input-11 input-sm" placeholder="Enter the high value" title="Please enter the high value" />
								</td>
								<td>
									<input type="text" name="quantitative[thresholdValue][1]" class="form-control quantitative-input-11 input-sm" placeholder="Enter the threshold value" title="Please enter the threshold value" />
								</td>
								<td>
									<input type="text" name="quantitative[lowValue][1]" class="form-control quantitative-input-11 input-sm" placeholder="Enter the low value" title="Please enter the low value" />
								</td>
								<td>
									<input type="text" name="quantitative[SDScalingFactor][1]" class="form-control quantitative-input-11 input-sm" placeholder="Enter the SD scaling factor" title="Please enter the SD scaling factor" />
								</td>
								<td>
									<input type="text" name="quantitative[uncertainyScalingFactor][1]" class="form-control quantitative-input-11 input-sm" placeholder="Enter the uncertainy scaling factor" title="Please enter the uncertainy scaling factor" />
								</td>
								<td>
									<input type="text" name="quantitative[uncertainyThreshold][1]" class="form-control quantitative-input-11 input-sm" placeholder="Enter the uncertainty threshold" title="Please enter the uncertainty threshold" />
								</td>
								<td>
									<input type="text" name="quantitative[minNumberOfResponses][1]" class="form-control quantitative-input-11 input-sm" placeholder="Enter the minimum number of response" title="Please enter the minimum number of response" />
								</td>
							</tr>
						</table>
					</td>
				</tr>
				<tr class="quantitative-warning hide" id="quantitativeWarning1">
					<td colspan="4">
						<div class="alert alert-warning" style="margin-top: 10px;">
							<i class="icon-warning-sign"></i> <strong><?= $this->translate->_("Note:"); ?></strong> <?= $this->translate->_("Quantitative is under active development and may have limited functionality."); ?>
						</div>
					</td>
				</tr>
			</table>
		</td>
		<!-- TODO: Multiple sub-tests feature hidden until evaluation logic supports it -->
		<td style="text-align:center;vertical-align: middle; display:none;" class="add-subtest-btn">
			<a href="javascript:void(0);" onclick="addNewRow(this);" class="btn btn-xs btn-info"><i class="icon-plus"></i></a>
		</td>
	</tr>
<?php } ?>
</tbody>
</table>
<div id="respond" style="margin: 0px auto 0px auto; text-align: center;" class="form-group col-lg-11" align="center">
	<input name="schemeId" class="btn btn-primary" type="hidden" value="<?php echo base64_encode($this->result['schemeResult']['scheme_id']); ?>" />
	<input name="submitbtn" class="btn btn-primary" type="submit" tabindex="7" value="<?= $this->translate->_("Update"); ?>" />
	<input class="btn btn-danger" type="button" onclick="window.location.href = '/admin/custom-test';" tabindex="8" value="<?= $this->translate->_("Cancel"); ?>" />
</div>
		</fieldset>
	</form>
</div>
<script type="text/javascript" src="<?php echo $this->baseUrl('js/select2.min.js'); ?>"></script>
<script type="text/javascript" src="<?php echo $this->baseUrl('js/bootstrap-select.min.js'); ?>"></script>
<script type="text/javascript" src="<?php echo $this->baseUrl("js/jquery.multi-select.js"); ?>"></script>
<script type="text/javascript">
	var duplicated = false;
	var sampleCounter = <?php echo (isset($this->result['possibleResult']) && sizeof($this->result['possibleResult']) > 0) ? sizeof($this->result['possibleResult']) : 1 ?>;

	function checkDuplicate(tableName, fieldName, obj, fnct, msg) {
		$.post("<?php echo $this->url(array('module' => 'default', 'controller' => 'common', 'action' => 'check-duplicate')); ?>", {
				tableName: tableName,
				fieldName: fieldName,
				value: obj.value,
				fnct: fnct,
				format: "html"
			},
			function(data) {
				if (data > 0) {
					alert(msg, "err");
					duplicated = true;
					$(obj).val('');
					obj.focus();
				} else {
					duplicated = false;
				}
			});
	}

	function validateQualitativeResults() {
		var qualitativeVisible = false;
		$('.qualitative-div').each(function() {
			if (!$(this).hasClass('hide')) {
				qualitativeVisible = true;
			}
		});

		if (!qualitativeVisible) {
			return true; // No qualitative results to validate
		}

		var hasTestResult = false;
		var hasFinalInterpretation = false;
		var resultsByType = {
			'test-result': [],
			'final-interpretation': []
		};
		var allResultCodes = [];

		// Collect all result types, expected results, and result codes
		$('.resultTypeInput').each(function() {
			var resultType = $(this).val();
			if (resultType) {
				if (resultType === 'test-result') {
					hasTestResult = true;
				} else if (resultType === 'final-interpretation') {
					hasFinalInterpretation = true;
				}

				// Get the expected result from the same row
				var row = $(this).closest('tr');
				var expectedResult = row.find('input[name*="[expectedResult]"]').val();
				if (expectedResult && expectedResult.trim() !== '') {
					var normalizedResult = expectedResult.trim().toLowerCase();
					if (resultsByType[resultType].includes(normalizedResult)) {
						alert('Duplicate expected result "' + expectedResult + '" found for Result Type "' + (resultType === 'test-result' ? 'Test Result' : 'Final Interpretation') + '". Each expected result must be unique within a result type.');
						return false;
					}
					resultsByType[resultType].push(normalizedResult);
				}

				// Check for duplicate result codes
				var resultCode = row.find('input[name*="[resultCode]"]').val();
				if (resultCode && resultCode.trim() !== '') {
					var normalizedCode = resultCode.trim().toUpperCase();
					if (allResultCodes.includes(normalizedCode)) {
						alert('Duplicate Result Code "' + resultCode + '" found. Each result code must be unique.');
						return false;
					}
					allResultCodes.push(normalizedCode);
				}
			}
		});

		// Check if both result types exist
		/* if (!hasTestResult || !hasFinalInterpretation) {
			alert('You must have at least one "Test Result" and one "Final Interpretation" result type.');
			return false;
		} */

		return true;
	}

	function validateNow() {
		flag = deforayValidator.init({
			formId: 'editGenericTestForm'
		});
		if (flag && !duplicated) {
			if (!validateQualitativeResults()) {
				return false;
			}
			$.blockUI();
			document.getElementById('editGenericTestForm').submit();
		}
	}

	function addQualitativeRow(obj, row1, row2) {
		$(obj).attr('disabled', true);
		var html = '<tr align="center"> \
			<td>\
				<input type="text" name="qualitative[expectedResult][' + row1 + '][' + row2 + ']" class="form-control qualitative-input-' + row1 + row2 + ' input-sm" placeholder="Enter the expected result" title="Please enter the expected result" />\
			</td>\
			<td>\
				<input type="text" name="qualitative[resultCode][' + row1 + '][' + row2 + ']" class="form-control isRequired qualitative-input-' + row1 + row2 + ' input-sm resultCodeInput" placeholder="Enter the result code" title="Please enter the result code" onchange="resultCodeChange(this);"/>\
			</td>\
			<td>\
				<select id="resultType' + row1 + row2 + '" name="qualitative[resultType][' + row1 + '][' + row2 + ']" class="form-control isRequired qualitative-input-' + row1 + row2 + ' input-sm resultTypeInput" placeholder="Select the result type" title="Please select the result type" onchange="resultTypeChange(' + row1 + ', ' + row2 + ')">\
					<option value="">-- <?= $this->translate->_("Select"); ?> --</option>\
					<option value="test-result"><?= $this->translate->_("Test Result"); ?></option>\
					<option value="final-interpretation"><?= $this->translate->_("Final Interpretation"); ?></option>\
				</select>\
			</td>\
			<td>\
				<select id="displayContext' + row1 + row2 + '" name="qualitative[displayContext][' + row1 + '][' + row2 + ']" class="form-control qualitative-input-' + row1 + row2 + ' input-sm" title="Please select the displayed context">\
					<option value=""> -- <?= $this->translate->_("Select"); ?> -- </option>\
					<option value="participant"><?= $this->translate->_("Participant"); ?></option>\
					<option value="admin"><?= $this->translate->_("Admin"); ?></option>\
					<option value="all"><?= $this->translate->_("All"); ?></option>\
				</select>\
			</td>\
			<td>\
				<input type="text" name="qualitative[sortOrder][' + row1 + '][' + row2 + ']" class="form-control qualitative-input-' + row1 + row2 + ' input-sm" placeholder="Enter the sort order" title="Please enter the sort order" />\
			</td>\
			<td><a href="javascript:void(0);" onclick="addQualitativeRow(this, ' + row1 + ',' + (row2 + 1) + ');" class="btn btn-xs btn-info qualitative-insrow-' + row1 + row2 + '"><i class="icon-plus"></i></a>&nbsp;&nbsp;<a  href="javascript:void(0);" onclick="removeQualitativeRow(this, ' + row1 + ', ' + (row2 - 1) + ')" class="btn btn-xs btn-danger"  title="Remove this row completely" alt="Remove this row completely"><i class="icon-minus"></i></a></td> \
		</tr>'
		$(obj.parentNode.parentNode).after(html);
	}

	function addNewRow(obj) {
		$('.firstSubTest').removeClass('hide');
		$('#resultSubGroup1').addClass('isRequired');
		sampleCounter++;
		var html = '<tr class="result-type">\
				<td>\
					<table style="width: 100%;margin: 0 auto;" border="1" class="table table-bordered table-striped clearfix">\
						<tr>\
							<td style="width:20%;"><lable for="resultSubGroup' + sampleCounter + '" class="form-label-control">Enter the test name</lable></td>\
							<td style="width:30%;">\
								<input type="text" name="resultSubGroup[' + sampleCounter + ']"id="resultSubGroup' + sampleCounter + '" class="form-control isRequired input-sm" placeholder="Enter the sub test name" title="Please enter the sub test name for ' + sampleCounter + ' row"/>\
							</td>\
							<td style="width:20%;"><lable for="testType' + sampleCounter + '" class="form-label-control">Select Test Format</lable></td>\
							<td style="width:30%;">\
								<select type="text" name="testType[' + sampleCounter + ']"id="testType' + sampleCounter + '" class="form-control test-type isRequired input-sm" title="Please select the test format" onchange="setTestFormatType(this.value, ' + sampleCounter + ')">\
									<option value=""> -- <?= $this->translate->_("Select"); ?> -- </option>\
									<option value="qualitative"><?= $this->translate->_("Qualitative"); ?></option>\
									<option value="quantitative"><?= $this->translate->_("Quantitative"); ?></option>\
								</select>\
							</td>\
						</tr>\
						<tr class="qualitative-div hide" id="qualitativeRow' + sampleCounter + '">\
							<td colspan="4">\
								<table style="width:100%;">\
									<tr>\
										<th><?= $this->translate->_("Expected Result"); ?></th>\
										<th><?= $this->translate->_("Result Code"); ?></th>\
										<th><?= $this->translate->_("Result Type"); ?></th>\
										<th><?= $this->translate->_("Displayed To"); ?></th>\
										<th><?= $this->translate->_("Sort Order"); ?></th>\
										<th><?= $this->translate->_("Action"); ?></th>\
									</tr>\
									<tr>\
										<td>\
											<input type="text" name="qualitative[expectedResult][' + sampleCounter + '][1]" class="form-control qualitative-input-' + sampleCounter + '1 input-sm" placeholder="Enter the expected result" title="Please enter the expected result" />\
										</td>\
										<td>\
											<input type="text" name="qualitative[resultCode][' + sampleCounter + '][1]" class="form-control qualitative-input-' + sampleCounter + '1 input-sm resultCodeInput" placeholder="Enter the result code" title="Please enter the result code" onchange="resultCodeChange(this);" />\
										</td>\
										<td>\
											<select id="resultType' + sampleCounter + '1" name="qualitative[resultType][' + sampleCounter + '][1]" class="form-control qualitative-input-' + sampleCounter + '1 input-sm resultTypeInput" placeholder="Select the result type" title="Please select the result type"  onchange="resultTypeChange(' + sampleCounter + ', 1)">\
												<option value="">-- <?= $this->translate->_("Select"); ?> --</option>\
												<option value="test-result"><?= $this->translate->_("Test Result"); ?></option>\
												<option value="final-interpretation"><?= $this->translate->_("Final Interpretation"); ?></option>\
											</select>\
										</td>\
										<td>\
											<select id="displayContext' + sampleCounter + '1" name="qualitative[displayContext][' + sampleCounter + '][1]" class="form-control qualitative-input-' + sampleCounter + '1 input-sm" title="Please select the displayed context">\
												<option value=""> -- <?= $this->translate->_("Select"); ?> -- </option>\
												<option value="participant"><?= $this->translate->_("Participant"); ?></option>\
												<option value="admin"><?= $this->translate->_("Admin"); ?></option>\
												<option value="all"><?= $this->translate->_("All"); ?></option>\
											</select>\
										</td>\
										<td>\
											<input type="text" name="qualitative[sortOrder][' + sampleCounter + '][1]" class="form-control qualitative-input-' + sampleCounter + '1 input-sm" placeholder="Enter the sort order" title="Please enter the sort order" />\
										</td>\
										<td style="text-align:center;">\
											<a href="javascript:void(0);" onclick="addQualitativeRow(this, ' + sampleCounter + ', 2);" class="btn btn-xs btn-info qualitative-insrow-' + sampleCounter + '1"><i class="icon-plus"></i></a>\
										</td>\
									</tr>\
								</table>\
							</td>\
						</tr>\
						<tr class="quantitative-div hide" id="quantitativeRow' + sampleCounter + '">\
							<td colspan="4">\
								<table style="width:100%;">\
									<tr>\
										<th><?= $this->translate->_("High Range"); ?></th>\
										<th><?= $this->translate->_("Threshold Range"); ?></th>\
										<th><?= $this->translate->_("Low Range"); ?></th>\
										<th><?= $this->translate->_("SD Scaling Factor"); ?></th>\
										<th><?= $this->translate->_("Uncertainty Scaling Factor"); ?></th>\
										<th><?= $this->translate->_("Uncertainty Threshold"); ?></th>\
										<th><?= $this->translate->_("Minimum Number of Responses"); ?></th>\
									</tr>\
									<tr>\
										<td>\
											<input type="text" name="quantitative[highValue][' + sampleCounter + ']" class="form-control quantitative-input-' + sampleCounter + '1 input-sm" placeholder="Enter the high value" title="Please enter the high value" />\
										</td>\
										<td>\
											<input type="text" name="quantitative[thresholdValue][' + sampleCounter + ']" class="form-control quantitative-input-' + sampleCounter + '1 input-sm" placeholder="Enter the threshold value" title="Please enter the threshold value" />\
										</td>\
										<td>\
											<input type="text" name="quantitative[lowValue][' + sampleCounter + ']" class="form-control quantitative-input-' + sampleCounter + '1 input-sm" placeholder="Enter the low value" title="Please enter the low value" />\
										</td>\
										<td>\
											<input type="text" name="quantitative[SDScalingFactor][' + sampleCounter + ']" class="form-control quantitative-input-' + sampleCounter + '1 input-sm" placeholder="Enter the SD scaling factor" title="Please enter the SD scaling factor" />\
										</td>\
										<td>\
											<input type="text" name="quantitative[uncertainyScalingFactor][' + sampleCounter + ']" class="form-control quantitative-input-' + sampleCounter + '1 input-sm" placeholder="Enter the uncertainy scaling factor" title="Please enter the uncertainy scaling factor" />\
										</td>\
										<td>\
											<input type="text" name="quantitative[uncertainyThreshold][' + sampleCounter + ']" class="form-control quantitative-input-' + sampleCounter + '1 input-sm" placeholder="Enter the uncertainty threshold" title="Please enter the uncertainty threshold" />\
										</td>\
										<td>\
											<input type="text" name="quantitative[minNumberOfResponses][' + sampleCounter + ']" class="form-control quantitative-input-' + sampleCounter + '1 input-sm" placeholder="Enter the minimum number of response" title="Please enter the minimum number of response" />\
										</td>\
									</tr>\
								</table>\
							</td>\
						</tr>\
						<tr class="quantitative-warning hide" id="quantitativeWarning' + sampleCounter + '">\
							<td colspan="4">\
								<div class="alert alert-warning" style="margin-top: 10px;">\
									<i class="icon-warning-sign"></i> <strong><?= $this->translate->_("Note:"); ?></strong> <?= $this->translate->_("Quantitative is under active development and may have limited functionality."); ?>\
								</div>\
							</td>\
						</tr>\
					</table>\
				</td>\
				<td style=" text-align:center;vertical-align: middle;">\
					<a href="javascript:void(0);" onclick="addNewRow(this);" class="btn btn-xs btn-info"><i class="icon-plus"></i></a>&nbsp;&nbsp;<a  href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger"  title="Remove this row completely" alt="Remove this row completely"><i class="icon-minus"></i></a>\
				</td>\
			</tr>';
		$(obj.parentNode.parentNode).after(html);
		$(".datepicker").datepicker({
			dateFormat: '<?php echo $this->defaultDateFormat(); ?>'
		});
	}

	$(document).ready(function() {
		$('.multipleSelect').multiselect({
			includeSelectAllOption: false
		});

		$('#captureAdditionalDetails').on("change", function() {
			if ($(this).val() == 'yes') {
				$("#additionalDetailLabelGroup").show();
				$("#additionalDetailLabel").addClass("isRequired");
			} else {
				$("#additionalDetailLabelGroup").hide();
				$("#additionalDetailLabel").removeClass("isRequired");
			}

		});
		$(".datepicker").datepicker({
			dateFormat: '<?php echo $this->defaultDateFormat(); ?>'
		});
		$('.resultCodeInput').on('input', function() {
			$(this).val($(this).val().replace(/[^a-z0-9-]/gi, ''));
		});
		$('.test-type').each(function(index, element) {
			setTestFormatType($(this).val(), (index + 1));
		});
	});

	function removeQualitativeRow(obj, row1, row2) {
		$('.qualitative-insrow-' + row1 + (row2 - 2)).attr('disabled', false);
		$(obj.parentNode.parentNode).fadeOut("normal", function() {
			$(this).remove();
		});
	}

	function removeRow(obj) {
		$(obj.parentNode.parentNode).fadeOut("normal", function() {
			$(this).remove();
		});
	}

	function setTestFormatType(id, row) {
		if (id == 'qualitative') {
			$('.quantitative-input' + row).removeClass('isRequired');
			$('#qualitativeRow' + row).removeClass('hide');
			$('.qualitative-input' + row).addClass('isRequired');
			$('#quantitativeRow' + row).addClass('hide');
			$('#quantitativeWarning' + row).addClass('hide');
		} else if (id == 'quantitative') {
			$('.qualitative-input' + row).removeClass('isRequired');
			$('#quantitativeRow' + row).removeClass('hide');
			$('.quantitative-input' + row).addClass('isRequired');
			$('#qualitativeRow' + row).addClass('hide');
			$('#quantitativeWarning' + row).removeClass('hide');
		}
	}

	function resultCodeChange(obj) {
		var schemeCode = $('#schemeCode').val().toUpperCase();
		var row = $(obj).closest('tr');
		var resultType = row.find('.resultTypeInput').val();
		var currentVal = $(obj).val().toUpperCase().replace(/[^A-Z0-9]/g, '');

		// Build the result code based on result type
		// Test Result: PREFIX-T-{value}, Final Interpretation: PREFIX-F-{value}
		var typeCode = (resultType === 'test-result') ? 'T' : (resultType === 'final-interpretation') ? 'F' : '';
		var prefix = schemeCode + '-' + typeCode + '-';

		// If result type is selected, use the pattern; otherwise just use schemeCode prefix
		if (typeCode && currentVal) {
			// Remove any existing prefix pattern to get the base value
			var baseVal = currentVal.replace(new RegExp('^' + schemeCode + '-[TF]-', 'i'), '');
			$(obj).val(prefix + baseVal);
		} else if (currentVal && !currentVal.startsWith(schemeCode + '-')) {
			$(obj).val(schemeCode + '-' + currentVal);
		}
	}

	function resultTypeChange(rrow, srow) {
		var resultType = $('#resultType' + rrow + srow).val();
		if (resultType == 'test-result') {
			$('#displayContext' + rrow + srow).val('participant');
		}

		// Update the result code when result type changes
		var row = $('#resultType' + rrow + srow).closest('tr');
		var resultCodeInput = row.find('.resultCodeInput');
		if (resultCodeInput.val()) {
			resultCodeChange(resultCodeInput[0]);
		}
	}

	$(function() {
		$("#customTestkit").select2({
			placeholder: 'Please Choose Test Kit',
			minimumInputLength: 0,
			width: '100%',
			allowClear: true,
			id: function(bond) {
				return bond._id;
			},
			ajax: {
				placeholder: "Type one or more character to search",
				url: "<?php echo $this->url(array('module' => 'reports', 'controller' => 'common', 'action' => 'testkit-list'), 'default', true); ?>",
				dataType: 'json',
				delay: 250,
				data: function(params) {
					return {
						q: params.term, // search term
						page: params.page
					};
				},
				processResults: function(data, params) {
					params.page = params.page || 1;
					return {
						results: data.result,
						pagination: {
							more: (params.page * 30) < data.total_count
						}
					};
				},
				//cache: true
			},
			escapeMarkup: function(markup) {
				return markup;
			}
		});
	});
</script>