<?php

/**
 * Unified Generic/Other Tests Scheme Form
 *
 * Works for both ADD and EDIT flows by detecting mode and normalizing data.
 *
 * ADD mode variables:
 * - $this->schemeDetails['user_test_config'] - JSON config for test type
 * - $this->otherTestsPossibleResults - Possible result options
 * - $this->reportType - Optional report type (e.g., 'malawi')
 *
 * EDIT mode variables:
 * - $this->shipmentData['reference'] - Existing sample/control data
 * - $this->otherTestsPossibleResults - Possible result options
 * - $this->schemeDetails['user_test_config'] - JSON config for test type
 */

// ============================================================================
// MODE DETECTION & DATA NORMALIZATION
// ============================================================================

$isEditMode = isset($this->shipmentData) && !empty($this->shipmentData);

// Parse JSON config for test type
$jsonConfig = [];
if (isset($this->schemeDetails['user_test_config']) && !empty($this->schemeDetails['user_test_config'])) {
    $jsonConfig = Zend_Json_Decoder::decode($this->schemeDetails['user_test_config'], true);
}

// Determine if this is a quantitative test (hides final result column)
$isQuantitative = isset($jsonConfig['testType']) && !empty($jsonConfig['testType']) && $jsonConfig['testType'] == 'quantitative';

// Normalize possible results
$possibleResults = $this->otherTestsPossibleResults ?? [];

// Normalize samples/controls - in ADD mode, start with empty array (will show one empty row)
$samples = $isEditMode
    ? ($this->shipmentData['reference'] ?? [])
    : [];

// Date format helper
$vHelper = $this->getHelper('DateFormat');
$dtFormat = $vHelper->getDateFormat();
// Normalize shipment attributes for EDIT mode
$shipmentAttribute = [];
if ($isEditMode) {
    $shipmentAttribute = isset($this->shipmentData['shipment']['shipment_attributes'])
        ? json_decode($this->shipmentData['shipment']['shipment_attributes'], true)
        : [];
}
// Build possible results dropdown HTML for JavaScript row addition
$possibleResultsHtml = '<select name="finalResult[]" class="isRequired form-control input-sm" title="Please choose one" placeholder="Please choose final result for this sample"><option value="">--Select--</option>';
foreach ($possibleResults as $pr) {
    $resultCode = isset($pr['result_code']) ? $pr['result_code'] : '';
    $response = isset($pr['response']) ? $pr['response'] : '';
    $possibleResultsHtml .= '<option value="' . htmlspecialchars($resultCode) . '">' . htmlspecialchars($response) . '</option>';
}
$possibleResultsHtml .= '</select>';

// Escape for JavaScript string
$possibleResultsJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $possibleResultsHtml);
$reportVersion = isset($this->config['reportVersion']) ? $this->config['reportVersion'] : '';
?>

<?php if (!$isEditMode && isset($this->reportType) && !empty($this->reportType) && $this->reportType == 'malawi'): ?>
    <!-- Malawi-specific fields (ADD mode only) -->
    <div class="form-group">
        <label class="col-lg-3 control-label"><?= $this->translate->_("PT Co-ordinator Email"); ?></label>
        <div class="col-lg-5">
            <input type="text" name="ptEmail" id="ptEmail" placeholder="Enter PT Co-ordinator email" title="Please enter the PT Co-ordinator email" class="form-control input-sm isEmail" />
        </div>
    </div>
    <div class="form-group">
        <label class="col-lg-3 control-label"><?= $this->translate->_("PT Co-ordinator Phone Number"); ?></label>
        <div class="col-lg-5">
            <input type="text" name="ptPhone" id="ptPhone" placeholder="Enter PT Co-ordinator phone number" title="Please enter the PT Co-ordinator phone number" class="form-control input-sm isNumeric" />
        </div>
    </div>
<?php endif; ?>
<div class="form-group">
    <label class="col-lg-3 control-label" for="reportVersion"><?= $this->translate->_("Report Version"); ?></label>
    <div class="col-lg-5">
        <input type="text" name="reportVersion" id="reportVersion" placeholder="Enter the report version"
            title="Please enter the report version" class="form-control input-sm" value="<?php echo $shipmentAttribute['report_version'] ?? $reportVersion; ?>" />
    </div>
</div>
<!-- Generic Sample Table -->
<table style="width: 100%; margin: 0 auto;" border="1" class="table table-bordered table-striped clearfix" id="genericSampleTable">
    <thead>
        <tr align="center">
            <th style="width:20%;"><?= $this->translate->_("Sample ID"); ?></th>
            <th style="width:20%; text-align: center; vertical-align: middle;"><?= $this->translate->_("Sample Preparation Date"); ?></th>
            <?php if (!$isQuantitative): ?>
                <th style="width:20%;"><?= $this->translate->_("Final Result"); ?> <span class='mandatory'>*</span></th>
            <?php endif; ?>
            <th style="width:15%; text-align: center; vertical-align: middle;"><?= $this->translate->_("Is it a Control?"); ?></th>
            <th style="width:15%; text-align: center; vertical-align: middle;"><?= $this->translate->_("Mandatory?"); ?></th>
            <th style="width:5%; text-align: center; vertical-align: middle;"><?= $this->translate->_("Add/Remove Row"); ?></th>
        </tr>
    </thead>
    <tbody>
        <?php
        $counter = 1;
        if ($isEditMode && count($samples) > 0):
            // EDIT mode with existing samples
            foreach ($samples as $key => $sample):
                $sampleLabel = isset($sample['sample_label']) ? $sample['sample_label'] : '';
                $samplePrepDate = isset($sample['sample_preparation_date']) ? $this->dateFormat($sample['sample_preparation_date']) : '';
                $referenceResult = isset($sample['reference_result']) ? $sample['reference_result'] : '';
                $control = isset($sample['control']) ? $sample['control'] : '';
                $mandatory = isset($sample['mandatory']) ? $sample['mandatory'] : '';
        ?>
                <tr align="center">
                    <td style="text-align: center">
                        <input type="text" name="sampleName[]" class="isRequired input-sm form-control"
                            value="<?php echo htmlspecialchars($sampleLabel); ?>"
                            placeholder="Please enter the Sample Name" title="Please enter the Sample Name" />
                    </td>
                    <td>
                        <input type="text" name="samplePreparationDate[]" readonly="readonly"
                            class="isRequired form-control input-sm datepicker"
                            value="<?php echo htmlspecialchars($samplePrepDate); ?>"
                            placeholder="Please enter the sample preparation date"
                            title="Please enter the sample preparation date" />
                    </td>
                    <?php if (!$isQuantitative): ?>
                        <td>
                            <select name="finalResult[]" class="isRequired form-control input-sm" title="Please choose one" placeholder="Please choose final result for this sample">
                                <option value="">--Select--</option>
                                <?php foreach ($possibleResults as $pr):
                                    $resultCode = isset($pr['result_code']) ? $pr['result_code'] : '';
                                    $response = isset($pr['response']) ? $pr['response'] : '';
                                    $selected = ($resultCode == $referenceResult) ? 'selected="selected"' : '';
                                ?>
                                    <option value="<?php echo htmlspecialchars($resultCode); ?>" <?php echo $selected; ?>>
                                        <?php echo htmlspecialchars($response); ?>
                                    </option>
                                <?php endforeach; ?>
                            </select>
                        </td>
                    <?php endif; ?>
                    <td>
                        <select name="control[]" class="isRequired controlOrNot form-control input-sm"
                            title="Please choose whether this sample is a control">
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <option value="1" <?php echo ($control == 1) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Yes"); ?></option>
                            <option value="0" <?php echo ($control === '0' || $control === 0 || $control == 0) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("No"); ?></option>
                        </select>
                    </td>
                    <td>
                        <select name="mandatory[]" class="isRequired form-control input-sm"
                            title="Please choose whether this sample/control is mandatory">
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <option value="1" <?php echo ($mandatory == 1) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Yes"); ?></option>
                            <option value="0" <?php echo ($mandatory === '0' || $mandatory === 0 || $mandatory == 0) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("No"); ?></option>
                        </select>
                    </td>
                    <td>
                        <a href="javascript:void(0);" onclick="addGenericRow(this);" class="btn btn-xs btn-info">
                            <i class="icon-plus"></i>
                        </a>
                        <?php if ($counter > 1): ?>
                            <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger"
                                title="Remove this row completely">
                                <i class="icon-minus"></i>
                            </a>
                        <?php endif; ?>
                    </td>
                </tr>
            <?php
                $counter++;
            endforeach;
        else:
            // ADD mode or EDIT mode with no samples - show empty row
            ?>
            <tr align="center" class="light">
                <th>
                    <input type="text" name="sampleName[]" value="" class="isRequired form-control input-sm"
                        placeholder="Please enter the Sample Name" title="Please enter the Sample Name" />
                </th>
                <td>
                    <input type="text" name="samplePreparationDate[]" readonly="readonly"
                        class="isRequired form-control input-sm datepicker"
                        placeholder="Please enter the sample preparation date"
                        title="Please enter the sample preparation date" />
                </td>
                <?php if (!$isQuantitative): ?>
                    <td>
                        <?php echo $possibleResultsHtml; ?>
                    </td>
                <?php endif; ?>
                <td>
                    <select name="control[]" class="isRequired controlOrNot form-control input-sm"
                        title="Please choose whether this sample is a control">
                        <?php if ($isEditMode): ?>
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <option value="1"><?= $this->translate->_("Yes"); ?></option>
                            <option value="0"><?= $this->translate->_("No"); ?></option>
                        <?php else: ?>
                            <option value="1"><?= $this->translate->_("Yes"); ?></option>
                            <option value="0" selected="selected"><?= $this->translate->_("No"); ?></option>
                        <?php endif; ?>
                    </select>
                </td>
                <td>
                    <select name="mandatory[]" class="isRequired form-control input-sm"
                        title="Please choose whether this sample/control is mandatory">
                        <?php if ($isEditMode): ?>
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <option value="1"><?= $this->translate->_("Yes"); ?></option>
                            <option value="0"><?= $this->translate->_("No"); ?></option>
                        <?php else: ?>
                            <option value="1" selected="selected"><?= $this->translate->_("Yes"); ?></option>
                            <option value="0"><?= $this->translate->_("No"); ?></option>
                        <?php endif; ?>
                    </select>
                </td>
                <td>
                    <a href="javascript:void(0);" onclick="addGenericRow(this);" class="btn btn-xs btn-info">
                        <i class="icon-plus"></i>
                    </a>
                    <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger"
                        title="Remove this row completely">
                        <i class="icon-minus"></i>
                    </a>
                </td>
            </tr>
        <?php endif; ?>
    </tbody>
</table>
<br>
<div id="eiaBlockHolder">

</div>

<!-- Generic-specific JavaScript -->
<script type="text/javascript">
    var sampleCounter = $("#genericSampleTable tbody tr").length || 1;

    function addGenericRow(obj) {
        sampleCounter++;
        var html = '<tr align="center"> \
        <th> \
            <input type="text" name="sampleName[]" value="" class="isRequired form-control input-sm" \
                placeholder="Please enter the Sample Name" title="Please enter the Sample Name" /> \
        </th> \
        <td> \
            <input type="text" name="samplePreparationDate[]" readonly="readonly" \
                class="isRequired form-control input-sm datepicker" \
                placeholder="Please enter the sample preparation date" \
                title="Please enter the sample preparation date" /> \
        </td> \
        <?php if (!$isQuantitative): ?> \
        <td><?php echo $possibleResultsJs; ?></td> \
        <?php endif; ?> \
        <td> \
            <select name="control[]" class="isRequired controlOrNot form-control input-sm" \
                title="Please choose whether this sample is a control"> \
                <option value="1"><?= $this->translate->_("Yes"); ?></option> \
                <option value="0" selected="selected"><?= $this->translate->_("No"); ?></option> \
            </select> \
        </td> \
        <td> \
            <select name="mandatory[]" class="isRequired form-control input-sm" \
                title="Please choose whether this sample/control is mandatory"> \
                <option value="1" selected="selected"><?= $this->translate->_("Yes"); ?></option> \
                <option value="0"><?= $this->translate->_("No"); ?></option> \
            </select> \
        </td> \
        <td> \
            <a href="javascript:void(0);" onclick="addGenericRow(this);" class="btn btn-xs btn-info"><i class="icon-plus"></i></a> \
            &nbsp;&nbsp; \
            <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger" \
                title="Remove this row completely"><i class="icon-minus"></i></a> \
        </td> \
    </tr>';
        $(obj.parentNode.parentNode).after(html);
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    }

    $(document).ready(function() {
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    });

    function removeRow(obj) {
        $(obj.parentNode.parentNode).fadeOut("normal", function() {
            $(this).remove();
        });
    }
</script>