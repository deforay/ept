<?php
/**
 * DTS Sample Modal Sub-Partial
 *
 * This partial renders the EIA/WB/RHIV/Geenius modal for each sample in EDIT mode.
 * It is included from dts.phtml for each sample row.
 *
 * Expected variables from parent:
 * - $sampleId - The sample ID
 * - $reference - The sample reference data
 * - $eiaData - All EIA records
 * - $wbData - All WB records
 * - $rhivData - All RHIV records
 * - $geeniusData - All Geenius records
 * - $allEia, $allWb, $allRhiv, $allGeenius - Arrays of sample IDs that have data
 * - $eiaChoices, $wbChoices, $dtsKitOptions - Dropdown option HTML
 * - $testResultsOptions, $finalResultsOptions - Result dropdown options
 * - $dtFormat - Date format for datepicker
 */
?>
<div id="sampleEia<?php echo htmlspecialchars($sampleId); ?>" class="dialog" tabindex="-1" data-width="860">
    <span onClick="hidedefModal()" class="closeModal"></span>

    <!-- ========== EIA SECTION ========== -->
    <div class="modal-header">
        <h4 class="modal-title"><?= $this->translate->_("EIA"); ?></h4>
    </div>
    <div class="modal-body">
        <div class="row">
            <div>
                <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix">
                    <thead>
                        <tr align="center">
                            <th style="width:20%; text-align: center;"><?= $this->translate->_("EIA"); ?></th>
                            <th style="width:10%; text-align: center;"><?= $this->translate->_("Lot"); ?></th>
                            <th style="width:12%; text-align: center;"><?= $this->translate->_("Expiry"); ?></th>
                            <th style="width:10%; text-align: center;">OD</th>
                            <th style="width:10%; text-align: center;"><?= $this->translate->_("Cutoff"); ?></th>
                            <th style="width:10%; text-align: center;"><?= $this->translate->_("Result"); ?></th>
                            <th style="width:10%; text-align: center;"><?= $this->translate->_("Options"); ?></th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        if (in_array($sampleId, $allEia)):
                            $k = 0;
                            foreach ($eiaData as $eia):
                                if ($eia['sample_id'] == $sampleId):
                        ?>
                        <tr>
                            <td>
                                <select class="form-control" name="eia[<?php echo htmlspecialchars($sampleId); ?>][eia][]">
                                    <?php $this->dropdownSelection($this->eia, $eia['eia'], true); ?>
                                </select>
                            </td>
                            <td><input type="text" name="eia[<?php echo htmlspecialchars($sampleId); ?>][lot][]" class="form-control" value="<?php echo htmlspecialchars($eia['lot']); ?>" /></td>
                            <td><input type="text" name="eia[<?php echo htmlspecialchars($sampleId); ?>][expiry][]" class="form-control datepicker" readonly="readonly" value="<?php echo htmlspecialchars($this->dateFormat($eia['exp_date'])); ?>" /></td>
                            <td><input type="text" name="eia[<?php echo htmlspecialchars($sampleId); ?>][od][]" class="form-control" value="<?php echo htmlspecialchars($eia['od']); ?>" /></td>
                            <td><input type="text" name="eia[<?php echo htmlspecialchars($sampleId); ?>][cutoff][]" class="form-control" value="<?php echo htmlspecialchars($eia['cutoff']); ?>" /></td>
                            <td>
                                <select class="form-control" name="eia[<?php echo htmlspecialchars($sampleId); ?>][result][]">
                                    <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                    <?php foreach ($dtsPossibleResults as $pr):
                                        if ($pr['scheme_sub_group'] == 'DTS_TEST'): ?>
                                        <option value="<?php echo htmlspecialchars($pr['id']); ?>" <?php echo (isset($pr['id']) && $pr['id'] == $eia['result']) ? "selected='selected'" : ""; ?>>
                                            <?php echo htmlspecialchars($pr['response']); ?>
                                        </option>
                                    <?php endif; endforeach; ?>
                                </select>
                            </td>
                            <td>
                                <a href="javascript:void(0);" onclick="addNewEiaRow(this, <?php echo htmlspecialchars($sampleId); ?>)" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>
                                <?php if ($k > 0): ?>
                                <a href="javascript:void(0);" onclick="removeEiaRow(this)" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php
                                endif;
                                $k++;
                            endforeach;
                        else:
                        ?>
                        <tr>
                            <td><select class="form-control" name="eia[<?php echo htmlspecialchars($sampleId); ?>][eia][]"><?php echo $eiaChoices; ?></select></td>
                            <td><input type="text" name="eia[<?php echo htmlspecialchars($sampleId); ?>][lot][]" class="form-control" /></td>
                            <td><input type="text" name="eia[<?php echo htmlspecialchars($sampleId); ?>][expiry][]" class="form-control datepicker" readonly="readonly" /></td>
                            <td><input type="text" name="eia[<?php echo htmlspecialchars($sampleId); ?>][od][]" class="form-control" /></td>
                            <td><input type="text" name="eia[<?php echo htmlspecialchars($sampleId); ?>][cutoff][]" class="form-control" /></td>
                            <td>
                                <select class="form-control" name="eia[<?php echo htmlspecialchars($sampleId); ?>][result][]">
                                    <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                    <?php foreach ($dtsPossibleResults as $pr):
                                        if ($pr['scheme_sub_group'] == 'DTS_TEST'): ?>
                                        <option value="<?php echo htmlspecialchars($pr['id']); ?>"><?php echo htmlspecialchars($pr['response']); ?></option>
                                    <?php endif; endforeach; ?>
                                </select>
                            </td>
                            <td>
                                <a href="javascript:void(0);" onclick="addNewEiaRow(this, <?php echo htmlspecialchars($sampleId); ?>)" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>
                            </td>
                        </tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ========== WB (WESTERN BLOT) SECTION ========== -->
    <div class="modal-header">
        <h4 class="modal-title"><?= $this->translate->_("WB"); ?></h4>
    </div>
    <div class="modal-body">
        <div class="row" style="overflow-x:scroll;">
            <div>
                <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix">
                    <thead>
                        <tr align="center">
                            <th style="text-align: center;"><?= $this->translate->_("WB"); ?></th>
                            <th style="text-align: center;"><?= $this->translate->_("Lot"); ?></th>
                            <th style="text-align: center;"><?= $this->translate->_("Expiry"); ?></th>
                            <th style="text-align: center;">160</th>
                            <th style="text-align: center;">120</th>
                            <th style="text-align: center;">66</th>
                            <th style="text-align: center;">55</th>
                            <th style="text-align: center;">51</th>
                            <th style="text-align: center;">41</th>
                            <th style="text-align: center;">31</th>
                            <th style="text-align: center;">24</th>
                            <th style="text-align: center;">17</th>
                            <th style="text-align: center;"><?= $this->translate->_("Result"); ?></th>
                            <th style="text-align: center;"><?= $this->translate->_("Options"); ?></th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        if (in_array($sampleId, $allWb)):
                            $k = 0;
                            foreach ($wbData as $wb):
                                if ($wb['sample_id'] == $sampleId):
                        ?>
                        <tr>
                            <td><select class="form-control" name="wb[<?php echo htmlspecialchars($sampleId); ?>][wb][]" style="width:125px;"><?php $this->dropdownSelection($this->wb, $wb['wb'], true); ?></select></td>
                            <td><input type="text" name="wb[<?php echo htmlspecialchars($sampleId); ?>][lot][]" class="form-control" style="width:100px;" value="<?php echo htmlspecialchars($wb['lot']); ?>" /></td>
                            <td><input type="text" name="wb[<?php echo htmlspecialchars($sampleId); ?>][expiry][]" class="form-control datepicker" readonly="readonly" style="width:125px;" value="<?php echo htmlspecialchars($this->dateFormat($wb['exp_date'])); ?>" /></td>
                            <?php foreach (['160', '120', '66', '55', '51', '41', '31', '24', '17'] as $band): ?>
                            <td>
                                <select name="wb[<?php echo htmlspecialchars($sampleId); ?>][<?php echo $band; ?>][]" style="width:70px; font-weight:bold;" class="form-control">
                                    <option value=""></option>
                                    <option value="1" <?php echo (isset($wb[$band]) && $wb[$band] == 1) ? "selected='selected'" : ""; ?>>+</option>
                                    <option value="0" <?php echo (isset($wb[$band]) && $wb[$band] === '0') ? "selected='selected'" : ""; ?>>-</option>
                                </select>
                            </td>
                            <?php endforeach; ?>
                            <td>
                                <select class="form-control" name="wb[<?php echo htmlspecialchars($sampleId); ?>][result][]">
                                    <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                    <?php foreach ($dtsPossibleResults as $pr):
                                        if ($pr['scheme_sub_group'] == 'DTS_TEST'): ?>
                                        <option value="<?php echo htmlspecialchars($pr['id']); ?>" <?php echo (isset($pr['id']) && $pr['id'] == $wb['result']) ? "selected='selected'" : ""; ?>>
                                            <?php echo htmlspecialchars($pr['response']); ?>
                                        </option>
                                    <?php endif; endforeach; ?>
                                </select>
                            </td>
                            <td>
                                <a href="javascript:void(0);" onclick="addNewWbRow(this, <?php echo htmlspecialchars($sampleId); ?>)" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>
                                <?php if ($k > 0): ?>
                                <a href="javascript:void(0);" onclick="removeWbRow(this, '<?php echo htmlspecialchars($sampleId); ?>')" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php
                                    $k++;
                                endif;
                            endforeach;
                        else:
                        ?>
                        <tr>
                            <td><select class="form-control" name="wb[<?php echo htmlspecialchars($sampleId); ?>][wb][]" style="width:125px;"><?php echo $wbChoices; ?></select></td>
                            <td><input type="text" name="wb[<?php echo htmlspecialchars($sampleId); ?>][lot][]" class="form-control" style="width:100px;" /></td>
                            <td><input type="text" name="wb[<?php echo htmlspecialchars($sampleId); ?>][expiry][]" class="form-control datepicker" readonly="readonly" style="width:125px;" /></td>
                            <?php foreach (['160', '120', '66', '55', '51', '41', '31', '24', '17'] as $band): ?>
                            <td>
                                <select name="wb[<?php echo htmlspecialchars($sampleId); ?>][<?php echo $band; ?>][]" style="width:70px; font-weight:bold;" class="form-control">
                                    <option value=""></option>
                                    <option value="1">+</option>
                                    <option value="0">-</option>
                                </select>
                            </td>
                            <?php endforeach; ?>
                            <td>
                                <select class="form-control" name="wb[<?php echo htmlspecialchars($sampleId); ?>][result][]">
                                    <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                    <?php foreach ($dtsPossibleResults as $pr):
                                        if ($pr['scheme_sub_group'] == 'DTS_TEST'): ?>
                                        <option value="<?php echo htmlspecialchars($pr['id']); ?>"><?php echo htmlspecialchars($pr['response']); ?></option>
                                    <?php endif; endforeach; ?>
                                </select>
                            </td>
                            <td>
                                <a href="javascript:void(0);" onclick="addNewWbRow(this, <?php echo htmlspecialchars($sampleId); ?>)" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>
                            </td>
                        </tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ========== RAPID HIV TESTING SECTION ========== -->
    <div class="modal-header">
        <h4 class="modal-title"><?= $this->translate->_("RAPID HIV TESTING"); ?></h4>
    </div>
    <div class="modal-body">
        <div class="row">
            <div>
                <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix">
                    <thead>
                        <tr align="center">
                            <th style="width:20%; text-align: center;"><?= $this->translate->_("Kit Name"); ?></th>
                            <th style="width:10%; text-align: center;"><?= $this->translate->_("Lot"); ?></th>
                            <th style="width:12%; text-align: center;"><?= $this->translate->_("Expiry"); ?></th>
                            <th style="width:15%; text-align: center;"><?= $this->translate->_("Result"); ?></th>
                            <th style="width:5%; text-align: center;"><?= $this->translate->_("Options"); ?></th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        if (in_array($sampleId, $allRhiv)):
                            $k = 0;
                            foreach ($rhivData as $rhiv):
                                if ($rhiv['sample_id'] == $sampleId):
                        ?>
                        <tr>
                            <td>
                                <select class="form-control" name="rhiv[<?php echo htmlspecialchars($sampleId); ?>][kit][]">
                                    <?php $this->dropdownSelection($this->allTestKits, $rhiv['testkit'], true); ?>
                                </select>
                            </td>
                            <td><input type="text" name="rhiv[<?php echo htmlspecialchars($sampleId); ?>][lot][]" class="form-control" value="<?php echo htmlspecialchars($rhiv['lot_no']); ?>" /></td>
                            <td><input type="text" name="rhiv[<?php echo htmlspecialchars($sampleId); ?>][expiry][]" class="form-control datepicker" readonly="readonly" value="<?php echo htmlspecialchars($this->dateFormat($rhiv['expiry_date'])); ?>" /></td>
                            <td>
                                <select class="form-control" name="rhiv[<?php echo htmlspecialchars($sampleId); ?>][result][]">
                                    <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                    <?php foreach ($dtsPossibleResults as $pr):
                                        if ($pr['scheme_sub_group'] == 'DTS_TEST'): ?>
                                        <option value="<?php echo htmlspecialchars($pr['id']); ?>" <?php echo (isset($pr['id']) && $pr['id'] == $rhiv['result']) ? "selected='selected'" : ""; ?>>
                                            <?php echo htmlspecialchars($pr['response']); ?>
                                        </option>
                                    <?php endif; endforeach; ?>
                                </select>
                            </td>
                            <td>
                                <a href="javascript:void(0);" onclick="addNewHivRow(this, <?php echo htmlspecialchars($sampleId); ?>)" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>
                                <?php if ($k > 0): ?>
                                <a href="javascript:void(0);" onclick="removeHivRow(this)" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php
                                    $k++;
                                endif;
                            endforeach;
                        else:
                        ?>
                        <tr>
                            <td><select class="form-control" name="rhiv[<?php echo htmlspecialchars($sampleId); ?>][kit][]"><?php echo $dtsKitOptions; ?></select></td>
                            <td><input type="text" name="rhiv[<?php echo htmlspecialchars($sampleId); ?>][lot][]" class="form-control" /></td>
                            <td><input type="text" name="rhiv[<?php echo htmlspecialchars($sampleId); ?>][expiry][]" class="form-control datepicker" readonly="readonly" /></td>
                            <td>
                                <select class="form-control" name="rhiv[<?php echo htmlspecialchars($sampleId); ?>][result][]">
                                    <?php echo $testResultsOptions; ?>
                                </select>
                            </td>
                            <td>
                                <a href="javascript:void(0);" onclick="addNewHivRow(this, <?php echo htmlspecialchars($sampleId); ?>)" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>
                            </td>
                        </tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ========== GEENIUS HIV 1/2 SUPPLEMENTAL ASSAY SECTION ========== -->
    <div class="modal-header">
        <h4 class="modal-title"><?= $this->translate->_("GEENIUS HIV 1/2 SUPPLEMENTAL ASSAY"); ?></h4>
    </div>
    <div class="modal-body">
        <div class="row">
            <div>
                <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix">
                    <thead>
                        <tr align="center">
                            <th style="width:25%; text-align: center;"><?= $this->translate->_("Lot"); ?></th>
                            <th style="width:25%; text-align: center;"><?= $this->translate->_("Expiry"); ?></th>
                            <th style="width:25%; text-align: center;"><?= $this->translate->_("Result"); ?></th>
                            <th style="width:25%; text-align: center;"><?= $this->translate->_("Options"); ?></th>
                        </tr>
                    </thead>
                    <tbody>
                        <?php
                        if (in_array($sampleId, $allGeenius)):
                            $k = 0;
                            foreach ($geeniusData as $geenius):
                                if ($geenius['sample_id'] == $sampleId):
                        ?>
                        <tr>
                            <td><input type="text" name="geenius[<?php echo htmlspecialchars($sampleId); ?>][lot][]" class="form-control" value="<?php echo htmlspecialchars($geenius['lot_no']); ?>" /></td>
                            <td><input type="text" name="geenius[<?php echo htmlspecialchars($sampleId); ?>][expiry][]" class="form-control datepicker" readonly="readonly" value="<?php echo htmlspecialchars($this->dateFormat($geenius['expiry_date'])); ?>" /></td>
                            <td>
                                <select class="form-control" name="geenius[<?php echo htmlspecialchars($sampleId); ?>][result][]">
                                    <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                    <?php foreach ($dtsPossibleResults as $pr):
                                        if ($pr['scheme_sub_group'] == 'DTS_TEST'):
                                            $selected = ($pr['id'] == $geenius['result']) ? "selected='selected'" : "";
                                    ?>
                                        <option value="<?php echo htmlspecialchars($pr['id']); ?>" <?php echo $selected; ?>>
                                            <?php echo htmlspecialchars($pr['response']); ?>
                                        </option>
                                    <?php endif; endforeach; ?>
                                </select>
                            </td>
                            <td>
                                <a href="javascript:void(0);" onclick="addNewGeeniusRow(this, <?php echo htmlspecialchars($sampleId); ?>)" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>
                                <?php if ($k > 0): ?>
                                <a href="javascript:void(0);" onclick="removeGeeniusRow(this)" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>
                                <?php endif; ?>
                            </td>
                        </tr>
                        <?php
                                    $k++;
                                endif;
                            endforeach;
                        else:
                        ?>
                        <tr>
                            <td><input type="text" name="geenius[<?php echo htmlspecialchars($sampleId); ?>][lot][]" class="form-control" /></td>
                            <td><input type="text" name="geenius[<?php echo htmlspecialchars($sampleId); ?>][expiry][]" class="form-control datepicker" readonly="readonly" /></td>
                            <td>
                                <select class="form-control" name="geenius[<?php echo htmlspecialchars($sampleId); ?>][result][]">
                                    <?php echo $testResultsOptions; ?>
                                </select>
                            </td>
                            <td>
                                <a href="javascript:void(0);" onclick="addNewGeeniusRow(this, <?php echo htmlspecialchars($sampleId); ?>)" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>
                            </td>
                        </tr>
                        <?php endif; ?>
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- ========== MODAL FOOTER ========== -->
    <div class="modal-footer">
        <button type="button" onclick="closeShipmentModal('sampleEia<?php echo htmlspecialchars($sampleId); ?>'); return false;" class="btn btn-primary"><?= $this->translate->_("OK"); ?></button>
    </div>
</div>
