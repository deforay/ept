<?php

/**
 * Unified TB Scheme Form
 *
 * Works for both ADD and EDIT flows by detecting mode and normalizing data.
 * Supports both molecular and microscopy TB test types.
 *
 * ADD mode variables:
 * - $this->assay - Available assay options
 * - $this->tbPossibleResults - Possible result options
 * - $this->reportType - Report type configuration
 * - $this->feedbackOption - Feedback collection option
 *
 * EDIT mode variables:
 * - $this->shipmentData['reference'] - Existing sample/control data
 * - $this->shipmentData['shipment'] - Shipment details
 * - $this->tbPossibleResults - Possible result options
 */

// ============================================================================
// MODE DETECTION & DATA NORMALIZATION
// ============================================================================

$isEditMode = isset($this->shipmentData) && !empty($this->shipmentData);

// Normalize shipment attributes
$shipmentAttribute = [];
if ($isEditMode && isset($this->shipmentData['shipment']['shipment_attributes'])) {
    $shipmentAttribute = json_decode($this->shipmentData['shipment']['shipment_attributes'], true) ?? [];
}

// Normalize possible results - categorize by type
$possibleMicroscopeResults = [];
$possibleResults = [];
$tbPossibleResults = $this->tbPossibleResults ?? [];
foreach ($tbPossibleResults as $pr) {
    if ($pr['scheme_sub_group'] == 'TB_MOLECULAR_FINAL') {
        $possibleResults[$pr['result_code']] = $pr['response'];
    }
    if ($pr['scheme_sub_group'] == 'TB_MICROSCOPY_FINAL') {
        $possibleMicroscopeResults[$pr['result_code']] = $pr['response'];
    }
}

// Normalize samples/controls
$samples = $isEditMode
    ? ($this->shipmentData['reference'] ?? [])
    : [];

// Build assay options HTML
$options = "";
if (isset($this->assay) && !empty($this->assay)) {
    foreach ($this->assay as $row) {
        $options .= '<option value="' . htmlspecialchars($row['id']) . '" data-type="' . htmlspecialchars($row['assay_type']) . '" data-drug="' . htmlspecialchars($row['drug_resistance_test']) . '" data-short="' . htmlspecialchars($row['short_name']) . '">' . ucwords(htmlspecialchars($row['name'])) . '</option>';
    }
}

// Date format helper
$vHelper = $this->getHelper('DateFormat');
$dtFormat = $vHelper->getDateFormat();

// Get current TB test type for edit mode
$currentTbTestType = $shipmentAttribute['tb_test_type'] ?? '';
?>

<div class="form-group">
    <label class="col-lg-3 control-label" for="scorePerSample"><?= $this->translate->_("Score Per Sample"); ?></label>
    <div class="col-lg-5">
        <input type="number" class="form-control input-sm" name="scorePerSample" id="scorePerSample"
            placeholder="Enter the score per sample" title="Please enter the score per sample"
            value="<?php echo isset($shipmentAttribute['score_per_sample']) ? htmlspecialchars($shipmentAttribute['score_per_sample']) : ''; ?>">
    </div>
</div>

<div class="form-group">
    <label class="col-lg-3 control-label" for="formVersion"><?= $this->translate->_("Form Version"); ?></label>
    <div class="col-lg-5">
        <input type="text" class="form-control input-sm" name="formVersion" id="formVersion"
            placeholder="Enter the form version" title="Please enter form version"
            value="<?php echo isset($shipmentAttribute['form_version']) ? htmlspecialchars($shipmentAttribute['form_version']) : ''; ?>">
    </div>
</div>

<?php if (isset($this->feedbackOption) && !empty($this->feedbackOption) && $this->feedbackOption == 'yes') { ?>
    <div class="form-group">
        <label class="col-lg-3 control-label"><?= $this->translate->_("Collect Feedback"); ?></label>
        <div class="col-lg-5">
            <select name="collectFeedBack" id="collectFeedBack" class='form-control input-sm' title="Please select feedback active or inactive">
                <option value=""><?= $this->translate->_("-- Select --"); ?></option>
                <option value="yes" <?php echo ($isEditMode && isset($this->shipmentData['shipment']['collect_feedback']) && $this->shipmentData['shipment']['collect_feedback'] == 'yes') ? "selected='selected'" : ''; ?>><?= $this->translate->_("Yes"); ?></option>
                <option value="no" <?php echo ($isEditMode && isset($this->shipmentData['shipment']['collect_feedback']) && $this->shipmentData['shipment']['collect_feedback'] == 'no') ? "selected='selected'" : (!$isEditMode ? "selected='selected'" : ''); ?>><?= $this->translate->_("No"); ?></option>
            </select>
        </div>
    </div>
<?php } ?>

<div class="form-group">
    <label class="col-lg-3 control-label" for="tbTest"><?= $this->translate->_("Select Type of TB Test"); ?></label>
    <div class="col-lg-5">
        <select type="text" id="tbTest" name="tbTest" class="form-control input-sm" title="Please select the type of tb test" onchange="loadRefTable(this.value);">
            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
            <option value="molecular" <?php echo ($currentTbTestType == 'molecular') ? "selected='selected'" : ''; ?>>Molecular</option>
            <option value="microscopy" <?php echo ($currentTbTestType == 'microscopy') ? "selected='selected'" : ''; ?>>Microscopy</option>
        </select>
    </div>
</div>

<!-- Microscopy Table -->
<table style="width: <?php echo $isEditMode ? '1050px' : '100%'; ?>; margin: 0 auto;" border="1" class="hide table table-bordered table-striped reftable clearfix" id="microscopy">
    <thead>
        <tr>
            <th style="width:15%;text-align: center;vertical-align:middle;"><?= $this->translate->_("Control/Sample"); ?></th>
            <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Sample Preparation Date"); ?></th>
            <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB Detected"); ?><br /><?= $this->translate->_("(Level)"); ?></th>
            <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Is it a Control?"); ?></th>
            <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Mandatory?"); ?></th>
            <th style="width:5%;text-align: center;vertical-align:middle;"><?= $this->translate->_("Add/Remove Row"); ?></th>
        </tr>
    </thead>
    <tbody>
        <?php
        $mcounter = 1;
        if ($isEditMode && count($samples) > 0):
            foreach ($samples as $reference):
                $sampleId = $reference['sample_id'];
        ?>
                <tr align="center">
                    <td style="text-align: center">
                        <input type="text" name="sampleName[<?php echo htmlspecialchars($sampleId); ?>]"
                            id="sampleName<?php echo htmlspecialchars($sampleId); ?>"
                            class="isRequired microscopyfield input-sm form-control"
                            value="<?php echo htmlspecialchars($reference['sample_label'] ?? ''); ?>" />
                    </td>
                    <td>
                        <input type="text" name="samplePreparationDate[<?php echo htmlspecialchars($sampleId); ?>]"
                            id="samplePreparationDate<?php echo htmlspecialchars($sampleId); ?>"
                            value="<?php echo htmlspecialchars($reference['sample_preparation_date'] ?? ''); ?>"
                            readonly="readonly"
                            class="isRequired microscopyfield form-control input-sm datepicker"
                            placeholder="Please enter the sample preparation date"
                            title="Please enter the sample preparation date" />
                    </td>
                    <td>
                        <select name="mtbDetected[<?php echo htmlspecialchars($sampleId); ?>]"
                            id="mtbDetected<?php echo htmlspecialchars($sampleId); ?>"
                            class="isRequired microscopyfield form-control input-sm"
                            title="Please enter the MTB Detected for this sample"
                            placeholder="Please enter the MTB Detected for this sample">
                            <?php $this->dropdownSelection($possibleMicroscopeResults, $reference['mtb_detected'] ?? null, true); ?>
                        </select>
                    </td>
                    <td>
                        <select name="control[<?php echo htmlspecialchars($sampleId); ?>]"
                            id="control<?php echo htmlspecialchars($sampleId); ?>"
                            class="isRequired controlOrNot microscopyfield form-control input-sm"
                            title="Please choose whether this sample is a control">
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <option value="1" <?php echo (isset($reference['control']) && $reference['control'] == 1) ? "selected='selected'" : ""; ?>><?= $this->translate->_("Yes"); ?></option>
                            <option value="0" <?php echo (isset($reference['control']) && $reference['control'] == 0) ? "selected='selected'" : ""; ?>><?= $this->translate->_("No"); ?></option>
                        </select>
                    </td>
                    <td>
                        <select name="mandatory[<?php echo htmlspecialchars($sampleId); ?>]"
                            id="mandatory<?php echo htmlspecialchars($sampleId); ?>"
                            class="isRequired form-control microscopyfield input-sm"
                            title="Please choose whether this sample/control is mandatory">
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <option value="1" <?php echo (isset($reference['mandatory']) && $reference['mandatory'] == 1) ? "selected='selected'" : ""; ?>><?= $this->translate->_("Yes"); ?></option>
                            <option value="0" <?php echo (isset($reference['mandatory']) && $reference['mandatory'] == 0) ? "selected='selected'" : ""; ?>><?= $this->translate->_("No"); ?></option>
                        </select>
                    </td>
                    <td>
                        <a href="javascript:void(0);" onclick="addTbRow(this, 'microscopy');" class="btn btn-xs btn-info"><i class="icon-plus"></i></a>
                        <?php if ($mcounter > 1): ?>
                            <a href="javascript:void(0);" onclick="removeRow(this, 'microscopy')" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>
                        <?php endif; ?>
                    </td>
                </tr>
            <?php
                $mcounter++;
            endforeach;
        else:
            ?>
            <!-- Default empty row for ADD mode or when no samples exist -->
            <tr>
                <th>
                    <input type="text" name="sampleName[1]" value="" class="isRequired microscopyfield form-control input-sm" placeholder="Please enter the Sample Name" title="Please enter the Sample Name" />
                </th>
                <td>
                    <input type="text" name="samplePreparationDate[1]" readonly="readonly" class="isRequired microscopyfield form-control input-sm datepicker" placeholder="Please enter the sample preparation date" title="Please enter the sample preparation date" />
                </td>
                <td>
                    <select name="mtbDetected[1]" class="isRequired microscopyfield form-control input-sm" title="Please enter the MTB Detected for this sample" placeholder="Please enter the MTB Detected for this sample">
                        <?php $this->dropdownSelection($possibleMicroscopeResults, null, true); ?>
                    </select>
                </td>
                <td>
                    <select name="control[1]" class="isRequired microscopyfield controlOrNot form-control input-sm" title="Please choose whether this sample is a control">
                        <option value="1"><?= $this->translate->_("Yes"); ?></option>
                        <option value="0" selected='selected'><?= $this->translate->_("No"); ?></option>
                    </select>
                </td>
                <td>
                    <select name="mandatory[1]" class="isRequired microscopyfield form-control input-sm" title="Please choose whether this sample/control is mandatory">
                        <option value="1" selected='selected'><?= $this->translate->_("Yes"); ?></option>
                        <option value="0"><?= $this->translate->_("No"); ?></option>
                    </select>
                </td>
                <td>
                    <a href="javascript:void(0);" onclick="addTbRow(this, 'microscopy');" class="btn btn-xs btn-info"><i class="icon-plus"></i></a>
                    <a href="javascript:void(0);" onclick="removeRow(this, 'microscopy')" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>
                </td>
            </tr>
        <?php endif; ?>
    </tbody>
</table>

<!-- Molecular Table -->
<div style="overflow-x:scroll;" class="table-responsive">
    <table border="1" class="hide table table-bordered table-striped reftable clearfix" id="molecular" style="border: 1px solid gray;">
        <thead>
            <tr>
                <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Sample Details"); ?></th>
                <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Add/Remove Row"); ?></th>
            </tr>
        </thead>
        <tbody>
            <?php
            $counter = 1;
            if ($isEditMode && count($samples) > 0):
                foreach ($samples as $reference):
                    $sampleId = $reference['sample_id'];
            ?>
                    <tr>
                        <td>
                            <table>
                                <tr>
                                    <th colspan="13">
                                        <input type="text" value="<?php echo htmlspecialchars($reference['sample_label'] ?? ''); ?>"
                                            name="sampleName[<?php echo htmlspecialchars($sampleId); ?>]"
                                            class="isRequired molecularfield form-control input-sm"
                                            placeholder="Please enter the Sample Name"
                                            title="Please enter the Sample Name" />
                                    </th>
                                </tr>
                                <tr>
                                    <th rowspan="2" style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB/Rif"); ?></th>
                                    <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB Detected"); ?><br /><?= $this->translate->_("(Level)"); ?></th>
                                    <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Rif Resistance"); ?></th>
                                    <th style="text-align: center;vertical-align:middle;">Probe D</th>
                                    <th style="text-align: center;vertical-align:middle;">Probe C</th>
                                    <th style="text-align: center;vertical-align:middle;">Probe E</th>
                                    <th style="text-align: center;vertical-align:middle;">Probe B</th>
                                    <th style="text-align: center;vertical-align:middle;">SPC Xpert</th>
                                    <th style="text-align: center;vertical-align:middle;">Probe A</th>
                                    <th style="text-align: center;vertical-align:middle;">Probe A Mean Stability</th>
                                    <th style="text-align: center;vertical-align:middle;border-left: solid 1px gray;"><?= $this->translate->_("Sample Preparation Date"); ?></th>
                                    <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("TB Isolate"); ?></th>
                                </tr>
                                <tr>
                                    <td>
                                        <select name="mtbDetected[<?php echo htmlspecialchars($sampleId); ?>]"
                                            id="mtbDetected<?php echo ($counter + 1); ?>"
                                            class="isRequired molecularfieldChange molecularfield form-control input-sm"
                                            title="Please enter the MTB Detected for this sample"
                                            placeholder="Please enter the MTB Detected for this sample">
                                            <?php $this->dropdownSelection($possibleResults, $reference['mtb_detected'] ?? null, true); ?>
                                        </select>
                                    </td>
                                    <td>
                                        <select name="rifResistance[<?php echo htmlspecialchars($sampleId); ?>]"
                                            id="rifResistance<?php echo ($counter + 1); ?>"
                                            class="isRequired molecularfieldChange molecularfield form-control input-sm"
                                            title="Please enter the Rif Resistance for this sample"
                                            placeholder="Please enter the Rif Resistance for this sample">
                                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                            <option value="na" <?php echo (isset($reference['rif_resistance']) && $reference['rif_resistance'] == 'na') ? "selected='selected'" : ""; ?>>N/A</option>
                                            <option value="detected" <?php echo (isset($reference['rif_resistance']) && $reference['rif_resistance'] == 'detected') ? "selected='selected'" : ""; ?>>Detected</option>
                                            <option value="not-detected" <?php echo (isset($reference['rif_resistance']) && $reference['rif_resistance'] == 'not-detected') ? "selected='selected'" : ""; ?>>Not Detected</option>
                                            <option value="indeterminate" <?php echo (isset($reference['rif_resistance']) && $reference['rif_resistance'] == 'indeterminate') ? "selected='selected'" : ""; ?>>Indeterminate</option>
                                            <option value="testing-not-performed" <?php echo (isset($reference['rif_resistance']) && $reference['rif_resistance'] == 'testing-not-performed') ? "selected='selected'" : ""; ?>>Testing NOT Performed</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" value="<?php echo htmlspecialchars($reference['probe_d'] ?? ''); ?>"
                                            id="probeD<?php echo ($counter + 1); ?>"
                                            name="probeD[<?php echo htmlspecialchars($sampleId); ?>]"
                                            class="form-control input-sm oneDecimal probe1"
                                            title="Please enter the Probe D" placeholder="D" />
                                    </td>
                                    <td>
                                        <input type="text" value="<?php echo htmlspecialchars($reference['probe_c'] ?? ''); ?>"
                                            id="probeC<?php echo ($counter + 1); ?>"
                                            name="probeC[<?php echo htmlspecialchars($sampleId); ?>]"
                                            class="form-control input-sm oneDecimal probe1"
                                            title="Please enter the Probe C" placeholder="C" />
                                    </td>
                                    <td>
                                        <input type="text" value="<?php echo htmlspecialchars($reference['probe_e'] ?? ''); ?>"
                                            id="probeE<?php echo ($counter + 1); ?>"
                                            name="probeE[<?php echo htmlspecialchars($sampleId); ?>]"
                                            class="form-control input-sm oneDecimal probe1"
                                            title="Please enter the Probe E" placeholder="E" />
                                    </td>
                                    <td>
                                        <input type="text" value="<?php echo htmlspecialchars($reference['probe_b'] ?? ''); ?>"
                                            id="probeB<?php echo ($counter + 1); ?>"
                                            name="probeB[<?php echo htmlspecialchars($sampleId); ?>]"
                                            class="form-control input-sm oneDecimal probe1"
                                            title="Please enter the Probe B" placeholder="B" />
                                    </td>
                                    <td>
                                        <input type="text" value="<?php echo htmlspecialchars($reference['spc_xpert'] ?? ''); ?>"
                                            id="spcXpert<?php echo ($counter + 1); ?>"
                                            name="spcXpert[<?php echo htmlspecialchars($sampleId); ?>]"
                                            class="form-control input-sm oneDecimal"
                                            title="Please enter the SPC Xpert" placeholder="SPC Xpert" />
                                    </td>
                                    <td>
                                        <input type="text" value="<?php echo htmlspecialchars($reference['probe_a'] ?? ''); ?>"
                                            id="probeA<?php echo ($counter + 1); ?>"
                                            name="probeA[<?php echo htmlspecialchars($sampleId); ?>]"
                                            class="form-control input-sm oneDecimal input-probeA1"
                                            title="Please enter the Probe A" placeholder="A" />
                                    </td>
                                    <td>
                                        <input type="text" value="<?php echo htmlspecialchars($reference['mtbrif_probe_a_mean_stability_ct'] ?? ''); ?>"
                                            name="probeAMean[<?php echo htmlspecialchars($sampleId); ?>]"
                                            id="probeAMean<?php echo ($counter + 1); ?>"
                                            class="form-control input-sm oneDecimal input-probeAMean<?php echo ($counter + 1); ?>"
                                            title="Please enter the Probe A Mean" placeholder="A Mean" />
                                    </td>
                                    <td style="border-left: solid 1px gray;">
                                        <input type="text" value="<?php echo htmlspecialchars($reference['sample_preparation_date'] ?? ''); ?>"
                                            id="sample1PreparationDate<?php echo ($counter + 1); ?>"
                                            name="samplePreparationDate[<?php echo htmlspecialchars($sampleId); ?>]"
                                            readonly="readonly"
                                            class="isRequired molecularfield form-control input-sm datepicker"
                                            placeholder="Please enter the sample preparation date"
                                            title="Please enter the sample preparation date" />
                                    </td>
                                    <td>
                                        <input type="text" value="<?php echo htmlspecialchars($reference['tb_isolate'] ?? ''); ?>"
                                            id="tbIsolate<?php echo ($counter + 1); ?>"
                                            name="tbIsolate[<?php echo htmlspecialchars($sampleId); ?>]"
                                            class="form-control input-sm" placeholder="Isolate"
                                            title="Please enter the TB Isolate" />
                                    </td>
                                </tr>
                                <tr>
                                    <th rowspan="2" style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB Ultra"); ?></th>
                                    <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB Detected"); ?><br /><?= $this->translate->_("(Level)"); ?></th>
                                    <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Rif Resistance"); ?></th>
                                    <th style="text-align: center;vertical-align:middle;">IS1081-IS6110</th>
                                    <th style="text-align: center;vertical-align:middle;">rpoB1</th>
                                    <th style="text-align: center;vertical-align:middle;">rpoB2</th>
                                    <th style="text-align: center;vertical-align:middle;">rpoB3</th>
                                    <th style="text-align: center;vertical-align:middle;">rpoB4</th>
                                    <th style="text-align: center;vertical-align:middle;">SPC Xpert Ultra</th>
                                    <th style="text-align: center;vertical-align:middle;">Lowerst rpoB Mean Stabillity</th>
                                    <th style="text-align: center;vertical-align:middle;border-left: solid 1px gray;"><?= $this->translate->_("Is it a Control?"); ?></th>
                                    <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Mandatory?"); ?></th>
                                </tr>
                                <tr>
                                    <td>
                                        <select id="mtbDetectedUltra<?php echo ($counter + 1); ?>"
                                            name="mtbDetectedUltra[<?php echo htmlspecialchars($sampleId); ?>]"
                                            class="isRequired molecularfield form-control input-sm"
                                            title="Please enter the MTB Detected for this sample"
                                            placeholder="Please enter the MTB Detected for this sample">
                                            <?php $this->dropdownSelection($possibleResults, $reference['mtb_detected_ultra'] ?? null, true); ?>
                                        </select>
                                    </td>
                                    <td>
                                        <select id="rifResistanceUltra<?php echo ($counter + 1); ?>"
                                            name="rifResistanceUltra[<?php echo htmlspecialchars($sampleId); ?>]"
                                            class="isRequired molecularfield form-control input-sm"
                                            title="Please enter the Rif Resistance for this sample"
                                            placeholder="Please enter the Rif Resistance for this sample">
                                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                            <option value="na" <?php echo (isset($reference['rif_resistance_ultra']) && $reference['rif_resistance_ultra'] == 'na') ? "selected='selected'" : ""; ?>>N/A</option>
                                            <option value="detected" <?php echo (isset($reference['rif_resistance_ultra']) && $reference['rif_resistance_ultra'] == 'detected') ? "selected='selected'" : ""; ?>>Detected</option>
                                            <option value="not-detected" <?php echo (isset($reference['rif_resistance_ultra']) && $reference['rif_resistance_ultra'] == 'not-detected') ? "selected='selected'" : ""; ?>>Not Detected</option>
                                            <option value="indeterminate" <?php echo (isset($reference['rif_resistance_ultra']) && $reference['rif_resistance_ultra'] == 'indeterminate') ? "selected='selected'" : ""; ?>>Indeterminate</option>
                                            <option value="testing-not-performed" <?php echo (isset($reference['rif_resistance_ultra']) && $reference['rif_resistance_ultra'] == 'testing-not-performed') ? "selected='selected'" : ""; ?>>Testing NOT Performed</option>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="number" value="<?php echo htmlspecialchars($reference['is1081_is6110'] ?? ''); ?>"
                                            step="0.01" id="ISI<?php echo ($counter + 1); ?>"
                                            name="ISI[<?php echo htmlspecialchars($sampleId); ?>]"
                                            placeholder="IS1081-IS6110" class="form-control oneDecimal input-sm"
                                            title="Please enter the IS1081-IS6110" />
                                    </td>
                                    <td>
                                        <input type="number" value="<?php echo htmlspecialchars($reference['rpo_b1'] ?? ''); ?>"
                                            step="0.01" id="rpoB1<?php echo ($counter + 1); ?>"
                                            name="rpoB1[<?php echo htmlspecialchars($sampleId); ?>]"
                                            placeholder="rpoB1" class="form-control oneDecimal input-sm"
                                            title="Please enter the B1" />
                                    </td>
                                    <td>
                                        <input type="number" value="<?php echo htmlspecialchars($reference['rpo_b2'] ?? ''); ?>"
                                            step="0.01" id="rpoB2<?php echo ($counter + 1); ?>"
                                            name="rpoB2[<?php echo htmlspecialchars($sampleId); ?>]"
                                            placeholder="rpoB2" class="form-control oneDecimal input-sm"
                                            title="Please enter the B2" />
                                    </td>
                                    <td>
                                        <input type="number" value="<?php echo htmlspecialchars($reference['rpo_b3'] ?? ''); ?>"
                                            step="0.01" id="rpoB3<?php echo ($counter + 1); ?>"
                                            name="rpoB3[<?php echo htmlspecialchars($sampleId); ?>]"
                                            placeholder="rpoB3" class="form-control oneDecimal input-sm"
                                            title="Please enter the B3" />
                                    </td>
                                    <td>
                                        <input type="number" value="<?php echo htmlspecialchars($reference['rpo_b4'] ?? ''); ?>"
                                            step="0.01" id="rpoB4<?php echo ($counter + 1); ?>"
                                            name="rpoB4[<?php echo htmlspecialchars($sampleId); ?>]"
                                            placeholder="rpoB4" class="form-control oneDecimal input-sm"
                                            title="Please enter the B4" />
                                    </td>
                                    <td>
                                        <input type="text" value="<?php echo htmlspecialchars($reference['spc_xpert_ultra'] ?? ''); ?>"
                                            id="spcXpertUltra<?php echo ($counter + 1); ?>"
                                            name="spcXpertUltra[<?php echo htmlspecialchars($sampleId); ?>]"
                                            class="form-control input-sm oneDecimal"
                                            title="Please enter the SPC Xpert Ultra" placeholder="SPC Xpert Ultra" />
                                    </td>
                                    <td>
                                        <input type="text" value="<?php echo htmlspecialchars($reference['mtbultra_lowest_rpo_b_probe_mean_stability_ct'] ?? ''); ?>"
                                            name="LowerstrpoBMean[<?php echo htmlspecialchars($sampleId); ?>]"
                                            id="LowerstrpoBMean<?php echo ($counter + 1); ?>"
                                            class="form-control input-sm oneDecimal input-LowerstrpoBMean<?php echo ($counter + 1); ?>"
                                            title="Please enter the Lowerst rpoB Mean" placeholder="Lowerst rpoB Mean" />
                                    </td>
                                    <td style="border-left: solid 1px gray;">
                                        <select name="control[<?php echo htmlspecialchars($sampleId); ?>]"
                                            id="control<?php echo ($counter + 1); ?>"
                                            class="isRequired molecularfield controlOrNot form-control input-sm"
                                            title="Please choose whether this sample is a control">
                                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                            <option value="1" <?php echo (isset($reference['control']) && $reference['control'] == 1) ? "selected='selected'" : ""; ?>><?= $this->translate->_("Yes"); ?></option>
                                            <option value="0" <?php echo (isset($reference['control']) && $reference['control'] == 0) ? "selected='selected'" : ""; ?>><?= $this->translate->_("No"); ?></option>
                                        </select>
                                    </td>
                                    <td>
                                        <select name="mandatory[<?php echo htmlspecialchars($sampleId); ?>]"
                                            id="mandatory<?php echo ($counter + 1); ?>"
                                            class="isRequired molecularfield form-control input-sm"
                                            title="Please choose whether this sample/control is mandatory">
                                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                            <option value="1" <?php echo (isset($reference['mandatory']) && $reference['mandatory'] == 1) ? "selected='selected'" : ""; ?>><?= $this->translate->_("Yes"); ?></option>
                                            <option value="0" <?php echo (isset($reference['mandatory']) && $reference['mandatory'] == 0) ? "selected='selected'" : ""; ?>><?= $this->translate->_("No"); ?></option>
                                        </select>
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td style="vertical-align: middle; text-align:center;">
                            <a href="javascript:void(0);" onclick="addTbRow(this, 'molecular');" class="btn btn-xs btn-info"><i class="icon-plus"></i></a>
                            <?php if ($counter > 1): ?>
                                <a href="javascript:void(0);" onclick="removeRow(this, 'molecular')" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>
                            <?php endif; ?>
                        </td>
                    </tr>
                <?php
                    $counter++;
                endforeach;
            else:
                ?>
                <!-- Default empty row for ADD mode or when no samples exist -->
                <tr>
                    <td>
                        <table>
                            <tr>
                                <th colspan="13"><input type="text" id="sampleName1" name="sampleName[1]" value="" class="isRequired molecularfield form-control input-sm" placeholder="Please enter the Sample Name" title="Please enter the Sample Name" /></th>
                            </tr>
                            <tr>
                                <th rowspan="2" style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB/Rif"); ?></th>
                                <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB Detected"); ?><br /><?= $this->translate->_("(Level)"); ?></th>
                                <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Rif Resistance"); ?></th>
                                <th style="text-align: center;vertical-align:middle;">Probe D</th>
                                <th style="text-align: center;vertical-align:middle;">Probe C</th>
                                <th style="text-align: center;vertical-align:middle;">Probe E</th>
                                <th style="text-align: center;vertical-align:middle;">Probe B</th>
                                <th style="text-align: center;vertical-align:middle;">SPC Xpert</th>
                                <th style="text-align: center;vertical-align:middle;">Probe A</th>
                                <th style="text-align: center;vertical-align:middle;">Probe A Mean Stability</th>
                                <th style="text-align: center;vertical-align:middle;border-left: solid 1px gray;"><?= $this->translate->_("Sample Preparation Date"); ?></th>
                                <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("TB Isolate"); ?></th>
                            </tr>
                            <tr>
                                <td>
                                    <select name="mtbDetected[1]" id="mtbDetected1" class="isRequired molecularfieldChange molecularfield form-control input-sm" title="Please enter the MTB Detected for this sample" placeholder="Please enter the MTB Detected for this sample">
                                        <?php $this->dropdownSelection($possibleResults, null, true); ?>
                                    </select>
                                </td>
                                <td>
                                    <select name="rifResistance[1]" id="rifResistance1" class="isRequired molecularfieldChange molecularfield form-control input-sm" title="Please enter the Rif Resistance for this sample" placeholder="Please enter the Rif Resistance for this sample">
                                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                        <option value="na">N/A</option>
                                        <option value="detected">Detected</option>
                                        <option value="not-detected">Not Detected</option>
                                        <option value="indeterminate">Indeterminate</option>
                                        <option value="testing-not-performed">Testing NOT Performed</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="text" name="probeD[1]" id="probeD1" class="form-control input-sm oneDecimal probe1" title="Please enter the Probe D" placeholder="D" />
                                </td>
                                <td>
                                    <input type="text" name="probeC[1]" id="probeC1" class="form-control input-sm oneDecimal probe1" title="Please enter the Probe C" placeholder="C" />
                                </td>
                                <td>
                                    <input type="text" name="probeE[1]" id="probeE1" class="form-control input-sm oneDecimal probe1" title="Please enter the Probe E" placeholder="E" />
                                </td>
                                <td>
                                    <input type="text" name="probeB[1]" id="probeB1" class="form-control input-sm oneDecimal probe1" title="Please enter the Probe B" placeholder="B" />
                                </td>
                                <td>
                                    <input type="text" name="spcXpert[1]" id="spcXpert1" class="form-control input-sm oneDecimal" title="Please enter the SPC Xpert" placeholder="SPC Xpert" />
                                </td>
                                <td>
                                    <input type="text" name="probeA[1]" id="probeA1" class="form-control input-sm oneDecimal input-probeA1" title="Please enter the Probe A" placeholder="A" />
                                </td>
                                <td>
                                    <input type="text" name="probeAMean[1]" id="probeAMean1" class="form-control input-sm oneDecimal input-probeAMean1" title="Please enter the Probe A Mean" placeholder="A Mean" />
                                </td>
                                <td style=" border-left: solid 1px gray; "><input type="text" name="samplePreparationDate[1]" id="samplePreparationDate1" readonly="readonly" class="isRequired molecularfield form-control input-sm datepicker" placeholder="Please enter the sample preparation date" title="Please enter the sample preparation date" /></td>
                                <td><input type="text" name="tbIsolate[1]" id="tbIsolate1" class="form-control input-sm" placeholder="Isolate" title="Please enter the TB Isolate" /></td>
                            </tr>
                            <tr>
                                <th rowspan="2" style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB Ultra"); ?></th>
                                <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB Detected"); ?><br /><?= $this->translate->_("(Level)"); ?></th>
                                <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Rif Resistance"); ?></th>
                                <th style="text-align: center;vertical-align:middle;">IS1081-IS6110</th>
                                <th style="text-align: center;vertical-align:middle;">rpoB1</th>
                                <th style="text-align: center;vertical-align:middle;">rpoB2</th>
                                <th style="text-align: center;vertical-align:middle;">rpoB3</th>
                                <th style="text-align: center;vertical-align:middle;">rpoB4</th>
                                <th style="text-align: center;vertical-align:middle;">SPC Xpert Ultra</th>
                                <th style="text-align: center;vertical-align:middle;">Lowerst rpoB Mean Stabillity</th>
                                <th style="text-align: center;vertical-align:middle;border-left: solid 1px gray;"><?= $this->translate->_("Is it a Control?"); ?></th>
                                <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Mandatory?"); ?></th>
                            </tr>
                            <tr>
                                <td>
                                    <select name="mtbDetectedUltra[1]" id="mtbDetectedUltra1" class="isRequired molecularfieldUpdate molecularfield form-control input-sm" title="Please enter the MTB Detected for this sample" placeholder="Please enter the MTB Detected for this sample">
                                        <?php $this->dropdownSelection($possibleResults, null, true); ?>
                                    </select>
                                </td>
                                <td>
                                    <select name="rifResistanceUltra[1]" id="rifResistanceUltra1" class="isRequired molecularfieldUpdate molecularfield form-control input-sm" title="Please enter the Rif Resistance for this sample" placeholder="Please enter the Rif Resistance for this sample">
                                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                        <option value="na">N/A</option>
                                        <option value="detected">Detected</option>
                                        <option value="not-detected">Not Detected</option>
                                        <option value="indeterminate">Indeterminate</option>
                                        <option value="testing-not-performed">Testing NOT Performed</option>
                                    </select>
                                </td>
                                <td>
                                    <input type="number" step="0.01" name="ISI[1]" id="ISI1" placeholder="IS1081-IS6110" class="form-control oneDecimal input-sm" title="Please enter the IS1081-IS6110" />
                                </td>
                                <td>
                                    <input type="number" step="0.01" name="rpoB1[1]" id="rpoB11" placeholder="rpoB1" class="form-control oneDecimal input-sm" title="Please enter the B1" />
                                </td>
                                <td>
                                    <input type="number" step="0.01" name="rpoB2[1]" id="rpoB21" placeholder="rpoB2" class="form-control oneDecimal input-sm" title="Please enter the B2" />
                                </td>
                                <td>
                                    <input type="number" step="0.01" name="rpoB3[1]" id="rpoB31" placeholder="rpoB3" class="form-control oneDecimal input-sm" title="Please enter the B3" />
                                </td>
                                <td>
                                    <input type="number" step="0.01" name="rpoB4[1]" id="rpoB41" placeholder="rpoB4" class="form-control oneDecimal input-sm" title="Please enter the B4" />
                                </td>
                                <td>
                                    <input type="text" name="spcXpertUltra[1]" id="spcXpertUltra1" class="form-control input-sm oneDecimal" title="Please enter the SPC Xpert Ultra" placeholder="SPC Xpert Ultra" />
                                </td>
                                <td>
                                    <input type="text" name="LowerstrpoBMean[1]" id="LowerstrpoBMean1" class="form-control input-sm oneDecimal input-LowerstrpoBMean1" title="Please enter the Lowerst rpoB Mean" placeholder="Lowerst rpoB Mean" />
                                </td>
                                <td style=" border-left: solid 1px gray; ">
                                    <select name="control[1]" id="control1" class="isRequired molecularfield controlOrNot form-control input-sm" title="Please choose whether this sample is a control">
                                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                        <option value="1"><?= $this->translate->_("Yes"); ?></option>
                                        <option value="0"><?= $this->translate->_("No"); ?></option>
                                    </select>
                                </td>
                                <td>
                                    <select name="mandatory[1]" id="mandatory1" class="isRequired molecularfield form-control input-sm" title="Please choose whether this sample/control is mandatory">
                                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                        <option value="1"><?= $this->translate->_("Yes"); ?></option>
                                        <option value="0"><?= $this->translate->_("No"); ?></option>
                                    </select>
                                </td>
                            </tr>
                        </table>
                    </td>
                    <td style=" vertical-align: middle; text-align:center; ">
                        <a href="javascript:void(0);" onclick="addTbRow(this, 'molecular');" class="btn btn-xs btn-info"><i class="icon-plus"></i></a>
                        <a href="javascript:void(0);" onclick="removeRow(this, 'molecular')" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>
                    </td>
                </tr>
            <?php endif; ?>
        </tbody>
    </table>
</div>
<br>

<!-- TB-specific JavaScript -->
<script type="text/javascript">
    <?php if ($isEditMode): ?>
        $(function() {
            let _tbTestType = '<?php echo htmlspecialchars($currentTbTestType); ?>';
            if (_tbTestType != '') {
                loadRefTable(_tbTestType);
            }
        });
    <?php endif; ?>

    var sampleCounter = <?php echo $isEditMode ? max(count($samples), 1) + 1 : 1; ?>;

    function loadRefTable(type) {
        if (type == 'microscopy') {
            sampleCounter = ($("#microscopy tbody tr").length + 1);
            $('#molecular').addClass('hide');
            $('#microscopy').removeClass('hide');
            $('.molecularfield').removeClass('isRequired');
            $('.molecularfield').prop('disabled', true);
            $('.microscopyfield').prop('disabled', false);
            <?php if ($isEditMode && isset($shipmentAttribute['tb_test_type']) && $shipmentAttribute['tb_test_type'] != 'molecular'): ?>
                $('.molecularfield').val('');
            <?php endif; ?>
        } else {
            sampleCounter = ($("#molecular tbody tr").length + 1);
            $('#microscopy').addClass('hide');
            $('#molecular').removeClass('hide');
            $('.molecularfield').prop('disabled', false);
            $('.microscopyfield').removeClass('isRequired');
            $('.microscopyfield').prop('disabled', true);
            <?php if ($isEditMode && isset($shipmentAttribute['tb_test_type']) && $shipmentAttribute['tb_test_type'] != 'microscopy'): ?>
                $('.microscopyfield').val('');
            <?php endif; ?>
        }
    }

    function loadOtherAssay(obj, row) {
        let _short = $(obj).find(':selected').data('short');
        if (_short == 'xpert-mtb-rif-ultra') {
            $(".input-ISI" + row + ",.rpoB" + row).show();
            $(".probe" + row + ",.probeA" + row).hide();
            $(".probHD").text("rpoB1");
            $(".probHC").text("rpoB2");
            $(".probHE").text("rpoB3");
            $(".probHB").text("rpoB4");
        } else {
            $(".input-ISI" + row + ",.rpoB" + row).hide();
            $(".probe" + row + ",.probeA" + row).show();
        }
        if (_short == 'other') {
            $('.other-assay-' + row).show();
            $('.other-assay-' + row).addClass('isRequired');
        } else {
            $('.other-assay-' + row).hide();
            $('.other-assay-' + row).removeClass('isRequired');
        }
    }

    function addTbRow(obj, type) {
        sampleCounter++;
        if (type == 'microscopy') {
            var html = '<tr> \
            <th> \
                <input type="text" name="sampleName[' + sampleCounter + ']" id="sampleName' + sampleCounter + '" value="" class="isRequired microscopyfield form-control input-sm" placeholder="Please enter the Sample Name" title="Please enter the Sample Name" /> \
            </th> \
            <td>\
                <input type="text" id="samplePreparationDate' + sampleCounter + '" name="samplePreparationDate[' + sampleCounter + ']" readonly="readonly" class="isRequired microscopyfield form-control input-sm datepicker" placeholder="Please enter the sample preparation date" title="Please enter the sample preparation date" />\
            </td>\
            <td> \
                <select name="mtbDetected[' + sampleCounter + ']" id="mtbDetected' + sampleCounter + '" class="isRequired form-control microscopyfield input-sm"  title="Please enter the MTB Detected for this sample" placeholder="Please enter the MTB Detected for this sample"> \
                <?php $this->dropdownSelection($possibleMicroscopeResults, null, true); ?>\
                </select> \
            </td> \
            <td> \
                <select name="control[' + sampleCounter + ']" id="control' + sampleCounter + '" class="isRequired controlOrNot microscopyfield form-control input-sm" title="Please choose whether this sample is a control"> \
                    <option value="">--Select--</option> \
                    <option value="1">Yes</option> \
                    <option value="0">No</option> \
                </select> \
            </td> \
            <td> \
                <select name="mandatory[' + sampleCounter + ']" id="mandatory' + sampleCounter + '" class="isRequired form-control microscopyfield input-sm" title="Please choose whether this sample/control is mandatory"> \
                    <option value="">--Select--</option> \
                    <option value="1">Yes</option> \
                    <option value="0">No</option> \
                </select> \
            </td> \
            <td><a href="javascript:void(0);" onclick="addTbRow(this, \'microscopy\');" class="btn btn-xs btn-info"><i class="icon-plus"></i></a>&nbsp;&nbsp;<a  href="javascript:void(0);" onclick="removeRow(this, \'microscopy\')" class="btn btn-xs btn-danger"  title="Remove this row completely" alt="Remove this row completely"><i class="icon-minus"></i></a></td> \
        </tr>'
        }
        if (type == 'molecular') {
            var html = '<tr>\
        <td>\
            <table>\
                <tr>\
                    <th colspan="13"><input type="text" name="sampleName[' + sampleCounter + ']" id="sampleName' + sampleCounter + '" value="" class="isRequired molecularfield form-control input-sm" placeholder="Please enter the Sample Name" title="Please enter the Sample Name" /></th>\
                </tr>\
                <tr>\
                    <th rowspan="2" style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB/Rif"); ?></th>\
                    <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB Detected"); ?><br /><?= $this->translate->_("(Level)"); ?></th>\
                    <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Rif Resistance"); ?></th>\
                    <th style="text-align: center;vertical-align:middle;">Probe D</th>\
                    <th style="text-align: center;vertical-align:middle;">Probe C</th>\
                    <th style="text-align: center;vertical-align:middle;">Probe E</th>\
                    <th style="text-align: center;vertical-align:middle;">Probe B</th>\
                    <th style="text-align: center;vertical-align:middle;">SPC Xpert</th>\
                    <th style="text-align: center;vertical-align:middle;">Probe A</th>\
                    <th style="text-align: center;vertical-align:middle;">Probe A Mean Stability</th>\
                    <th style="text-align: center;vertical-align:middle;border-left: solid 1px gray;"><?= $this->translate->_("Sample Preparation Date"); ?></th>\
                    <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("TB Isolate"); ?></th>\
                </tr>\
                <tr>\
                    <td>\
                        <select name="mtbDetected[' + sampleCounter + ']" id="mtbDetected' + sampleCounter + '" class="isRequired molecularfieldChange molecularfield form-control input-sm" title="Please enter the MTB Detected for this sample" placeholder="Please enter the MTB Detected for this sample">\
                        <?php $this->dropdownSelection($possibleResults, null, true); ?>\
                        </select>\
                    </td>\
                    <td>\
                        <select name="rifResistance[' + sampleCounter + ']" id="rifResistance' + sampleCounter + '" class="isRequired molecularfieldChange molecularfield form-control input-sm" title="Please enter the Rif Resistance for this sample" placeholder="Please enter the Rif Resistance for this sample">\
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>\
                            <option value="na">N/A</option>\
                            <option value="detected">Detected</option>\
                            <option value="not-detected">Not Detected</option>\
                            <option value="indeterminate">Indeterminate</option>\
                            <option value="testing-not-performed">Testing NOT Performed</option>\
                        </select>\
                    </td>\
                    <td>\
                        <input type="text" name="probeD[' + sampleCounter + ']" id="probeD' + sampleCounter + '" class="form-control input-sm oneDecimal probe1" title="Please enter the Probe D" placeholder="D" />\
                    </td>\
                    <td>\
                        <input type="text" name="probeC[' + sampleCounter + ']" id="probeC' + sampleCounter + '" class="form-control input-sm oneDecimal probe1" title="Please enter the Probe C" placeholder="C" />\
                    </td>\
                    <td>\
                        <input type="text" name="probeE[' + sampleCounter + ']" id="probeE' + sampleCounter + '" class="form-control input-sm oneDecimal probe1" title="Please enter the Probe E" placeholder="E" />\
                    </td>\
                    <td>\
                        <input type="text" name="probeB[' + sampleCounter + ']" id="probeB' + sampleCounter + '" class="form-control input-sm oneDecimal probe1" title="Please enter the Probe B" placeholder="B" />\
                    </td>\
                    <td>\
                        <input type="text" name="spcXpert[' + sampleCounter + ']" id="spcXpert' + sampleCounter + '" class="form-control input-sm oneDecimal" title="Please enter the SPC Xpert" placeholder="SPC Xpert" />\
                    </td>\
                    <td>\
                        <input type="text" name="probeA[' + sampleCounter + ']" id="probeA' + sampleCounter + '" class="form-control input-sm oneDecimal input-probeA' + sampleCounter + '" title="Please enter the Probe A" placeholder="A" />\
                    </td>\
                    <td>\
                        <input type="text" name="probeAMean[' + sampleCounter + ']" id="probeAMean' + sampleCounter + '" class="form-control input-sm oneDecimal input-probeAMean' + sampleCounter + '" title="Please enter the Probe A Mean" placeholder="A Mean" />\
                    </td>\
                    <td style=" border-left: solid 1px gray; "><input type="text" id="samplePreparationDate' + sampleCounter + '" name="samplePreparationDate[' + sampleCounter + ']" readonly="readonly" class="isRequired molecularfield form-control input-sm datepicker" placeholder="Please enter the sample preparation date" title="Please enter the sample preparation date" /></td>\
                    <td><input type="text" name="tbIsolate[' + sampleCounter + ']" id="tbIsolate' + sampleCounter + '" class="form-control input-sm" placeholder="Isolate" title="Please enter the TB Isolate" /></td>\
                </tr>\
                <tr>\
                    <th rowspan="2" style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB Ultra"); ?></th>\
                    <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("MTB Detected"); ?><br /><?= $this->translate->_("(Level)"); ?></th>\
                    <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Rif Resistance"); ?></th>\
                    <th style="text-align: center;vertical-align:middle;">IS1081-IS6110</th>\
                    <th style="text-align: center;vertical-align:middle;">rpoB1</th>\
                    <th style="text-align: center;vertical-align:middle;">rpoB2</th>\
                    <th style="text-align: center;vertical-align:middle;">rpoB3</th>\
                    <th style="text-align: center;vertical-align:middle;">rpoB4</th>\
                    <th style="text-align: center;vertical-align:middle;">SPC Xpert Ultra</th>\
                    <th style="text-align: center;vertical-align:middle;">Lowerst rpoB Mean Stabillity</th>\
                    <th style="text-align: center;vertical-align:middle;border-left: solid 1px gray;"><?= $this->translate->_("Is it a Control?"); ?></th>\
                    <th style="text-align: center;vertical-align:middle;"><?= $this->translate->_("Mandatory?"); ?></th>\
                </tr>\
                <tr>\
                    <td>\
                        <select name="mtbDetectedUltra[' + sampleCounter + ']" id="mtbDetectedUltra' + sampleCounter + '" class="isRequired molecularfieldUpdate molecularfield form-control input-sm" title="Please enter the MTB Detected for this sample" placeholder="Please enter the MTB Detected for this sample">\
                        <?php $this->dropdownSelection($possibleResults, null, true); ?>\
                        </select>\
                    </td>\
                    <td>\
                        <select name="rifResistanceUltra[' + sampleCounter + ']" id="rifResistanceUltra' + sampleCounter + '" class="isRequired molecularfieldUpdate molecularfield form-control input-sm" title="Please enter the Rif Resistance for this sample" placeholder="Please enter the Rif Resistance for this sample">\
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>\
                            <option value="na">N/A</option>\
                            <option value="detected">Detected</option>\
                            <option value="not-detected">Not Detected</option>\
                            <option value="indeterminate">Indeterminate</option>\
                            <option value="testing-not-performed">Testing NOT Performed</option>\
                        </select>\
                    </td>\
                    <td>\
                        <input type="number" step="0.01" name="ISI[' + sampleCounter + ']" id="ISI' + sampleCounter + '" placeholder="IS1081-IS6110" class="form-control oneDecimal input-sm" title="Please enter the IS1081-IS6110" />\
                    </td>\
                    <td>\
                        <input type="number" step="0.01" name="rpoB1[' + sampleCounter + ']" id="rpoB1' + sampleCounter + '" placeholder="rpoB1" class="form-control oneDecimal input-sm" title="Please enter the B1" />\
                    </td>\
                    <td>\
                        <input type="number" step="0.01" name="rpoB2[' + sampleCounter + ']" id="rpoB2' + sampleCounter + '" placeholder="rpoB2" class="form-control oneDecimal input-sm" title="Please enter the B2" />\
                    </td>\
                    <td>\
                        <input type="number" step="0.01" name="rpoB3[' + sampleCounter + ']" id="rpoB3' + sampleCounter + '" placeholder="rpoB3" class="form-control oneDecimal input-sm" title="Please enter the B3" />\
                    </td>\
                    <td>\
                        <input type="number" step="0.01" name="rpoB4[' + sampleCounter + ']" id="rpoB4' + sampleCounter + '" placeholder="rpoB4" class="form-control oneDecimal input-sm" title="Please enter the B4" />\
                    </td>\
                    <td>\
                        <input type="text" name="spcXpertUltra[' + sampleCounter + ']" id="spcXpertUltra' + sampleCounter + '" class="form-control input-sm oneDecimal" title="Please enter the SPC Xpert Ultra" placeholder="SPC Xpert Ultra" />\
                    </td>\
                    <td>\
                        <input type="text" name="LowerstrpoBMean[' + sampleCounter + ']" id="LowerstrpoBMean' + sampleCounter + '" class="form-control input-sm oneDecimal input-LowerstrpoBMean' + sampleCounter + '" title="Please enter the Lowerst rpoB Mean" placeholder="Lowerst rpoB Mean" />\
                    </td>\
                    <td style=" border-left: solid 1px gray; ">\
                        <select name="control[' + sampleCounter + ']" id="control' + sampleCounter + '" class="isRequired molecularfield controlOrNot form-control input-sm" title="Please choose whether this sample is a control">\
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>\
                            <option value="1"><?= $this->translate->_("Yes"); ?></option>\
                            <option value="0"><?= $this->translate->_("No"); ?></option>\
                        </select>\
                    </td>\
                    <td>\
                        <select name="mandatory[' + sampleCounter + ']" id="mandatory' + sampleCounter + '" class="isRequired molecularfield form-control input-sm" title="Please choose whether this sample/control is mandatory">\
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>\
                            <option value="1"><?= $this->translate->_("Yes"); ?></option>\
                            <option value="0"><?= $this->translate->_("No"); ?></option>\
                        </select>\
                    </td>\
                </tr>\
            </table>\
        </td>\
        <td style=" vertical-align: middle; text-align:center; "><a href="javascript:void(0);" onclick="addTbRow(this, \'molecular\');" class="btn btn-xs btn-info"><i class="icon-plus"></i></a>&nbsp;&nbsp;<a  href="javascript:void(0);" onclick="removeRow(this, \'molecular\')" class="btn btn-xs btn-danger"  title="Remove this row completely" alt="Remove this row completely"><i class="icon-minus"></i></a></td> \
    </tr>'
        }
        $(obj.parentNode.parentNode).after(html);
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
        $('.molecularfieldChange').change(function() {
            // Dynamically get row number
            const _name = $(this).attr('name');
            const _id = this.id;
            const unmatched = [..._id].filter(char => !_name.includes(char));
            let uniqueId = unmatched.join("");
            if (_name == 'mtbDetected[]' && this.value != '') {
                $('#mtbDetectedUltra' + uniqueId).val(this.value);
            } else if (this.value) {
                $('#rifResistanceUltra' + uniqueId).val(this.value);
            }
        });
    }

    $(document).ready(function() {
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });

        $('.molecularfieldChange').change(function() {
            // Dynamically get row number
            const _name = $(this).attr('name');
            const _id = this.id;
            const unmatched = [..._id].filter(char => !_name.includes(char));
            let uniqueId = unmatched.join("");
            if (_name == 'mtbDetected[]' && this.value != '') {
                $('#mtbDetectedUltra' + uniqueId).val(this.value);
            } else if (this.value) {
                $('#rifResistanceUltra' + uniqueId).val(this.value);
            }
        });
    });

    function removeRow(obj) {
        $(obj.parentNode.parentNode).fadeOut("normal", function() {
            $(this).remove();
        });
    }
</script>