<?php
/**
 * Unified Recency Scheme Form
 *
 * Works for both ADD and EDIT flows by detecting mode and normalizing data.
 *
 * ADD mode variables:
 * - $this->recencyAssay - Available assay options
 * - $this->recencyPossibleResults - Possible result options
 *
 * EDIT mode variables:
 * - $this->shipmentData['reference'] - Existing sample/control data
 * - $this->shipmentData['possibleResults'] - Possible result options
 * - $this->shipmentData['recencyAssay'] - Existing assay data
 * - $this->recencyAssay - Available assay options
 * - $this->recencyPossibleResults - Possible result options
 */

// ============================================================================
// MODE DETECTION & DATA NORMALIZATION
// ============================================================================

$isEditMode = isset($this->shipmentData) && !empty($this->shipmentData);

// Normalize assay choices
$recencyAssayOptions = $this->recencyAssay ?? [];

// Normalize possible results - filter for RECENCY_FINAL
$possibleResultsRaw = $isEditMode
    ? ($this->shipmentData['possibleResults'] ?? $this->recencyPossibleResults ?? [])
    : ($this->recencyPossibleResults ?? []);

// Build filtered possible results for RECENCY_FINAL
$possibleResults = [];
foreach ($possibleResultsRaw as $pr) {
    if (isset($pr['scheme_sub_group']) && $pr['scheme_sub_group'] == 'RECENCY_FINAL') {
        $possibleResults[] = $pr;
    } elseif (!isset($pr['scheme_sub_group'])) {
        // In edit mode, shipmentData['possibleResults'] may already be filtered
        $possibleResults[] = $pr;
    }
}

// Normalize samples/controls
$samples = $isEditMode
    ? ($this->shipmentData['reference'] ?? [])
    : [];

// Get existing recency assay data for edit mode
$recencyAssayData = $isEditMode ? ($this->shipmentData['recencyAssay'] ?? []) : [];
$allRecencyAssaySampleIds = [];
foreach ($recencyAssayData as $assay) {
    $allRecencyAssaySampleIds[] = $assay['sample_id'];
}

// Date format helper
$vHelper = $this->getHelper('DateFormat');
$dtFormat = $vHelper->getDateFormat();

// Build assay choices dropdown HTML for JavaScript
$assayChoicesHtml = '<option value="">--' . $this->translate->_("Select") . '--</option>';
foreach ($recencyAssayOptions as $assayId => $assayName) {
    $assayChoicesHtml .= '<option value="' . htmlspecialchars($assayId) . '">' . htmlspecialchars($assayName) . '</option>';
}
$assayChoicesJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $assayChoicesHtml);

// Build possible results dropdown HTML for JavaScript row addition
$possibleResultsHtml = '<select name="possibleResults[]" class="isRequired form-control input-sm"><option value="">--' . $this->translate->_("Select") . '--</option>';
foreach ($possibleResults as $pr) {
    $possibleResultsHtml .= '<option value="' . htmlspecialchars($pr['id']) . '">' . htmlspecialchars($pr['response']) . '</option>';
}
$possibleResultsHtml .= '</select>';

// Escape for JavaScript string
$possibleResultsJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $possibleResultsHtml);

// Build test results dropdown HTML for JavaScript (assay modals)
$testResultsHtml = '<option value="">--' . $this->translate->_("Select") . '--</option>';
foreach ($possibleResults as $pr) {
    $testResultsHtml .= '<option value="' . htmlspecialchars($pr['id']) . '">' . htmlspecialchars($pr['response']) . '</option>';
}
$testResultsJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $testResultsHtml);
?>

<!-- Recency Sample Table -->
<table style="width: 100%; margin: 0 auto;" border="1" class="table table-bordered table-striped clearfix" id="vlSampleTable">
    <thead>
        <tr align="center">
            <th style="width:20%; text-align: center;"><?= $this->translate->_("Control/Sample"); ?></th>
            <th style="text-align: center; vertical-align: middle;"><?= $this->translate->_("Sample Preparation Date"); ?></th>
            <th style="width:22%; text-align: center;"><?= $this->translate->_("Final Result"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Control Line"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Verification Line"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Longterm Line"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Control?"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Mandatory?"); ?></th>
            <th style="width:13%; text-align: center;"><?= $this->translate->_("Add/Remove Row"); ?></th>
        </tr>
    </thead>
    <tbody>
        <?php if ($isEditMode && !empty($samples)): ?>
            <?php
            $counter = 1;
            foreach ($samples as $sample):
                // EDIT mode: data comes from shipmentData['reference']
                $sampleId = $sample['sample_id'] ?? $counter;
                $sampleLabel = $sample['sample_label'] ?? '';
                $samplePrepDate = isset($sample['sample_preparation_date']) ? $this->dateFormat($sample['sample_preparation_date']) : '';
                $referenceResult = $sample['reference_result'] ?? '';
                $controlLine = $sample['reference_control_line'] ?? '';
                $verificationLine = $sample['reference_diagnosis_line'] ?? '';
                $longtermLine = $sample['reference_longterm_line'] ?? '';
                $control = $sample['control'] ?? '';
                $mandatory = $sample['mandatory'] ?? '';
            ?>
            <tr align="center">
                <td style="text-align: center">
                    <input type="text" name="sampleName[]" class="isRequired input-sm form-control"
                        value="<?php echo htmlspecialchars($sampleLabel); ?>"
                        title="Please enter sample name here" placeholder="Please enter sample name here" />
                </td>
                <td>
                    <input type="text" name="samplePreparationDate[]" readonly="readonly"
                        class="isRequired form-control input-sm datepicker"
                        value="<?php echo htmlspecialchars($samplePrepDate); ?>"
                        placeholder="Please enter the sample preparation date"
                        title="Please enter the sample preparation date" />
                </td>
                <td>
                    <select name="possibleResults[]" class="isRequired form-control input-sm">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <?php foreach ($possibleResults as $pr): ?>
                        <option value="<?php echo htmlspecialchars($pr['id']); ?>"
                            <?php echo ($referenceResult == $pr['id']) ? 'selected="selected"' : ''; ?>>
                            <?php echo htmlspecialchars($pr['response']); ?>
                        </option>
                        <?php endforeach; ?>
                    </select>
                </td>
                <td>
                    <select name="controlLine[]" class="isRequired form-control input-sm" title="Please choose control line">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <option value="present" <?php echo ($controlLine == "present") ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Present"); ?></option>
                        <option value="absent" <?php echo ($controlLine == "absent") ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Absent"); ?></option>
                    </select>
                </td>
                <td>
                    <select name="verificationLine[]" class="isRequired form-control input-sm" title="Please choose verification line">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <option value="present" <?php echo ($verificationLine == "present") ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Present"); ?></option>
                        <option value="absent" <?php echo ($verificationLine == "absent") ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Absent"); ?></option>
                    </select>
                </td>
                <td>
                    <select name="longtermLine[]" class="isRequired form-control input-sm" title="Please choose Longterm line">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <option value="present" <?php echo ($longtermLine == "present") ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Present"); ?></option>
                        <option value="absent" <?php echo ($longtermLine == "absent") ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Absent"); ?></option>
                    </select>
                </td>
                <td>
                    <select name="control[]" class="isRequired controlOrNot form-control input-sm"
                        title="Please choose whether this sample is a control">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <option value="1" <?php echo ($control == 1) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Yes"); ?></option>
                        <option value="0" <?php echo ($control === '0' || $control === 0) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("No"); ?></option>
                    </select>
                </td>
                <td>
                    <select name="mandatory[]" class="isRequired form-control input-sm"
                        title="Please choose whether this sample/control is mandatory">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <option value="1" <?php echo ($mandatory == 1) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Yes"); ?></option>
                        <option value="0" <?php echo ($mandatory === '0' || $mandatory === 0) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("No"); ?></option>
                    </select>
                </td>
                <td>
                    <a href="javascript:void(0);" class="btn btn-xs btn-primary"
                        onclick="showdefModal('sampleAssay<?php echo htmlspecialchars($sampleId); ?>', 900, 600);loadCal();">
                        <i class="icon-beaker"></i> <?= $this->translate->_("Ref. Results"); ?>
                    </a>
                    <a href="javascript:void(0);" onclick="addRecencyRow(this);" class="btn btn-xs btn-info">
                        <i class="icon-plus"></i>
                    </a>
                    <?php if ($counter > 1): ?>
                    <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger"
                        title="Remove this row completely">
                        <i class="icon-minus"></i>
                    </a>
                    <?php endif; ?>
                </td>
            </tr>
            <?php
                $counter++;
            endforeach;
            ?>
        <?php else: ?>
            <!-- ADD mode: empty row -->
            <tr align="center">
                <td style="text-align: center">
                    <input type="text" name="sampleName[]" class="isRequired input-sm form-control"
                        title="Please enter sample name here" placeholder="Please enter sample name here" />
                </td>
                <td>
                    <input type="text" name="samplePreparationDate[]" readonly="readonly"
                        class="isRequired form-control input-sm datepicker"
                        placeholder="Please enter the sample preparation date"
                        title="Please enter the sample preparation date" />
                </td>
                <td>
                    <?php echo $possibleResultsHtml; ?>
                </td>
                <td>
                    <select name="controlLine[]" class="isRequired form-control input-sm" title="Please choose control line">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <option value="present"><?= $this->translate->_("Present"); ?></option>
                        <option value="absent"><?= $this->translate->_("Absent"); ?></option>
                    </select>
                </td>
                <td>
                    <select name="verificationLine[]" class="isRequired form-control input-sm" title="Please choose verification line">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <option value="present"><?= $this->translate->_("Present"); ?></option>
                        <option value="absent"><?= $this->translate->_("Absent"); ?></option>
                    </select>
                </td>
                <td>
                    <select name="longtermLine[]" class="isRequired form-control input-sm" title="Please choose Longterm line">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <option value="present"><?= $this->translate->_("Present"); ?></option>
                        <option value="absent"><?= $this->translate->_("Absent"); ?></option>
                    </select>
                </td>
                <td>
                    <select name="control[]" class="isRequired controlOrNot form-control input-sm"
                        title="Please choose whether this sample is a control">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <option value="1"><?= $this->translate->_("Yes"); ?></option>
                        <option value="0"><?= $this->translate->_("No"); ?></option>
                    </select>
                </td>
                <td>
                    <select name="mandatory[]" class="isRequired form-control input-sm"
                        title="Please choose whether this sample/control is mandatory">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <option value="1"><?= $this->translate->_("Yes"); ?></option>
                        <option value="0"><?= $this->translate->_("No"); ?></option>
                    </select>
                </td>
                <td>
                    <a href="javascript:void(0);" class="btn btn-xs btn-primary"
                        onclick="showdefModal('sampleAssay1', 900, 600);loadCal();">
                        <i class="icon-beaker"></i> <?= $this->translate->_("Ref. Results"); ?>
                    </a>
                    <a href="javascript:void(0);" onclick="addRecencyRow(this);" class="btn btn-xs btn-info">
                        <i class="icon-plus"></i>
                    </a>
                    <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger"
                        title="Remove this row completely">
                        <i class="icon-minus"></i>
                    </a>
                </td>
            </tr>
        <?php endif; ?>
    </tbody>
</table>
<br>

<!-- Recency Assay Block Holder and Modals -->
<?php if ($isEditMode && !empty($samples)): ?>
    <?php foreach ($samples as $sample):
        $sampleId = $sample['sample_id'] ?? '';
    ?>
    <div id="recencyAssayBlockHolder">
        <div id="sampleAssay<?php echo htmlspecialchars($sampleId); ?>" class="dialog">
            <span onClick="hidedefModal()" class="closeModal"></span>
            <div class="modal-header">
                <h4 class="modal-title"><?= $this->translate->_("Assay"); ?></h4>
            </div>
            <div class="modal-body">
                <div class="row">
                    <div>
                        <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix">
                            <thead>
                                <tr align="center">
                                    <th style="width:20%; text-align: center;"><?= $this->translate->_("Recency Assay"); ?></th>
                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Lot"); ?></th>
                                    <th style="width:12%; text-align: center;"><?= $this->translate->_("Expiry"); ?></th>
                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Result"); ?></th>
                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Options"); ?></th>
                                </tr>
                            </thead>
                            <tbody>
                                <?php if (in_array($sampleId, $allRecencyAssaySampleIds)):
                                    $k = 0;
                                    foreach ($recencyAssayData as $recencyAssay):
                                        if ($recencyAssay['sample_id'] == $sampleId):
                                            // Build selected results dropdown
                                            $testSelectedResults = '<option value="">--' . $this->translate->_("Select") . '--</option>';
                                            foreach ($this->recencyPossibleResults as $pr) {
                                                if ($pr['scheme_sub_group'] == 'RECENCY_FINAL') {
                                                    $selected = ($pr['id'] == $recencyAssay['result']) ? "selected='selected'" : "";
                                                    $testSelectedResults .= '<option value="' . htmlspecialchars($pr['id']) . '" ' . $selected . '>' . htmlspecialchars($pr['response']) . '</option>';
                                                }
                                            }
                                ?>
                                <tr>
                                    <td>
                                        <select class="form-control" name="assay[<?php echo htmlspecialchars($sampleId); ?>][assay][]">
                                            <?php $this->dropdownSelection($this->recencyAssay, $recencyAssay['assay'], true); ?>
                                        </select>
                                    </td>
                                    <td>
                                        <input type="text" name="assay[<?php echo htmlspecialchars($recencyAssay['sample_id']); ?>][lot][]"
                                            class="form-control" value="<?php echo htmlspecialchars($recencyAssay['lot_no']); ?>" />
                                    </td>
                                    <td>
                                        <input type="text" name="assay[<?php echo htmlspecialchars($recencyAssay['sample_id']); ?>][expiry][]"
                                            class="form-control datepicker" readonly="readonly"
                                            value="<?php echo htmlspecialchars($this->dateFormat($recencyAssay['expiry_date'])); ?>" />
                                    </td>
                                    <td>
                                        <select class="form-control" name="assay[<?php echo htmlspecialchars($recencyAssay['sample_id']); ?>][result][]">
                                            <?php echo $testSelectedResults; ?>
                                        </select>
                                    </td>
                                    <td>
                                        <a href="javascript:void(0);" onclick="addNewAssayRow(this, <?php echo htmlspecialchars($recencyAssay['sample_id']); ?>)"
                                            class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>
                                        <?php if ($k > 0): ?>
                                        <a href="javascript:void(0);" onclick="removeAssayRow(this, '<?php echo htmlspecialchars($recencyAssay['sample_id']); ?>')"
                                            class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>
                                        <?php endif; ?>
                                    </td>
                                </tr>
                                <?php
                                            $k++;
                                        endif;
                                    endforeach;
                                else: ?>
                                <tr>
                                    <td>
                                        <select class="form-control" name="assay[<?php echo htmlspecialchars($sampleId); ?>][assay][]">
                                            <?php echo $assayChoicesHtml; ?>
                                        </select>
                                    </td>
                                    <td><input type="text" name="assay[<?php echo htmlspecialchars($sampleId); ?>][lot][]" class="form-control" /></td>
                                    <td><input type="text" name="assay[<?php echo htmlspecialchars($sampleId); ?>][expiry][]" class="form-control datepicker" readonly="readonly" /></td>
                                    <td>
                                        <select class="form-control" name="assay[<?php echo htmlspecialchars($sampleId); ?>][result][]">
                                            <option value="">--<?= $this->translate->_("Select"); ?>--</option>
                                            <?php echo $testResultsHtml; ?>
                                        </select>
                                    </td>
                                    <td>
                                        <a href="javascript:void(0);" onclick="addNewAssayRow(this, <?php echo htmlspecialchars($sampleId); ?>)"
                                            class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>
                                    </td>
                                </tr>
                                <?php endif; ?>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary"
                    onclick="closeShipmentModal('sampleAssay<?php echo htmlspecialchars($sampleId); ?>')"><?= $this->translate->_("OK"); ?></button>
            </div>
        </div>
    </div> <!-- recencyAssayBlockHolder -->
    <?php endforeach; ?>
<?php else: ?>
    <div id="recencyAssayBlockHolder">
    </div> <!-- recencyAssayBlockHolder -->
<?php endif; ?>

<!-- Recency-specific JavaScript -->
<script type="text/javascript">
var sampleCounter = <?php echo ($isEditMode && !empty($samples)) ? count($samples) : 1; ?>;

function addRecencyRow(obj) {
    sampleCounter++;
    $(obj.parentNode.parentNode).after('<tr align="center"> \
        <td style="text-align: center"> \
            <input type="text" name="sampleName[]" class="isRequired input-sm form-control" \
                title="Please enter sample name here" placeholder="Please enter sample name here"/> \
        </td> \
        <td> \
            <input type="text" name="samplePreparationDate[]" readonly="readonly" \
                class="isRequired form-control input-sm datepicker" \
                placeholder="Please enter the sample preparation date" \
                title="Please enter the sample preparation date" /> \
        </td> \
        <td><?php echo $possibleResultsJs; ?></td> \
        <td> \
            <select name="controlLine[]" class="isRequired form-control input-sm" title="Please choose control line"> \
                <option value="">-- <?= $this->translate->_("Select"); ?> --</option> \
                <option value="present"><?= $this->translate->_("Present"); ?></option> \
                <option value="absent"><?= $this->translate->_("Absent"); ?></option> \
            </select> \
        </td> \
        <td> \
            <select name="verificationLine[]" class="isRequired form-control input-sm" title="Please choose verification line"> \
                <option value="">-- <?= $this->translate->_("Select"); ?> --</option> \
                <option value="present"><?= $this->translate->_("Present"); ?></option> \
                <option value="absent"><?= $this->translate->_("Absent"); ?></option> \
            </select> \
        </td> \
        <td> \
            <select name="longtermLine[]" class="isRequired form-control input-sm" title="Please choose Longterm line"> \
                <option value="">-- <?= $this->translate->_("Select"); ?> --</option> \
                <option value="present"><?= $this->translate->_("Present"); ?></option> \
                <option value="absent"><?= $this->translate->_("Absent"); ?></option> \
            </select> \
        </td> \
        <td> \
            <select name="control[]" class="isRequired controlOrNot form-control input-sm" \
                title="Please choose whether this sample is a control"> \
                <option value="1"><?= $this->translate->_("Yes"); ?></option> \
                <option value="0" selected="selected"><?= $this->translate->_("No"); ?></option> \
            </select> \
        </td> \
        <td> \
            <select name="mandatory[]" class="isRequired form-control input-sm" \
                title="Please choose whether this sample/control is mandatory"> \
                <option value="1" selected="selected"><?= $this->translate->_("Yes"); ?></option> \
                <option value="0"><?= $this->translate->_("No"); ?></option> \
            </select> \
        </td> \
        <td> \
            <a href="javascript:void(0);" class="btn btn-xs btn-primary" \
                onclick="showdefModal(\'sampleAssay\' + sampleCounter, 900, 600);loadCal();"> \
                <i class="icon-beaker"></i> <?= $this->translate->_("Ref. Results"); ?> \
            </a> \
            <a href="javascript:void(0);" onclick="addRecencyRow(this);" class="btn btn-xs btn-info"><i class="icon-plus"></i></a> \
            <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger" \
                title="Remove this row completely"><i class="icon-minus"></i></a> \
        </td> \
    </tr>');

    // Reinitialize datepickers for new row
    $(".datepicker").datepicker({
        dateFormat: '<?php echo $dtFormat; ?>'
    });

    addNewAssayBlock(sampleCounter);
}

function removeRow(obj) {
    $(obj.parentNode.parentNode).fadeOut("normal", function() {
        $(this).remove();
    });
}

function addNewAssayBlock(sampleId) {
    $("#recencyAssayBlockHolder").after('<div id="sampleAssay' + sampleId + '" class="dialog"> \
        <span onClick="hidedefModal()" class="closeModal"></span> \
        <div class="modal-header"> \
            <h4 class="modal-title"><?= $this->translate->_("Assay"); ?></h4> \
        </div> \
        <div class="modal-body"> \
            <div class="row"> \
                <div> \
                    <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix"> \
                        <thead> \
                            <tr align="center"> \
                                <th style="width:20%; text-align: center;"><?= $this->translate->_("Recency Assay"); ?></th> \
                                <th style="width:10%; text-align: center;"><?= $this->translate->_("Lot"); ?></th> \
                                <th style="width:12%; text-align: center;"><?= $this->translate->_("Expiry"); ?></th> \
                                <th style="width:10%; text-align: center;"><?= $this->translate->_("Result"); ?></th> \
                                <th style="width:10%; text-align: center;"><?= $this->translate->_("Options"); ?></th> \
                            </tr> \
                        </thead> \
                        <tbody> \
                            <tr> \
                                <td><select class="form-control" name="assay[' + sampleId + '][assay][]"><?php echo $assayChoicesJs; ?></select></td> \
                                <td><input type="text" name="assay[' + sampleId + '][lot][]" class="form-control"/></td> \
                                <td><input type="text" name="assay[' + sampleId + '][expiry][]" class="form-control datepicker" readonly="readonly"/></td> \
                                <td><select class="form-control" name="assay[' + sampleId + '][result][]"><?php echo $testResultsJs; ?></select></td> \
                                <td> \
                                    <a href="javascript:void(0);" onclick="addNewAssayRow(this,' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a> \
                                </td> \
                            </tr> \
                        </tbody> \
                    </table> \
                </div> \
            </div> \
        </div> \
        <div class="modal-footer"> \
            <button type="button" class="btn btn-primary" onclick="closeShipmentModal(\'sampleAssay' + sampleId + '\')"><?= $this->translate->_("OK"); ?></button> \
        </div> \
    </div>');

    $(".datepicker").datepicker({
        dateFormat: '<?php echo $dtFormat; ?>'
    });
}

function addNewAssayRow(obj, sampleId) {
    $(obj.parentNode.parentNode).after('<tr> \
        <td><select class="form-control" name="assay[' + sampleId + '][assay][]"><?php echo $assayChoicesJs; ?></select></td> \
        <td><input type="text" name="assay[' + sampleId + '][lot][]" class="form-control"/></td> \
        <td><input type="text" name="assay[' + sampleId + '][expiry][]" class="form-control datepicker" readonly="readonly"/></td> \
        <td><select class="form-control" name="assay[' + sampleId + '][result][]"><?php echo $testResultsJs; ?></select></td> \
        <td> \
            <a href="javascript:void(0);" onclick="addNewAssayRow(this,' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a> \
            <a href="javascript:void(0);" onclick="removeAssayRow(this)" class="btn btn-xs btn-danger" \
                title="Remove this row completely"><i class="icon-minus"></i></a> \
        </td> \
    </tr>');

    $(".datepicker").datepicker({
        dateFormat: '<?php echo $dtFormat; ?>'
    });
}

function removeAssayRow(obj) {
    $(obj.parentNode.parentNode).fadeOut("normal", function() {
        $(this).remove();
    });
}

$(document).ready(function() {
    <?php if (!$isEditMode || empty($samples)): ?>
    addNewAssayBlock('1');
    <?php endif; ?>

    $(".datepicker").datepicker({
        dateFormat: '<?php echo $dtFormat; ?>'
    });
});

function loadCal() {
    $(".datepicker").removeClass("hasDatepicker");
    $(".datepicker").datepicker({
        dateFormat: '<?php echo $dtFormat; ?>'
    });
}

function closeShipmentModal(divId) {
    var mbdEl = document.getElementById("mbd");
    var targetEl = document.getElementById(divId);
    if (mbdEl && targetEl) {
        targetEl.textContent = '';
        var clone = mbdEl.cloneNode(true);
        while (clone.firstChild) {
            targetEl.appendChild(clone.firstChild);
        }
    }

    $("#mbd input:text").each(function(i, obj) {
        $("#" + divId + " input:text:eq(" + i + ")").val($(this).val());
    });
    $("#mbd select").each(function(i, obj) {
        $("#" + divId + " select:eq(" + i + ")").val($(this).val());
    });

    hidedefModal();
}
</script>
