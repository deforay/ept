<?php

/**
 * Unified EID Scheme Form
 *
 * Works for both ADD and EDIT flows by detecting mode and normalizing data.
 *
 * ADD mode variables:
 * - $this->eidControls - Default controls from scheme configuration
 * - $this->eidPossibleResults - Possible result options
 *
 * EDIT mode variables:
 * - $this->shipmentData['reference'] - Existing sample/control data
 * - $this->shipmentData['possibleResults'] - Possible result options
 */

// ============================================================================
// MODE DETECTION & DATA NORMALIZATION
// ============================================================================

$isEditMode = isset($this->shipmentData) && !empty($this->shipmentData);

// Normalize possible results
$possibleResults = $isEditMode
    ? $this->shipmentData['possibleResults']
    : ($this->eidPossibleResults ?? []);

// Normalize samples/controls
$samples = $isEditMode
    ? $this->shipmentData['reference']
    : ($this->eidControls ?? []);

// Date format helper
$vHelper = $this->getHelper('DateFormat');
$dtFormat = $vHelper->getDateFormat();

// Build possible results dropdown HTML for JavaScript row addition
$possibleResultsHtml = '<select name="possibleResults[]" class="isRequired form-control input-sm"><option value="">--' . $this->translate->_("Select") . '--</option>';
foreach ($possibleResults as $pr) {
    $possibleResultsHtml .= '<option value="' . htmlspecialchars($pr['id']) . '">' . htmlspecialchars($pr['response']) . '</option>';
}
$possibleResultsHtml .= '</select>';

// Escape for JavaScript string
$possibleResultsJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $possibleResultsHtml);
?>

<!-- EID Sample Table -->
<table style="width: 100%; margin: 0 auto;" border="1" class="table table-bordered table-striped clearfix" id="vlSampleTable">
    <thead>
        <tr align="center">
            <th style="width:20%; text-align: center;"><?= $this->translate->_("Control/Sample"); ?></th>
            <th style="text-align: center; vertical-align: middle;"><?= $this->translate->_("Sample Preparation Date"); ?></th>
            <th style="width:22%; text-align: center;"><?= $this->translate->_("Results"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("HIV CT/OD"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("IC/QS Values"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Control?"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Mandatory?"); ?></th>
            <th style="width:13%; text-align: center;"><?= $this->translate->_("Add/Remove Row"); ?></th>
        </tr>
    </thead>
    <tbody>
        <?php
        $counter = 1;
        foreach ($samples as $sample):
            // Normalize sample data between ADD and EDIT modes
            if ($isEditMode) {
                // EDIT mode: data comes from shipmentData['reference']
                $sampleLabel = $sample['sample_label'] ?? '';
                $samplePrepDate = isset($sample['sample_preparation_date']) ? $this->dateFormat($sample['sample_preparation_date']) : '';
                $referenceResult = $sample['reference_result'] ?? '';
                $hivCtOd = $sample['reference_hiv_ct_od'] ?? '';
                $icQs = $sample['reference_ic_qs'] ?? '';
                $control = $sample['control'] ?? '';
                $mandatory = $sample['mandatory'] ?? '';
            } else {
                // ADD mode: data comes from eidControls (scheme defaults)
                $sampleLabel = $sample['control_name'] ?? '';
                $samplePrepDate = '';
                $referenceResult = '';
                $hivCtOd = '';
                $icQs = '';
                $control = '';
                $mandatory = '';
            }
        ?>
            <tr align="center">
                <td style="text-align: center">
                    <input type="text" name="sampleName[]" class="isRequired input-sm form-control"
                        value="<?php echo htmlspecialchars($sampleLabel); ?>"
                        title="Please enter sample name here" placeholder="Please enter sample name here" />
                </td>
                <td>
                    <input type="text" name="samplePreparationDate[]" readonly="readonly"
                        class="isRequired form-control input-sm datepicker"
                        value="<?php echo htmlspecialchars($samplePrepDate); ?>"
                        placeholder="Please enter the sample preparation date"
                        title="Please enter the sample preparation date" />
                </td>
                <td>
                    <select name="possibleResults[]" class="isRequired form-control input-sm">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <?php foreach ($possibleResults as $pr): ?>
                            <option value="<?php echo htmlspecialchars($pr['id']); ?>"
                                <?php echo ($referenceResult == $pr['id']) ? 'selected="selected"' : ''; ?>>
                                <?php echo htmlspecialchars($pr['response']); ?>
                            </option>
                        <?php endforeach; ?>
                    </select>
                </td>
                <td>
                    <input type="text" name="hivCtOd[]" class="isRequired form-control input-sm"
                        placeholder="HIV CT/OD" title="Please enter the HIV CT/OD values here"
                        value="<?php echo htmlspecialchars($hivCtOd); ?>" />
                </td>
                <td>
                    <input type="text" name="icQs[]" class="isRequired form-control input-sm"
                        placeholder="IC/QS" title="Please enter the IC/QS Values here"
                        value="<?php echo htmlspecialchars($icQs); ?>" />
                </td>
                <td>
                    <select name="control[]" class="isRequired controlOrNot form-control input-sm"
                        title="Please choose whether this sample is a control">
                        <?php if ($isEditMode): ?>
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <option value="1" <?php echo ($control == 1) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Yes"); ?></option>
                            <option value="0" <?php echo ($control === '0' || $control === 0) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("No"); ?></option>
                        <?php else: ?>
                            <option value="1"><?= $this->translate->_("Yes"); ?></option>
                            <option value="0" selected="selected"><?= $this->translate->_("No"); ?></option>
                        <?php endif; ?>
                    </select>
                </td>
                <td>
                    <select name="mandatory[]" class="isRequired form-control input-sm"
                        title="Please choose whether this sample/control is mandatory">
                        <?php if ($isEditMode): ?>
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <option value="1" <?php echo ($mandatory == 1) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Yes"); ?></option>
                            <option value="0" <?php echo ($mandatory === '0' || $mandatory === 0) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("No"); ?></option>
                        <?php else: ?>
                            <option value="1" selected="selected"><?= $this->translate->_("Yes"); ?></option>
                            <option value="0"><?= $this->translate->_("No"); ?></option>
                        <?php endif; ?>
                    </select>
                </td>
                <td>
                    <a href="javascript:void(0);" onclick="addEidRow(this);" class="btn btn-xs btn-info">
                        <i class="icon-plus"></i>
                    </a>
                    <?php if ($counter > 1): ?>
                        <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger"
                            title="Remove this row completely">
                            <i class="icon-minus"></i>
                        </a>
                    <?php endif; ?>
                </td>
            </tr>
        <?php
            $counter++;
        endforeach;
        ?>

        <?php if (!$isEditMode): ?>
            <!-- Extra empty row for ADD mode -->
            <tr align="center">
                <td style="text-align: center">
                    <input type="text" name="sampleName[]" class="isRequired input-sm form-control"
                        title="Please enter sample name here" placeholder="Please enter sample name here" />
                </td>
                <td>
                    <input type="text" name="samplePreparationDate[]" readonly="readonly"
                        class="isRequired form-control input-sm datepicker"
                        placeholder="Please enter the sample preparation date"
                        title="Please enter the sample preparation date" />
                </td>
                <td>
                    <?php echo $possibleResultsHtml; ?>
                </td>
                <td>
                    <input type="text" name="hivCtOd[]" class="isRequired form-control input-sm"
                        placeholder="HIV CT/OD" title="Please enter the HIV CT/OD values here" />
                </td>
                <td>
                    <input type="text" name="icQs[]" class="isRequired form-control input-sm"
                        placeholder="IC/QS" title="Please enter the IC/QS Values here" />
                </td>
                <td>
                    <select name="control[]" class="isRequired controlOrNot form-control input-sm"
                        title="Please choose whether this sample is a control">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <option value="1"><?= $this->translate->_("Yes"); ?></option>
                        <option value="0"><?= $this->translate->_("No"); ?></option>
                    </select>
                </td>
                <td>
                    <select name="mandatory[]" class="isRequired form-control input-sm"
                        title="Please choose whether this sample/control is mandatory">
                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                        <option value="1"><?= $this->translate->_("Yes"); ?></option>
                        <option value="0"><?= $this->translate->_("No"); ?></option>
                    </select>
                </td>
                <td>
                    <a href="javascript:void(0);" onclick="addEidRow(this);" class="btn btn-xs btn-info">
                        <i class="icon-plus"></i>
                    </a>
                </td>
            </tr>
        <?php endif; ?>
    </tbody>
</table>
<br>

<!-- EID-specific JavaScript -->
<script type="text/javascript">
    function addEidRow(obj) {
        $(obj.parentNode.parentNode).after('<tr align="center"> \
        <td style="text-align: center"> \
            <input type="text" name="sampleName[]" class="isRequired input-sm form-control" \
                title="Please enter sample name here" placeholder="Please enter sample name here"/> \
        </td> \
        <td> \
            <input type="text" name="samplePreparationDate[]" readonly="readonly" \
                class="isRequired form-control input-sm datepicker" \
                placeholder="Please enter the sample preparation date" \
                title="Please enter the sample preparation date" /> \
        </td> \
        <td><?php echo $possibleResultsJs; ?></td> \
        <td> \
            <input type="text" name="hivCtOd[]" class="isRequired form-control input-sm" \
                placeholder="HIV CT/OD" title="Please enter the HIV CT/OD values here" /> \
        </td> \
        <td> \
            <input type="text" name="icQs[]" class="isRequired form-control input-sm" \
                placeholder="IC/QS" title="Please enter the IC/QS Values here" /> \
        </td> \
        <td> \
            <select name="control[]" class="isRequired controlOrNot form-control input-sm" \
                title="Please choose whether this sample is a control"> \
                <option value="1"><?= $this->translate->_("Yes"); ?></option> \
                <option value="0" selected="selected"><?= $this->translate->_("No"); ?></option> \
            </select> \
        </td> \
        <td> \
            <select name="mandatory[]" class="isRequired form-control input-sm" \
                title="Please choose whether this sample/control is mandatory"> \
                <option value="1" selected="selected"><?= $this->translate->_("Yes"); ?></option> \
                <option value="0"><?= $this->translate->_("No"); ?></option> \
            </select> \
        </td> \
        <td> \
            <a href="javascript:void(0);" onclick="addEidRow(this);" class="btn btn-xs btn-info"><i class="icon-plus"></i></a> \
            <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger" \
                title="Remove this row completely"><i class="icon-minus"></i></a> \
        </td> \
    </tr>');

        // Reinitialize datepickers for new row
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    }

    function removeRow(obj) {
        $(obj.parentNode.parentNode).fadeOut("normal", function() {
            $(this).remove();
        });
    }

    $(document).ready(function() {
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    });
</script>