<?php

/**
 * Unified DTS (Dried Tube Specimen) Scheme Form
 *
 * Works for both ADD and EDIT flows by detecting mode and normalizing data.
 * This is the most complex scheme with multiple modals (EIA, WB, Rapid HIV, Geenius)
 * and conditional sections (Syphilis, RTRI).
 *
 * ADD mode variables:
 * - $this->dtsConfig - DTS configuration (algorithm, scheme type, etc.)
 * - $this->dtsPossibleResults - Possible result options for DTS tests
 * - $this->rtriPossibleResults - Possible result options for RTRI
 * - $this->eia - EIA kit options
 * - $this->wb - Western Blot kit options
 * - $this->allTestKits - All test kit options for Rapid HIV
 * - $this->reportType - Report type (e.g., 'malawi')
 *
 * EDIT mode variables:
 * - $this->shipmentData['reference'] - Existing sample/control data
 * - $this->shipmentData['possibleResults'] - Possible result options
 * - $this->shipmentData['eia'] - Existing EIA data
 * - $this->shipmentData['wb'] - Existing WB data
 * - $this->shipmentData['rhiv'] - Existing Rapid HIV data
 * - $this->shipmentData['geenius'] - Existing Geenius data
 *
 * Note: The innerHTML usage in closeShipmentModal is part of the existing modal
 * copy mechanism that copies form values between modal and hidden storage.
 * The content is generated server-side with proper escaping.
 */

// ============================================================================
// MODE DETECTION & DATA NORMALIZATION
// ============================================================================

$isEditMode = isset($this->shipmentData) && !empty($this->shipmentData);

// Parse DTS configuration
$dtsConfig = $this->dtsConfig;
if (is_string($dtsConfig) && Application_Service_Common::isJSON($dtsConfig)) {
    $dtsConfig = json_decode($dtsConfig);
} elseif (is_array($dtsConfig)) {
    $dtsConfig = (object) $dtsConfig;
}

$allowedAlgorithms = isset($dtsConfig->allowedAlgorithms) ? explode(",", $dtsConfig->allowedAlgorithms) : [];
$dtsSchemeType = isset($dtsConfig->dtsSchemeType) ? $dtsConfig->dtsSchemeType : 'standard';
$rtriEnabled = isset($dtsConfig->rtriEnabled) ? $dtsConfig->rtriEnabled : 'no';

// Date format helper
$vHelper = $this->getHelper('DateFormat');
$dtFormat = $vHelper->getDateFormat();
// Normalize shipment attributes for EDIT mode
$shipmentAttribute = [];
if ($isEditMode) {
    $shipmentAttribute = isset($this->shipmentData['shipment']['shipment_attributes'])
        ? json_decode($this->shipmentData['shipment']['shipment_attributes'], true)
        : [];
}

// Normalize possible results
$dtsPossibleResults = $this->dtsPossibleResults ?? [];
$rtriPossibleResults = $this->rtriPossibleResults ?? [];
$editPossibleResults = $isEditMode ? ($this->shipmentData['possibleResults'] ?? []) : [];

// Normalize samples/controls
$samples = $isEditMode
    ? ($this->shipmentData['reference'] ?? [])
    : [];
// Normalize EIA, WB, RHIV, Geenius data for EDIT mode
$eiaData = $isEditMode ? ($this->shipmentData['eia'] ?? []) : [];
$wbData = $isEditMode ? ($this->shipmentData['wb'] ?? []) : [];
$rhivData = $isEditMode ? ($this->shipmentData['rhiv'] ?? []) : [];
$geeniusData = $isEditMode ? ($this->shipmentData['geenius'] ?? []) : [];

// Build sample ID arrays for checking existing data
$allEia = array_column($eiaData, 'sample_id');
$allWb = array_column($wbData, 'sample_id');
$allRhiv = array_column($rhivData, 'sample_id');
$allGeenius = array_column($geeniusData, 'sample_id');

// ============================================================================
// BUILD DROPDOWN OPTIONS
// ============================================================================

// Test results (for individual tests - DTS_TEST)
$testResultsOptions = '<option value="">--' . htmlspecialchars($this->translate->_("Select")) . '--</option>';
foreach ($dtsPossibleResults as $pr) {
    if ($pr['scheme_sub_group'] == 'DTS_TEST') {
        $testResultsOptions .= '<option value="' . htmlspecialchars($pr['id']) . '">' . htmlspecialchars($pr['response']) . '</option>';
    }
}

// Final results (for sample final result - DTS_FINAL)
$finalResultsOptions = '<option value="">--' . htmlspecialchars($this->translate->_("Select")) . '--</option>';
foreach ($dtsPossibleResults as $pr) {
    if ($pr['scheme_sub_group'] == 'DTS_FINAL') {
        $finalResultsOptions .= '<option value="' . htmlspecialchars($pr['id']) . '">' . htmlspecialchars($pr['response']) . '</option>';
    }
}

// Syphilis results (DTS_SYP_FINAL)
$syphilisResultsOptions = '<option value="">--' . htmlspecialchars($this->translate->_("Select")) . '--</option>';
foreach ($dtsPossibleResults as $pr) {
    if ($pr['scheme_sub_group'] == 'DTS_SYP_FINAL') {
        $syphilisResultsOptions .= '<option value="' . htmlspecialchars($pr['id']) . '">' . htmlspecialchars($pr['response']) . '</option>';
    }
}

// RTRI results (RECENCY_FINAL)
$rtriResultsOptions = '<option value="">--' . htmlspecialchars($this->translate->_("Select")) . '--</option>';
foreach ($rtriPossibleResults as $pr) {
    if ($pr['scheme_sub_group'] == 'RECENCY_FINAL') {
        $rtriResultsOptions .= '<option value="' . htmlspecialchars($pr['id']) . '">' . htmlspecialchars($pr['response']) . '</option>';
    }
}

// EIA kit options
$eiaChoices = '<option value="">--' . htmlspecialchars($this->translate->_("Select")) . '--</option>';
foreach ($this->eia as $eiaId => $eiaName) {
    $eiaChoices .= '<option value="' . htmlspecialchars($eiaId) . '">' . htmlspecialchars($eiaName) . '</option>';
}

// WB kit options
$wbChoices = '<option value="">--' . htmlspecialchars($this->translate->_("Select")) . '--</option>';
foreach ($this->wb as $wbId => $wbName) {
    $wbChoices .= '<option value="' . htmlspecialchars($wbId) . '">' . htmlspecialchars($wbName) . '</option>';
}

// Rapid HIV test kit options
$dtsKitOptions = '<option value="">--' . htmlspecialchars($this->translate->_("Select")) . '--</option>';
foreach ($this->allTestKits as $kitId => $kitName) {
    $dtsKitOptions .= '<option value="' . htmlspecialchars($kitId) . '">' . htmlspecialchars($kitName) . '</option>';
}

// Build HTML for dropdowns used in JavaScript (escaped for JS strings)
$possibleResultsSelectHtml = '<select name="possibleResults[]" class="isRequired form-control input-sm">' . $finalResultsOptions . '</select>';
$possibleSyphilisResultsSelectHtml = '<select name="possibleSyphilisResults[]" class="form-control input-sm">' . $syphilisResultsOptions . '</select>';
$possibleRTRIResultsSelectHtml = '<select name="possibleRTRIResults[]" class="form-control input-sm">' . $rtriResultsOptions . '</select>';

// Escape for JavaScript
$possibleResultsJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $possibleResultsSelectHtml);
$possibleSyphilisResultsJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $possibleSyphilisResultsSelectHtml);
$possibleRTRIResultsJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $possibleRTRIResultsSelectHtml);
$eiaChoicesJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $eiaChoices);
$wbChoicesJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $wbChoices);
$dtsKitOptionsJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $dtsKitOptions);
$testResultsOptionsJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $testResultsOptions);
$finalResultsOptionsJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $finalResultsOptions);

// Determine visibility states
$showSyphilis = $isEditMode
    ? (isset($shipmentAttribute['enableSyphilis']) && $shipmentAttribute['enableSyphilis'] == 'yes')
    : false;
$showRtri = $isEditMode
    ? (isset($shipmentAttribute['enableRtri']) && $shipmentAttribute['enableRtri'] == 'yes')
    : false;
$showTestPanelType = $isEditMode
    ? (isset($shipmentAttribute['screeningTest']) && $shipmentAttribute['screeningTest'] == 'no')
    : true;
?>

<style type="text/css">
    .modal-scrollable {
        z-index: 1000 !important;
    }

    .modal-backdrop {
        z-index: 900 !important;
    }

    #mbd {
        overflow-y: scroll;
        max-height: 100%;
    }
</style>

<?php
// ============================================================================
// PT CO-ORDINATOR FIELDS (Malawi report type only) - ADD MODE ONLY
// ============================================================================
if (!$isEditMode && isset($this->reportType) && !empty($this->reportType) && $this->reportType == 'malawi') { ?>
    <div class="form-group">
        <label class="col-lg-3 control-label"><?= $this->translate->_("PT Co-ordinator Email"); ?></label>
        <div class="col-lg-5">
            <input type="text" name="ptEmail" id="ptEmail" placeholder="Enter PT Co-ordinator email"
                title="Please enter the PT Co-ordinator email" class="form-control input-sm isEmail" />
        </div>
    </div>
    <div class="form-group">
        <label class="col-lg-3 control-label"><?= $this->translate->_("PT Co-ordinator Phone Number"); ?></label>
        <div class="col-lg-5">
            <input type="text" name="ptPhone" id="ptPhone" placeholder="Enter PT Co-ordinator phone number"
                title="Please enter the PT Co-ordinator phone number" class="form-control input-sm isNumeric" />
        </div>
    </div>
<?php }

// ============================================================================
// ENABLE RTRI (updated-3-tests scheme type only)
// ============================================================================
if (isset($dtsSchemeType) && !empty($dtsSchemeType) && $dtsSchemeType == 'updated-3-tests' && isset($rtriEnabled) && !empty($rtriEnabled) && $rtriEnabled == 'yes') { ?>
    <div class="form-group">
        <label class="col-lg-3 control-label"><?= $this->translate->_("Enable RTRI"); ?></label>
        <div class="col-lg-5">
            <select id="enableRtri" name="enableRtri" class="form-control input-sm"
                title="Please select if is RTRI enabled">
                <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                <option value="yes" <?php echo ($isEditMode && isset($shipmentAttribute['enableRtri']) && $shipmentAttribute['enableRtri'] == 'yes') ? "selected='selected'" : ""; ?>>
                    <?= $this->translate->_("Yes"); ?>
                </option>
                <option value="no" <?php echo ($isEditMode && isset($shipmentAttribute['enableRtri']) && $shipmentAttribute['enableRtri'] == 'no') ? "selected='selected'" : ""; ?>>
                    <?= $this->translate->_("No"); ?>
                </option>
            </select>
        </div>
    </div>
<?php }

// ============================================================================
// SAMPLE TYPE
// ============================================================================
?>
<div class="form-group">
    <label class="col-lg-3 control-label" for="dtsSampleType"><?= $this->translate->_("Sample Type"); ?>
        <span class="mandatory">*</span></label>
    <div class="col-lg-5">
        <select id="dtsSampleType" name="dtsSampleType" class="isRequired form-control input-sm"
            title="Please select a Sample Type">
            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
            <option value="dried" <?php echo (!$isEditMode || (isset($shipmentAttribute['sampleType']) && $shipmentAttribute['sampleType'] == 'dried')) ? "selected='selected'" : ""; ?>>
                <?= $this->translate->_("Dried Tube Specimen"); ?>
            </option>
            <option value="serum" <?php echo ($isEditMode && isset($shipmentAttribute['sampleType']) && $shipmentAttribute['sampleType'] == 'serum') ? "selected='selected'" : ""; ?>>
                <?= $this->translate->_("Serum"); ?>
            </option>
            <option value="plasma" <?php echo ($isEditMode && isset($shipmentAttribute['sampleType']) && $shipmentAttribute['sampleType'] == 'plasma') ? "selected='selected'" : ""; ?>>
                <?= $this->translate->_("Plasma"); ?>
            </option>
        </select>
    </div>
</div>

<?php
// ============================================================================
// ENABLE SYPHILIS (Ghana scheme type only)
// ============================================================================
if (isset($dtsSchemeType) && !empty($dtsSchemeType) && $dtsSchemeType == "ghana") { ?>
    <div class="form-group">
        <label class="col-lg-3 control-label" for="enableSyphilis">
            <?= $this->translate->_("Enable Syphilis Test for ANC Sites?"); ?> <span class="mandatory">*</span><br>
            <small><?= $this->translate->_("(This creates a Syphilis panel for all ANC sites)"); ?></small>
        </label>
        <div class="col-lg-5">
            <select id="enableSyphilis" name="enableSyphilis" class="isRequired form-control input-sm"
                title="Please select if this has a Syphilis Panel">
                <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                <option value="yes" <?php echo ($isEditMode && isset($shipmentAttribute['enableSyphilis']) && $shipmentAttribute['enableSyphilis'] == 'yes') ? "selected='selected'" : ""; ?>>
                    <?= $this->translate->_("Yes"); ?>
                </option>
                <option value="no" <?php echo ($isEditMode && isset($shipmentAttribute['enableSyphilis']) && $shipmentAttribute['enableSyphilis'] == 'no') ? "selected='selected'" : ""; ?>>
                    <?= $this->translate->_("No"); ?>
                </option>
            </select>
        </div>
    </div>
<?php }

// ============================================================================
// NUMBER OF TESTS IN PANEL (standard or malawi scheme type only)
// ============================================================================
if (isset($dtsSchemeType) && !empty($dtsSchemeType) && ($dtsSchemeType == "standard" || $dtsSchemeType == "malawi")) { ?>
    <div class="form-group">
        <label class="col-lg-3 control-label"><?= $this->translate->_("No. of tests in this Test Panel"); ?>
            <span class="mandatory">*</span></label>
        <div class="col-lg-5">
            <select id="noOfTestsInPanel" name="noOfTestsInPanel" class="isRequired form-control input-sm"
                title="Please select no. of tests in this panel">
                <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                <option value="2" <?php echo ($isEditMode && isset($shipmentAttribute['noOfTestsInPanel']) && $shipmentAttribute['noOfTestsInPanel'] == '2') ? "selected='selected'" : ""; ?>>2</option>
                <option value="3" <?php echo (!$isEditMode || (isset($shipmentAttribute['noOfTestsInPanel']) && $shipmentAttribute['noOfTestsInPanel'] == '3')) ? "selected='selected'" : ""; ?>>3</option>
            </select>
        </div>
    </div>
<?php } ?>

<!-- ============================================================================ -->
<!-- SCREENING TEST PANEL -->
<!-- ============================================================================ -->
<div class="form-group">
    <label class="col-lg-3 control-label" for="screeningTest">
        <?= $this->translate->_("Is this ONLY Screening Test Panel?"); ?> <span class="mandatory">*</span><br>
        <small><?= $this->translate->_("(This creates a panel with only ONE test)"); ?></small>
    </label>
    <div class="col-lg-5">
        <select id="screeningTest" name="screeningTest" class="isRequired form-control input-sm"
            title="Please select if this is a Screening Test" onchange="screeningTestPanel(this.value)">
            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
            <option value="yes" <?php echo ($isEditMode && isset($shipmentAttribute['screeningTest']) && $shipmentAttribute['screeningTest'] == 'yes') ? "selected='selected'" : ""; ?>>
                <?= $this->translate->_("Yes"); ?>
            </option>
            <option value="no" <?php echo (!$isEditMode || (isset($shipmentAttribute['screeningTest']) && $shipmentAttribute['screeningTest'] == 'no')) ? "selected='selected'" : ""; ?>>
                <?= $this->translate->_("No"); ?>
            </option>
        </select>
    </div>
</div>

<?php
// ============================================================================
// TEST PANEL TYPE (updated-3-tests scheme type only)
// ============================================================================
if (isset($dtsSchemeType) && !empty($dtsSchemeType) && $dtsSchemeType == 'updated-3-tests') { ?>
    <div class="form-group dtsTestPanelType" style="<?php echo $showTestPanelType ? '' : 'display:none;'; ?>">
        <label class="col-lg-3 control-label" for="dtsTestPanelType">
            <?= $this->translate->_("Allow users to Choose Screening/Confirmatory"); ?>
        </label>
        <div class="col-lg-5">
            <select id="dtsTestPanelType" name="dtsTestPanelType" class="form-control input-sm"
                title="Please Allow users to Choose Screening/Confirmatory">
                <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                <option value="yes" <?php echo ($isEditMode && isset($shipmentAttribute['dtsTestPanelType']) && $shipmentAttribute['dtsTestPanelType'] == 'yes') ? "selected='selected'" : ""; ?>>
                    <?= $this->translate->_("Yes"); ?>
                </option>
                <option value="no" <?php echo (!$isEditMode || (isset($shipmentAttribute['dtsTestPanelType']) && $shipmentAttribute['dtsTestPanelType'] == 'no')) ? "selected='selected'" : ""; ?>>
                    <?= $this->translate->_("No"); ?>
                </option>
            </select>
        </div>
    </div>
<?php } ?>

<!-- ============================================================================ -->
<!-- COLLECT QC DATA -->
<!-- ============================================================================ -->
<div class="form-group">
    <label class="col-lg-3 control-label" for="collectQcData"><?= $this->translate->_("Collect QC Data"); ?></label>
    <div class="col-lg-5">
        <select id="collectQcData" name="collectQcData" class="form-control input-sm"
            title="Please select Collect QC Data">
            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
            <option value="yes" <?php echo ($isEditMode && isset($shipmentAttribute['collect_qc_data']) && $shipmentAttribute['collect_qc_data'] == 'yes') ? "selected='selected'" : ""; ?>>
                <?= $this->translate->_("Yes"); ?>
            </option>
            <option value="no" <?php echo (!$isEditMode || (isset($shipmentAttribute['collect_qc_data']) && $shipmentAttribute['collect_qc_data'] == 'no')) ? "selected='selected'" : ""; ?>>
                <?= $this->translate->_("No"); ?>
            </option>
        </select>
    </div>
</div>

<!-- ============================================================================ -->
<!-- SAMPLE TABLE -->
<!-- ============================================================================ -->
<table style="width: 100%; margin: 0 auto;" border="1" class="table table-bordered table-striped clearfix" id="vlSampleTable">
    <thead>
        <tr align="center">
            <th style="width:25%; text-align: center;"><?= $this->translate->_("Sample"); ?></th>
            <th style="text-align: center; vertical-align:middle;"><?= $this->translate->_("Sample Preparation Date"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Final Result"); ?></th>
            <th class="syphilis-input" style="width:10%; text-align: center; <?php echo $showSyphilis ? '' : 'display:none'; ?>;">
                <?= $this->translate->_("Syphilis Final Result"); ?>
            </th>
            <th class="rtri-input" style="width:10%; text-align: center; <?php echo $showRtri ? '' : 'display:none'; ?>;">
                <?= $this->translate->_("RTRI Final Result"); ?>
            </th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Control?"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Mandatory?"); ?></th>
            <th style="width:20%; text-align: center;"><?= $this->translate->_("Option"); ?></th>
        </tr>
    </thead>
    <tbody>
        <?php
        $counter = 1;
        if ($isEditMode && count($samples) > 0):
            // EDIT MODE: Display existing samples
            foreach ($samples as $reference):
                $sampleId = $reference['sample_id'];
                $sampleLabel = $reference['sample_label'] ?? '';
                $samplePrepDate = isset($reference['sample_preparation_date']) ? $this->dateFormat($reference['sample_preparation_date']) : '';
                $referenceResult = $reference['reference_result'] ?? '';
                $syphilisResult = $reference['syphilis_reference_result'] ?? '';
                $rtriResult = $reference['dts_rtri_reference_result'] ?? '';
                $control = $reference['control'] ?? 0;
                $mandatory = $reference['mandatory'] ?? 1;
        ?>
                <tr align="center">
                    <td style="text-align: center">
                        <input type="text" name="sampleName[]" class="isRequired input-sm form-control"
                            title="Please enter sample name here" placeholder="Please enter sample name here"
                            value="<?php echo htmlspecialchars($sampleLabel); ?>" />
                        <input type="hidden" id="sampleId" name="sampleId[]" value="<?php echo htmlspecialchars($sampleId); ?>" />
                    </td>
                    <td>
                        <input type="text" value="<?php echo htmlspecialchars($samplePrepDate); ?>"
                            name="samplePreparationDate[]" readonly="readonly"
                            class="isRequired form-control input-sm datepicker"
                            placeholder="Please enter the sample preparation date"
                            title="Please enter the sample preparation date" />
                    </td>
                    <td>
                        <select name="possibleResults[]" class="isRequired form-control input-sm">
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <?php foreach ($editPossibleResults as $pr):
                                if ($pr['scheme_sub_group'] == 'DTS_FINAL'): ?>
                                    <option value="<?php echo htmlspecialchars($pr['id']); ?>"
                                        <?php echo ($referenceResult == $pr['id']) ? "selected='selected'" : ""; ?>>
                                        <?php echo htmlspecialchars($pr['response']); ?>
                                    </option>
                            <?php endif;
                            endforeach; ?>
                        </select>
                    </td>
                    <td class="syphilis-input" style="<?php echo $showSyphilis ? '' : 'display:none'; ?>;">
                        <select name="possibleSyphilisResults[]" class="form-control input-sm">
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <?php foreach ($editPossibleResults as $pr):
                                if ($pr['scheme_sub_group'] == 'DTS_SYP_FINAL'): ?>
                                    <option value="<?php echo htmlspecialchars($pr['id']); ?>"
                                        <?php echo ($syphilisResult == $pr['id']) ? "selected='selected'" : ""; ?>>
                                        <?php echo htmlspecialchars($pr['response']); ?>
                                    </option>
                            <?php endif;
                            endforeach; ?>
                        </select>
                    </td>
                    <td class="rtri-input" style="<?php echo $showRtri ? '' : 'display:none'; ?>;">
                        <select name="possibleRTRIResults[]" class="form-control input-sm">
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <?php foreach ($rtriPossibleResults as $pr):
                                if ($pr['scheme_sub_group'] == 'RECENCY_FINAL'): ?>
                                    <option value="<?php echo htmlspecialchars($pr['id']); ?>"
                                        <?php echo ($rtriResult == $pr['id']) ? "selected='selected'" : ""; ?>>
                                        <?php echo htmlspecialchars($pr['response']); ?>
                                    </option>
                            <?php endif;
                            endforeach; ?>
                        </select>
                    </td>
                    <td>
                        <select name="control[]" class="isRequired controlOrNot form-control input-sm"
                            title="Please choose whether this sample is a control">
                            <option value="0" <?php echo ($control == 0) ? "selected='selected'" : ""; ?>><?= $this->translate->_("No"); ?></option>
                            <option value="1" <?php echo ($control == 1) ? "selected='selected'" : ""; ?>><?= $this->translate->_("Yes"); ?></option>
                        </select>
                    </td>
                    <td>
                        <select name="mandatory[]" class="isRequired form-control input-sm"
                            title="Please choose whether this sample/control is mandatory">
                            <option value="1" <?php echo ($mandatory == 1) ? "selected='selected'" : ""; ?>><?= $this->translate->_("Yes"); ?></option>
                            <option value="0" <?php echo ($mandatory == 0) ? "selected='selected'" : ""; ?>><?= $this->translate->_("No"); ?></option>
                        </select>
                    </td>
                    <td>
                        <a href="javascript:void(0);" class="btn btn-xs btn-primary"
                            onclick="showdefModal('sampleEia<?php echo htmlspecialchars($sampleId); ?>', 900, 600); loadCal();">
                            <i class="icon-beaker"></i> <?= $this->translate->_("Ref. Results"); ?>
                        </a>
                        <a href="javascript:void(0);" onclick="addDtsRow(this);" class="btn btn-xs btn-info">
                            <i class="icon-plus"></i> <?= $this->translate->_("Sample/Control"); ?>
                        </a>
                        <?php if ($counter > 1): ?>
                            <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger"
                                title="Remove this row completely"><i class="icon-minus"></i></a>
                        <?php endif; ?>

                        <!-- EIA/WB/RHIV/Geenius Modal for this sample -->
                        <?php include dirname(__FILE__) . '/_dts-sample-modal.phtml'; ?>
                    </td>
                </tr>
            <?php
                $counter++;
            endforeach;
        else:
            // ADD MODE: Display empty row
            ?>
            <tr align="center">
                <td style="text-align: center">
                    <input type="text" name="sampleName[]" class="isRequired input-sm form-control"
                        title="Please enter sample name here" placeholder="Please enter sample name here" />
                </td>
                <td>
                    <input type="text" name="samplePreparationDate[]" readonly="readonly"
                        class="isRequired form-control input-sm datepicker"
                        placeholder="Please enter the sample preparation date"
                        title="Please enter the sample preparation date" />
                </td>
                <td>
                    <select name="possibleResults[]" class="isRequired form-control input-sm">
                        <?php echo $finalResultsOptions; ?>
                    </select>
                </td>
                <td class="syphilis-input" style="display:none;">
                    <select name="possibleSyphilisResults[]" class="form-control input-sm">
                        <?php echo $syphilisResultsOptions; ?>
                    </select>
                </td>
                <td class="rtri-input" style="display:none;">
                    <select name="possibleRTRIResults[]" class="form-control input-sm">
                        <?php echo $rtriResultsOptions; ?>
                    </select>
                </td>
                <td>
                    <select name="control[]" class="isRequired controlOrNot form-control input-sm"
                        title="Please choose whether this sample is a control">
                        <option value="1"><?= $this->translate->_("Yes"); ?></option>
                        <option value="0" selected="selected"><?= $this->translate->_("No"); ?></option>
                    </select>
                </td>
                <td>
                    <select name="mandatory[]" class="isRequired form-control input-sm"
                        title="Please choose whether this sample/control is mandatory">
                        <option value="1" selected="selected"><?= $this->translate->_("Yes"); ?></option>
                        <option value="0"><?= $this->translate->_("No"); ?></option>
                    </select>
                </td>
                <td>
                    <a href="javascript:void(0);" class="btn btn-xs btn-primary"
                        onclick="showdefModal('sampleEia1', 900, 600); loadCal();">
                        <i class="icon-beaker"></i> <?= $this->translate->_("Ref. Results"); ?>
                    </a>
                    <a href="javascript:void(0);" onclick="addDtsRow(this);" class="btn btn-xs btn-info">
                        <i class="icon-plus"></i> <?= $this->translate->_("Sample/Control"); ?>
                    </a>
                    <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger"
                        title="Remove this row completely">
                        <i class="icon-minus"></i>
                    </a>
                </td>
            </tr>
        <?php endif; ?>
    </tbody>
</table>
<br>

<!-- Block holders for dynamically added modals -->
<div id="eiaBlockHolder"></div>
<div id="wbBlockHolder"></div>

<!-- ============================================================================ -->
<!-- JAVASCRIPT -->
<!-- ============================================================================ -->
<script type="text/javascript">
    var sampleCounter = <?php echo $isEditMode && count($samples) > 0 ? count($samples) : 1; ?>;

    $(document).ready(function() {
        <?php if ($isEditMode && count($samples) > 0): ?>
            // EDIT mode: Initialize modals for existing samples (blocks are already in HTML)
        <?php else: ?>
            // ADD mode: Create initial EIA block
            addNewEiaBlock('1');
        <?php endif; ?>

        // Initialize datepickers
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });

        // Syphilis toggle
        $("#enableSyphilis").change(function() {
            if ($(this).val() == "yes") {
                $(".syphilis-input").show();
                $("select[name='possibleSyphilisResults[]']").addClass("isRequired");
            } else {
                $(".syphilis-input").hide();
                $("select[name='possibleSyphilisResults[]']").removeClass("isRequired");
            }
        });

        // RTRI toggle
        $("#enableRtri").change(function() {
            if ($(this).val() == "yes") {
                $(".rtri-input").show();
            } else {
                $(".rtri-input").hide();
            }
        });
    });

    function addDtsRow(obj) {
        sampleCounter++;
        $(obj.parentNode.parentNode).after('<tr align="center"> \
        <td style="text-align: center"> \
            <input type="text" name="sampleName[]" class="isRequired input-sm form-control" title="Please enter sample name here" placeholder="Please enter sample name here"/> \
        </td> \
        <td> \
            <input type="text" name="samplePreparationDate[]" readonly="readonly" class="isRequired form-control input-sm datepicker" placeholder="Please enter the sample preparation date" title="Please enter the sample preparation date" /> \
        </td> \
        <td><?php echo $possibleResultsJs; ?></td> \
        <td class="syphilis-input" style="display:none;"><?php echo $possibleSyphilisResultsJs; ?></td> \
        <td class="rtri-input" style="display:none;"><?php echo $possibleRTRIResultsJs; ?></td> \
        <td> \
            <select name="control[]" class="isRequired controlOrNot form-control input-sm" title="Please choose whether this sample is a control"> \
                <option value="1"><?= $this->translate->_("Yes"); ?></option> \
                <option value="0" selected="selected"><?= $this->translate->_("No"); ?></option> \
            </select> \
        </td> \
        <td> \
            <select name="mandatory[]" class="isRequired form-control input-sm" title="Please choose whether this sample/control is mandatory"> \
                <option value="1" selected="selected"><?= $this->translate->_("Yes"); ?></option> \
                <option value="0"><?= $this->translate->_("No"); ?></option> \
            </select> \
        </td> \
        <td> \
            <a href="javascript:void(0);" class="btn btn-xs btn-primary" onclick="showdefModal(\'sampleEia' + sampleCounter + '\', 900, 600); loadCal();"><i class="icon-beaker"></i> <?= $this->translate->_("Ref. Results"); ?></a> \
            <a href="javascript:void(0);" onclick="addDtsRow(this);" class="btn btn-xs btn-info"><i class="icon-plus"></i> <?= $this->translate->_("Sample/Control"); ?></a> \
            <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a> \
        </td> \
    </tr>');

        // Show/hide conditional columns based on current selections
        if ($("#enableSyphilis").val() == "yes") {
            $(".syphilis-input").show();
            $("select[name='possibleSyphilisResults[]']").addClass("isRequired");
        } else {
            $(".syphilis-input").hide();
            $("select[name='possibleSyphilisResults[]']").removeClass("isRequired");
        }

        if ($("#enableRtri").val() == "yes") {
            $(".rtri-input").show();
        } else {
            $(".rtri-input").hide();
        }

        // Reinitialize datepickers
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });

        // Create EIA block for new sample
        addNewEiaBlock(sampleCounter);
    }

    function removeRow(obj) {
        $(obj.parentNode.parentNode).fadeOut("normal", function() {
            $(this).remove();
        });
    }

    function addNewEiaBlock(sampleId) {
        $("#eiaBlockHolder").after('<div id="sampleEia' + sampleId + '" class="dialog">\
        <span onClick="hidedefModal()" class="closeModal"></span>\
        <div class="modal-header">\
            <h4 class="modal-title"><?= $this->translate->_("EIA"); ?></h4>\
        </div>\
        <div class="modal-body">\
            <div class="row">\
                <div>\
                    <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix">\
                        <thead>\
                            <tr align="center">\
                                <th style="width:20%; text-align: center;"><?= $this->translate->_("EIA"); ?></th>\
                                <th style="width:10%; text-align: center;"><?= $this->translate->_("Lot"); ?></th>\
                                <th style="width:12%; text-align: center;"><?= $this->translate->_("Expiry"); ?></th>\
                                <th style="width:10%; text-align: center;"><?= $this->translate->_("OD"); ?></th>\
                                <th style="width:10%; text-align: center;"><?= $this->translate->_("Cutoff"); ?></th>\
                                <th style="width:10%; text-align: center;"><?= $this->translate->_("Result"); ?></th>\
                                <th style="width:10%; text-align: center;"><?= $this->translate->_("Options"); ?></th>\
                            </tr>\
                        </thead>\
                        <tbody>\
                            <tr>\
                                <td><select class="form-control" name="eia[' + sampleId + '][eia][]"><?php echo $eiaChoicesJs; ?></select></td>\
                                <td><input type="text" name="eia[' + sampleId + '][lot][]" class="form-control"/></td>\
                                <td><input type="text" name="eia[' + sampleId + '][expiry][]" class="form-control datepicker" readonly="readonly"/></td>\
                                <td><input type="text" name="eia[' + sampleId + '][od][]" class="form-control"/></td>\
                                <td><input type="text" name="eia[' + sampleId + '][cutoff][]" class="form-control"/></td>\
                                <td><select class="form-control" name="eia[' + sampleId + '][result][]"><?php echo $testResultsOptionsJs; ?></select></td>\
                                <td>\
                                    <a href="javascript:void(0);" onclick="addNewEiaRow(this, ' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>\
                                </td>\
                            </tr>\
                        </tbody>\
                    </table>\
                </div>\
            </div>\
        </div>\
        <div class="modal-header">\
            <h4 class="modal-title"><?= $this->translate->_("WB"); ?></h4>\
        </div>\
        <div class="modal-body">\
            <div class="row" style="overflow-x:scroll;">\
                <div>\
                    <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix">\
                        <thead>\
                            <tr align="center">\
                                <th style="text-align: center;"><?= $this->translate->_("WB"); ?></th>\
                                <th style="text-align: center;"><?= $this->translate->_("Lot"); ?></th>\
                                <th style="text-align: center;"><?= $this->translate->_("Expiry"); ?></th>\
                                <th style="text-align: center;">160</th>\
                                <th style="text-align: center;">120</th>\
                                <th style="text-align: center;">66</th>\
                                <th style="text-align: center;">55</th>\
                                <th style="text-align: center;">51</th>\
                                <th style="text-align: center;">41</th>\
                                <th style="text-align: center;">31</th>\
                                <th style="text-align: center;">24</th>\
                                <th style="text-align: center;">17</th>\
                                <th style="text-align: center;"><?= $this->translate->_("Result"); ?></th>\
                                <th style="text-align: center;"><?= $this->translate->_("Options"); ?></th>\
                            </tr>\
                        </thead>\
                        <tbody>\
                            <tr>\
                                <td><select class="form-control" name="wb[' + sampleId + '][wb][]" style="width:125px;"><?php echo $wbChoicesJs; ?></select></td>\
                                <td><input type="text" name="wb[' + sampleId + '][lot][]" class="form-control" style="width:100px;"/></td>\
                                <td><input type="text" name="wb[' + sampleId + '][expiry][]" class="form-control datepicker" readonly="readonly" style="width:125px;"/></td>\
                                <td><select name="wb[' + sampleId + '][160][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
                                <td><select name="wb[' + sampleId + '][120][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
                                <td><select name="wb[' + sampleId + '][66][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
                                <td><select name="wb[' + sampleId + '][55][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
                                <td><select name="wb[' + sampleId + '][51][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
                                <td><select name="wb[' + sampleId + '][41][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
                                <td><select name="wb[' + sampleId + '][31][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
                                <td><select name="wb[' + sampleId + '][24][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
                                <td><select name="wb[' + sampleId + '][17][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
                                <td><select class="form-control" name="wb[' + sampleId + '][result][]"><?php echo $finalResultsOptionsJs; ?></select></td>\
                                <td>\
                                    <a href="javascript:void(0);" onclick="addNewWbRow(this, ' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>\
                                </td>\
                            </tr>\
                        </tbody>\
                    </table>\
                </div>\
            </div>\
        </div>\
        <div class="modal-header">\
            <h4 class="modal-title"><?= $this->translate->_("RAPID HIV TESTING"); ?></h4>\
        </div>\
        <div class="modal-body">\
            <div class="row">\
                <div>\
                    <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix">\
                        <thead>\
                            <tr align="center">\
                                <th style="width:20%; text-align: center;"><?= $this->translate->_("Kit Name"); ?></th>\
                                <th style="width:10%; text-align: center;"><?= $this->translate->_("Lot"); ?></th>\
                                <th style="width:12%; text-align: center;"><?= $this->translate->_("Expiry"); ?></th>\
                                <th style="width:15%; text-align: center;"><?= $this->translate->_("Result"); ?></th>\
                                <th style="width:5%; text-align: center;"><?= $this->translate->_("Options"); ?></th>\
                            </tr>\
                        </thead>\
                        <tbody>\
                            <tr>\
                                <td><select class="form-control" name="rhiv[' + sampleId + '][kit][]"><?php echo $dtsKitOptionsJs; ?></select></td>\
                                <td><input type="text" name="rhiv[' + sampleId + '][lot][]" class="form-control"/></td>\
                                <td><input type="text" name="rhiv[' + sampleId + '][expiry][]" class="form-control datepicker" readonly="readonly"/></td>\
                                <td><select class="form-control" name="rhiv[' + sampleId + '][result][]"><?php echo $testResultsOptionsJs; ?></select></td>\
                                <td>\
                                    <a href="javascript:void(0);" onclick="addNewHivRow(this, ' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>\
                                </td>\
                            </tr>\
                        </tbody>\
                    </table>\
                </div>\
            </div>\
        </div>\
        <div class="modal-header">\
            <h4 class="modal-title"><?= $this->translate->_("GEENIUS HIV 1/2 SUPPLEMENTAL ASSAY"); ?></h4>\
        </div>\
        <div class="modal-body">\
            <div class="row">\
                <div>\
                    <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix">\
                        <thead>\
                            <tr align="center">\
                                <th style="width:25%; text-align: center;"><?= $this->translate->_("Lot"); ?></th>\
                                <th style="width:25%; text-align: center;"><?= $this->translate->_("Expiry"); ?></th>\
                                <th style="width:25%; text-align: center;"><?= $this->translate->_("Result"); ?></th>\
                                <th style="width:25%; text-align: center;"><?= $this->translate->_("Options"); ?></th>\
                            </tr>\
                        </thead>\
                        <tbody>\
                            <tr>\
                                <td><input type="text" name="geenius[' + sampleId + '][lot][]" class="form-control"/></td>\
                                <td><input type="text" name="geenius[' + sampleId + '][expiry][]" class="form-control datepicker" readonly="readonly"/></td>\
                                <td><select class="form-control" name="geenius[' + sampleId + '][result][]"><?php echo $testResultsOptionsJs; ?></select></td>\
                                <td>\
                                    <a href="javascript:void(0);" onclick="addNewGeeniusRow(this, ' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>\
                                </td>\
                            </tr>\
                        </tbody>\
                    </table>\
                </div>\
            </div>\
        </div>\
        <div class="modal-footer">\
            <button type="button" class="btn btn-primary" onclick="closeShipmentModal(\'sampleEia' + sampleId + '\')"><?= $this->translate->_("OK"); ?></button>\
        </div>\
    </div>');
    }

    function addNewEiaRow(obj, sampleId) {
        $(obj.parentNode.parentNode).after('<tr>\
        <td><select class="form-control" name="eia[' + sampleId + '][eia][]"><?php echo $eiaChoicesJs; ?></select></td>\
        <td><input type="text" name="eia[' + sampleId + '][lot][]" class="form-control"/></td>\
        <td><input type="text" name="eia[' + sampleId + '][expiry][]" class="form-control datepicker" readonly="readonly"/></td>\
        <td><input type="text" name="eia[' + sampleId + '][od][]" class="form-control"/></td>\
        <td><input type="text" name="eia[' + sampleId + '][cutoff][]" class="form-control"/></td>\
        <td><select class="form-control" name="eia[' + sampleId + '][result][]"><?php echo $testResultsOptionsJs; ?></select></td>\
        <td>\
            <a href="javascript:void(0);" onclick="addNewEiaRow(this, ' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>\
            <a href="javascript:void(0);" onclick="removeEiaRow(this)" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>\
        </td>\
    </tr>');
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    }

    function addNewWbRow(obj, sampleWbId) {
        $(obj.parentNode.parentNode).after('<tr>\
        <td><select class="form-control" name="wb[' + sampleWbId + '][wb][]" style="width:125px;"><?php echo $wbChoicesJs; ?></select></td>\
        <td><input type="text" name="wb[' + sampleWbId + '][lot][]" class="form-control" style="width:100px;"/></td>\
        <td><input type="text" name="wb[' + sampleWbId + '][expiry][]" class="form-control datepicker" readonly="readonly" style="width:125px;"/></td>\
        <td><select name="wb[' + sampleWbId + '][160][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
        <td><select name="wb[' + sampleWbId + '][120][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
        <td><select name="wb[' + sampleWbId + '][66][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
        <td><select name="wb[' + sampleWbId + '][55][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
        <td><select name="wb[' + sampleWbId + '][51][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
        <td><select name="wb[' + sampleWbId + '][41][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
        <td><select name="wb[' + sampleWbId + '][31][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
        <td><select name="wb[' + sampleWbId + '][24][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
        <td><select name="wb[' + sampleWbId + '][17][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td>\
        <td><select class="form-control" name="wb[' + sampleWbId + '][result][]"><?php echo $finalResultsOptionsJs; ?></select></td>\
        <td>\
            <a href="javascript:void(0);" onclick="addNewWbRow(this, ' + sampleWbId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>\
            <a href="javascript:void(0);" onclick="removeWbRow(this, ' + sampleWbId + ')" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>\
        </td>\
    </tr>');
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    }

    function addNewHivRow(obj, sampleId) {
        $(obj.parentNode.parentNode).after('<tr>\
        <td><select class="form-control" name="rhiv[' + sampleId + '][kit][]"><?php echo $dtsKitOptionsJs; ?></select></td>\
        <td><input type="text" name="rhiv[' + sampleId + '][lot][]" class="form-control"/></td>\
        <td><input type="text" name="rhiv[' + sampleId + '][expiry][]" class="form-control datepicker" readonly="readonly"/></td>\
        <td><select class="form-control" name="rhiv[' + sampleId + '][result][]"><?php echo $testResultsOptionsJs; ?></select></td>\
        <td>\
            <a href="javascript:void(0);" onclick="addNewHivRow(this, ' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>\
            <a href="javascript:void(0);" onclick="removeHivRow(this)" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>\
        </td>\
    </tr>');
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    }

    function addNewGeeniusRow(obj, sampleId) {
        $(obj.parentNode.parentNode).after('<tr>\
        <td><input type="text" name="geenius[' + sampleId + '][lot][]" class="form-control"/></td>\
        <td><input type="text" name="geenius[' + sampleId + '][expiry][]" class="form-control datepicker" readonly="readonly"/></td>\
        <td><select class="form-control" name="geenius[' + sampleId + '][result][]"><?php echo $testResultsOptionsJs; ?></select></td>\
        <td>\
            <a href="javascript:void(0);" onclick="addNewGeeniusRow(this, ' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a>\
            <a href="javascript:void(0);" onclick="removeGeeniusRow(this)" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a>\
        </td>\
    </tr>');
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    }

    function removeEiaRow(obj) {
        $(obj.parentNode.parentNode).fadeOut("normal", function() {
            $(this).remove();
        });
    }

    function removeWbRow(obj, sampleId) {
        $(obj.parentNode.parentNode).fadeOut("normal", function() {
            $(this).remove();
        });
    }

    function removeHivRow(obj) {
        $(obj.parentNode.parentNode).fadeOut("normal", function() {
            $(this).remove();
        });
    }

    function removeGeeniusRow(obj) {
        $(obj.parentNode.parentNode).fadeOut("normal", function() {
            $(this).remove();
        });
    }

    function loadCal() {
        $(".datepicker").removeClass("hasDatepicker");
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    }

    function closeShipmentModal(divId) {
        // This function copies form values from modal to hidden storage
        // Content is server-generated with proper escaping
        var modalDiv = document.getElementById(divId);
        var mbdDiv = document.getElementById("mbd");
        if (modalDiv && mbdDiv) {
            modalDiv.innerHTML = mbdDiv.innerHTML;

            $("#mbd input:text").each(function(i, obj) {
                $("#" + divId + " input:text:eq(" + i + ")").val($(this).val());
            });
            $("#mbd select").each(function(i, obj) {
                $("#" + divId + " select:eq(" + i + ")").val($(this).val());
            });
        }

        hidedefModal();
    }

    function screeningTestPanel(value) {
        if ($('.dtsTestPanelType')) {
            if (value == 'no') {
                $('.dtsTestPanelType').show();
            } else {
                $('#dtsTestPanelType').val('');
                $('.dtsTestPanelType').hide();
            }
        }
    }
</script>