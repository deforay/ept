<?php
/**
 * Unified DBS Scheme Form
 *
 * Works for both ADD and EDIT flows by detecting mode and normalizing data.
 *
 * ADD mode variables:
 * - $this->dtsPossibleResults - Possible result options (DBS_FINAL for main results, DTS_TEST for EIA/WB results)
 * - $this->eia - EIA test kit options
 * - $this->wb - Western Blot test kit options
 * - $this->reportType - Optional report type (e.g., 'malawi')
 *
 * EDIT mode variables:
 * - $this->shipmentData['reference'] - Existing sample/control data
 * - $this->shipmentData['possibleResults'] - Possible result options
 * - $this->shipmentData['eia'] - Existing EIA data
 * - $this->shipmentData['wb'] - Existing WB data
 * - $this->eia - EIA test kit options
 * - $this->wb - Western Blot test kit options
 * - $this->dtsPossibleResults - For DTS_TEST results in EIA/WB
 */

// ============================================================================
// MODE DETECTION & DATA NORMALIZATION
// ============================================================================

$isEditMode = isset($this->shipmentData) && !empty($this->shipmentData);

// Normalize possible results
$possibleResults = $isEditMode
    ? ($this->shipmentData['possibleResults'] ?? [])
    : ($this->dtsPossibleResults ?? []);

// Normalize samples/controls
$samples = $isEditMode
    ? ($this->shipmentData['reference'] ?? [])
    : [];

// Normalize EIA/WB options
$eiaOptions = $this->eia ?? [];
$wbOptions = $this->wb ?? [];

// Normalize EIA/WB data (for EDIT mode)
$eiaData = $isEditMode ? ($this->shipmentData['eia'] ?? []) : [];
$wbData = $isEditMode ? ($this->shipmentData['wb'] ?? []) : [];

// Build EIA sample ID list
$allEia = [];
foreach ($eiaData as $eia) {
    $allEia[] = $eia['sample_id'];
}

// Build WB sample ID list
$allWb = [];
foreach ($wbData as $wb) {
    $allWb[] = $wb['sample_id'];
}

// Date format helper
$vHelper = $this->getHelper('DateFormat');
$dtFormat = $vHelper->getDateFormat();

// Report type (for Malawi-specific fields)
$reportType = $this->reportType ?? '';

// Build possible results dropdown HTML for main table
$possibleResultsHtml = '<select name="possibleResults[]" class="isRequired form-control input-sm"><option value="">--' . $this->translate->_("Select") . '--</option>';
foreach ($possibleResults as $pr) {
    if ($pr['scheme_sub_group'] == 'DBS_FINAL') {
        $possibleResultsHtml .= '<option value="' . htmlspecialchars($pr['id']) . '">' . htmlspecialchars($pr['response']) . '</option>';
    }
}
$possibleResultsHtml .= '</select>';

// Build EIA choices HTML
$eiaChoicesHtml = '<option value="">--' . $this->translate->_("Select") . '--</option>';
foreach ($eiaOptions as $eiaId => $eiaName) {
    $eiaChoicesHtml .= '<option value="' . htmlspecialchars($eiaId) . '">' . htmlspecialchars($eiaName) . '</option>';
}

// Build WB choices HTML
$wbChoicesHtml = '<option value="">--' . $this->translate->_("Select") . '--</option>';
foreach ($wbOptions as $wbId => $wbName) {
    $wbChoicesHtml .= '<option value="' . htmlspecialchars($wbId) . '">' . htmlspecialchars($wbName) . '</option>';
}

// Build test results HTML (for EIA/WB result dropdowns)
$testResultsHtml = '<option value="">--' . $this->translate->_("Select") . '--</option>';
$dtsPossibleResults = $this->dtsPossibleResults ?? [];
foreach ($dtsPossibleResults as $pr) {
    if ($pr['scheme_sub_group'] == 'DTS_TEST') {
        $testResultsHtml .= '<option value="' . htmlspecialchars($pr['id']) . '">' . htmlspecialchars($pr['response']) . '</option>';
    }
}

// Escape for JavaScript strings
$possibleResultsJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $possibleResultsHtml);
$eiaChoicesJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $eiaChoicesHtml);
$wbChoicesJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $wbChoicesHtml);
$testResultsJs = str_replace(array("\n", "\r", "'"), array('', '', "\\'"), $testResultsHtml);
?>

<style type="text/css">
    .modal-scrollable {
        z-index: 1000 !important;
    }

    .modal-backdrop {
        z-index: 900 !important;
    }

    #mbd {
        overflow-y: scroll;
        max-height: 100%;
    }
</style>

<?php if (!empty($reportType) && $reportType == 'malawi'): ?>
    <div class="form-group">
        <label class="col-lg-3 control-label"><?= $this->translate->_("PT Co-ordinator Email"); ?></label>
        <div class="col-lg-5">
            <input type="text" name="ptEmail" id="ptEmail" placeholder="Enter PT Co-ordinator email"
                title="Please enter the PT Co-ordinator email" class="form-control input-sm isEmail" />
        </div>
    </div>
    <div class="form-group">
        <label class="col-lg-3 control-label"><?= $this->translate->_("PT Co-ordinator Phone Number"); ?></label>
        <div class="col-lg-5">
            <input type="text" name="ptPhone" id="ptPhone" placeholder="Enter PT Co-ordinator phone number"
                title="Please enter the PT Co-ordinator phone number" class="form-control input-sm isNumeric" />
        </div>
    </div>
<?php endif; ?>

<!-- DBS Sample Table -->
<table style="width: 100%; margin: 0 auto;" border="1" class="table table-bordered table-striped clearfix" id="<?php echo $isEditMode ? 'dbsSampleTable' : 'vlSampleTable'; ?>">
    <thead>
        <tr align="center">
            <th style="width:20%; text-align: center;"><?= $this->translate->_("Sample"); ?></th>
            <th style="text-align: center; vertical-align: middle;"><?= $this->translate->_("Sample Preparation Date"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Final Result"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Control?"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Mandatory?"); ?></th>
            <th style="width:10%; text-align: center;"><?= $this->translate->_("Score"); ?></th>
            <th style="width:20%; text-align: center;"><?= $this->translate->_("Options"); ?></th>
        </tr>
    </thead>
    <tbody>
        <?php
        $counter = 1;
        if ($isEditMode && count($samples) > 0):
            foreach ($samples as $sample):
                $sampleId = $sample['sample_id'] ?? '';
                $sampleLabel = $sample['sample_label'] ?? '';
                $samplePrepDate = isset($sample['sample_preparation_date']) ? $this->dateFormat($sample['sample_preparation_date']) : '';
                $referenceResult = $sample['reference_result'] ?? '';
                $control = $sample['control'] ?? '';
                $mandatory = $sample['mandatory'] ?? '';
                $sampleScore = $sample['sample_score'] ?? '';
        ?>
                <tr align="center">
                    <td style="text-align: center">
                        <input type="text" name="sampleName[]" class="isRequired input-sm form-control"
                            value="<?php echo htmlspecialchars($sampleLabel); ?>"
                            title="Please enter sample name here" placeholder="Please enter sample name here" />
                        <input type="hidden" id="sampleId" name="sampleId[]"
                            value="<?php echo htmlspecialchars($sampleId); ?>" />
                    </td>
                    <td>
                        <input type="text" name="samplePreparationDate[]" readonly="readonly"
                            class="isRequired form-control input-sm datepicker"
                            value="<?php echo htmlspecialchars($samplePrepDate); ?>"
                            placeholder="Please enter the sample preparation date"
                            title="Please enter the sample preparation date" />
                    </td>
                    <td>
                        <select name="possibleResults[]" class="isRequired form-control input-sm">
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <?php foreach ($possibleResults as $pr):
                                if ($pr['scheme_sub_group'] == 'DBS_FINAL'):
                            ?>
                                    <option value="<?php echo htmlspecialchars($pr['id']); ?>"
                                        <?php echo ($referenceResult == $pr['id']) ? 'selected="selected"' : ''; ?>>
                                        <?php echo htmlspecialchars($pr['response']); ?>
                                    </option>
                            <?php
                                endif;
                            endforeach;
                            ?>
                        </select>
                    </td>
                    <td>
                        <select name="control[]" class="isRequired controlOrNot form-control input-sm"
                            title="Please choose whether this sample is a control">
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <option value="1" <?php echo ($control == 1) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Yes"); ?></option>
                            <option value="0" <?php echo ($control == 0) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("No"); ?></option>
                        </select>
                    </td>
                    <td>
                        <select name="mandatory[]" class="isRequired form-control input-sm"
                            title="Please choose whether this sample/control is mandatory">
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <option value="1" <?php echo ($mandatory == 1) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Yes"); ?></option>
                            <option value="0" <?php echo ($mandatory == 0) ? 'selected="selected"' : ''; ?>><?= $this->translate->_("No"); ?></option>
                        </select>
                    </td>
                    <td>
                        <input type="text" name="score[]" class="isRequired score isNumeric form-control input-sm"
                            placeholder="Score" title="Please enter the score for this control/sample"
                            value="<?php echo htmlspecialchars($sampleScore); ?>" />
                    </td>
                    <td>
                        <a data-toggle="modal" href="#sampleEia<?php echo htmlspecialchars($sampleId); ?>"
                            class="btn btn-xs btn-primary" onclick="loadCal()">
                            <i class="icon-beaker"></i> <?= $this->translate->_("EIA"); ?>
                        </a>
                        <a data-toggle="modal" href="#sampleWb<?php echo htmlspecialchars($sampleId); ?>"
                            class="btn btn-xs btn-primary" onclick="loadCal()">
                            <i class="icon-beaker"></i> <?= $this->translate->_("WB"); ?>
                        </a>
                        <a href="javascript:void(0);" onclick="addDbsRow(this);" class="btn btn-xs btn-info">
                            <i class="icon-plus"></i> <?= $this->translate->_("Sample/Control"); ?>
                        </a>
                        <?php if ($counter > 1): ?>
                            <a href="javascript:void(0);" onclick="removeDbsRow(this,<?php echo htmlspecialchars($sampleId); ?>)"
                                class="btn btn-xs btn-danger" title="Remove this row completely">
                                <i class="icon-minus"></i>
                            </a>
                        <?php endif; ?>
                    </td>
                </tr>
                <!-- EIA Modal for this sample -->
                <tr style="display: none;">
                    <td colspan="7">
                        <div id="sampleEia<?php echo htmlspecialchars($sampleId); ?>" class="modal fade"
                            tabindex="-1" data-width="860" style="display: none;">
                            <div class="modal-header">
                                <h4 class="modal-title"><?= $this->translate->_("EIA"); ?></h4>
                            </div>
                            <div class="modal-body">
                                <div class="row">
                                    <div>
                                        <table style="width: 100%; margin: 0 auto;"
                                            class="table table-bordered table-striped clearfix">
                                            <thead>
                                                <tr align="center">
                                                    <th style="width:20%; text-align: center;"><?= $this->translate->_("EIA"); ?></th>
                                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Lot"); ?></th>
                                                    <th style="width:20%; text-align: center;"><?= $this->translate->_("Expiry"); ?></th>
                                                    <th style="width:10%; text-align: center;">OD</th>
                                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Cutoff"); ?></th>
                                                    <th style="width:20%; text-align: center;"><?= $this->translate->_("Result"); ?></th>
                                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Options"); ?></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <?php
                                                if (in_array($sampleId, $allEia)):
                                                    $k = 0;
                                                    foreach ($eiaData as $eia):
                                                        if ($eia['sample_id'] == $sampleId):
                                                ?>
                                                            <tr>
                                                                <td>
                                                                    <select class="form-control"
                                                                        name="eia[<?php echo htmlspecialchars($eia['sample_id']); ?>][eia][]">
                                                                        <?php $this->dropdownSelection($eiaOptions, $eia['eia'], true); ?>
                                                                    </select>
                                                                </td>
                                                                <td>
                                                                    <input type="text"
                                                                        name="eia[<?php echo htmlspecialchars($eia['sample_id']); ?>][lot][]"
                                                                        class="form-control"
                                                                        value="<?php echo htmlspecialchars($eia['lot'] ?? ''); ?>" />
                                                                </td>
                                                                <td>
                                                                    <input type="text"
                                                                        name="eia[<?php echo htmlspecialchars($eia['sample_id']); ?>][expiry][]"
                                                                        class="form-control datepicker" readonly="readonly"
                                                                        value="<?php echo isset($eia['exp_date']) ? $this->dateFormat($eia['exp_date']) : ''; ?>" />
                                                                </td>
                                                                <td>
                                                                    <input type="text"
                                                                        name="eia[<?php echo htmlspecialchars($eia['sample_id']); ?>][od][]"
                                                                        class="form-control"
                                                                        value="<?php echo htmlspecialchars($eia['od'] ?? ''); ?>" />
                                                                </td>
                                                                <td>
                                                                    <input type="text"
                                                                        name="eia[<?php echo htmlspecialchars($eia['sample_id']); ?>][cutoff][]"
                                                                        class="form-control"
                                                                        value="<?php echo htmlspecialchars($eia['cutoff'] ?? ''); ?>" />
                                                                </td>
                                                                <td>
                                                                    <select class="form-control"
                                                                        name="eia[<?php echo htmlspecialchars($eia['sample_id']); ?>][result][]">
                                                                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                                                        <?php foreach ($dtsPossibleResults as $pr):
                                                                            if ($pr['scheme_sub_group'] == 'DTS_TEST'):
                                                                        ?>
                                                                                <option value="<?php echo htmlspecialchars($pr['id']); ?>"
                                                                                    <?php echo (isset($pr['id']) && $pr['id'] == ($eia['result'] ?? '')) ? 'selected="selected"' : ''; ?>>
                                                                                    <?php echo htmlspecialchars($pr['response']); ?>
                                                                                </option>
                                                                        <?php
                                                                            endif;
                                                                        endforeach;
                                                                        ?>
                                                                    </select>
                                                                </td>
                                                                <td>
                                                                    <a href="javascript:void(0);"
                                                                        onclick="addNewEiaRow(this,<?php echo htmlspecialchars($eia['sample_id']); ?>)"
                                                                        class="btn btn-primary btn-xs">
                                                                        <i class="icon-plus"></i>
                                                                    </a>
                                                                    <?php if ($k > 0): ?>
                                                                        <a href="javascript:void(0);"
                                                                            onclick="removeDbsRow(this,'<?php echo htmlspecialchars($eia['sample_id']); ?>')"
                                                                            class="btn btn-xs btn-danger"
                                                                            title="Remove this row completely">
                                                                            <i class="icon-minus"></i>
                                                                        </a>
                                                                    <?php endif; ?>
                                                                </td>
                                                            </tr>
                                                <?php
                                                            $k++;
                                                        endif;
                                                    endforeach;
                                                else:
                                                ?>
                                                    <tr>
                                                        <td>
                                                            <select class="form-control"
                                                                name="eia[<?php echo htmlspecialchars($sampleId); ?>][eia][]">
                                                                <?php echo $eiaChoicesHtml; ?>
                                                            </select>
                                                        </td>
                                                        <td><input type="text" name="eia[<?php echo htmlspecialchars($sampleId); ?>][lot][]" class="form-control" value="" /></td>
                                                        <td><input type="text" name="eia[<?php echo htmlspecialchars($sampleId); ?>][expiry][]" class="form-control datepicker" readonly="readonly" value="" /></td>
                                                        <td><input type="text" name="eia[<?php echo htmlspecialchars($sampleId); ?>][od][]" class="form-control" value="" /></td>
                                                        <td><input type="text" name="eia[<?php echo htmlspecialchars($sampleId); ?>][cutoff][]" class="form-control" value="" /></td>
                                                        <td>
                                                            <select class="form-control"
                                                                name="eia[<?php echo htmlspecialchars($sampleId); ?>][result][]">
                                                                <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                                                <?php foreach ($dtsPossibleResults as $pr):
                                                                    if ($pr['scheme_sub_group'] == 'DTS_TEST'):
                                                                ?>
                                                                        <option value="<?php echo htmlspecialchars($pr['id']); ?>">
                                                                            <?php echo htmlspecialchars($pr['response']); ?>
                                                                        </option>
                                                                <?php
                                                                    endif;
                                                                endforeach;
                                                                ?>
                                                            </select>
                                                        </td>
                                                        <td>
                                                            <a href="javascript:void(0);"
                                                                onclick="addNewEiaRow(this,<?php echo htmlspecialchars($sampleId); ?>)"
                                                                class="btn btn-primary btn-xs">
                                                                <i class="icon-plus"></i>
                                                            </a>
                                                        </td>
                                                    </tr>
                                                <?php endif; ?>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" data-dismiss="modal" class="btn btn-primary">OK</button>
                            </div>
                        </div>
                    </td>
                </tr>
                <!-- WB Modal for this sample -->
                <tr style="display: none;">
                    <td colspan="7">
                        <div id="sampleWb<?php echo htmlspecialchars($sampleId); ?>" class="modal fade"
                            tabindex="-1" data-width="960" style="display: none;">
                            <div class="modal-header">
                                <h4 class="modal-title"><?= $this->translate->_("WB"); ?></h4>
                            </div>
                            <div class="modal-body">
                                <div class="row" style="overflow-x: scroll;">
                                    <div>
                                        <table style="width: 100%; margin: 0 auto;"
                                            class="table table-bordered table-striped clearfix">
                                            <thead>
                                                <tr align="center">
                                                    <th style="text-align: center;">WB</th>
                                                    <th style="text-align: center;">Lot</th>
                                                    <th style="text-align: center;">Expiry</th>
                                                    <th style="text-align: center;">160</th>
                                                    <th style="text-align: center;">120</th>
                                                    <th style="text-align: center;">66</th>
                                                    <th style="text-align: center;">55</th>
                                                    <th style="text-align: center;">51</th>
                                                    <th style="text-align: center;">41</th>
                                                    <th style="text-align: center;">31</th>
                                                    <th style="text-align: center;">24</th>
                                                    <th style="text-align: center;">17</th>
                                                    <th style="text-align: center;"><?= $this->translate->_("Result"); ?></th>
                                                    <th style="text-align: center;"><?= $this->translate->_("Options"); ?></th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                <?php
                                                if (in_array($sampleId, $allWb)):
                                                    $k = 0;
                                                    foreach ($wbData as $wb):
                                                        if ($wb['sample_id'] == $sampleId):
                                                ?>
                                                            <tr>
                                                                <td>
                                                                    <select class="form-control"
                                                                        name="wb[<?php echo htmlspecialchars($wb['sample_id']); ?>][wb][]"
                                                                        style="width:125px;">
                                                                        <?php $this->dropdownSelection($wbOptions, $wb['wb'], true); ?>
                                                                    </select>
                                                                </td>
                                                                <td>
                                                                    <input type="text"
                                                                        name="wb[<?php echo htmlspecialchars($wb['sample_id']); ?>][lot][]"
                                                                        class="form-control" style="width:100px;"
                                                                        value="<?php echo htmlspecialchars($wb['lot'] ?? ''); ?>" />
                                                                </td>
                                                                <td>
                                                                    <input type="text"
                                                                        name="wb[<?php echo htmlspecialchars($wb['sample_id']); ?>][expiry][]"
                                                                        class="form-control datepicker" readonly="readonly"
                                                                        style="width:125px;"
                                                                        value="<?php echo isset($wb['exp_date']) ? $this->dateFormat($wb['exp_date']) : ''; ?>" />
                                                                </td>
                                                                <?php
                                                                $wbBands = ['160', '120', '66', '55', '51', '41', '31', '24', '17'];
                                                                foreach ($wbBands as $band):
                                                                ?>
                                                                    <td>
                                                                        <select name="wb[<?php echo htmlspecialchars($wb['sample_id']); ?>][<?php echo $band; ?>][]"
                                                                            style="width:70px; font-weight:bold;" class="form-control">
                                                                            <option value=""></option>
                                                                            <option value="1" <?php echo (isset($wb[$band]) && $wb[$band] == 1) ? 'selected="selected"' : ''; ?>>+</option>
                                                                            <option value="0" <?php echo (isset($wb[$band]) && $wb[$band] == 0) ? 'selected="selected"' : ''; ?>>-</option>
                                                                        </select>
                                                                    </td>
                                                                <?php endforeach; ?>
                                                                <td>
                                                                    <select class="form-control"
                                                                        name="wb[<?php echo htmlspecialchars($wb['sample_id']); ?>][result][]">
                                                                        <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                                                                        <?php foreach ($dtsPossibleResults as $pr):
                                                                            if ($pr['scheme_sub_group'] == 'DTS_TEST'):
                                                                        ?>
                                                                                <option value="<?php echo htmlspecialchars($pr['id']); ?>"
                                                                                    <?php echo (isset($pr['id']) && $pr['id'] == ($wb['result'] ?? '')) ? 'selected="selected"' : ''; ?>>
                                                                                    <?php echo htmlspecialchars($pr['response']); ?>
                                                                                </option>
                                                                        <?php
                                                                            endif;
                                                                        endforeach;
                                                                        ?>
                                                                    </select>
                                                                </td>
                                                                <td>
                                                                    <a href="javascript:void(0);"
                                                                        onclick="addNewWbRow(this,<?php echo htmlspecialchars($wb['sample_id']); ?>)"
                                                                        class="btn btn-primary btn-xs">
                                                                        <i class="icon-plus"></i>
                                                                    </a>
                                                                    <?php if ($k > 0): ?>
                                                                        <a href="javascript:void(0);"
                                                                            onclick="removeWbRow(this,'<?php echo htmlspecialchars($wb['sample_id']); ?>')"
                                                                            class="btn btn-xs btn-danger"
                                                                            title="Remove this row completely">
                                                                            <i class="icon-minus"></i>
                                                                        </a>
                                                                    <?php endif; ?>
                                                                </td>
                                                            </tr>
                                                <?php
                                                            $k++;
                                                        endif;
                                                    endforeach;
                                                else:
                                                ?>
                                                    <tr>
                                                        <td>
                                                            <select class="form-control"
                                                                name="wb[<?php echo htmlspecialchars($sampleId); ?>][wb][]"
                                                                style="width:125px;">
                                                                <?php echo $wbChoicesHtml; ?>
                                                            </select>
                                                        </td>
                                                        <td><input type="text" name="wb[<?php echo htmlspecialchars($sampleId); ?>][lot][]" class="form-control" style="width:100px;" /></td>
                                                        <td><input type="text" name="wb[<?php echo htmlspecialchars($sampleId); ?>][expiry][]" class="form-control datepicker" readonly="readonly" style="width:125px;" /></td>
                                                        <?php foreach (['160', '120', '66', '55', '51', '41', '31', '24', '17'] as $band): ?>
                                                            <td>
                                                                <select name="wb[<?php echo htmlspecialchars($sampleId); ?>][<?php echo $band; ?>][]"
                                                                    style="width:70px; font-weight:bold;" class="form-control">
                                                                    <option value=""></option>
                                                                    <option value="1">+</option>
                                                                    <option value="0">-</option>
                                                                </select>
                                                            </td>
                                                        <?php endforeach; ?>
                                                        <td>
                                                            <a href="javascript:void(0);"
                                                                onclick="addNewWbRow(this,<?php echo htmlspecialchars($sampleId); ?>)"
                                                                class="btn btn-primary btn-xs">
                                                                <i class="icon-plus"></i>
                                                            </a>
                                                        </td>
                                                    </tr>
                                                <?php endif; ?>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                            <div class="modal-footer">
                                <button type="button" data-dismiss="modal" class="btn btn-primary"><?= $this->translate->_("OK"); ?></button>
                            </div>
                        </div>
                    </td>
                </tr>
        <?php
                $counter++;
            endforeach;
        else:
            // ADD mode or EDIT mode with no samples - show empty row
        ?>
            <tr align="center">
                <td style="text-align: center">
                    <input type="text" name="sampleName[]" class="isRequired input-sm form-control"
                        title="Please enter sample name here" placeholder="Please enter sample name here" />
                </td>
                <td>
                    <input type="text" name="samplePreparationDate[]" readonly="readonly"
                        class="isRequired form-control input-sm datepicker"
                        placeholder="Please enter the sample preparation date"
                        title="Please enter the sample preparation date" />
                </td>
                <td>
                    <?php echo $possibleResultsHtml; ?>
                </td>
                <td>
                    <select name="control[]" class="isRequired controlOrNot form-control input-sm"
                        title="Please choose whether this sample is a control">
                        <?php if ($isEditMode): ?>
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <option value="1"><?= $this->translate->_("Yes"); ?></option>
                            <option value="0"><?= $this->translate->_("No"); ?></option>
                        <?php else: ?>
                            <option value="1"><?= $this->translate->_("Yes"); ?></option>
                            <option value="0" selected="selected"><?= $this->translate->_("No"); ?></option>
                        <?php endif; ?>
                    </select>
                </td>
                <td>
                    <select name="mandatory[]" class="isRequired form-control input-sm"
                        title="Please choose whether this sample/control is mandatory">
                        <?php if ($isEditMode): ?>
                            <option value="">-- <?= $this->translate->_("Select"); ?> --</option>
                            <option value="1"><?= $this->translate->_("Yes"); ?></option>
                            <option value="0"><?= $this->translate->_("No"); ?></option>
                        <?php else: ?>
                            <option value="1" selected="selected"><?= $this->translate->_("Yes"); ?></option>
                            <option value="0"><?= $this->translate->_("No"); ?></option>
                        <?php endif; ?>
                    </select>
                </td>
                <td>
                    <input type="text" name="score[]" class="isRequired score isNumeric form-control input-sm"
                        placeholder="Score" title="Please enter the score for this control/sample" />
                </td>
                <td>
                    <?php if ($isEditMode): ?>
                        <a data-toggle="modal" href="#sampleEia1" class="btn btn-xs btn-primary" onclick="loadCal()">
                            <i class="icon-beaker"></i> <?= $this->translate->_("EIA"); ?>
                        </a>
                        <a data-toggle="modal" href="#sampleWb1" class="btn btn-xs btn-primary" onclick="loadCal()">
                            <i class="icon-beaker"></i> <?= $this->translate->_("WB"); ?>
                        </a>
                    <?php else: ?>
                        <a href="javascript:void(0);" class="btn btn-xs btn-primary"
                            onclick="showdefModal('sampleEia1', 900, 500); loadCal()">
                            <i class="icon-beaker"></i> <?= $this->translate->_("EIA"); ?>
                        </a>
                        <a href="javascript:void(0);" class="btn btn-xs btn-primary"
                            onclick="showdefModal('sampleWb1', 900, 500); loadCal()">
                            <i class="icon-beaker"></i> <?= $this->translate->_("WB"); ?>
                        </a>
                    <?php endif; ?>
                    <a href="javascript:void(0);" onclick="addDbsRow(this);" class="btn btn-xs btn-info">
                        <i class="icon-plus"></i> <?= $this->translate->_("Sample/Control"); ?>
                    </a>
                    <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger"
                        title="Remove this row completely">
                        <i class="icon-minus"></i>
                    </a>
                </td>
            </tr>
        <?php endif; ?>
    </tbody>
</table>
<br>
<div id="eiaBlockHolder"></div>
<div id="wbBlockHolder"></div>

<!-- DBS-specific JavaScript -->
<script type="text/javascript">
    var sampleCounter = <?php echo $isEditMode && count($samples) > 0 ? count($samples) : 1; ?>;

    $(document).ready(function() {
        <?php if ($isEditMode): ?>
            $(".datepicker").on("click", function() {
                $(this).datepicker({
                    dateFormat: '<?php echo $dtFormat; ?>'
                });
            });
            sampleCounter = $("#dbsSampleTable tbody tr").length;
            <?php
            if (count($samples) > 0):
                $i = 1;
                foreach ($samples as $sample):
            ?>
                    addNewEiaBlock('<?php echo $i; ?>');
                    addNewWbBlock('<?php echo $i; ?>');
            <?php
                    $i++;
                endforeach;
            else:
            ?>
                addNewEiaBlock(sampleCounter);
                addNewWbBlock(sampleCounter);
            <?php endif; ?>
        <?php else: ?>
            addNewEiaBlock('1');
            addNewWbBlock('1');
        <?php endif; ?>

        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    });

    function addDbsRow(obj) {
        sampleCounter++;
        <?php if ($isEditMode): ?>
        $(obj.parentNode.parentNode).after('<tr align="center"> \
            <td style="text-align: center"> \
                <input type="text" name="sampleName[]" class="isRequired input-sm form-control" title="Please enter sample name here" placeholder="Please enter sample name here"/> \
            </td> \
            <td> \
                <input type="text" name="samplePreparationDate[]" readonly="readonly" class="isRequired form-control input-sm datepicker" placeholder="Please enter the sample preparation date" title="Please enter the sample preparation date" /> \
            </td> \
            <td><?php echo $possibleResultsJs; ?></td> \
            <td> \
                <select name="control[]" class="isRequired controlOrNot form-control input-sm" title="Please choose whether this sample is a control"> \
                    <option value="1"><?= $this->translate->_("Yes"); ?></option> \
                    <option value="0" selected="selected"><?= $this->translate->_("No"); ?></option> \
                </select> \
            </td> \
            <td> \
                <select name="mandatory[]" class="isRequired form-control input-sm" title="Please choose whether this sample/control is mandatory"> \
                    <option value="1" selected="selected"><?= $this->translate->_("Yes"); ?></option> \
                    <option value="0"><?= $this->translate->_("No"); ?></option> \
                </select> \
            </td> \
            <td><input type="text" name="score[]" class="isRequired score isNumeric form-control input-sm" placeholder="Score" title="Please enter the score for this control/sample" /></td> \
            <td> \
                <a data-toggle="modal" href="#sampleEia' + sampleCounter + '" class="btn btn-xs btn-primary" onclick="loadCal()"><i class="icon-beaker"></i> <?= $this->translate->_("EIA"); ?> </a> \
                <a data-toggle="modal" href="#sampleWb' + sampleCounter + '" class="btn btn-xs btn-primary" onclick="loadCal()"><i class="icon-beaker"></i> <?= $this->translate->_("WB"); ?> </a> \
                <a href="javascript:void(0);" onclick="addDbsRow(this);" class="btn btn-xs btn-info"><i class="icon-plus"></i> <?= $this->translate->_("Sample/Control"); ?></a> \
                <a href="javascript:void(0);" onclick="removeDbsRow(this,' + sampleCounter + ')" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a> \
            </td> \
        </tr>');
        <?php else: ?>
        $(obj.parentNode.parentNode).after('<tr align="center"> \
            <td style="text-align: center"> \
                <input type="text" name="sampleName[]" class="isRequired input-sm form-control" title="Please enter sample name here" placeholder="Please enter sample name here"/> \
            </td> \
            <td> \
                <input type="text" name="samplePreparationDate[]" readonly="readonly" class="isRequired form-control input-sm datepicker" placeholder="Please enter the sample preparation date" title="Please enter the sample preparation date" /> \
            </td> \
            <td><?php echo $possibleResultsJs; ?></td> \
            <td> \
                <select name="control[]" class="isRequired controlOrNot form-control input-sm" title="Please choose whether this sample is a control"> \
                    <option value="1"><?= $this->translate->_("Yes"); ?></option> \
                    <option value="0" selected="selected"><?= $this->translate->_("No"); ?></option> \
                </select> \
            </td> \
            <td> \
                <select name="mandatory[]" class="isRequired form-control input-sm" title="Please choose whether this sample/control is mandatory"> \
                    <option value="1" selected="selected"><?= $this->translate->_("Yes"); ?></option> \
                    <option value="0"><?= $this->translate->_("No"); ?></option> \
                </select> \
            </td> \
            <td><input type="text" name="score[]" class="isRequired score isNumeric form-control input-sm" placeholder="Score" title="Please enter the score for this control/sample" /></td> \
            <td> \
                <a href="javascript:void(0);" class="btn btn-xs btn-primary" onclick="showdefModal(\'sampleEia' + sampleCounter + '\', 900, 500); loadCal()"><i class="icon-beaker"></i> <?= $this->translate->_("EIA"); ?> </a> \
                <a href="javascript:void(0);" class="btn btn-xs btn-primary" onclick="showdefModal(\'sampleWb' + sampleCounter + '\', 900, 500); loadCal()"><i class="icon-beaker"></i> <?= $this->translate->_("WB"); ?> </a> \
                <a href="javascript:void(0);" onclick="addDbsRow(this);" class="btn btn-xs btn-info"><i class="icon-plus"></i> <?= $this->translate->_("Sample/Control"); ?></a> \
                <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a> \
            </td> \
        </tr>');
        <?php endif; ?>
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
        addNewEiaBlock(sampleCounter);
        addNewWbBlock(sampleCounter);
    }

    function removeRow(obj) {
        $(obj.parentNode.parentNode).fadeOut("normal", function() {
            $(this).remove();
        });
    }

    function removeDbsRow(obj, sampleId) {
        $(obj.parentNode.parentNode).fadeOut("normal", function() {
            $(this).remove();
            $('#sampleEia' + sampleId).remove();
            $('#sampleWb' + sampleId).remove();
        });
    }

    function addNewEiaBlock(sampleId) {
        <?php if ($isEditMode): ?>
        $("#eiaBlockHolder").after('<div id="sampleEia' + sampleId + '" class="modal fade" tabindex="-1" data-width="860" style="display: none;"> \
            <div class="modal-header"> \
                <h4 class="modal-title"><?= $this->translate->_("EIA"); ?></h4> \
            </div> \
            <div class="modal-body"> \
                <div class="row"> \
                    <div> \
                        <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix"> \
                            <thead> \
                                <tr align="center"> \
                                    <th style="width:20%; text-align: center;"><?= $this->translate->_("EIA"); ?></th> \
                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Lot"); ?></th> \
                                    <th style="width:12%; text-align: center;"><?= $this->translate->_("Expiry"); ?></th> \
                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("OD"); ?></th> \
                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Cutoff"); ?></th> \
                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Result"); ?></th> \
                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Options"); ?></th> \
                                </tr> \
                            </thead> \
                            <tbody> \
                                <tr> \
                                    <td><select class="form-control" name="eia[' + sampleId + '][eia][]"><?php echo $eiaChoicesJs; ?></select></td> \
                                    <td><input type="text" name="eia[' + sampleId + '][lot][]" class="form-control"/></td> \
                                    <td><input type="text" name="eia[' + sampleId + '][expiry][]" class="form-control datepicker"/></td> \
                                    <td><input type="text" name="eia[' + sampleId + '][od][]" class="form-control"/></td> \
                                    <td><input type="text" name="eia[' + sampleId + '][cutoff][]" class="form-control"/></td> \
                                    <td><select class="form-control" name="eia[' + sampleId + '][result][]"><?php echo $testResultsJs; ?></select></td> \
                                    <td> \
                                        <a href="javascript:void(0);" onclick="addNewEiaRow(this,' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a> \
                                    </td> \
                                </tr> \
                            </tbody> \
                        </table> \
                    </div> \
                </div> \
            </div> \
            <div class="modal-footer"> \
                <button type="button" data-dismiss="modal" class="btn btn-primary">OK</button> \
            </div> \
        </div>');
        <?php else: ?>
        $("#eiaBlockHolder").after('<div id="sampleEia' + sampleId + '" class="dialog"> \
            <span onClick="hidedefModal()" class="closeModal"></span> \
            <div class="modal-header"> \
                <h4 class="modal-title"><?= $this->translate->_("EIA"); ?></h4> \
            </div> \
            <div class="modal-body"> \
                <div class="row"> \
                    <div> \
                        <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix"> \
                            <thead> \
                                <tr align="center"> \
                                    <th style="width:20%; text-align: center;"><?= $this->translate->_("EIA"); ?></th> \
                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Lot"); ?></th> \
                                    <th style="width:12%; text-align: center;"><?= $this->translate->_("Expiry"); ?></th> \
                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("OD"); ?></th> \
                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Cutoff"); ?></th> \
                                    <th style="width:10%; text-align: center;"><?= $this->translate->_("Options"); ?></th> \
                                </tr> \
                            </thead> \
                            <tbody> \
                                <tr> \
                                    <td><select class="form-control" name="eia[' + sampleId + '][eia][]"><?php echo $eiaChoicesJs; ?></select></td> \
                                    <td><input type="text" name="eia[' + sampleId + '][lot][]" class="form-control"/></td> \
                                    <td><input type="text" name="eia[' + sampleId + '][expiry][]" class="form-control datepicker" readonly="readonly"/></td> \
                                    <td><input type="text" name="eia[' + sampleId + '][od][]" class="form-control"/></td> \
                                    <td><input type="text" name="eia[' + sampleId + '][cutoff][]" class="form-control"/></td> \
                                    <td> \
                                        <a href="javascript:void(0);" onclick="addNewEiaRow(this,' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a> \
                                    </td> \
                                </tr> \
                            </tbody> \
                        </table> \
                    </div> \
                </div> \
            </div> \
            <div class="modal-footer"> \
                <button type="button" class="btn btn-primary" onclick="closeShipmentModal(\'sampleEia' + sampleId + '\')">OK</button> \
            </div> \
        </div>');
        <?php endif; ?>
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    }

    function addNewEiaRow(obj, sampleId) {
        <?php if ($isEditMode): ?>
        $(obj.parentNode.parentNode).after('<tr> \
            <td><select class="form-control" name="eia[' + sampleId + '][eia][]"><?php echo $eiaChoicesJs; ?></select></td> \
            <td><input type="text" name="eia[' + sampleId + '][lot][]" class="form-control"/></td> \
            <td><input type="text" name="eia[' + sampleId + '][expiry][]" class="form-control datepicker" readonly="readonly"/></td> \
            <td><input type="text" name="eia[' + sampleId + '][od][]" class="form-control"/></td> \
            <td><input type="text" name="eia[' + sampleId + '][cutoff][]" class="form-control"/></td> \
            <td><select class="form-control" name="eia[' + sampleId + '][result][]"><?php echo $testResultsJs; ?></select></td> \
            <td> \
                <a href="javascript:void(0);" onclick="addNewEiaRow(this,' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a> \
                <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a> \
            </td> \
        </tr>');
        <?php else: ?>
        $(obj.parentNode.parentNode).after('<tr> \
            <td><select class="form-control" name="eia[' + sampleId + '][eia][]"><?php echo $eiaChoicesJs; ?></select></td> \
            <td><input type="text" name="eia[' + sampleId + '][lot][]" class="form-control"/></td> \
            <td><input type="text" name="eia[' + sampleId + '][expiry][]" class="form-control datepicker" readonly="readonly"/></td> \
            <td><input type="text" name="eia[' + sampleId + '][od][]" class="form-control"/></td> \
            <td><input type="text" name="eia[' + sampleId + '][cutoff][]" class="form-control"/></td> \
            <td> \
                <a href="javascript:void(0);" onclick="addNewEiaRow(this,' + sampleId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a> \
                <a href="javascript:void(0);" onclick="removeRow(this)" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a> \
            </td> \
        </tr>');
        <?php endif; ?>
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    }

    function addNewWbBlock(sampleWbId) {
        <?php if ($isEditMode): ?>
        $("#wbBlockHolder").after('<div id="sampleWb' + sampleWbId + '" class="modal fade" tabindex="-1" data-width="960" style="display: none;"> \
            <div class="modal-header"> \
                <h4 class="modal-title"><?= $this->translate->_("WB"); ?></h4> \
            </div> \
            <div class="modal-body"> \
                <div class="row" style="overflow-x: scroll;"> \
                    <div> \
                        <table style="width: 100%; margin: 0 auto; overflow: scroll" class="table table-bordered table-striped clearfix"> \
                            <thead> \
                                <tr align="center"> \
                                    <th style="text-align: center;">WB</th> \
                                    <th style="text-align: center;">Lot</th> \
                                    <th style="text-align: center;">Expiry</th> \
                                    <th style="text-align: center;">160</th> \
                                    <th style="text-align: center;">120</th> \
                                    <th style="text-align: center;">66</th> \
                                    <th style="text-align: center;">55</th> \
                                    <th style="text-align: center;">51</th> \
                                    <th style="text-align: center;">41</th> \
                                    <th style="text-align: center;">31</th> \
                                    <th style="text-align: center;">24</th> \
                                    <th style="text-align: center;">17</th> \
                                    <th style="text-align: center;"><?= $this->translate->_("Options"); ?></th> \
                                </tr> \
                            </thead> \
                            <tbody> \
                                <tr> \
                                    <td><select class="form-control" name="wb[' + sampleWbId + '][wb][]" style="width:125px;"><?php echo $wbChoicesJs; ?></select></td> \
                                    <td><input type="text" name="wb[' + sampleWbId + '][lot][]" class="form-control" style="width:100px;"/></td> \
                                    <td><input type="text" name="wb[' + sampleWbId + '][expiry][]" class="form-control datepicker" readonly="readonly" style="width:125px;"/></td> \
                                    <td><select name="wb[' + sampleWbId + '][160][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][120][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][66][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][55][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][51][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][41][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][31][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][24][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][17][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td> \
                                        <a href="javascript:void(0);" onclick="addNewWbRow(this,' + sampleWbId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a> \
                                    </td> \
                                </tr> \
                            </tbody> \
                        </table> \
                    </div> \
                </div> \
            </div> \
            <div class="modal-footer"> \
                <button type="button" data-dismiss="modal" class="btn btn-primary"><?= $this->translate->_("OK"); ?></button> \
            </div> \
        </div>');
        <?php else: ?>
        $("#wbBlockHolder").after('<div id="sampleWb' + sampleWbId + '" class="dialog" tabindex="-1"> \
            <span onClick="hidedefModal()" class="closeModal"></span> \
            <div class="modal-header"> \
                <h4 class="modal-title"><?= $this->translate->_("WB"); ?></h4> \
            </div> \
            <div class="modal-body"> \
                <div class="row" style="overflow-x: scroll;"> \
                    <div> \
                        <table style="width: 100%; margin: 0 auto;" class="table table-bordered table-striped clearfix"> \
                            <thead> \
                                <tr align="center"> \
                                    <th style="text-align: center;"><?= $this->translate->_("WB"); ?></th> \
                                    <th style="text-align: center;"><?= $this->translate->_("Lot"); ?></th> \
                                    <th style="text-align: center;"><?= $this->translate->_("Expiry"); ?></th> \
                                    <th style="text-align: center;">160</th> \
                                    <th style="text-align: center;">120</th> \
                                    <th style="text-align: center;">66</th> \
                                    <th style="text-align: center;">55</th> \
                                    <th style="text-align: center;">51</th> \
                                    <th style="text-align: center;">41</th> \
                                    <th style="text-align: center;">31</th> \
                                    <th style="text-align: center;">24</th> \
                                    <th style="text-align: center;">17</th> \
                                    <th style="text-align: center;"><?= $this->translate->_("Options"); ?></th> \
                                </tr> \
                            </thead> \
                            <tbody> \
                                <tr> \
                                    <td><select class="form-control" name="wb[' + sampleWbId + '][wb][]" style="width:125px;"><?php echo $wbChoicesJs; ?></select></td> \
                                    <td><input type="text" name="wb[' + sampleWbId + '][lot][]" class="form-control" style="width:100px;"/></td> \
                                    <td><input type="text" name="wb[' + sampleWbId + '][expiry][]" class="form-control datepicker" readonly="readonly" style="width:125px;"/></td> \
                                    <td><select name="wb[' + sampleWbId + '][160][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][120][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][66][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][55][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][51][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][41][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][31][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][24][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td><select name="wb[' + sampleWbId + '][17][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
                                    <td> \
                                        <a href="javascript:void(0);" onclick="addNewWbRow(this,' + sampleWbId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a> \
                                    </td> \
                                </tr> \
                            </tbody> \
                        </table> \
                    </div> \
                </div> \
            </div> \
            <div class="modal-footer"> \
                <button type="button" class="btn btn-primary" onclick="closeShipmentModal(\'sampleWb' + sampleWbId + '\')"><?= $this->translate->_("OK"); ?></button> \
            </div> \
        </div>');
        <?php endif; ?>
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    }

    function addNewWbRow(obj, sampleWbId) {
        $(obj.parentNode.parentNode).after('<tr> \
            <td><select class="form-control" name="wb[' + sampleWbId + '][wb][]" style="width:125px;"><?php echo $wbChoicesJs; ?></select></td> \
            <td><input type="text" name="wb[' + sampleWbId + '][lot][]" class="form-control" style="width:100px;"/></td> \
            <td><input type="text" name="wb[' + sampleWbId + '][expiry][]" class="form-control datepicker" readonly="readonly" style="width:125px;"/></td> \
            <td><select name="wb[' + sampleWbId + '][160][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
            <td><select name="wb[' + sampleWbId + '][120][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
            <td><select name="wb[' + sampleWbId + '][66][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
            <td><select name="wb[' + sampleWbId + '][55][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
            <td><select name="wb[' + sampleWbId + '][51][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
            <td><select name="wb[' + sampleWbId + '][41][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
            <td><select name="wb[' + sampleWbId + '][31][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
            <td><select name="wb[' + sampleWbId + '][24][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
            <td><select name="wb[' + sampleWbId + '][17][]" style="width:70px; font-weight:bold;" class="form-control"><option value=""></option><option value="1">+</option><option value="0">-</option></select></td> \
            <td> \
                <a href="javascript:void(0);" onclick="addNewWbRow(this,' + sampleWbId + ')" class="btn btn-primary btn-xs"><i class="icon-plus"></i></a> \
                <a href="javascript:void(0);" onclick="removeWbRow(this,' + sampleWbId + ')" class="btn btn-xs btn-danger" title="Remove this row completely"><i class="icon-minus"></i></a> \
            </td> \
        </tr>');
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    }

    function removeWbRow(obj, sampleId) {
        $(obj.parentNode.parentNode).fadeOut("normal", function() {
            $(this).remove();
        });
    }

    function loadCal() {
        $(".datepicker").removeClass("hasDatepicker");
        $(".datepicker").datepicker({
            dateFormat: '<?php echo $dtFormat; ?>'
        });
    }

    <?php if (!$isEditMode): ?>
    function closeShipmentModal(divId) {
        var modalDiv = document.getElementById(divId);
        var mbdDiv = document.getElementById("mbd");
        if (modalDiv && mbdDiv) {
            // Clone the content instead of using innerHTML
            while (modalDiv.firstChild) {
                modalDiv.removeChild(modalDiv.firstChild);
            }
            var children = mbdDiv.childNodes;
            for (var i = 0; i < children.length; i++) {
                modalDiv.appendChild(children[i].cloneNode(true));
            }
        }

        $("#mbd input:text").each(function(i, obj) {
            $("#" + divId + " input:text:eq(" + i + ")").val($(this).val());
        });
        $("#mbd select").each(function(i, obj) {
            $("#" + divId + " select:eq(" + i + ")").val($(this).val());
        });

        hidedefModal();
    }
    <?php endif; ?>
</script>
