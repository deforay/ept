<?php
$dtsConfig = $this->dtsConfig;
if (is_string($dtsConfig) && Application_Service_Common::isJSON($dtsConfig)) {
	$dtsConfig = json_decode($dtsConfig);
} elseif (is_array($dtsConfig)) {
	$dtsConfig = (object) $dtsConfig;
}
$shipmentData = $this->shipmentData;
$shipmentAttribute = json_decode($shipmentData['shipment']['shipment_attributes'], true);
$vHelper = $this->getHelper('DateFormat');
$dtFormat = $vHelper->getDateFormat();
$style = '';
if ($shipmentData['shipment']['scheme_type'] == 'tb') {
	$style = 'style=" width: 1550px; margin-left: -208px; "';
}

$allowedAlgorithms = $dtsConfig->allowedAlgorithms;
if (!is_array($allowedAlgorithms))
	$allowedAlgorithms = explode(',', $allowedAlgorithms);
$dtsSchemeType = $dtsConfig->dtsSchemeType ?? 'standard';
$rtriEnabled = $dtsConfig->rtriEnabled ?? 'no';
?>

<style type="text/css">
	.modal-scrollable {
		z-index: 1000 !important;

	}

	.modal-backdrop {
		z-index: 900 !important;
	}

	#mbd {
		overflow-y: scroll;
		max-height: 100%;
	}

	thead tr th {
		text-align: center;
	}
</style>
<div class="well" <?php echo $style; ?>>
	<fieldset class="container">
		<legend><?= $this->translate->_("Update Shipment Sample Details"); ?> -
			<?php echo $shipmentData['shipment']['shipment_code']; ?>
		</legend>
		<form class="form-horizontal" name="shipmentForm" id="shipmentForm" method="post"
			action="<?php echo $this->url(array('module' => 'admin', 'controller' => 'shipment', 'action' => 'edit')); ?>"
			autocomplete="off">
			<div class="form-group">
				<label class="col-lg-3 control-label"><?= $this->translate->_("Distribution Code"); ?> </label>

				<div class="col-lg-5">
					<input type='text' disabled='disabled' class='form-control'
						value='<?php echo $shipmentData['shipment']['distribution_code']; ?>' />
				</div>

				<input type="hidden" name="shipmentId" id="shipmentId"
					value="<?php echo $shipmentData['shipment']['shipment_id']; ?>" class="isRequired"
					title="Please choose a Scheme Type on the top of this page" />
				<input type="hidden" name="selectedDistribution" id="selectedDistribution" class=""
					value="<?php echo $this->selectedDistribution; ?>" />

			</div>
			<div class="form-group">
				<label class="col-lg-3 control-label"><?= $this->translate->_("Shipment Code"); ?> </label>
				<div class="col-lg-5">
					<input type='text' name="shipmentCode" id="shipmentCode" class='form-control isRequired'
						value='<?php echo $shipmentData['shipment']['shipment_code']; ?>'
						title="Please enter the Shipment Code" />
				</div>
			</div>
			<div class="form-group">
				<label class="col-lg-3 control-label"><?= $this->translate->_("Result Due Date"); ?></label>

				<div class="col-lg-5">
					<input type='text' readonly='readonly' name="lastDate" id="lastDate"
						class='form-control datepicker isRequired'
						value='<?php echo $this->dateFormat($shipmentData['shipment']['lastdate_response']); ?>'
						title="Please choose the last response date" />
				</div>
			</div>
			<div class="form-group">
				<label class="col-lg-3 control-label"
					for="allowEditingResponse"><?= $this->translate->_("Allow Editing Response"); ?> <span
						class="mandatory">*</span></label>
				<div class="col-lg-5">
					<select id="allowEditingResponse" name="allowEditingResponse"
						class="isRequired form-control input-sm" title="Please select a allow editing response yes/no">
						<option value="">-- <?= $this->translate->_("Select"); ?> --</option>
						<option value="yes" <?php echo (isset($shipmentData['shipment']['allow_editing_response']) && $shipmentData['shipment']['allow_editing_response'] == 'yes') ? 'selected="selected"' : ''; ?>>Yes</option>
						<option value="no" <?php echo (isset($shipmentData['shipment']['allow_editing_response']) && $shipmentData['shipment']['allow_editing_response'] == 'no') ? 'selected="selected"' : ''; ?>>
							No</option>
					</select>
				</div>
			</div>
			<div class="form-group">
				<label class="col-lg-3 control-label"
					for="issuingAuthority"><?= $this->translate->_("Issuing Authority"); ?></label>
				<div class="col-lg-5"><input type="text"
						value='<?php echo $shipmentData['shipment']['issuing_authority']; ?>' id="issuingAuthority"
						name="issuingAuthority" class="form-control input-sm" title="Please enter the issuing authority"
						placeholder="Enter the issuing authority" /></div>
			</div>
			<div class="form-group">
				<label class="col-lg-3 control-label"
					for="PtCoOrdinatorName"><?= $this->translate->_("PT Co-ordinator Name"); ?></label>
				<div class="col-lg-5"><input type="text"
						value='<?php echo $shipmentData['shipment']['pt_co_ordinator_name']; ?>' id="PtCoOrdinatorName"
						name="PtCoOrdinatorName" class="form-control input-sm"
						title="Please enter the PT Co-ordinator Name" placeholder="Enter the PT Co-ordinator Name" />
				</div>
			</div>
			<?php if (isset($this->reportType) && !empty($this->reportType) && $this->reportType == 'malawi') { ?>
				<div class="form-group">
					<label class="col-lg-3 control-label"><?= $this->translate->_("PT Co-ordinator Email"); ?></label>
					<div class="col-lg-5">
						<input type="text" value='<?php echo $shipmentData['shipment']['pt_co_ordinator_email']; ?>'
							name="ptEmail" id="ptEmail" placeholder="Enter PT Co-ordinator email"
							title="Please enter the PT Co-ordinator email" class="form-control input-sm isEmail" />
					</div>
				</div>
				<div class="form-group">
					<label
						class="col-lg-3 control-label"><?= $this->translate->_("PT Co-ordinator Phone Number"); ?></label>
					<div class="col-lg-5">
						<input type="text" value='<?php echo $shipmentData['shipment']['pt_co_ordinator_phone']; ?>'
							name="ptPhone" id="ptPhone" placeholder="Enter PT Co-ordinator phone number"
							title="Please enter the PT Co-ordinator phone number" class="form-control input-sm isNumeric" />
					</div>
				</div>
			<?php } ?>
			<div id="sampleFormFragment">
				<?php if ($shipmentData['shipment']['scheme_type'] == 'dts') {
					// DTS Edit Form - Using unified partial
					include dirname(__FILE__) . '/partials/schemes/dts.phtml';
				} elseif ($shipmentData['shipment']['scheme_type'] == 'covid19') {
					// COVID-19 Edit Form - Using unified partial
					include dirname(__FILE__) . '/partials/schemes/covid19.phtml';
				} elseif ($shipmentData['shipment']['scheme_type'] == 'dbs') {
					// DBS Edit Form - Using unified partial
					include dirname(__FILE__) . '/partials/schemes/dbs.phtml';
				} elseif ($shipmentData['shipment']['scheme_type'] == 'eid') {
					// Use unified EID partial
					include dirname(__FILE__) . '/partials/schemes/eid.phtml';
				} elseif ($shipmentData['shipment']['scheme_type'] == 'vl') {
					// Use unified VL partial
					include dirname(__FILE__) . '/partials/schemes/vl.phtml';
				} elseif ($shipmentData['shipment']['scheme_type'] == 'tb') {
					// Use unified TB partial
					include dirname(__FILE__) . '/partials/schemes/tb.phtml';
				} elseif ($shipmentData['shipment']['scheme_type'] == 'generic-test' || $shipmentData['shipment']['is_user_configured'] == 'yes') {
					include dirname(__FILE__) . '/partials/schemes/generic.phtml';
				} elseif ($shipmentData['shipment']['scheme_type'] == 'recency') {
					include dirname(__FILE__) . '/partials/schemes/recency.phtml';
				} ?>

			</div>

			<div style="margin: 0px auto 0px auto; text-align: center;" align="center">
				<input name="submitbtn" class="btn btn-primary btn-sm" type="button"
					onclick="validateNow();return false;" tabindex="7" value="Update Shipment" />
				<input class="btn btn-danger btn-sm" type="button" onclick="window.history.go(-1);" tabindex="8"
					value="<?= $this->translate->_("Cancel"); ?>" />
			</div>
		</form>
	</fieldset>
</div>

<script>
	var duplicated = false;

	function checkDuplicate(tableName, fieldName, obj, fnct, msg) {
		if (obj.val() == "" || obj.val() == null) {
			return;
		}
		$.post("<?php echo $this->url(array('module' => 'default', 'controller' => 'common', 'action' => 'check-duplicate')); ?>", {
			tableName: tableName,
			fieldName: fieldName,
			value: obj.val(),
			fnct: fnct,
			format: "html"
		},
			function (data) {
				if (data > 0) {
					alert(msg, "err");
					duplicated = true;
					obj.focus();
				} else {
					duplicated = false;
				}
			});
	}


	<?php
	$vHelper = $this->getHelper('DateFormat');
	$dtFormat = $vHelper->getDateFormat();
	?>
	$(document).ready(function () {
		$(".datepicker").datepicker({
			dateFormat: '<?php echo $dtFormat; ?>'
		});

		$('#shipmentCode').on('input', function (event) {
			allowOnlyAlphaNumericAndHyphen('#shipmentCode');
		});
		$("body").on("change", 'select.controlOrNot', function () {
			var scoreElem = $(this).parent().parent().find('.score');
			if ($(this).val() == 1) {
				$(scoreElem).val(0);
				$(scoreElem).attr('readonly', 'readonly');
			} else {
				$(scoreElem).removeAttr('readonly');
			}

		});

		$('#captureAdditionalDetails').on("change", function () {
			if ($(this).val() == 'yes') {
				$("#additionalDetailLabel").attr("disabled", false);
				$("#additionalDetailLabel").addClass("isRequired");
			} else {
				$("#additionalDetailLabel").attr("disabled", true);
				$("#additionalDetailLabel").removeClass("isRequired");
			}

		});
	});



	function validateNow() {
		allowOnlyAlphaNumericAndHyphen('#shipmentCode');
		//checkDuplicate('shipment', 'shipment_code', $("#shipmentCode"), '<?php echo "shipment_id##" . $shipmentData['shipment']['shipment_id']; ?>', 'This Code already exists for another Shipment. Please try something else.')
		flag = deforayValidator.init({
			formId: 'shipmentForm'
		});
		if (flag && !duplicated) {
			$.blockUI();
			document.getElementById('shipmentForm').submit();
		}
	}
</script>
