<?php

/**
 * Shipment Management View
 * Displays shipments under PT Survey with evaluation and reporting options
 */

// Validate shipments data
if (empty($this->shipments)) {
	echo '<br><br><br><h4 style="text-align:center;">' . $this->translate->_("Unable to fetch shipments. Please click view shipment or contact system admin for help") . '</h4>';
	return;
}

// Initialize date checks
$currentDate = date('Y-m-d');
$distributionDate = $this->shipments[0]['distribution_date'];
$canGenerateIndividualReport = ($distributionDate < $currentDate) ? 1 : 0;
$canGenerateFinalReport = ($distributionDate <= $currentDate) ? 1 : 0;

// Determine report button states
$individualReportTitle = $this->translate->_('Generate Reports');
$individualReportClass = '';
$finalReportTitle = $this->translate->_('Finalize');
$finalReportClass = '';

if (isset($this->shipmentStatus['generateReport']['status'])) {
	$reportStatus = $this->shipmentStatus['generateReport']['status'];

	if ($reportStatus === 'pending') {
		$individualReportTitle = $this->translate->_('Processing..');
		$individualReportClass = 'disabled';
	} elseif ($reportStatus === 'evaluated') {
		$individualReportTitle = $this->translate->_('Generate Reports');
	}
}

if (isset($this->shipmentStatus['finalized']['status'])) {
	$finalizedStatus = $this->shipmentStatus['finalized']['status'];

	if ($finalizedStatus === 'pending') {
		$finalReportTitle = $this->translate->_('Processing..');
		$finalReportClass = 'disabled';
	} elseif ($finalizedStatus === 'finalized') {
		$finalReportTitle = $this->translate->_('Finalized');
	}
}
?>

<div class="modal-dialog" style="width:100%;">
	<div class="modal-header">
		<h4 class="modal-title">
			<?= $this->translate->_("Shipments Under PT Survey"); ?>
			<?= htmlspecialchars($this->shipments[0]['distribution_code']); ?>
			(<?= $this->dateFormat($this->shipments[0]['distribution_date']); ?>)
		</h4>
	</div>

	<div class="modal-body">
		<table class="table table-bordered table-striped table-hover">
			<thead>
				<tr>
					<th style="text-align: center;"><?= $this->translate->_("Shipment Code"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("Scheme"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("No. of Samples"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("No. of Participants"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("No. of Responses"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("Response%"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("Number Passed"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("Shipment Status"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("Action"); ?></th>
				</tr>
			</thead>
			<tbody>
				<?php foreach ($this->shipments as $shipment): ?>
					<?php
					// Calculate metrics
					$reported = $shipment['reported_count'] ?? 0;
					$totalParticipants = $shipment['participant_count'];
					$passed = $shipment['number_passed'] ?? 0;
					$nonResponse = $totalParticipants - $reported;
					$responsePercentage = $totalParticipants > 0
						? round(($reported / $totalParticipants) * 100, 2)
						: 0;

					// Get button states from common function
					$btnStates = Application_Service_Shipments::getShipmentButtonStates($shipment);
					$isEvaluated = $btnStates['isEvaluated'];
					$hasReportsGenerated = $btnStates['hasReportsGenerated'];
					$isFinalized = $btnStates['isFinalized'];
					$viewEnabled = $btnStates['viewEnabled'];
					$generateReportsEnabled = $btnStates['generateReportsEnabled'];
					$finalizeEnabled = $btnStates['finalizeEnabled'];
					$displayStatus = $this->translate->_($btnStates['displayStatus']);
					$buttonText = $this->translate->_($btnStates['evaluateButtonText']);

					$evaluateButtonClass = $btnStates['evaluateEnabled'] ? '' : 'disabled';
					$generateReportsClass = $generateReportsEnabled ? '' : 'disabled';
					$finalizeClass = $finalizeEnabled ? '' : 'disabled';
					$encodedShipmentId = base64_encode($shipment['shipment_id']);
					?>

					<tr>
						<td style="text-align: center;"><?= htmlspecialchars($shipment['shipment_code']); ?></td>
						<td style="text-align: center;"><?= htmlspecialchars($shipment['scheme_name']); ?></td>
						<td style="text-align: center;"><?= (int) $shipment['number_of_samples']; ?></td>
						<td style="text-align: center;"><?= (int) $totalParticipants; ?></td>
						<td style="text-align: center;"><?= (int) $reported; ?></td>
						<td style="text-align: center;"><?= $responsePercentage; ?>%</td>
						<td style="text-align: center;"><?= (int) $passed; ?></td>
						<td style="text-align: center;"><?= $displayStatus; ?></td>
						<td style="text-align: center; line-height: 30px;">
							<?php if ($reported > 0): ?>

								<!-- View Button (enabled when evaluated) -->
								<?php if ($viewEnabled): ?>
									<a class="btn btn-success btn-xs"
										href="/admin/evaluate/shipment/sid/<?= $encodedShipmentId; ?>">
										<i class="icon-eye-open"></i> <?= $this->translate->_("View"); ?>
									</a>
								<?php endif; ?>

								<!-- Evaluate/Re-Evaluate Button -->
								<?php if (!$isFinalized): ?>
									<a class="btn btn-success btn-xs <?= $evaluateButtonClass; ?>"
										href="javascript:scheduleShipmentEvaluation('<?= $encodedShipmentId; ?>');">
										<i class="icon-edit"></i> <?= $buttonText; ?>
									</a>
								<?php endif; ?>

								<!-- VL Range Button (only for VL scheme type, not finalized) -->
								<?php if ($shipment['scheme_type'] === 'vl' && !$isFinalized): ?>
									<a class="btn btn-success btn-xs <?= $evaluateButtonClass; ?>" href="javascript:void(0);"
										onclick="getVLReferenceScores('<?= $encodedShipmentId; ?>')">
										<i class="icon-edit"></i> <?= $this->translate->_("VL Range"); ?>
									</a>
								<?php endif; ?>

								<!-- Report Generation Buttons (not shown when finalized) -->
								<?php if (!$isFinalized): ?>
								<div style="display: inline;">
									<?php if ($hasReportsGenerated): ?>
										<a class="btn btn-info btn-xs"
											href="/reports/distribution/shipment/sid/<?= $encodedShipmentId; ?>">
											<i class="icon-eye-open"></i> <?= $this->translate->_("View Reports"); ?>
										</a>
										<a href="javascript:void(0)"
											class="btn btn-xs btn-warning <?= $generateReportsClass; ?>"
											onclick="generateReports('<?= $encodedShipmentId; ?>', <?= $canGenerateIndividualReport; ?>, '<?= $this->dateFormat($shipment['distribution_date']); ?>', 'generateReport')">
											<i class="icon-refresh"></i> <?= $this->translate->_("Re-generate Reports"); ?>
										</a>
									<?php else: ?>
										<a href="javascript:void(0)"
											class="btn btn-xs btn-primary <?= $generateReportsClass; ?>"
											onclick="generateReports('<?= $encodedShipmentId; ?>', <?= $canGenerateIndividualReport; ?>, '<?= $this->dateFormat($shipment['distribution_date']); ?>', 'generateReport')">
											<i class="icon-ok"></i> <?= $this->translate->_("Generate Reports"); ?>
										</a>
									<?php endif; ?>

									<?php if ($isFinalized): ?>
										<a class="btn btn-info btn-xs"
											href="/reports/distribution/finalize/sid/<?= $encodedShipmentId; ?>">
											<i class="icon-check"></i> <?= $finalReportTitle; ?>
										</a>
									<?php else: ?>
										<a href="javascript:void(0)"
											class="btn btn-xs btn-primary <?= $finalizeClass; ?>"
											onclick="generateReports('<?= $encodedShipmentId; ?>', <?= $canGenerateFinalReport; ?>, '<?= $this->dateFormat($shipment['distribution_date']); ?>', 'finalized')">
											<i class="icon-ok"></i> <?= $finalReportTitle; ?>
										</a>
									<?php endif; ?>
								</div>
								<?php endif; ?>

								<!-- Email Non-Respondents Button (not shown when finalized) -->
								<?php if ($nonResponse > 0 && !$isFinalized): ?>
									<a class="btn btn-warning btn-xs <?= $evaluateButtonClass; ?>" href="javascript:void(0);"
										onclick="mailNonParticipants('<?= $encodedShipmentId; ?>');">
										<i class="icon-envelope"></i> Mail <?= (int) $nonResponse; ?>
										<?= $this->translate->_("Not Responded Participants"); ?>
									</a>
								<?php endif; ?>

							<?php else: ?>
								<a class="btn btn-primary btn-xs disabled" href="javascript:void(0)">
									<i class="icon-eye-open"></i> <?= $this->translate->_("View"); ?>
								</a>
							<?php endif; ?>
						</td>
					</tr>
				<?php endforeach; ?>
			</tbody>
		</table>
	</div>
</div>

<div id="vlRangeDiv"></div>

<script>
	function getVLReferenceScores(sid) {
		$.blockUI();
		$.post(
			"<?php echo $this->url(['module' => 'admin', 'controller' => 'evaluate', 'action' => 'vl-range'], 'default', true); ?>", {
			sid: sid,
			format: "html"
		},
			function (data) {
				$("#vlRangeDiv").html(data);
				$.unblockUI();
			}
		).fail(function () {
			$.unblockUI();
			alert("`<?= Pt_Commons_TranslateUtility::jsTranslate("Error loading VL reference scores. Please try again."); ?>");
		});
	}

	function scheduleShipmentEvaluation(sid) {
		$.blockUI();
		$.post(
			"<?php echo $this->url(['module' => 'admin', 'controller' => 'evaluate', 'action' => 'schedule-evaluation'], 'default', true); ?>", {
			sid: sid,
			format: "html"
		},
			function (data) {
				$.unblockUI();
				alert("<?= Pt_Commons_TranslateUtility::jsTranslate("Shipment has been added to the queue. It will be evaluated shortly."); ?>");
				window.location.href = "/admin/evaluate";
			}
		).fail(function () {
			$.unblockUI();
			alert("<?= Pt_Commons_TranslateUtility::jsTranslate("Error scheduling evaluation. Please try again."); ?>");
	});
	}
</script>