<?php

$attributes = json_decode($this->evaluateData['shipment']['attributes'], true);
$shipmentAttributes = json_decode($this->evaluateData['shipment']['shipment_attributes'], true);
$authNameSpace = new Zend_Session_Namespace('datamanagers');

if (isset($this->evaluateData['shipment']["shipment_test_report_date"]) && trim($this->evaluateData['shipment']["shipment_test_report_date"]) != "") {
	$expTestReceiptDate = explode(" ", $this->evaluateData['shipment']["shipment_test_report_date"]);
	$participantResponseDate = $this->dateFormat($expTestReceiptDate[0]);
} else {
	$participantResponseDate = date('d-M-Y');
}
$kitExpiryDate = "";
if (isset($attributes['kit_expiry_date']) && $attributes['kit_expiry_date'] != "") {
	$kitExpiryDate = $this->dateFormat($attributes['kit_expiry_date']);
}
$genderHelper = $this->getHelper('DateFormat');
$dtFormat =  $genderHelper->getDateFormat();
?>

<table class="table table-bordered table-striped" style="width:100%;margin:0 auto 10px auto;">
    <tr class="dark">
        <th style="width:20%;"><?= $this->translate->_("Shipment Code"); ?></th>
        <td style="width:20%;">
            <?php echo $this->evaluateData['shipment']['shipment_code']; ?>
        </td>
        <th style="width:20%;"><?= $this->translate->_("Scheme Name"); ?></th>
        <td style="width:20%;">
            <?php echo $this->evaluateData['shipment']['scheme_name']; ?>
        </td>
    </tr>
    <tr class="light">
        <th style="width:20%;"><?= $this->translate->_("Participant Site Name"); ?></th>
        <td style="width:20%;">
            <?php echo ($this->participant['first_name'] . ' ' . $this->participant['last_name']); ?>
        </td>
        <th style="width:20%;"><?= $this->translate->_("PT-ID"); ?></th>
        <td style="width:20%;">
            <?php echo $this->participantId; ?>
        </td>
    </tr>
    <tr class="dark">
        <th style="width:20%;"><?= $this->translate->_("Country"); ?></th>
        <td style="width:20%;">
            <?php echo $this->participant['iso_name']; ?>
        </td>
        <th style="width:20%;"></th>
        <td style="width:20%;">
        </td>
    </tr>
</table>
<br>
<div style="width:100%;padding-left:0;">
    <label style="font-size:16px;" for="isPtTestNotPerformed"><?= $this->translate->_("Were you able to test the Panel?"); ?>&nbsp; &nbsp;<label>
    <select name="isPtTestNotPerformed" id="isPtTestNotPerformed" class="form-control">
        <option value="no" <?php echo (isset($this->evaluateData['shipment']['is_pt_test_not_performed']) && $this->evaluateData['shipment']['is_pt_test_not_performed'] == 'yes') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Able to Test Panel"); ?></option>
        <option value="yes" <?php echo (isset($this->evaluateData['shipment']['is_pt_test_not_performed']) && $this->evaluateData['shipment']['is_pt_test_not_performed'] == 'yes') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Unable to Test Panel"); ?></option>
    </select>
</div>
<table class="ptNotPerformedSection table table-bordered table-striped" style="<?php echo (isset($this->evaluateData['shipment']['is_pt_test_not_performed']) && $this->evaluateData['shipment']['is_pt_test_not_performed'] == 'yes') ? '' : 'display:none;'; ?>background:none;width:100%;margin:10px auto;">
    <tr class="ptNotPerformedSection">
        <td colspan="2">
            <label><?= $this->translate->_("Reason for not testing the PT Panel"); ?></label> <span class="mandatory">*</span> :
            <select id="vlNotTestedReason" name="vlNotTestedReason" class="form-control" title="Please select reason" onchange="collectPanelReceiptDate();">
                <option value="">--<?= $this->translate->_("Select"); ?>--</option>
                <?php
                foreach ($this->allNotTestedReason as $reason) {
                ?>
                    <option data-collect-panel-receipt-date="<?= $reason['collect_panel_receipt_date']; ?>" value="<?= $reason['ntr_id']; ?>" <?php echo ($this->evaluateData['shipment']['vl_not_tested_reason'] == $reason['ntr_id']) ? 'selected="selected"' : ''; ?>><?php echo ($reason['ntr_reason']); ?></option>
                <?php } ?>
            </select>
        </td>
    </tr>
    <tr class="ptNotPerformedSection" style="<?php echo (isset($this->evaluateData['shipment']['is_pt_test_not_performed']) && $this->evaluateData['shipment']['is_pt_test_not_performed'] == 'yes') ? '' : 'display:none;'; ?>background:none;">
        <td colspan="4"><label><?= $this->translate->_("Comments"); ?></label> : <textarea id="ptNotTestedComments" name="ptNotTestedComments" class="form-control" title="Please enter comments"><?php echo $this->evaluateData['shipment']['pt_test_not_performed_comments']; ?></textarea></td>
    </tr>
</table>

<table class="vlResultSection table table-bordered table-striped" style="<?php echo (isset($this->evaluateData['shipment']['is_pt_test_not_performed']) && $this->evaluateData['shipment']['is_pt_test_not_performed'] != 'yes') ? '' : 'display:none;'; ?>width:100%;margin:10px auto;">
	<tr class="light">
		<th style="width:20%;"><?= $this->translate->_("PT Shipment Date"); ?></th>
        <td style="width:20%;">
            <?php echo $this->dateFormat($this->evaluateData['shipment']['shipment_date']); ?>
        </td>
		<td style="width:20%;"> <label class="control-lable" for="responseDate"><?= $this->translate->_("Result submission Date"); ?></label></td>
		<td style="width:30%;">
			<?php echo $this->dateFormat($this->evaluateData['shipment']["lastdate_response"]);  ?>
		</td>
	</tr>
    <tr class="dark">
        <td style="width:20%;"> <label class="control-lable" for="receiptDate"><?= $this->translate->_("Shipment Received Date"); ?> <span class="mandatory">*</span></label></td>
        <td style="width:30%;">
            <input type="text" id="receiptDate" name="receiptDate" size="11" placeholder="Shipment Receipt Date" maxlength="11" style="width:250px;float:left;" value="<?php echo $this->dateFormat($this->evaluateData['shipment']["shipment_receipt_date"]);  ?>" class="form-control vlResultValues isRequired datepicker" readonly="readonly" />
            <i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date" onclick="clearDate('receiptDate')"> Clear</i>
        </td>
		<td><label><?= $this->translate->_("Shipment Testing Date"); ?> <span class='mandatory'>*</span></label></td>
        <td>
            <input type="text" id="testDate" name="testDate" size="11" maxlength="11" style="width:250px;float:left;" placeholder="Enter Shipment Test Date" value="<?php echo (isset($this->evaluateData['shipment']["shipment_test_date"]) && !empty($this->evaluateData['shipment']["shipment_test_date"]) && $this->evaluateData['shipment']["shipment_test_date"] != "0000-00-00") ? $this->dateFormat($this->evaluateData['shipment']["shipment_test_date"]) : ""; ?>" class="form-control datepicker vlResultValues isRequired" readonly="readonly" title="Please enter Shipment Test Date" />
            <i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date" onclick="clearDate('testDate')"> <?= $this->translate->_("Clear"); ?></i>
        </td>
    </tr>
    <tr class="light">
        <td style="width:20%;"> <label class="control-lable" for="analystName"><?= $this->translate->_("Analyst Name"); ?> <span class="mandatory">*</span></label></td>
        <td style="width:30%;">
            <input type="text" id="analystName" name="analystName" style="float:left;" value="<?php echo (isset($attributes['analyst_name']) && !empty($attributes['analyst_name'])) ? $attributes['analyst_name'] : ""; ?>" class="form-control vlResultValues isRequired" placeholder="Enter analyst name" title="Please enter analyst name" />
        </td>
        <td style="width:20%;"> <label class="control-lable" for="kitName"><?= $this->translate->_("Kit Name"); ?> <span class="mandatory">*</span></label></td>
        <td style="width:30%;">
            <input type="text" id="kitName" name="kitName" style="float:left;" value="<?php echo (isset($attributes['kit_name']) && !empty($attributes['kit_name'])) ? $attributes['kit_name'] : ""; ?>" class="form-control vlResultValues isRequired" placeholder="Enter kit name" title="Please enter kit name" />
        </td>
    </tr>
    <tr>
        <td style="width:20%;"> <label class="control-lable" for="kitLot"><?= $this->translate->_("Kit Lot Number"); ?> <span class="mandatory">*</span></label></td>
        <td style="width:30%;">
            <input type="text" id="kitLot" name="kitLot" style="float:left;" value="<?php echo (isset($attributes['kit_lot_number']) && !empty($attributes['kit_lot_number'])) ? $attributes['kit_lot_number'] : ""; ?>" class="form-control vlResultValues isRequired" placeholder="Enter kit lot" title="Please enter kit lot" />
        </td>
        <td style="width:20%;"> <label class="control-lable" for="expiryDate"><?= $this->translate->_("Kit Expiry Date"); ?> <span class="mandatory">*</span></label></td>
        <td style="width:30%;">
            <input type="text" id="expiryDate" name="expiryDate" style="width:210px;float:left;" placeholder="Kit Expiry Date" title="Please select the kit expiry date" class="form-control vlResultValues isRequired datepicker" value="<?php echo $kitExpiryDate; ?>" readonly="readonly" />
            <i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date" onclick="clearDate('expiryDate')"> <?= $this->translate->_("Clear"); ?></i>
        </td>
    </tr>
</table>
<div class="vlResultSection" style="<?php echo (isset($this->evaluateData['shipment']['is_pt_test_not_performed']) && $this->evaluateData['shipment']['is_pt_test_not_performed'] != 'yes') ? '' : 'display:none;'; ?>">
    <table class="table table-bordered table-striped" style="width:100%;margin:10px auto;" id="other">
        <thead>
            <tr align="CENTER" class="dark">
                <th style="width:10%;">Sample ID</th>
                <th>First Result <span class='mandatory'>*</span></th>
                <?php if(isset($shipmentAttributes['noOfTest']) && $shipmentAttributes['noOfTest'] == 2){ ?>
                    <th>Second Result <span class='mandatory'>*</span></th>
                <?php }?>
                <th>Final Result <span class='mandatory'>*</span></th>
                <?php if(isset($shipmentAttributes['captureAdditionalDetails']) && $shipmentAttributes['captureAdditionalDetails'] == 'yes'){ ?>
                    <th><?php echo (isset($shipmentAttributes['additionalDetailLabel']) && !empty($shipmentAttributes['additionalDetailLabel']))?$shipmentAttributes['additionalDetailLabel']:'Additional Detail';?></th>
                <?php } ?>
                <th>Comments</th>
            </tr>
        </thead>

        <?php $count = 0;
        foreach ($this->evaluateData['results'] as $key => $sample) {
            $count++; ?>
            <tr align="CENTER" class="light other<?php echo $sample['sample_id']; ?>">
                <th>
                    <?php echo $sample['sample_label']; ?> <?php echo ($sample['mandatory'] == 1) ? " <span class='mandatory'>*</span>" : "&nbsp;&nbsp;"; ?>
                    <input type="hidden" id="sample<?php echo $count; ?>" name="sampleId[]" value="<?php echo $sample['sample_id']; ?>" />
                </th>
                <td>
                    <select name="result[]" class="<?php echo ($sample['mandatory'] == 1) ? " isRequired" : ""; ?> form-control input-sm vlResultValues" title="Please choose one" placeholder="Please choose result for this sample">
                        <option value="">-- Select --</option>
                        <option value="positive" <?php echo ($sample['result'] == 'positive' ? "selected='selected'" : ""); ?>>Positive</option>
                        <option value="negative" <?php echo ($sample['result'] == 'negative' ? "selected='selected'" : ""); ?>>Negative</option>
                        <option value="invalid" <?php echo ($sample['result'] == 'invalid' ? "selected='selected'" : ""); ?>>Invalid</option>
                    </select>
                </td>
                <?php if(isset($shipmentAttributes['noOfTest']) && $shipmentAttributes['noOfTest'] == 2){ ?>
                <td>
                    <select name="repeatResult[]" class="<?php echo ($sample['mandatory'] == 1) ? " isRequired" : ""; ?> form-control input-sm vlResultValues" title="Please choose one" placeholder="Please choose repeat result for this sample">
                        <option value="">-- Select --</option>
                        <option value="positive" <?php echo ($sample['repeat_result'] == 'positive' ? "selected='selected'" : ""); ?>>Positive</option>
                        <option value="negative" <?php echo ($sample['repeat_result'] == 'negative' ? "selected='selected'" : ""); ?>>Negative</option>
                        <option value="invalid" <?php echo ($sample['repeat_result'] == 'invalid' ? "selected='selected'" : ""); ?>>Invalid</option>
                    </select>
                </td>
                <?php } ?>
                <td>
                    <select name="finalResult[]" class="<?php echo ($sample['mandatory'] == 1) ? " isRequired" : ""; ?> form-control input-sm vlResultValues" title="Please choose one" placeholder="Please choose final result for this sample">
                        <option value="">-- Select --</option>
                        <option value="positive" <?php echo ($sample['reported_result'] == 'positive' ? "selected='selected'" : ""); ?>>Positive</option>
                        <option value="negative" <?php echo ($sample['reported_result'] == 'negative' ? "selected='selected'" : ""); ?>>Negative</option>
                        <option value="invalid" <?php echo ($sample['reported_result'] == 'invalid' ? "selected='selected'" : ""); ?>>Invalid</option>
                    </select>
                </td>
                <?php if(isset($shipmentAttributes['captureAdditionalDetails']) && $shipmentAttributes['captureAdditionalDetails'] == 'yes'){ ?>
                <td>
                    <input type="text" class="form-control vlResultValues" placeholder="Additional Detail" name="additionalDetail[]" value="<?php echo (isset($sample['additional_detail']) && $sample['additional_detail'] != "") ? $sample['additional_detail'] : ''; ?>" title="Please enter the Additional Detail" />
                </td>
                <?php } ?>
                <td>
                    <input type="text" class="form-control vlResultValues" placeholder="Comments" name="comments[]" value="<?php echo (isset($sample['comments']) && $sample['comments'] != "") ? $sample['comments'] : ''; ?>" title="Please enter the comments" />
                </td>
            </tr>
        <?php } ?>
    </table>
</div>
<br>
<hr>
<table class="table table-bordered table-striped" style="width:100%;margin:10px auto;">
    <tr>
        <th style="width:20%;"><?= $this->translate->_("Supervisor Review"); ?> <span class="mandatory">*</span></th>
        <td style="width:20%;">
            <select name="supervisorApproval" id="supervisorApproval" class="form-control isRequired">
                <option value="">--<?= $this->translate->_("Select"); ?>--</option>
                <option value="yes" <?php if ($this->evaluateData['shipment']['supervisor_approval'] == 'yes') echo " selected "; ?>><?= $this->translate->_("Yes"); ?></option>
                <option value="no" <?php if ($this->evaluateData['shipment']['supervisor_approval'] == 'no') echo " selected "; ?>><?= $this->translate->_("No"); ?></option>
            </select>
        </td>
        <th class="participantSupervisor" <?php echo (isset($this->evaluateData['shipment']['supervisor_approval']) && $this->evaluateData['shipment']['supervisor_approval'] == 'yes') ? "" : "style='display:none;'" ?>><label for="participantSupervisor"><?= $this->translate->_("Supervisor Name"); ?> <span class="mandatory">*</span></label></th>
        <td class="participantSupervisor" <?php echo (isset($this->evaluateData['shipment']['supervisor_approval']) && $this->evaluateData['shipment']['supervisor_approval'] == 'yes') ? "" : "style='display:none;'" ?>><input name="participantSupervisor" id="participantSupervisor" <?php echo (isset($this->evaluateData['shipment']['supervisor_approval']) && $this->evaluateData['shipment']['supervisor_approval'] == 'yes') ? "" : "style='display:none;'" ?> type="text" class="form-control" value="<?php echo $this->evaluateData['shipment']['participant_supervisor']; ?>" /></td>
    </tr>
    <tr>
        <th><?= $this->translate->_("Comments"); ?> </th>
        <td colspan="3">
            <textarea name="userComments" id="userComments" class="form-control" size="120" maxlength="40"><?php echo $this->evaluateData['shipment']['user_comment']; ?></textarea>
        </td>
    </tr>
</table>
<script type="text/javascript" src="/js/datalist-css.min.js"></script>
<script>
	function goto_dashboard() {
		window.history.back();
	}

	var timeOut;

	$(function() {
		$("#receiptDate").datepicker({
			dateFormat: '<?php echo $dtFormat; ?>',
			minDate: new Date('<?php echo $this->evaluateData['shipment']['shipment_date']; ?>'),
			maxDate: 'today'
		});
		$(".datepicker").datepicker({
			dateFormat: '<?php echo $dtFormat; ?>',
			// maxDate: '0',
			minDate: 'today',
			// maxDate: new Date('<?php echo $this->evaluateData['shipment']['shipment_date']; ?>')
		});

		$(".expDatepicker").datepicker({
			dateFormat: '<?php echo $dtFormat; ?>'
		});
		<?php if (!$this->isEditable) { ?>
			$("#tbResponseForm").find("input:enabled, select:enabled, textarea:enabled").attr("disabled", "disabled");
		<?php } ?>

		$('input[name="mtbDetected[]"').change(function() {
			console.log($(this).val());
			_detacted = false;
			$('input[name="mtbDetected[]"').each(function(index) {
				console.log($(this).val());
				if ($(this).val() == 'detected') {
					_detacted = true;
				}
			});
			if (_detacted) {
				$('#cepheidMTBXDRTest').show();
			} else {
				$('#cepheidMTBXDRTest').hide();
			}
		});

		loadAssayFields($('#assayName'));
	});

	$('.oneDecimal').keypress(function() {
		var $this = $(this);
		$this.val($this.val().replace(/[^\d.]/g, ''));
	});
	$('.sampleTestDate').change(function() {
		$('.sampleTestDate').each(function() {

		});
	});

	$(".oneDecimal").on("blur", function(el) {
		clearTimeout(timeOut)
		timeOut = setTimeout(function() {
			var newVal = Number($(el.target).val()).toFixed(1);
			if ($.isNumeric(newVal)) {
				$(el.target).val(newVal);
			} else {
				$(el.target).val(0);
			}

		}, 600)
	});


	function validateNow() {
		var dates = [];
		$(".sampleTestDate").each(function() {

			dates.push(new Date($(this).val()))

		});
		var maxDate = new Date(Math.max.apply(null, dates));
		$("#testDate").val(moment(maxDate).format('DD-MMM-YYYY'));
		if (moment($("#receipt_date").val()).isAfter($("#test_date").val())) {
			alert('Testing Date has to come after the Shipment Receipt Date');
			return false;
		}
		$(".oneDecimal").each(function() {
			if (!$.isNumeric($(this).val())) {
				alert('Please ensure all SPC and Probe values are valid numbers');
				return false;
			}
		});
		flag = deforayValidator.init({
			formId: 'tbResponseForm'
		});
		return flag;
	}
	$('#supervisorApproval').change(function() {
		if ($('#supervisorApproval').val() == 'yes') {
			$('#labSupervisor').show();
			$('#labSupervisor').addClass('isRequired');
			$('#participantSupervisor').val('');
			$('.participantSupervisor').show();
		} else {
			$('#labSupervisor').hide();
			$('#labSupervisor').removeClass('isRequired');
			$('#participantSupervisor').val('');
			$('.participantSupervisor').hide();
		}
	});

	$('#attestation').change(function() {
		if ($('#attestation').val() == 'yes') {
			$('.attestation-statement').show();
			$('#attestationStatement').addClass('isRequired');
		} else {
			$('.attestation-statement').hide();
			$('#attestationStatement').removeClass('isRequired');
		}
	});

	//PT not performed case
	function rifDetectionChange(obj, id) {
		if ($(obj).val() == 'detected') {
			$("#rifResistance" + id).attr("disabled", false);
		} else {
			$("#rifResistance" + id).val("na");
			$("#rifResistance" + id).attr("disabled", true);
		}
	}
	$('#isPtTestNotPerformed').change(function() {
		if ($(this).val() == 'yes') {
			$('.vlResultSection').hide();
			$('.vlResultValues').val('');
			$('.vlResultBlock').html('');
			$('.ptNotPerformedSection').show();
			$('.vlResultMandatory').css('visibility', 'hidden');
			$('.vlResultValues').removeClass('isRequired');
			$('#vlNotTestedReason').addClass('isRequired');
			$('#ptNotTestedComments').addClass('isRequired');
			$('#testDate,#receiptDate,#sampleRehydrationDate,#supervisorApproval').removeClass('isRequired');
			$('.ptTestPerformed').hide();
		} else {
			$('.vlResultSection').show();
			$('.ptNotPerformedSection').hide();
			$('.vlResultMandatory').css('visibility', 'visible');
			$('.vlResultValues').addClass('isRequired');
			$('#vlNotTestedReason').removeClass('isRequired');
			$('#ptNotTestedComments').removeClass('isRequired');
			$('#testDate,#receiptDate,#sampleRehydrationDate,#supervisorApproval').addClass('isRequired');
			$('.ptTestPerformed').show();

		}

	});

	function loadAssayFields(obj) {
		let _short = $(obj).find(':selected').data('short');
		let _type = $(obj).find(':selected').data('type');
		let _drug = $(obj).find(':selected').data('drug');
		let _assayId = $(obj).val();
		// return false;
		if ($(obj).find(':selected').data('type') == "generic") {
			$(".generic-tb-assay").show();
		} else {
			$(".generic-tb-assay").hide();
		}
		if (obj.value != "") {
			$.get("<?php echo $this->url(array('module' => 'admin', 'controller' => 'evaluate', 'action' => 'assay-formats', 'format' => 'html')); ?>?assayId="+_assayId + "&type=" + _short + "&sid=<?php echo $this->shipId; ?>&pid=<?php echo $this->participantId; ?>&scheme=<?php echo $this->scheme; ?>&assayType=" + _type + "&assayDrug=" + _drug, {
					format: "html"
				},
				function(data) {
					if (data != "") {
						$(".loadAssay").html(data);
					}
					if (_short == "molbio-truenat-tb" || _short == "molbio-truenat-plus") {
						$('#tb-plus').hide();
					} else {
						$('#tb-plus').show();
					}
				});
		}
	}



	function clearDate(id) {
		$("#" + id).val('');
	}

	function checkQcStatus() {
		var radioValue = $("input[name='qcDone']:checked").val();
		if (radioValue == "yes") {
			$("#qcSection").show();
			$("#qcDate").addClass("isRequired");
			$("#qcDoneBy").addClass("isRequired");
		} else {
			$("#qcSection").hide();
			$("#qcDate").val("");
			$("#qcDoneBy").val("");
			$("#qcDate").removeClass("isRequired");
			$("#qcDoneBy").removeClass("isRequired");
		}
	}

	function dnaStatusUpdate(value, id) {
		if (value == 'valid') {
			$(".dna-available-label, .dna-available-" + id).show();
		} else {
			$(".dna-available-" + id).hide();
		}
	}
</script>