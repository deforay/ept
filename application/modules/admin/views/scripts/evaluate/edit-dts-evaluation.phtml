<?php



$testThreeHidden = false;
$testTwoHidden = false;
$screeningTest = false;

$attributes = json_decode($this->evaluateData['shipment']['attributes'], true);

$allowedAlgorithms = isset($this->config->evaluation->dts->allowedAlgorithms) ? explode(",", $this->config->evaluation->dts->allowedAlgorithms) : array();
$allowRepeatTests = isset($this->config->evaluation->dts->allowRepeatTests) ? $this->config->evaluation->dts->allowRepeatTests : 0;
$dtsSchemeType = (isset($this->config->evaluation->dts->dtsSchemeType) && $this->config->evaluation->dts->dtsSchemeType != "") ? $this->config->evaluation->dts->dtsSchemeType : 'standard';
$shipmentAttributes = isset($this->evaluateData['shipment']['shipment_attributes']) ? json_decode($this->evaluateData['shipment']['shipment_attributes'], true) : array();

if (isset($this->config->evaluation->dts->dtsOptionalTest3) && $this->config->evaluation->dts->dtsOptionalTest3 == 'yes') {
    $testThreeHidden = true;
}

if (in_array("ghanaNationalDtsAlgo", $allowedAlgorithms) && sizeof($allowedAlgorithms) == 1) {
    $testThreeHidden = false;
    $testTwoHidden = false;
    $screeningTest = false;
}

if ($dtsSchemeType == 'malawi' || $dtsSchemeType == 'myanmar') {
    $testThreeHidden = false;
    $testTwoHidden = false;
    $screeningTest = false;
}
if (isset($shipmentAttributes['screeningTest']) && $shipmentAttributes['screeningTest'] == 'yes') {
    $testTwoHidden = true;
    $testThreeHidden = true;
    $screeningTest = true;
}
$displaySampleConditionFields = false;
if ($dtsSchemeType == 'malawi') {
    $displaySampleConditionFields = true;
}
$ghanaNationalDtsAlgo = false;
if ($dtsSchemeType == 'ghana') {
    $ghanaNationalDtsAlgo = true;
}
// if (isset($shipmentAttributes['enableSyphilis']) && $shipmentAttributes['enableSyphilis'] == "yes" && isset($this->participant['anc']) && $this->participant['anc'] == "yes" && $ghanaNationalDtsAlgo) {
$syphilisActive = false;
if (isset($shipmentAttributes['enableSyphilis']) && $shipmentAttributes['enableSyphilis'] == "yes" && $ghanaNationalDtsAlgo) {
    $syphilisActive = true;
}
$isThisRetestField = false;
if ($dtsSchemeType == 'ghana' && $syphilisActive) {
    $isThisRetestField = true;
}
if (($testTwoHidden)) {
    $noTest = 1;
} else if ($testThreeHidden) {
    $noTest = 2;
} else {
    $noTest = 3;
}
?>

<table class="table table-bordered table-striped" style="width:100%;margin:0 auto 10px auto;">
    <tr>
        <th><?= $this->translate->_("Shipment Code"); ?></th>
        <td><?php echo $this->evaluateData['shipment']['shipment_code']; ?></td>
        <th><?= $this->translate->_("Scheme Type"); ?></th>
        <td><?php echo strtoupper($this->evaluateData['shipment']['scheme_name']); ?></td>
    </tr>
    <tr>
        <th><?= $this->translate->_("Shipment Date"); ?></th>
        <td><?php echo $this->dateFormat($this->evaluateData['shipment']['shipment_date']); ?></td>
        <th><?= $this->translate->_("Result Due Date"); ?></th>
        <td><?php echo $this->dateFormat($this->evaluateData['shipment']['lastdate_response']); ?></td>
    </tr>
    <tr>
        <th><?= $this->translate->_("Shipment Received on"); ?></th>
        <td><input id="receivedOn" type="text" name="receivedOn" value="<?php echo $this->dateFormat($this->evaluateData['shipment']['shipment_receipt_date']); ?>" size="11" maxlength="11" class="datepicker form-control" readonly="readonly" /></td>
        <th><?= $this->translate->_("Samples Tested on"); ?></th>
        <td><input id="testedOn" type="text" name="testedOn" value="<?php echo $this->dateFormat($this->evaluateData['shipment']['shipment_test_date']); ?>" size="11" maxlength="11" class="datepicker form-control" readonly="readonly" /></td>
    </tr>
    <tr>
        <th>
            <?php if (isset($shipmentAttributes['sampleType']) && $shipmentAttributes['sampleType'] != 'serum' && $shipmentAttributes['sampleType'] != 'plasma') { ?>
                <?= $this->translate->_("Sample Rehydration Date"); ?>
            <?php } ?>
        </th>
        <td>
            <?php if (isset($shipmentAttributes['sampleType']) && $shipmentAttributes['sampleType'] != 'serum' && $shipmentAttributes['sampleType'] != 'plasma') { ?>
                <input id="rehydrationDate" type="text" name="rehydrationDate" value="<?php echo $this->dateFormat($attributes['sample_rehydration_date']); ?>" size="11" maxlength="11" class="datepicker form-control" readonly="readonly" />
            <?php } ?>
        </td>
        <th>Algorithm Used</th>
        <td>
            <select name="algorithm" id="algorithm" class="isRequired form-control" title="Please choose the Algorithm used" onchange="showHideTest3();">

                <?php if (count($allowedAlgorithms) > 1) { ?>
                <?php } ?>
                <option value="">--Select--</option>
                <?php if (!empty($this->config->evaluation->dts->dtsEnforceAlgorithmCheck) && $this->config->dtsEnforceAlgorithmCheck == 'yes') {
                }
                if (!empty($allowedAlgorithms) && in_array('serial', $allowedAlgorithms)) { ?>
                    <option value="serial" <?php echo (isset($attributes["algorithm"]) && $attributes["algorithm"] == 'serial') ? "selected='selected'" : ''; ?>>Serial</option>
                <?php }
                if (!empty($allowedAlgorithms) && in_array('parallel', $allowedAlgorithms)) { ?>
                    <option value="parallel" <?php echo (isset($attributes["algorithm"]) && $attributes["algorithm"] == 'parallel') ? "selected='selected'" : ''; ?>>Parallel</option>
                <?php }
                if (!empty($allowedAlgorithms) && in_array('myanmarNationalDtsAlgo', $allowedAlgorithms)) { ?>
                    <option value="myanmarNationalDtsAlgo" <?php echo (isset($attributes["algorithm"]) && $attributes["algorithm"] == 'myanmarNationalDtsAlgo') ? "selected='selected'" : ''; ?>>Myanmar National Algorithm</option>
                <?php }
                if (!empty($allowedAlgorithms) && in_array('malawiNationalDtsAlgo', $allowedAlgorithms)) { ?>
                    <option value="malawiNationalDtsAlgo" <?php echo (isset($attributes["algorithm"]) && $attributes["algorithm"] == 'malawiNationalDtsAlgo') ? "selected='selected'" : ''; ?>>Malawi National Algorithm</option>
                <?php }
                if (!empty($allowedAlgorithms) && in_array('ghanaNationalDtsAlgo', $allowedAlgorithms)) { ?>
                    <option value="ghanaNationalDtsAlgo" <?php echo (isset($attributes["algorithm"]) && $attributes["algorithm"] == 'ghanaNationalDtsAlgo') ? "selected='selected'" : ''; ?>>Ghana National Algorithm</option>
                <?php } ?>
            </select>
        </td>
    </tr>
    <?php if ((isset($this->config->evaluation->dts->displaySampleConditionFields) && $this->config->evaluation->dts->displaySampleConditionFields == "yes")) { ?>

        <tr class="light malawiNationalDtsAlgo">
            <td><label for="conditionOfPTSamples" class="label-control">Condition Of PT Samples");?></label></td>
            <td>
                <select class="form-control" name="conditionOfPTSamples" id="conditionOfPTSamples" title="Please select the condition of samples">
                    <option value="">--<?= $this->translate->_("Select"); ?>--</option>
                    <option value="good" <?php echo ($attributes['condition_pt_samples'] == 'good') ? "selected='selected'" : ""; ?>><?= $this->translate->_("Good"); ?></option>
                    <option value="bad" <?php echo ($attributes['condition_pt_samples'] == 'bad') ? "selected='selected'" : ""; ?>><?= $this->translate->_("Bad"); ?></option>
                    <option value="not-sure" <?php echo ($attributes['condition_pt_samples'] == 'not-sure') ? "selected='selected'" : ""; ?>><?= $this->translate->_("Not Sure"); ?></option>
                </select>
            </td>

            <td><label for="refridgerator" class="label-control">Refridgerator");?></label></td>
            <td>
                <select class="form-control" name="refridgerator" id="refridgerator" title="Please select if a fridge is available">
                    <option value="">--<?= $this->translate->_("Select"); ?>--</option>
                    <option value="available" <?php echo ($attributes['refridgerator'] == 'available') ? "selected='selected'" : ""; ?>><?= $this->translate->_("Available"); ?></option>
                    <option value="not-available" <?php echo ($attributes['refridgerator'] == 'not-available') ? "selected='selected'" : ""; ?>><?= $this->translate->_("Not Available"); ?></option>
                </select>
            </td>
        </tr>
        <tr class="light malawiNationalDtsAlgo">
            <td><label for="roomTemperature" class="label-control"><?= $this->translate->_("Room Temperature"); ?></label></td>
            <td style=" display: flex; ">
                <input class="form-control" type="text" style="width:100px;" value="<?php echo $attributes['room_temperature']; ?>" name="roomTemperature" id="roomTemperature" placeholder="Room Temperature" title="Please enter the room temperature">&nbsp;&nbsp;&nbsp;<span>&deg;C</span>
            </td>

            <td><label for="stopWatch" class="label-control"><?= $this->translate->_("Stop Watch"); ?></label></td>
            <td>
                <select class="form-control" name="stopWatch" id="stopWatch" title="Please select if a stop watch is available">
                    <option value="">--<?= $this->translate->_("Select"); ?>--</option>
                    <option value="available" <?php echo ($attributes['stop_watch'] == 'available') ? "selected='selected'" : ""; ?>><?= $this->translate->_("Available"); ?></option>
                    <option value="not-available" <?php echo ($attributes['stop_watch'] == 'not-available') ? "selected='selected'" : ""; ?>><?= $this->translate->_("Not Available"); ?></option>
                </select>
            </td>
        </tr>
    <?php } ?>
    <tr>
        <th><?= $this->translate->_("Supervisor Review"); ?></th>
        <td>
            <select name="supervisorApproval" id="supervisorApproval" class="isRequired form-control" title="Please select if Supervisor Approval was conducted or not">
                <option value=""> -- <?= $this->translate->_("Select"); ?> -- </option>
                <option value="yes" <?php if (strtolower($this->evaluateData['shipment']['supervisor_approval']) == 'yes') echo " selected "; ?>><?= $this->translate->_("YES"); ?></option>
                <option value="no" <?php if (strtolower($this->evaluateData['shipment']['supervisor_approval']) == 'no') echo " selected "; ?>><?= $this->translate->_("NO"); ?></option>
            </select>
        </td>
        <th id="labSupervisor" <?php echo (isset($this->evaluateData['shipment']['supervisor_approval']) && strtolower($this->evaluateData['shipment']['supervisor_approval']) == 'yes') ? "" : "style='display:none;'" ?>><?= $this->translate->_("Supervisor Name"); ?></th>
        <td>
            <input name="participantSupervisor" id="participantSupervisor" type="text" <?php echo (isset($this->evaluateData['shipment']['supervisor_approval']) && strtolower($this->evaluateData['shipment']['supervisor_approval']) == 'yes') ? "" : "style='display:none;'" ?> class="form-control" value="<?php echo $this->evaluateData['shipment']['participant_supervisor']; ?>" />
        </td>
    </tr>
    <tr>
        <th><?= $this->translate->_("User Comments"); ?></th>
        <td colspan="3"><textarea class="form-control" name="userComments" id="userComments"><?php echo $this->evaluateData['shipment']['user_comment']; ?></textarea></td>
    </tr>
</table>

<?php
$possibleResults = array();
$possibleSyphilisResults = array();
$possibleFinalResults = array();
$possibleSyphilisFinalResults = array();
foreach ($this->evaluateData['possibleResults'] as $pr) {
    if ($pr['scheme_sub_group'] == 'DTS_TEST') {
        $possibleResults[$pr['id']] = $pr['response'];
    }
    if ($pr['scheme_sub_group'] == 'DTS_SYP_TEST') {
        $possibleSyphilisResults[$pr['id']] = $pr['response'];
    }
    if ($pr['scheme_sub_group'] == 'DTS_FINAL') {
        $possibleFinalResults[$pr['id']] = $pr['response'];
    }

    if ($pr['scheme_sub_group'] == 'DTS_SYP_FINAL') {
        $possibleSyphilisFinalResults[$pr['id']] = $pr['response'];
    }
}
if (isset($shipmentAttributes['enableRtri']) && $shipmentAttributes['enableRtri'] == 'yes') {
    $rtriFinalPossibleResults = array();
    foreach ($this->evaluateData['possibleResults']['recency'] as $pr) {
        if ($pr['scheme_sub_group'] == 'RECENCY_FINAL') {
            $rtriFinalPossibleResults[$pr['id']] = $pr['response'];
        }
    }
}
?>


<table class="table table-striped table-bordered">
    <thead>
        <tr align="CENTER" class="dark">
            <th></th>
            <?php if ($syphilisActive) { ?>
                <th class="colwidth"></th>
            <?php } ?>
            <th style="text-align: center" class="colwidth"><?= $this->translate->_("Test-1"); ?></th>
            <th style="text-align: center" class='testTwo colwidth'><?= $this->translate->_("Test-2"); ?></th>
            <th style="text-align: center" class='testThree colwidth'><?= $this->translate->_("Test-3"); ?></th>
            <th class="2-span colwidth" style="width: <?php echo $width; ?>%;" colspan="2"></th>
        </tr>
    </thead>
    <tr style="text-align:center" class="colwidth">
        <th> <?= $this->translate->_("Kit Name"); ?></th>
        <?php if ($syphilisActive) { ?>
            <th class="colwidth"></th>
        <?php } ?>
        <td>
            <select name="test_kit_name_1" id="test_kit_name_1" class="isRequired form-control" title="Please Choose Test Kit 1">
                <?php $this->dropdownSelection($this->allTestKits, $this->evaluateData['results'][0]["test_kit_name_1"], true); ?>
            </select>
        </td>
        <td class='testTwo colwidth'>
            <select name="test_kit_name_2" id="test_kit_name_2" class="<?php echo (isset($testTwoHidden) && $testTwoHidden) ? "" : "isRequired"; ?> form-control" title="Please Choose Test Kit 2">
                <?php $this->dropdownSelection($this->allTestKits, $this->evaluateData['results'][0]["test_kit_name_2"], true); ?>
            </select>
        </td>
        <td class='testThree colwidth'>
            <select name="test_kit_name_3" id="test_kit_name_3" class="<?php echo (isset($testThreeHidden) && $testThreeHidden) ? "" : "isRequired"; ?> form-control" title="Please Choose Test Kit 3">
                <?php $this->dropdownSelection($this->allTestKits, $this->evaluateData['results'][0]["test_kit_name_3"], true); ?>
            </select>
        </td>
        <td class="2-span colwidth" style="width: <?php echo $width; ?>%;" colspan="2"></td>
    </tr>
    <tr align="CENTER" class="dark colwidth">
        <th><?= $this->translate->_("Lot No."); ?></th>
        <?php if ($syphilisActive) { ?>
            <th class="colwidth"></th>
        <?php } ?>
        <td><input type="text" size="40" maxlength="40" name="lot_no_1" id="lot_no_1" value="<?php echo (isset($this->evaluateData['results'][0]["lot_no_1"]) ? $this->evaluateData['results'][0]["lot_no_1"] : ""); ?>" class="isRequired form-control" title="Please enter Lot No. 1" /></td>
        <td class='testTwo'><input type="text" size="40" maxlength="40" name="lot_no_2" id="lot_no_2" value="<?php echo (isset($this->evaluateData['results'][0]["lot_no_2"]) ? $this->evaluateData['results'][0]["lot_no_2"] : ""); ?>" class="<?php echo (isset($testTwoHidden) && $testTwoHidden) ? "" : "isRequired"; ?> form-control" title="Please enter Lot No. 2" /></td>
        <td class='testThree'><input type="text" size="40" maxlength="40" name="lot_no_3" id="lot_no_3" value="<?php echo (isset($this->evaluateData['results'][0]["lot_no_3"]) ? $this->evaluateData['results'][0]["lot_no_3"] : ""); ?>" class="<?php echo (isset($testThreeHidden) && $testThreeHidden) ? "" : "isRequired"; ?> form-control" title="Please enter Lot No. 3" /></td>
        <td class="2-span colwidth" style="width: <?php echo $width; ?>%;" colspan="2"></td>
    </tr>

    <tr style="text-align:center" class="colwidth">
        <th><?= $this->translate->_("Expiry Date"); ?></th>
        <?php if ($syphilisActive) { ?>
            <th class="colwidth"></th>
        <?php } ?>
        <td><input id="exp_date1" type="text" id="exp_date1" name="exp_date_1" value="<?php echo ((isset($this->evaluateData['results'][0]["exp_date_1"]) && $this->evaluateData['results'][0]["exp_date_1"] != "0000-00-00" && $this->evaluateData['results'][0]["exp_date_1"] != "") ? $this->dateFormat($this->evaluateData['results'][0]["exp_date_1"]) : ""); ?>" size="11" maxlength="11" class="datepicker form-control" readonly="readonly" /></td>
        <td class='testTwo'><input id="exp_date2" type="text" id="exp_date2" name="exp_date_2" value="<?php echo ((isset($this->evaluateData['results'][0]["exp_date_2"]) && $this->evaluateData['results'][0]["exp_date_2"] != "0000-00-00" && $this->evaluateData['results'][0]["exp_date_2"] != "") ? $this->dateFormat($this->evaluateData['results'][0]["exp_date_2"]) : ""); ?>" size="11" maxlength="11" class="datepicker form-control" readonly="readonly" /></td>
        <td class='testThree'><input id="exp_date3" type="text" id="exp_date3" name="exp_date_3" value="<?php echo ((isset($this->evaluateData['results'][0]["exp_date_3"]) && $this->evaluateData['results'][0]["exp_date_3"] != "0000-00-00" && $this->evaluateData['results'][0]["exp_date_3"] != "") ? $this->dateFormat($this->evaluateData['results'][0]["exp_date_3"]) : ""); ?>" size="11" maxlength="11" class="datepicker form-control" readonly="readonly" /></td>
        <td class="2-span colwidth" style="width: <?php echo $width; ?>%;" colspan="2"></td>
    </tr>
    <thead class="vl-results">
        <?php if ($allowRepeatTests == 'yes') { ?>
            <tr align="CENTER" class="light">
                <?php if ($syphilisActive) { ?>
                    <th class="4-span colwidth" colspan="<?php echo ($noTest + 2); ?>"></th>
                <?php } else { ?>
                    <th class="4-span colwidth" colspan="<?php echo ($noTest + 1); ?>"></th>
                <?php } ?>
                <th style="text-align: center;" class="3-span colwidth" colspan="<?php echo $noTest; ?>">
                    <?= $this->translate->_("Repeat-Tests"); ?>
                </th>
                <th class="3-span colwidth" style="width: <?php echo $width; ?>%;" colspan="2"></th>
            </tr>
        <?php } ?>
        <tr align="CENTER" class="dark">
            <th class="colwidth"><?= $this->translate->_("PT Panel Identifier"); ?></th>
            <?php if ($syphilisActive) { ?>
                <th class="syphilis-fields colwidth"><?= $this->translate->_("Type of Test"); ?></th>
            <?php } ?>
            <th style="text-align: center" class="colwidth"><?= $this->translate->_("Result-1"); ?></th>
            <th style="text-align: center" class='testTwo colwidth'><?= $this->translate->_("Result-2"); ?></th>
            <th style="text-align: center" class='testThree colwidth'><?= $this->translate->_("Result-3"); ?></th>
            <?php if ($allowRepeatTests == 'yes') { ?>
                <th style="text-align: center;" class="colwidth"><?= $this->translate->_("Result-1"); ?></th>
                <th style="text-align: center;" class='testTwo colwidth'><?= $this->translate->_("Result-2"); ?></th>
                <th style="text-align: center;" class='testThree colwidth'><?= $this->translate->_("Result-3"); ?></th>
            <?php } ?>
            <th style="text-align: center" class="colwidth"><?= $this->translate->_("Reported Result"); ?></th>
            <th style="text-align: center" class="colwidth"><?= $this->translate->_("Reference Result"); ?></th>
            <?php if ($ghanaNationalDtsAlgo) { ?>
                <th class="colwidth"><?= $this->translate->_("Is this a Retest?"); ?></th>
            <?php } ?>
        </tr>
    </thead>

    <?php
    $count = 1;
    if (count($this->evaluateData['controlResults']) > 0) { ?>
        <tr>
            <td colspan="7" style="text-align: center;">
                <strong><?= $this->translate->_("Controls"); ?></strong>
            </td>
        </tr>
    <?php }
    foreach ($this->evaluateData['controlResults'] as $sample) {
        $count++; ?>

        <tr style="text-align:center;vertical-align: middle;">

            <th style="white-space: nowrap;vertical-align: middle;" class="colwidth">
                <?php echo ($sample['sample_label']); ?> <?php echo ($sample['mandatory'] == 1) ? " <span class='mandatory'>*</span>" : "&nbsp;&nbsp;"; ?>
                <input type="hidden" id="sample<?php echo $count; ?>" name="sampleId[]" value="<?php echo $sample['sample_id']; ?>" />
            </th>
            <?php if ($syphilisActive) { ?>
                <th style="text-align:left;" class="syphilis-fields colwidth">
                    <ul style="list-style:none;padding: 0px;">
                        <li style="padding: 5% 4%;border-bottom: 1px solid gray;"><?= $this->translate->_("HIV"); ?></li>
                        <li style="padding: 5% 4%;"><?= $this->translate->_("SYPHILIS"); ?></li>
                    </ul>
                </th>
            <?php } ?>
            <td class="colwidth">
                <select name="test_result_1[]" id="<?php echo "testresult1_" . $count; ?>" class=" form-control">
                    <?php $this->dropdownSelection($possibleResults, $sample['test_result_1'], true); ?>
                </select>
                <?php if ($syphilisActive) { ?>
                    <div style="margin-top: 2%;padding-top: 4%;border-top: 1px solid gray;" class="syphilis-fields">
                        <select name="syphilis_result[]" id="<?php echo "syphilis_result_" . $count; ?>" class="form-control">
                            <?php $this->dropdownSelection($possibleSyphilisResults, $sample['syphilis_result'], true); ?>
                        </select>
                    </div>
                <?php } ?>
            </td>
            <td class='testTwo colwidth'>
                <select name="test_result_2[]" id="<?php echo "testresult2_" . $count; ?>" class=" form-control">
                    <?php $this->dropdownSelection($possibleResults, $sample['test_result_2'], true); ?>
                </select>
            </td>
            <td class='testThree colwidth'>
                <select name="test_result_3[]" id="<?php echo "testresult3_" . $count; ?>" class=" form-control">
                    <?php $this->dropdownSelection($possibleResults, $sample['test_result_3'], true); ?>
                </select>
            </td>
            <?php if ($allowRepeatTests == 'yes') { ?>
                <td>
                    <select name="repeat_test_result_1[]" id="<?php echo "repeat_test_result_1_" . $count; ?>" class="form-control">
                        <?php $this->dropdownSelection($possibleResults, $sample['repeat_test_result_1'], true); ?>
                    </select>
                </td>
                <td class='testTwo'>
                    <select name="repeat_test_result_2[]" id="<?php echo "repeat_test_result_2_" . $count; ?>" class="form-control">
                        <?php $this->dropdownSelection($possibleResults, $sample['repeat_test_result_2'], true); ?>
                    </select>
                </td>
                <td class='testThree'>
                    <select name="repeat_test_result_3[]" id="<?php echo "repeat_test_result_3_" . $count; ?>" class="form-control">
                        <?php $this->dropdownSelection($possibleResults, $sample['repeat_test_result_3'], true); ?>
                    </select>
                </td>
            <?php } ?>
            <td class="colwidth">
                <select name="reported_result[]" id="<?php echo "testresultf_" . $count; ?>" <?php echo ($sample['mandatory'] == 1) ? "class='isRequired form-control'" : "class=' form-control'"; ?> title="Please enter the result">
                    <?php $this->dropdownSelection($possibleFinalResults, $sample['reported_result'], true); ?>
                </select>
                <?php if ($syphilisActive) { ?>
                    <div style="margin-top: 2%;padding-top: 4%;border-top: 1px solid gray;" class="syphilis-fields">
                        <select name="syphilis_final[]" id="<?php echo "syphilis_final_" . $count; ?>" class="form-control">
                            <?php $this->dropdownSelection($possibleSyphilisFinalResults, $sample['syphilis_final'], true); ?>
                        </select>
                    </div>
                <?php } ?>
            </td>
            <?php if ($ghanaNationalDtsAlgo) { ?>
                <td style="width: <?php echo $width; ?>%;" class="colwidth">
                    <select name="is_this_retest[]" id="<?php echo "is_this_retest_" . $count; ?>" class="form-control" title="Please select restest or not?" style="float: left;">
                        <option value="">--<?= $this->translate->_("Select"); ?>--</option>
                        <option value="yes" <?php echo (isset($sample['is_this_retest']) && $sample['is_this_retest'] == "yes") ? "selected='selected'" : "" ?>><?= $this->translate->_("Yes"); ?></option>
                        <option value="no" <?php echo (isset($sample['is_this_retest']) && $sample['is_this_retest'] == "no") ? "selected='selected'" : "" ?>><?= $this->translate->_("No"); ?></option>
                    </select>
                </td>
            <?php } ?>
            <td style="vertical-align: middle;" class="colwidth">
                <?php $this->dropdownSelectedText($possibleFinalResults, $sample['reference_result'], true); ?>
            </td>
        </tr>
    <?php } ?>


    <tr>
        <td colspan="8" style="text-align: center;">
            <strong><?= $this->translate->_("Samples"); ?></strong>
        </td>
    </tr>
    <?php
    $total = 0;
    $count = 1;
    $showHideRtri = '';
    foreach ($this->evaluateData['results'] as $sample) {
        if ((!isset($sample['reported_result']) || $sample['reported_result'] != 4 || $sample['reported_result'] == '') && empty($showHideRtri)) {
            $showHideRtri = 'display:none;';
        } else {
            $showHideRtri = '';
        }
        $count++; ?>

        <tr style="text-align:center">
            <th style="white-space: nowrap;vertical-align: middle;" class="colwidth">
                <?php echo ($sample['sample_label']); ?> <?php echo ($sample['mandatory'] == 1) ? " <span class='mandatory'>*</span>" : "&nbsp;&nbsp;"; ?>
                <input type="hidden" id="sample<?php echo $count; ?>" name="sampleId[]" value="<?php echo $sample['sample_id']; ?>" />
            </th>
            <?php if ($syphilisActive) { ?>
                <th style="text-align:left;" class="syphilis-fields colwidth">
                    <ul style="list-style:none;padding: 0px;">
                        <li style="padding: 5% 4%;border-bottom: 1px solid gray;"><?= $this->translate->_("HIV"); ?></li>
                        <li style="padding: 5% 4%;"><?= $this->translate->_("SYPHILIS"); ?></li>
                    </ul>
                </th>
            <?php } ?>
            <td class="colwidth">
                <select name="test_result_1[]" id="<?php echo "testresult1_" . $count; ?>" class=" form-control">
                    <?php $this->dropdownSelection($possibleResults, $sample['test_result_1'], true); ?>
                </select>
                <?php if ($syphilisActive) { ?>
                    <div style="margin-top: 2%;padding-top: 4%;border-top: 1px solid gray;" class="syphilis-fields">
                        <select name="syphilis_result[]" id="<?php echo "syphilis_result_" . $count; ?>" class="form-control">
                            <?php $this->dropdownSelection($possibleSyphilisResults, $sample['syphilis_result'], true); ?>
                        </select>
                    </div>
                <?php } ?>
            </td>
            <td class='testTwo colwidth'>
                <select name="test_result_2[]" id="<?php echo "testresult2_" . $count; ?>" class=" form-control">
                    <?php $this->dropdownSelection($possibleResults, $sample['test_result_2'], true); ?>
                </select>
            </td>
            <td class='testThree colwidth'>
                <select name="test_result_3[]" id="<?php echo "testresult3_" . $count; ?>" class=" form-control">
                    <?php $this->dropdownSelection($possibleResults, $sample['test_result_3'], true); ?>
                </select>
            </td>
            <?php if ($allowRepeatTests == 'yes') { ?>
                <td>
                    <select name="repeat_test_result_1[]" id="<?php echo "repeat_test_result_1_" . $count; ?>" class="form-control">
                        <?php $this->dropdownSelection($possibleResults, $sample['repeat_test_result_1'], true); ?>
                    </select>
                </td>
                <td class='testTwo'>
                    <select name="repeat_test_result_2[]" id="<?php echo "repeat_test_result_2_" . $count; ?>" class="form-control">
                        <?php $this->dropdownSelection($possibleResults, $sample['repeat_test_result_2'], true); ?>
                    </select>
                </td>
                <td class='testThree'>
                    <select name="repeat_test_result_3[]" id="<?php echo "repeat_test_result_3_" . $count; ?>" class="form-control">
                        <?php $this->dropdownSelection($possibleResults, $sample['repeat_test_result_3'], true); ?>
                    </select>
                </td>
            <?php } ?>
            <td class="colwidth">
                <select name="reported_result[]" id="<?php echo "testresultf_" . $count; ?>" <?php echo ($sample['mandatory'] == 1) ? "class='isRequired form-control'" : "class=' form-control'"; ?> title="Please enter the result" onchange="rtriResultChange(this.value, <?php echo $sample['sample_id']; ?>);">
                    <?php $this->dropdownSelection($possibleFinalResults, $sample['reported_result'], true); ?>
                </select>
                <?php if ($syphilisActive) { ?>
                    <div style="margin-top: 2%;padding-top: 4%;border-top: 1px solid gray;" class="syphilis-fields">
                        <select name="syphilis_final[]" id="<?php echo "syphilis_final_" . $count; ?>" class="form-control">
                            <?php $this->dropdownSelection($possibleSyphilisFinalResults, $sample['syphilis_final'], true); ?>
                        </select>
                    </div>
                <?php } ?>
            </td>

            <td style="vertical-align: middle;" class="colwidth">
                <?php $this->dropdownSelectedText($possibleFinalResults, $sample['reference_result'], true); ?>
            </td>
            <?php if ($ghanaNationalDtsAlgo) { ?>
                <td style="width: <?php echo $width; ?>%;" class="colwidth">
                    <select name="is_this_retest[]" id="<?php echo "is_this_retest_" . $count; ?>" class="form-control" title="Please select restest or not?" style="float: left;">
                        <option value="">--<?= $this->translate->_("Select"); ?>--</option>
                        <option value="yes" <?php echo (isset($sample['is_this_retest']) && $sample['is_this_retest'] == "yes") ? "selected='selected'" : "" ?>><?= $this->translate->_("Yes"); ?></option>
                        <option value="no" <?php echo (isset($sample['is_this_retest']) && $sample['is_this_retest'] == "no") ? "selected='selected'" : "" ?>><?= $this->translate->_("No"); ?></option>
                    </select>
                </td>
            <?php } ?>
            </td>
        </tr>
    <?php } ?>
    <!--<tr style="text-align:center" >
        <td colspan="6" style="text-align: right;">Total</td>
        <td style="vertical-align: middle;"><?php echo $total; ?></td>
</tr>-->
</table>
<!-- If RTRI Enabled -->
<?php if (isset($shipmentAttributes['enableRtri']) && $shipmentAttributes['enableRtri'] == 'yes') { ?>
    <div class="rtrisection vlResultSection" style="<?php echo $showHideRtri . (isset($this->shipment['is_pt_test_not_performed']) && $this->shipment['is_pt_test_not_performed'] == 'yes') ? 'display:none;' : ''; ?>">
        <hr>
        <h4>RTRI Panel</h4>
        <table class="table table-bordered table-striped" style="width:100%;margin:10px auto;">
            <thead>
                <tr align="center" class="">
                    <th style="width:20%;text-align: center;"><?= $this->translate->_("Control/Sample"); ?></th>
                    <th style="width:20%;text-align: center;"><?= $this->translate->_("Control Line"); ?></th>
                    <th style="width:20%;text-align: center;"><?= $this->translate->_("Verification Line"); ?></th>
                    <th style="width:20%;text-align: center;"><?= $this->translate->_("Longterm Line"); ?></th>
                    <th style="width:20%;text-align: center;"><?= $this->translate->_("Final Results"); ?></th>
                </tr>
            </thead>
            <tbody id="rtrisectionTable">
                <?php $count = 0;
                foreach ($this->evaluateData['results'] as $sample) {
                    $count++; ?>
                    <tr class="light rtrivlResultSection<?php echo $sample['sample_id']; ?>" align="CENTER" style="<?php echo (!isset($sample['reported_result']) || $sample['reported_result'] != 4) ? 'display:none;' : ''; ?>">
                        <th style="white-space: nowrap">
                            <?php echo $sample['sample_label']; ?> <?php echo ($sample['mandatory'] == 1) ? " <span class='mandatory vlResultMandatory recency-mandatory rm-" . $count . "'>*</span>" : "&nbsp;&nbsp;<span class='mandatory vlResultMandatory recency-mandatory rm-" . $count . "' style='visibility:hidden;'>*</span>"; ?>
                            <input type="hidden" id="rtriSampleId<?php echo $count; ?>" name="rtriSampleId[]" value="<?php echo $sample['sample_id']; ?>" />
                        </th>

                        <td>
                            <select name="controlLine[]" id="controlLine<?php echo $count; ?>" class="recency-pt-tested form-control input-sm" title="Please choose control line">
                                <option value="">--<?= $this->translate->_("Select"); ?>--</option>
                                <option value="present" <?php echo (isset($sample['dts_rtri_control_line']) && $sample['dts_rtri_control_line'] == "present") ? "selected='selected'" : ""; ?>><?= $this->translate->_("Present"); ?></option>
                                <option value="absent" <?php echo (isset($sample['dts_rtri_control_line']) && $sample['dts_rtri_control_line'] == "absent") ? "selected='selected'" : ""; ?>><?= $this->translate->_("Absent"); ?></option>
                            </select>
                        </td>
                        <td>
                            <select name="verificationLine[]" id="verificationLine<?php echo $count; ?>" class="recency-pt-tested form-control input-sm" title="Please choose verification line">
                                <option value="">--<?= $this->translate->_("Select"); ?>--</option>
                                <option value="present" <?php echo (isset($sample['dts_rtri_diagnosis_line']) && $sample['dts_rtri_diagnosis_line'] == "present") ? "selected='selected'" : ""; ?>><?= $this->translate->_("Present"); ?></option>
                                <option value="absent" <?php echo (isset($sample['dts_rtri_diagnosis_line']) && $sample['dts_rtri_diagnosis_line'] == "absent") ? "selected='selected'" : ""; ?>><?= $this->translate->_("Absent"); ?></option>
                            </select>
                        </td>
                        <td>
                            <select name="longtermLine[]" id="longtermLine<?php echo $count; ?>" class="recency-pt-tested form-control input-sm" title="Please choose Longterm line">
                                <option value="">--<?= $this->translate->_("Select"); ?>--</option>
                                <option value="present" <?php echo (isset($sample['dts_rtri_longterm_line']) && $sample['dts_rtri_longterm_line'] == "present") ? "selected='selected'" : ""; ?>><?= $this->translate->_("Present"); ?></option>
                                <option value="absent" <?php echo (isset($sample['dts_rtri_longterm_line']) && $sample['dts_rtri_longterm_line'] == "absent") ? "selected='selected'" : ""; ?>><?= $this->translate->_("Absent"); ?></option>
                            </select>
                        </td>
                        <td class="dark">
                            <select name="rtriResult[]" id="rtriResult<?php echo $count; ?>" style="width: 200px" class="recency-pt-tested form-control vlResultValues" title="Please select the result for <?php echo $sample['sample_label']; ?>">
                                <?php $this->dropdownSelection($rtriFinalPossibleResults, $sample['dts_rtri_reported_result'], true); ?>
                            </select>
                            <input type="hidden" name="enableRtri" id="enableRtri" value="<?php echo $shipmentAttributes['enableRtri']; ?>" />
                        </td>
                    </tr>
                <?php } ?>
            </tbody>
        </table>
    </div>
<?php  } ?>
<script>
    function showHideTest2() {

        var test2Hidden = "<?php echo $testTwoHidden ? 'yes' : 'no'; ?>";

        if (test2Hidden == 'yes') {
            $('.testTwo').hide();
        } else {
            $('.testTwo').show();
        }

    }

    function showHideTest3() {

        var test3Hidden = "<?php echo $testThreeHidden ? 'yes' : 'no'; ?>";
        var screeningTest = "<?php echo $screeningTest ? 'yes' : 'no'; ?>";

        if (screeningTest == 'yes' || (test3Hidden == 'yes' && $("#algorithm").val() != 'myanmarNationalDtsAlgo')) {
            $('.testThree').hide();
        } else {
            $('.testThree').show();
        }

    }

    $(function() {
        var totalCols = $(".vl-results > tr:nth-child(1) > th").length;
        var _width = (100 / totalCols);
        $(".colwidth").css('width', _width + "%");
        $(".4-span").css('width', (_width * 4) + "%");
        $(".3-span").css('width', (_width * 3) + "%");
        $(".2-span").css('width', (_width * 2) + "%");

        showHideTest2();
        showHideTest3();
    });

    function rtriResultChange(value, id) {
        if (value == 4) {
            $('.rtrisection, .rtrivlResultSection' + id).show();
        } else {
            $("input[name='sampleId[]']").each(function(index) {
                if ($("#testresultf_" + this.value).val() != 4) {
                    $('.rtrivlResultSection' + this.value + ' input, .rtrivlResultSection' + this.value + ' select').val('');
                    $('.rtrivlResultSection' + this.value).hide();
                }
            });
            _visible = false;
            $("#rtrisectionTable tr").each(function(index) {
                if ($(this).is(":visible")) {
                    _visible = true;
                }
            });
            if (!_visible) {
                $('.rtrisection').hide();
            }
        }
    }
</script>