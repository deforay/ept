<link rel="stylesheet" href="<?php echo $this->baseUrl('css/daterangepicker.css'); ?>" type="text/css" media="all">
<script type="text/javascript" src="<?php echo $this->baseUrl('js/jquery3.min.js'); ?>"></script>
<script type="text/javascript" src="<?php echo $this->baseUrl('js/moment.min.js'); ?>"></script>
<link href="<?php echo $this->baseUrl('css/select2.css'); ?>" rel="stylesheet" />
<legend>
	<h3 style="display: inline-block;"><?= $this->translate->_("Annual Performance Report"); ?></h3>
	<a href="<?= $this->url(['module' => 'admin', 'controller' => 'certificate-batches'], 'default', true); ?>" class="btn btn-default btn-sm" style="float: right; margin-top: 5px;">
		<i class="icon-list-alt"></i> <?= $this->translate->_("View All Certificate Batches"); ?>
	</a>
</legend>
<table style="margin:20px 0;" class="table table-bordered">

	<tr>
		<td style="width:20%">
			<input type="text" id="dateRange" name="dateRange" class="form-control input-sm" readonly="readonly" style="background: #fff" placeholder="Click here to pick the Date Range" />
		</td>
		<td style="width:20%">
			<select id="scheme" name="scheme" class="form-control input-sm" multiple="multiple" onchange="getShipmentCodes()" style="width:100%;">
				<option></option>
				<?php foreach ($this->schemes as $scheme) { ?>
					<option value="<?php echo $scheme['scheme_id']; ?>"><?php echo $scheme['scheme_name']; ?></option>
				<?php } ?>
			</select>
		</td>
		<td style="width:25%">
			<select id="shipmentId" class="form-control input-sm" name="shipmentId" multiple="multiple" style="width:100%;">
				<option></option>
			</select>
		</td>
		<td style="width:15%">
			<select id="reportType" class="form-control input-sm" name="reportType" style="width:100%;">
				<option value="csv"><?= $this->translate->_("Annual Report Only"); ?></option>
				<option value="excel"><?= $this->translate->_("For Certification"); ?></option>
			</select>
		</td>
	</tr>
	<tr>
		<td colspan="4" class="dontPrint" style="width:15%"><button class="btn btn-success btn-sm" onclick="getAnnualReport()"><span><?= $this->translate->_("Get Report"); ?></span></button> <button class="btn btn-danger btn-sm" onclick="document.location.href = document.location"><span><?= $this->translate->_("Reset"); ?></span></button></td>
	</tr>

</table>
<br />
<br />
<div align="left" style="padding-top:3px;" class="col-lg-12">
	<span id="summaryDiv">

	</span>
</div>
<div align="left" style="margin-top: 3em;display: none;" class="col-lg-12 certificate-btn">
	<div style="width: 74%;display: flex;">
		<input type="text" style="width:30%;margin-right: 34px;" class="form-control input-sm" name="certificateName" id="certificateName" placeholder="Enter certificate name" title="Please enter certificate name to filter">
		<a href="javascript:void(0);" onclick="genarateCertificate(this);" class="btn-sm btn btn-info certificate-anchor"><i class="icon-certificate"></i> Generate Certificates</a>
	</div>
</div>

<!-- Certificate Generation Progress Section -->
<div id="certificateProgressSection" class="col-lg-12" style="display: none; margin-top: 2em;">
	<div id="certificateProgressIndicator" style="display: none;">
		<div class="alert alert-info">
			<i class="icon-spinner icon-spin"></i> <span id="progressMessage">Generating certificates...</span>
		</div>
	</div>

	<div id="certificateErrorSection" style="display: none;">
		<div class="alert alert-danger">
			<strong>Error:</strong> <span id="certificateErrorMessage"></span>
		</div>
	</div>

	<div id="certificateStatsSection" style="display: none;">
		<h4>Certificate Generation Summary</h4>
		<table class="table table-bordered table-striped" style="width: 50%;">
			<tbody>
				<tr>
					<td><strong>Excellence Certificates</strong></td>
					<td id="excellenceCount">0</td>
				</tr>
				<tr>
					<td><strong>Participation Certificates</strong></td>
					<td id="participationCount">0</td>
				</tr>
				<tr>
					<td><strong>Skipped (No certificates)</strong></td>
					<td id="skippedCount">0</td>
				</tr>
			</tbody>
		</table>
		<div style="margin-top: 1em;">
			<a href="javascript:void(0);" id="downloadZipBtn" class="btn btn-success btn-sm" target="_blank" style="margin-right: 10px;">
				<i class="icon-download"></i> Download ZIP
			</a>
			<a href="javascript:void(0);" onclick="approveCertificates();" id="approveDistributeBtn" class="btn btn-primary btn-sm">
				<i class="icon-ok"></i> Approve &amp; Distribute
			</a>
		</div>
	</div>

	<div id="certificateDistributionSection" style="display: none;">
		<div class="alert alert-success">
			<i class="icon-ok"></i> <span id="distributionMessage">Certificates approved! Distribution has been scheduled and will begin shortly.</span>
		</div>
	</div>
</div>
<script type="text/javascript" src="<?php echo $this->baseUrl('js/daterangepicker.js'); ?>"></script>
<script type="text/javascript" src="<?php echo $this->baseUrl('js/select2.min.js'); ?>"></script>
<script type="text/javascript">
	var startDate = "";
	var endDate = "";
	var shipmentCode = false;
	var currentBatchId = null;
	var pollingInterval = null;
	$(document).ready(function() {
		$("#scheme").select2({
				placeholder: "Select one or more schemes",
				allowClear: true
			})
			.on("change", function(e) {
				//console.log("change val=" + e.val);
				//$("#scheme").select2("val","");
			});

		$("#shipmentId").select2({
			placeholder: "Select one or more shipments",
			allowClear: true
		});


		$('#certificateName').on('input', function(event) {
			allowOnlyAlphaNumericAndHyphen('#certificateName');
		});

		$('#dateRange').daterangepicker({
				locale: {
					cancelLabel: 'Clear',
					format: 'DD-MMM-YYYY',
					separator: ' to ',
				},
				showDropdowns: true,
				autoApply: true,
				alwaysShowCalendars: true,
				autoUpdateInput: true,
				startDate: moment().subtract(179, 'days'),
				endDate: moment(),
				maxDate: moment(),
				ranges: {
					'This Month': [moment().startOf('month'), moment().endOf('month')],
					'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
					'Last 60 Days': [moment().subtract(59, 'days'), moment()],
					'Last 90 Days': [moment().subtract(89, 'days'), moment()],
					'Last 180 Days': [moment().subtract(179, 'days'), moment()],
					'Last 12 Months': [moment().subtract(12, 'month'), moment()],
					'Last 18 Months': [moment().subtract(18, 'month'), moment()],
					'Previous Year': [moment().subtract(1, 'year').startOf('year'), moment().subtract(1, 'year').endOf('year')],
					'Current Year To Date': [moment().startOf('year'), moment()]
				}
			},
			function(start, end) {
				startDate = start.format('DD-MMM-YYYY');
				endDate = end.format('DD-MMM-YYYY');
			});
		var dateRange = $("#dateRange").val();
		var _dateRange = dateRange.split(" to ");
		startDate = _dateRange[0];
		endDate = _dateRange[1];
	});

	function getShipmentCodes() {
		schemeType = $("#scheme").select2("val");
		$('#shipmentId').select2('data', null);
		$.blockUI();
		$.post("<?php echo $this->url(array('module' => 'reports', 'controller' => 'common', 'action' => 'get-shipments-by-date')); ?>", {
				schemeType: schemeType,
				startDate: startDate,
				endDate: endDate,
				format: "html"
			},
			function(data) {
				if (data == 0) {
					shipmentCode = false;
				} else {
					$("#shipmentId").html(data);
					shipmentCode = true;
				}

				$.unblockUI();
			});
	}

	function getAnnualReport() {
		if (startDate == "" || endDate == "") {
			alert('Please pick a date range to fetch shipment list');
			return false;
		}
		if (shipmentCode) {
			$.blockUI();
			scheme = $("#scheme").select2("val");
			shipmentId = $("#shipmentId").select2("val");
			$.post("<?php echo $this->url(array('module' => 'reports', 'controller' => 'annual', 'action' => 'index'), 'default', true); ?>", {
					startDate: startDate,
					endDate: endDate,
					scheme: scheme,
					shipmentId: shipmentId,
					reportType: $("#reportType").val(),
					format: "html"
				},
				function(data) {
					data = $.parseJSON(data);
					if (data.fileName) {
						$("#summaryDiv").html("&nbsp;&nbsp;<a href='<?php echo $this->baseUrl("temporary/annual-reports/"); ?>" + data.fileName + "' class='btn btn-info btn-sm' target='_BLANK' style='margin-top:10px;float:left;clear:both;'><i class='icon-file-text'></i> Download " + data.fileName + " </a>");
						$(".certificate-btn").hide();
						$(".certificate-anchor").attr("disabled", true);
					}
					if (data.reportType && data.reportType == "excel") {
						$(".certificate-btn").show();
						$(".certificate-anchor").attr("disabled", false);
					}
					$.unblockUI();
				});
		} else {
			alert("Shipment not available,Please select correct date and scheme");
		}
	}

	function genarateCertificate(obj) {
		var _certificateName = $("#certificateName").val();
		if (_certificateName != "") {

			$.blockUI();
			scheme = $("#scheme").select2("val");
			shipmentId = $("#shipmentId").select2("val");
			$.post("<?php echo $this->url(['module' => 'reports', 'controller' => 'annual', 'action' => 'save-scheduled-jobs'], 'default', true); ?>", {
					startDate: startDate,
					endDate: endDate,
					scheme: scheme,
					shipmentId: shipmentId,
					certificateName: _certificateName,
					format: "html"
				},
				function(data) {
					$.unblockUI();
					if (data == 9999999) {
						alert("Please ensure the template files for the selected scheme(s) are available and readable");
					} else if (data > 0) {
						// Store batch_id and start polling
						currentBatchId = parseInt(data);
						$(obj).attr("disabled", true);

						// Show progress section and indicator
						resetCertificateUI();
						$("#certificateProgressSection").show();
						$("#certificateProgressIndicator").show();
						$("#progressMessage").text("Generating certificates...");

						// Start polling for status
						startStatusPolling();
					} else {
						alert("No matched shipment for selected date range.");
					}

				});
		} else {
			alert("Please enter the certificate name to proceed")
		}
	}

	function resetCertificateUI() {
		$("#certificateProgressIndicator").hide();
		$("#certificateErrorSection").hide();
		$("#certificateStatsSection").hide();
		$("#certificateDistributionSection").hide();
	}

	function startStatusPolling() {
		// Clear any existing polling
		if (pollingInterval) {
			clearInterval(pollingInterval);
		}

		// Poll every 3 seconds
		pollingInterval = setInterval(function() {
			checkCertificateStatus();
		}, 3000);
	}

	function stopStatusPolling() {
		if (pollingInterval) {
			clearInterval(pollingInterval);
			pollingInterval = null;
		}
	}

	function checkCertificateStatus() {
		if (!currentBatchId) {
			stopStatusPolling();
			return;
		}

		$.get("<?php echo $this->url(['module' => 'reports', 'controller' => 'annual', 'action' => 'get-certificate-status'], 'default', true); ?>", {
			batch_id: currentBatchId,
			format: "json"
		}, function(response) {
			if (!response.success) {
				stopStatusPolling();
				showCertificateError(response.error_message || "Failed to get status");
				return;
			}

			switch (response.status) {
				case 'pending':
				case 'processing':
					// Still generating, update message and continue polling
					$("#progressMessage").text(response.status === 'processing' ? "Processing certificates..." : "Waiting to start...");
					break;

				case 'generated':
					// Generation complete, show stats and buttons
					stopStatusPolling();
					showCertificateStats(response);
					break;

				case 'failed':
					// Generation failed
					stopStatusPolling();
					showCertificateError(response.error_message || "Certificate generation failed");
					break;

				case 'approved':
				case 'distributing':
				case 'distributed':
					// Already approved/distributed
					stopStatusPolling();
					showDistributionStatus(response.status);
					break;

				default:
					// Unknown status, continue polling
					break;
			}
		}).fail(function() {
			// Request failed, but keep polling
			console.error("Failed to check certificate status");
		});
	}

	function showCertificateError(message) {
		resetCertificateUI();
		$("#certificateProgressSection").show();
		$("#certificateErrorSection").show();
		$("#certificateErrorMessage").text(message);
	}

	function showCertificateStats(data) {
		resetCertificateUI();
		$("#certificateProgressSection").show();
		$("#certificateStatsSection").show();

		$("#excellenceCount").text(data.excellence_count);
		$("#participationCount").text(data.participation_count);
		$("#skippedCount").text(data.skipped_count);

		if (data.download_url) {
			$("#downloadZipBtn").attr("href", data.download_url).show();
		} else {
			$("#downloadZipBtn").hide();
		}
	}

	function showDistributionStatus(status) {
		resetCertificateUI();
		$("#certificateProgressSection").show();
		$("#certificateDistributionSection").show();

		var message = "Certificates approved!";
		switch (status) {
			case 'approved':
				message = "Certificates approved! Distribution has been scheduled and will begin shortly.";
				break;
			case 'distributing':
				message = "Certificates are being distributed...";
				break;
			case 'distributed':
				message = "Certificates have been successfully distributed!";
				break;
		}
		$("#distributionMessage").text(message);
	}

	function approveCertificates() {
		if (!currentBatchId) {
			alert("No batch selected");
			return;
		}

		if (!confirm("Are you sure you want to approve and distribute these certificates?")) {
			return;
		}

		$.blockUI();
		$.post("<?php echo $this->url(['module' => 'reports', 'controller' => 'annual', 'action' => 'approve-certificates'], 'default', true); ?>", {
			batch_id: currentBatchId,
			format: "json"
		}, function(response) {
			$.unblockUI();

			if (response.success) {
				showDistributionStatus('approved');
			} else {
				alert(response.message || "Failed to approve certificates");
			}
		}).fail(function() {
			$.unblockUI();
			alert("Failed to approve certificates. Please try again.");
		});
	}
</script>
