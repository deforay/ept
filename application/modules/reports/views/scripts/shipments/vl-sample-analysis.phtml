<?php
//Zend_Debug::dump($this->vlAssayCount);
?>
<link rel="stylesheet" href="<?php echo $this->baseUrl('css/daterangepicker.css'); ?>" type="text/css" media="all">
<style>
    @media print {

        .dontPrint,
        #testKitTable_filter,
        #testKitTable_info {
            display: none;

        }
    }
    .vl-assay-section {
        margin-top: 25px;
    }
    .vl-assay-grid {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
        gap: 12px;
    }
    .vl-assay-grid-wrapper {
        height: auto;
        max-height: none;
        overflow: visible;
    }
    .vl-assay-card {
        border: 1px solid #e3e3e3;
        border-radius: 4px;
        padding: 10px;
        background: #fff;
        box-shadow: 0 1px 2px rgba(0,0,0,0.05);
    }
    .vl-assay-card h5 {
        margin: 0 0 6px 0;
        font-size: 14px;
        font-weight: 600;
    }
    .vl-assay-meta {
        font-size: 12px;
        color: #666;
        margin-bottom: 6px;
    }
    .vl-toggle {
        display: inline-flex;
        border: 1px solid #3b5a9a;
        border-radius: 6px;
        overflow: hidden;
        vertical-align: middle;
        margin: 0 6px;
    }
    .vl-toggle .vl-toggle-btn {
        padding: 4px 10px;
        font-size: 12px;
        cursor: pointer;
        background: #fff;
        color: #3b5a9a;
        border: none;
    }
    .vl-toggle .vl-toggle-btn.active {
        background: #3b5a9a;
        color: #fff;
    }
</style>
<legend>
    <h3>VL Sample Analysis</h3>
</legend>
<table style="margin:20px 0;" class="table table-bordered">
    <tr>
        <td style="width:150px;text-align: center;font-weight:bold;">
            Pick a Date Range
        </td>
        <td style="width:200px;text-align: center;font-weight:bold;">
            Select Shipment
        </td>
        <td class="dontPrint" style="width:115px;text-align: center;font-weight:bold;">Action</td>
    </tr>
    <tr>
        <td>
            <input type="text" id="dateRange" name="dateRange" class="form-control input-sm" readonly="readonly"
                style="background: #fff" placeholder="Click here to pick a Date Range" />
        </td>
        <td>
            <select id="shipmentId" name="shipmentId" class="form-control input-sm">
                <option value=''>-- Select Date Range to populate this list --</option>
            </select>
        </td>
        <td class="dontPrint"><button class="btn btn-success btn-sm"
                onclick="drawTable()"><span><?= $this->translate->_("Get Report"); ?></span></button> <button
                class="btn btn-danger btn-sm"
                onclick="document.location.href = document.location"><span><?= $this->translate->_("Reset"); ?></span></button>
            <button class="btn btn-info btn-sm hide" id="exportExcel" onclick="shipmentExcel()"><span><i
                        class="icon-download"></i> Excel</span></button> <a href="#" class="btn btn-primary btn-sm hide"
                id="exportPdf" target="_blank"><i class="icon-download"></i> PDF</a>
        </td>
    </tr>
</table>
<br />

<div id="shipmentchart"></div>

<br />

<div class="vl-assay-section">
    <h4 id="vlAssayDistributionsTitle" class="hide">VL Response Distribution by Assay</h4>
    <div id="vlScatterAxisToggle" class="vl-assay-meta dontPrint hide" style="margin-bottom:6px;">
        <span style="margin-right:6px;">X-axis</span>
        <div class="vl-toggle" id="vlScatterAxisMode">
            <button type="button" class="vl-toggle-btn active" data-mode="participants">Participants</button>
            <button type="button" class="vl-toggle-btn" data-mode="log10">log10 VL</button>
        </div>
    </div>
    <div id="vlAssayDistributions" class="vl-assay-grid-wrapper">
        <div class="vl-assay-meta">Select a shipment and click Get Report to view distributions.</div>
    </div>
    <div id="vlAssayDistributionsNote" class="vl-assay-meta hide" style="margin-top:6px;">
        Note: Each chart aggregates all log10 reported viral loads for an assay across all samples in the shipment. Values outside assay sample ranges are excluded; 0 values are counted as Undetectable.
    </div>
</div>

<br />

<table cellpadding="0" cellspacing="0" border="0" class="table table-striped table-bordered table-hover hide"
    id="shipmentTable">
    <thead>
        <tr>
            <th style="text-align: center;">Participant Name</th>
            <th style="text-align: center;">Score</th>
            <th style="text-align: center;">Shipment Test Date</th>
            <th style="text-align: center;">Shipment Receipt Date</th>
            <!--<th style="text-align: center;">Total Valid Responses<br/><small>(Total - Excluded)</small></th>-->
        </tr>
    </thead>
    <tbody>
        <tr>
            <td colspan="10" class="dataTables_empty"><?= $this->translate->_("Loading data from server"); ?></td>
        </tr>
    </tbody>
</table>

<script type="text/javascript" src="<?php echo $this->baseUrl('js/jquery3.min.js'); ?>"></script>
<script type="text/javascript" src="<?php echo $this->baseUrl('js/moment.min.js'); ?>"></script>
<script type="text/javascript" src="<?php echo $this->baseUrl('js/daterangepicker.js'); ?>"></script>
<script type="text/javascript">
    var startDate = "";
    var endDate = "";
    var paginate = true;
    $(document).ready(function () {
        var defaultStart = moment().subtract(24, 'month');
        var defaultEnd = moment();
        $('#dateRange').daterangepicker({
            locale: {
                cancelLabel: 'Clear',
                format: 'DD-MMM-YYYY',
                separator: ' to ',
            },
            autoApply: true,
            showDropdowns: true,
            alwaysShowCalendars: true,
            autoUpdateInput: true,
            startDate: defaultStart,
            endDate: defaultEnd,
            ranges: {
                'This Month': [moment().startOf('month'), moment().endOf('month')],
                'Last Month': [moment().subtract(1, 'month').startOf('month'), moment().subtract(1, 'month').endOf('month')],
                'Last 60 Days': [moment().subtract(59, 'days'), moment()],
                'Last 90 Days': [moment().subtract(89, 'days'), moment()],
                'Last 180 Days': [moment().subtract(179, 'days'), moment()],
                'Last 12 Months': [moment().subtract(12, 'month'), moment()],
                'Last 18 Months': [moment().subtract(18, 'month'), moment()],
            }
        },
            function (start, end) {
                startDate = start.format('DD-MMM-YYYY');
                endDate = end.format('DD-MMM-YYYY');
                getShipmentCodes();
            });
        startDate = defaultStart.format('DD-MMM-YYYY');
        endDate = defaultEnd.format('DD-MMM-YYYY');
        $('#dateRange').val(startDate + ' to ' + endDate);
        getShipmentCodes();
    });

    function getShipmentCodes() {
        schemeType = 'vl';
        if (startDate == "" || endDate == "") {
            alert('Please pick a date range to fetch shipment list');
            $('#dateRange').focus();
            return false;
        }
        $.blockUI();
        $.post("<?php echo $this->url(array('module' => 'reports', 'controller' => 'common', 'action' => 'get-shipments-by-scheme')); ?>", {
            schemeType: schemeType,
            startDate: startDate,
            endDate: endDate,
            format: "html"
        },
            function (data) {
                if (data != 0) {
                    barChart = true;
                    $("#shipmentId").html(data);
                } else {
                    $("#shipmentId").html("<option value=''>-- Select Date Range to populate this list --</option>");
                    $("#shipmentchart").html('');
                    barChart = false;
                }
                $.unblockUI();
            });
    }

    function drawTable() {
        if ($("#dateRange").val() == "") {
            alert("Please pick date range and shipment to proceed");
            return false;
        } else {
            var dateRange = $("#dateRange").val();
            var _dateRange = dateRange.split(" to ");
            startDate = _dateRange[0];
            endDate = _dateRange[1];

            $("#shipmentTable").removeClass("hide");
            $.blockUI;
            oTable = $('#shipmentTable').dataTable({
                "bPaginate": paginate,
                "bJQueryUI": false,
                "bAutoWidth": false,
                "bInfo": true,
                "bScrollCollapse": true,
                "sPaginationType": "bootstrap",
                "bRetrieve": false,
                "bDestroy": true,
                "aoColumns": [{
                    "sClass": ""
                },
                {
                    "sClass": "center"
                },
                {
                    "sClass": "center"
                },
                {
                    "sClass": "center"
                },
                ],
                "aaSorting": [
                    [1, "asc"]
                ],
                "bProcessing": true,
                "bServerSide": true,
                "sAjaxSource": "<?php echo $this->url(array('module' => 'reports', 'controller' => 'shipments', 'action' => 'vl-sample-analysis', 'format' => 'html')); ?>",
                "fnServerParams": function (aoData) {
                    aoData.push({
                        "name": "shipmentId",
                        "value": $("#shipmentId").val()
                    });
                    aoData.push({
                        "name": "startDate",
                        "value": startDate
                    });
                    aoData.push({
                        "name": "endDate",
                        "value": endDate
                    });
                },
                "fnServerData": function (sSource, aoData, fnCallback) {
                    $.ajax({
                        "dataType": 'json',
                        "type": "POST",
                        "url": sSource,
                        "data": aoData,
                        "success": fnCallback
                    });
                },
                "fnRowCallback": function (nRow, aData, iDisplayIndex) {
                    $.unblockUI;
                },
            });
            if (barChart) {
                showBarChart();
                showAssayDistributions();
            }
        }
    }

    function showBarChart() {
        shipmentId = $("#shipmentId").val();
        $.post("<?php echo $this->url(array('module' => 'reports', 'controller' => 'shipments', 'action' => 'vl-sample-analysis-result')); ?>", {
            shipmentId: shipmentId,
            start: startDate,
            end: endDate,
            format: "html"
        },
            function (data) {
                $("#shipmentchart").html(data);
                $.unblockUI();
            });
    }

    function showAssayDistributions() {
        shipmentId = $("#shipmentId").val();
        $.post("<?php echo $this->url(array('module' => 'reports', 'controller' => 'shipments', 'action' => 'vl-assay-distribution-plot')); ?>", {
            shipmentId: shipmentId,
            start: startDate,
            end: endDate,
            format: "html"
        },
            function (data) {
                $("#vlAssayDistributions").html(data);
                if (data && data.indexOf('vl-assay-card') !== -1) {
                    $("#vlAssayDistributionsTitle").removeClass("hide");
                    $("#vlAssayDistributionsNote").removeClass("hide");
                    $("#vlScatterAxisToggle").removeClass("hide");
                } else {
                    $("#vlAssayDistributionsTitle").addClass("hide");
                    $("#vlAssayDistributionsNote").addClass("hide");
                    $("#vlScatterAxisToggle").addClass("hide");
                }
            });
    }
</script>
