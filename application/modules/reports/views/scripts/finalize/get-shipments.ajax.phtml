<?php
if ($this->shipments == false && count($this->shipments) <= 0) {
	echo "<br/><br/><br/><h4 style='text-align:center;'>" . $this->translate->_("Unable to fetch shipments. Please try again later or contact system admin for help") . "</h4>";
} else {
	?>


	<div class="modal-dialog" style="width:100%;">
		<div class="modal-header">
			<h4 class="modal-title"><?= $this->translate->_("Shipments Under PT Survey"); ?> <?php echo $this->shipments[0]['distribution_code']; ?>
				(<?php echo $this->dateFormat($this->shipments[0]['distribution_date']); ?>)</h4>
		</div>
		<div class="modal-body">
			<table class="table table-bordered table-striped table-hover">
				<tr>
					<th style="text-align: center;"><?= $this->translate->_("Shipment Code"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("Scheme"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("No. of Samples"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("No. of Participants"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("No. of Responses"); ?></th>
					<th style="text-align: center;"><?= $this->translate->_("Response %"); ?></th>
					<th style="text-align: center;">
						<?= $this->translate->_("Number Passed"); ?>
					</th>
					<th style="text-align: center;">
						<?= $this->translate->_("Shipment Status"); ?>
					</th>
					<th style="text-align: center;">
						<?= $this->translate->_("Action"); ?>
					</th>
				</tr>
				<?php
				if (count($this->shipments) > 0) {
					foreach ($this->shipments as $shipment) {
						$reported = (isset($shipment['reported_count']) && $shipment['reported_count'] > 0) ? $shipment['reported_count'] : 0;

						// Get button states from common function
						$btnStates = Application_Service_Shipments::getShipmentButtonStates($shipment);
						$displayStatus = $this->translate->_($btnStates['displayStatus']);
						$isFinalized = $btnStates['isFinalized'];
						$finalizeEnabled = $btnStates['finalizeEnabled'];
						$finalizeClass = $finalizeEnabled ? '' : 'disabled';
						$encodedShipmentId = base64_encode($shipment['shipment_id']);
						?>
						<tr>
							<td style="text-align: center;"><?php echo $shipment['shipment_code'] ?></td>
							<td style="text-align: center;"><?php echo ($shipment['scheme_name']) ?></td>
							<td style="text-align: center;"><?php echo $shipment['number_of_samples'] ?></td>
							<td style="text-align: center;"><?php echo $shipment['participant_count'] ?></td>
							<td style="text-align: center;"><?php echo $reported ?></td>
							<td style="text-align: center;">
								<?php echo (isset($shipment['participant_count']) && $shipment['participant_count'] > 0) ? round(($reported / $shipment['participant_count']) * 100, 2) : 0; ?>
							</td>
							<td style="text-align: center;">
								<?php echo (isset($shipment['number_passed']) && $shipment['number_passed'] >= 0) ? $shipment['number_passed'] : 0; ?>
							</td>
							<td style="text-align: center;"><?= $displayStatus; ?></td>
							<td style="text-align: center;">
								<?php if ($finalizeEnabled): ?>
									<a class="btn btn-success btn-xs"
										href="/reports/distribution/finalize/sid/<?= $encodedShipmentId; ?>">
										<i class="icon-check"></i> <?= $this->translate->_("Finalize"); ?>
									</a>
								<?php elseif ($isFinalized): ?>
									<a class="btn btn-danger btn-xs disabled" href="javascript:void(0)">
										<i class="icon-check"></i> <?= $this->translate->_("Finalized"); ?>
									</a>
									<?php if ($shipment['report_generated'] == 'yes'):
										if (file_exists(UPLOAD_PATH . DIRECTORY_SEPARATOR . "reports" . DIRECTORY_SEPARATOR . $shipment['shipment_code'] . DIRECTORY_SEPARATOR . $shipment['shipment_code'] . "-summary.pdf")):
											$filePath = base64_encode(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . "reports" . DIRECTORY_SEPARATOR . $shipment['shipment_code'] . DIRECTORY_SEPARATOR . $shipment['shipment_code'] . "-summary.pdf");
											?>
											<a class="btn btn-success btn-xs" href="/d/<?= $filePath; ?>" target="_blank">
												<i class="icon-check"></i> <?= $this->translate->_("Download Summary Report"); ?>
											</a>
										<?php endif;
										$buttonCount = (int) ceil($reported / 50);
										$start = 1;
										$lastEnd = ($reported >= 50) ? 50 : $reported;
										for ($i = 1; $i <= $buttonCount; $i++):
											$end = ($reported >= 50) ? $i * 50 : $reported;
											if ($end > $reported):
												$sub = $reported - $lastEnd;
												$start = $lastEnd + 1;
												$end = $lastEnd + $sub;
											elseif ($i != 1):
												$start = $lastEnd + 1;
												$lastEnd = $end;
											endif;
											$participantReportPath = DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . "reports" . DIRECTORY_SEPARATOR . $shipment['shipment_code'] . DIRECTORY_SEPARATOR . $shipment['shipment_code'] . "-" . $start . "-" . $end . "-bulk-participant-report.pdf";
											if (file_exists($participantReportPath)):
												$filePath = base64_encode($participantReportPath);
												?>
												<a class="btn btn-info btn-xs" href="/d/<?= $filePath; ?>" target="_blank">
													<i class="icon-check"></i> <?= $this->translate->_("Download"); ?> <?= $start; ?> - <?= $end; ?> <?= $this->translate->_("Participants Report"); ?>
												</a>
											<?php endif;
										endfor;
									endif; ?>
								<?php else: ?>
									<a class="btn btn-primary btn-xs disabled" href="javascript:void(0)">
										<i class="icon-check"></i> <?= $this->translate->_("Finalize"); ?>
									</a>
								<?php endif; ?>
							</td>
						</tr>
						<?php
					}
				} else {
					?>
					<tr>
						<td colspan="5" align="center" style="text-align:center">
							<?= $this->translate->_("No shipments for this distribution yet"); ?>
						</td>
					</tr>
					<?php
				}
				?>
			</table>
		</div>
	</div><!-- /.modal-dialog -->


	<?php
}
