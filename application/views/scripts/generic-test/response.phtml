<?php
$authNameSpace = new Zend_Session_Namespace('datamanagers');

if (isset($this->shipment["shipment_test_report_date"]) && trim($this->shipment["shipment_test_report_date"]) != "") {
	$expTestReceiptDate = explode(" ", $this->shipment["shipment_test_report_date"]);
	$participantResponseDate = $this->dateFormat($expTestReceiptDate[0]);
} else {
	$participantResponseDate = date('d-M-Y');
}
$kitExpiryDate = "";
if (isset($this->shipment['attributes']['kit_expiry_date']) && $this->shipment['attributes']['kit_expiry_date'] != "") {
	$kitExpiryDate = $this->dateFormat($this->shipment['attributes']['kit_expiry_date']);
}
$shipmentAttributes = json_decode($this->shipment['shipment_attributes'], true);
?>
<style>
	th {
		text-align: center;
	}

	table,
	th,
	td {
		border-color: #ccc !important;
	}

	.hideOtherAssay,
	.dna-hidden {
		display: none;
	}
</style>
<section class="content-header">
	<h1><?php echo (isset($this->shipment['panelName']) && !empty($this->shipment['panelName'])) ? $this->shipment['panelName'] : $this->shipment['scheme_name']; ?></h1>
</section>
<section class="content">
	<div class="box">
		<form name="tbResponseForm" id="tbResponseForm" method="post" action="<?php echo $this->url(array("controller" => "generic-test", "action" => "response"), null, true) ?>" onsubmit="return validateNow();return false;">
			<div class="box-body">
				<input type="hidden" id="hdLastDate" name="hdLastDate" value="<?php echo $this->shipment['lastdate_response']; ?>" />
				<input type="hidden" id="smid" name="smid" value="<?php echo $this->shipment['map_id']; ?>" />
				<input type="hidden" id="shipmentId" name="shipmentId" value="<?php echo $this->shipId; ?>" />
				<input type="hidden" id="participantId" name="participantId" value="<?php echo $this->participantId; ?>" />
				<input type="hidden" id="evId" name="evId" value="<?php echo $this->eID; ?>" />
				<?php $date = (new DateTime())->setTime(0, 0, 0);
				$lastDate = (new DateTime($this->shipment['lastdate_response']))->setTime(0, 0, 0); ?>
				<div id="view-content">
					<?php if ($this->isEditable) {
						if (($date > $lastDate)  && $this->shipment['status'] == 'finalized') { ?>
							<h4 align="CENTER" style="color:red"><?= $this->translate->_("Your response is late and this shipment has been finalized. Your result will not be evaluated"); ?></h4>
						<?php } else if (($date > $lastDate)) { ?>
							<h4 align="CENTER" style="color:red"><?= $this->translate->_("Your response is late."); ?></h4>
						<?php } else if ($this->shipment['status'] == 'finalized') { ?>
							<h4 align="CENTER" style="color:red"><?= $this->translate->_("This shipment has been finalized. Your result will not be evaluated. Please contact your PT Provider for any clarifications."); ?></h4>
						<?php }
					} else { ?>
						<h4 align="CENTER" style="color:red"><?= $this->translate->_("Responding for this shipment is not allowed at this time. Please contact your PT Provider for any clarifications."); ?></h4>
					<?php } ?>
					<br>
					<div id=error></div>
					<table class="table table-bordered table-striped" style="width:100%;margin:10px auto;">
						<tr class="dark">
							<th style="width:20%;"><?= $this->translate->_("Shipment Code"); ?></th>
							<th style="width:20%;"><?= $this->translate->_("Scheme Name"); ?></th>
							<th style="width:20%;"><?= $this->translate->_("PT Shipment Date"); ?></th>
							<th style="width:20%;"><?= $this->translate->_("Result Submission Deadline"); ?></th>
						</tr>
						<tr class="light" style="text-align: center;">
							<td style="width:20%;">
								<?php echo $this->shipment['shipment_code']; ?>
							</td>
							<td style="width:20%;">
								<?php echo (isset($shipmentAttributes['panelName']) && !empty($shipmentAttributes['panelName'])) ? $shipmentAttributes['panelName'] : $this->shipment['scheme_name']; ?>
							</td>
							<td style="width:20%;">
								<?php echo $this->dateFormat($this->shipment['shipment_date']); ?>
							</td>
							<td style="width:20%;">
								<?php echo $this->dateFormat(date('d-m-Y')); ?>
							</td>
						</tr>
						<tr class="dark">
							<th style="width:20%;"><?= $this->translate->_("Participant Site Name"); ?></th>
							<th style="width:20%;"><?= $this->translate->_("PT-ID"); ?></th>
							<th style="width:20%;"><?= $this->translate->_("Country"); ?></th>
							<th style="width:20%;"></th>
						</tr>
						<tr class="light" style="text-align: center;">
							<td style="width:20%;">
								<?php echo ($this->participant['first_name'] . ' ' . $this->participant['last_name']); ?>
							</td>
							<td style="width:20%;">
								<?php echo $this->participant['unique_identifier']; ?>
							</td>
							<td style="width:20%;">
								<?php echo $this->participant['iso_name']; ?>
							</td>
							<td style="width:20%;">
							</td>
						</tr>
					</table>
					<hr>
					<div style="width:100%;padding-left:0;">
						<label style="font-size:16px;" for="isPtTestNotPerformed"><?= $this->translate->_("Were you able to test the Panel?"); ?>&nbsp; &nbsp;<label>
						<select name="isPtTestNotPerformed" id="isPtTestNotPerformed" class="form-control">
							<option value="no" <?php echo (isset($this->shipment['is_pt_test_not_performed']) && $this->shipment['is_pt_test_not_performed'] == 'yes') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Able to Test Panel"); ?></option>
							<option value="yes" <?php echo (isset($this->shipment['is_pt_test_not_performed']) && $this->shipment['is_pt_test_not_performed'] == 'yes') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Unable to Test Panel"); ?></option>
						</select>
					</div>

					<table class="ptNotPerformedSection table table-bordered table-striped" style="<?php echo (isset($this->shipment['is_pt_test_not_performed']) && $this->shipment['is_pt_test_not_performed'] == 'yes') ? '' : 'display:none;'; ?>background:none;width:100%;margin:10px auto;">
						<tr class="ptNotPerformedSection">
							<td colspan="2">
								<label><?= $this->translate->_("Reason for not testing the PT Panel"); ?></label> <span class="mandatory">*</span> :
								<select id="vlNotTestedReason" name="vlNotTestedReason" class="form-control" title="Please select reason" onchange="collectPanelReceiptDate();">
									<option value="">--<?= $this->translate->_("Select"); ?>--</option>
									<?php
									foreach ($this->allNotTestedReason as $reason) {
									?>
										<option data-collect-panel-receipt-date="<?= $reason['collect_panel_receipt_date']; ?>" value="<?= $reason['ntr_id']; ?>" <?php echo ($this->shipment['vl_not_tested_reason'] == $reason['ntr_id']) ? 'selected="selected"' : ''; ?>><?php echo ($reason['ntr_reason']); ?></option>
									<?php } ?>
								</select>
							</td>
						</tr>
						<tr class="ptNotPerformedSection" style="<?php echo (isset($this->shipment['is_pt_test_not_performed']) && $this->shipment['is_pt_test_not_performed'] == 'yes') ? '' : 'display:none;'; ?>background:none;">
							<td colspan="4"><label><?= $this->translate->_("Comments"); ?></label> : <textarea id="ptNotTestedComments" name="ptNotTestedComments" class="form-control" title="Please enter comments"><?php echo $this->shipment['pt_test_not_performed_comments']; ?></textarea></td>
						</tr>
					</table>

					<table class="vlResultSection table table-bordered table-striped" style="width:100%;margin:10px auto;">
						<tr class="dark">
							<td style="width:20%;"> <label class="control-lable" for="analystName"><?= $this->translate->_("Analyst Name"); ?> <span class="mandatory">*</span></label></td>
							<td style="width:30%;">
								<input type="text" id="analystName" name="analystName" style="float:left;" value="<?php echo (isset($this->shipment['attributes']['analyst_name']) && !empty($this->shipment['attributes']['analyst_name'])) ? $this->shipment['attributes']['analyst_name'] : ""; ?>" class="form-control isRequired" placeholder="Enter analyst name" title="Please enter analyst name" />
							</td>
							<td style="width:20%;"> <label class="control-lable" for="receiptDate"><?= $this->translate->_("Date Panel Received"); ?> <span class="mandatory">*</span></label></td>
							<td style="width:30%;">
								<input type="text" id="receiptDate" name="receiptDate" size="11" placeholder="Panel Receipt Date" maxlength="11" style="width:210px;float:left;" value="<?php echo $this->dateFormat($this->shipment["shipment_receipt_date"]);  ?>" class="form-control isRequired datepicker" readonly="readonly" />
								<i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date" onclick="clearDate('receiptDate')"> Clear</i>
							</td>
						</tr>
						<tr>
							<td><label for="testDate"><?= $this->translate->_("Date Tested"); ?> <span class='mandatory'>*</span></label></td>
							<td>
								<input type="text" id="testDate" name="testDate" size="11" maxlength="11" style="width:210px;float:left;" placeholder="Enter the panel test date" value="<?php echo (isset($this->shipment["shipment_test_date"]) && !empty($this->shipment["shipment_test_date"]) && $this->shipment["shipment_test_date"] != "0000-00-00") ? $this->dateFormat($this->shipment["shipment_test_date"]) : ""; ?>" class="form-control datepicker isRequired" readonly="readonly" title="Please enter Shipment Test Date" />
								<i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date" onclick="clearDate('testDate')"> <?= $this->translate->_("Clear"); ?></i>
							</td>
							<td style="width:20%;"> <label class="control-lable" for="kitName"><?= $this->translate->_("Kit Name"); ?> <span class="mandatory">*</span></label></td>
							<td style="width:30%;">
								<input type="text" id="kitName" name="kitName" style="float:left;" value="<?php echo (isset($this->shipment['attributes']['kit_name']) && !empty($this->shipment['attributes']['kit_name'])) ? $this->shipment['attributes']['kit_name'] : ""; ?>" class="form-control isRequired" placeholder="Enter kit name" title="Please enter kit name" />
							</td>
						</tr>
						<tr>
							<td style="width:20%;"> <label class="control-lable" for="kitLot"><?= $this->translate->_("Kit Lot Number"); ?> <span class="mandatory">*</span></label></td>
							<td style="width:30%;">
								<input type="text" id="kitLot" name="kitLot" style="float:left;" value="<?php echo (isset($this->shipment['attributes']['kit_lot_number']) && !empty($this->shipment['attributes']['kit_lot_number'])) ? $this->shipment['attributes']['kit_lot_number'] : ""; ?>" class="form-control isRequired" placeholder="Enter kit lot" title="Please enter kit lot" />
							</td>
							<td style="width:20%;"> <label class="control-lable" for="expiryDate"><?= $this->translate->_("Kit Expiry Date"); ?> <span class="mandatory">*</span></label></td>
							<td style="width:30%;">
								<input type="text" id="expiryDate" name="expiryDate" style="width:210px;float:left;" placeholder="Kit Expiry Date" title="Please select the kit expiry date" class="form-control isRequired datepicker" value="<?php echo $kitExpiryDate; ?>" readonly="readonly" />
								<i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date" onclick="clearDate('expiryDate')"> <?= $this->translate->_("Clear"); ?></i>
							</td>
						</tr>
						<tr>
							<?php if (isset($authNameSpace->enable_adding_test_response_date) && $authNameSpace->enable_adding_test_response_date != null && $authNameSpace->enable_adding_test_response_date != '' && $authNameSpace->enable_adding_test_response_date == 'yes') { ?>
								<td><label><?= $this->translate->_("Date Submitted"); ?> <span class='mandatory'>*</span></label></td>
								<td>
									<input type="text" id="responseDate" name="responseDate" size="11" maxlength="11" style="width:210px;float:left;" value="<?php echo $participantResponseDate; ?>" class="form-control datepicker isRequired" readonly="readonly" title="Please enter Shipment Test Response Date " />
									<i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date" onclick="clearDate('testReceiptDate')"> <?= $this->translate->_("Clear"); ?></i>
								</td>
							<?php } ?>
						</tr>
					</table>
					<div class="vlResultSection vlResultBlock loadAssay">
						<table class="table table-bordered table-striped" style="width:100%;margin:10px auto;" id="other">
							<thead>
								<tr>
									<th scope="col" style="width:10%;">Sample ID</th>
									<th scope="col">Test 1 Result<span class='mandatory'>*</span></th>
									<?php if (isset($shipmentAttributes['noOfTest']) && $shipmentAttributes['noOfTest'] == 2) { ?>
										<th>Test 2 Result<span class='mandatory'>*</span></th>
									<?php } ?>
									<th scope="col">Final Result <span class='mandatory'>*</span></th>
									<?php if (isset($shipmentAttributes['captureAdditionalDetails']) && $shipmentAttributes['captureAdditionalDetails'] == 'yes') { ?>
										<th><?php echo (isset($shipmentAttributes['additionalDetailLabel']) && !empty($shipmentAttributes['additionalDetailLabel'])) ? $shipmentAttributes['additionalDetailLabel'] : 'Additional Detail'; ?></th>
									<?php } ?>
									<th scope="col">Comments</th>
								</tr>
							</thead>

							<?php $count = 0;
							foreach ($this->allSamples as $key => $sample) {
								$count++; ?>
								<tr align="CENTER" class="light other<?php echo $sample['sample_id']; ?>">
									<th>
										<?php echo $sample['sample_label']; ?> <?php echo ($sample['mandatory'] == 1) ? " <span class='mandatory'>*</span>" : "&nbsp;&nbsp;"; ?>
										<input type="hidden" id="sample<?php echo $count; ?>" name="sampleId[]" value="<?php echo $sample['sample_id']; ?>" />
									</th>
									<td>
										<select name="result[]" class="<?php echo ($sample['mandatory'] == 1) ? " isRequired" : ""; ?> form-control input-sm" title="Please choose one" placeholder="Please choose result for this sample">
											<option value="">-- Select --</option>
											<option value="reactive" <?php echo ($sample['result'] == 'reactive' ? "selected='selected'" : ""); ?>>Reactive</option>
											<option value="non-reactive" <?php echo ($sample['result'] == 'non-reactive' ? "selected='selected'" : ""); ?>>Non Reactive</option>
											<option value="indeterminate" <?php echo ($sample['result'] == 'indeterminate' ? "selected='selected'" : ""); ?>>Indeterminate</option>
										</select>
									</td>
									<?php if (isset($shipmentAttributes['noOfTest']) && $shipmentAttributes['noOfTest'] == 2) { ?>
										<td>
											<select name="repeatResult[]" class="<?php echo ($sample['mandatory'] == 1) ? " isRequired" : ""; ?> form-control input-sm" title="Please choose one" placeholder="Please choose repeat result for this sample">
												<option value="">-- Select --</option>
												<option value="reactive" <?php echo ($sample['repeat_result'] == 'reactive' ? "selected='selected'" : ""); ?>>Reactive</option>
												<option value="non-reactive" <?php echo ($sample['repeat_result'] == 'non-reactive' ? "selected='selected'" : ""); ?>>Non Reactive</option>
												<option value="indeterminate" <?php echo ($sample['repeat_result'] == 'indeterminate' ? "selected='selected'" : ""); ?>>Indeterminate</option>
											</select>
										</td>
									<?php } ?>
									<td>
										<select name="finalResult[]" class="<?php echo ($sample['mandatory'] == 1) ? " isRequired" : ""; ?> form-control input-sm" title="Please choose one" placeholder="Please choose final result for this sample">
											<option value="">-- Select --</option>
											<option value="positive" <?php echo ($sample['reported_result'] == 'positive' ? "selected='selected'" : ""); ?>>Positive</option>
											<option value="negative" <?php echo ($sample['reported_result'] == 'negative' ? "selected='selected'" : ""); ?>>Negative</option>
											<option value="invalid" <?php echo ($sample['reported_result'] == 'invalid' ? "selected='selected'" : ""); ?>>Invalid</option>

										</select>
									</td>
									<?php if (isset($shipmentAttributes['captureAdditionalDetails']) && $shipmentAttributes['captureAdditionalDetails'] == 'yes') { ?>
										<td>
											<input type="text" class="form-control" placeholder="<?= $shipmentAttributes['additionalDetailLabel']; ?>" name="additionalDetail[]" value="<?php echo (isset($sample['additional_detail']) && $sample['additional_detail'] != "") ? $sample['additional_detail'] : ''; ?>" title="Please enter <?= $shipmentAttributes['additionalDetailLabel']; ?>" />
										</td>
									<?php } ?>
									<td>
										<input type="text" class="form-control" placeholder="Comments" name="comments[]" value="<?php echo (isset($sample['comments']) && $sample['comments'] != "") ? $sample['comments'] : ''; ?>" title="Please enter the comments" />
									</td>
								</tr>
							<?php } ?>
						</table>
					</div>
					<br>
					<hr>
					<table class="table table-bordered table-striped" style="width:100%;margin:10px auto;">

						<tr>
							<th style="width:20%;"><?= $this->translate->_("Supervisor Review"); ?> <span class="mandatory">*</span></th>
							<td style="width:20%;">
								<select name="supervisorApproval" id="supervisorApproval" class="form-control isRequired">
									<option value="">--<?= $this->translate->_("Select"); ?>--</option>
									<option value="yes" <?php if ($this->shipment['supervisor_approval'] == 'yes') echo " selected "; ?>><?= $this->translate->_("Yes"); ?></option>
									<option value="no" <?php if ($this->shipment['supervisor_approval'] == 'no') echo " selected "; ?>><?= $this->translate->_("No"); ?></option>
								</select>
							</td>
							<th class="participantSupervisor" <?php echo (isset($this->shipment['supervisor_approval']) && $this->shipment['supervisor_approval'] == 'yes') ? "" : "style='display:none;'" ?>><label for="participantSupervisor"><?= $this->translate->_("Supervisor Name"); ?> <span class="mandatory">*</span></label></th>
							<td class="participantSupervisor" <?php echo (isset($this->shipment['supervisor_approval']) && $this->shipment['supervisor_approval'] == 'yes') ? "" : "style='display:none;'" ?>><input name="participantSupervisor" id="participantSupervisor" type="text" class="form-control" value="<?php echo $this->shipment['participant_supervisor']; ?>" /></td>
						</tr>
						<tr>
							<th><?= $this->translate->_("Comments"); ?> </th>
							<td colspan="3">
								<textarea name="userComments" id="userComments" class="form-control" size="120" maxlength="40"><?php echo $this->shipment['user_comment']; ?></textarea>
							</td>
						</tr>
					</table>
					<?php if ($this->isEditable) { ?>
						<div id="respond" style="margin: 0px auto 0px auto; text-align: center;">
							<p>
								<input name="submitbtn" class="btn btn-primary" type="submit" value="Submit" />
								&nbsp;&nbsp;&nbsp;
								<input name="cancel" class="btn btn-danger" type="button" id="reset" value="Cancel" onclick="javascript:goto_dashboard()" />

							</p>
						</div>
					<?php } ?>
				</div>
				<?php
				$genderHelper = $this->getHelper('DateFormat');
				$dtFormat =  $genderHelper->getDateFormat();
				?>
			</div>
		</form>
		<?php if (!$this->isEditable) {
		?>
			<div id="respond" style="margin: 0px auto 0px auto; text-align: center;">
				<input name="cancel" class="btn btn-info" type="button" id="reset" value="Back" onclick="javascript:goto_dashboard()" />
			</div>
		<?php
		}
		?>
	</div>
</section>
<script type="text/javascript" src="/js/datalist-css.min.js"></script>
<script>
	function goto_dashboard() {
		window.history.back();
	}

	var timeOut;

	$(function() {
		$("#receiptDate").datepicker({
			dateFormat: '<?php echo $dtFormat; ?>',
			minDate: new Date('<?php echo $this->shipment['shipment_date']; ?>'),
			maxDate: 'today'
		});
		$(".datepicker").datepicker({
			dateFormat: '<?php echo $dtFormat; ?>',
			// maxDate: '0',
			minDate: 'today',
			// maxDate: new Date('<?php echo $this->shipment['shipment_date']; ?>')
		});

		$(".expDatepicker").datepicker({
			dateFormat: '<?php echo $dtFormat; ?>'
		});
	});

	function validateNow() {
		var dates = [];

		var maxDate = new Date(Math.max.apply(null, dates));
		// $("#testDate").val(moment(maxDate).format('DD-MMM-YYYY'));
		if (moment($("#receipt_date").val()).isAfter($("#test_date").val())) {
			alert('Testing Date has to come after the Panel Receipt Date');
			return false;
		}
		$(".oneDecimal").each(function() {
			if (!$.isNumeric($(this).val())) {
				alert('Please ensure all SPC and Probe values are valid numbers');
				return false;
			}
		});
		flag = deforayValidator.init({
			formId: 'tbResponseForm'
		});
		return flag;
	}
	$('#supervisorApproval').change(function() {
		if ($('#supervisorApproval').val() == 'yes') {
			$('#labSupervisor').show();
			$('#labSupervisor').addClass('isRequired');
			$('#participantSupervisor').val('');
			$('.participantSupervisor').show();
		} else {
			$('#labSupervisor').hide();
			$('#labSupervisor').removeClass('isRequired');
			$('#participantSupervisor').val('');
			$('.participantSupervisor').hide();
		}
	});

	$('#isPtTestNotPerformed').change(function() {
		if ($(this).val() == 'yes') {
			$('.vlResultSection').hide();
			$('.vlResultValues').val('');
			$('.vlResultBlock').html('');
			$('.ptNotPerformedSection').show();
			$('.vlResultMandatory').css('visibility', 'hidden');
			$('.vlResultValues').removeClass('isRequired');
			$('#vlNotTestedReason').addClass('isRequired');
			$('#ptNotTestedComments').addClass('isRequired');
			$('#testDate,#receiptDate,#sampleRehydrationDate,#supervisorApproval').removeClass('isRequired');
			$('.ptTestPerformed').hide();
		} else {
			$('.vlResultSection').show();
			$('.ptNotPerformedSection').hide();
			$('.vlResultMandatory').css('visibility', 'visible');
			$('.vlResultValues').addClass('isRequired');
			$('#vlNotTestedReason').removeClass('isRequired');
			$('#ptNotTestedComments').removeClass('isRequired');
			$('#testDate,#receiptDate,#sampleRehydrationDate,#supervisorApproval').addClass('isRequired');
			$('.ptTestPerformed').show();

		}

	});
</script>