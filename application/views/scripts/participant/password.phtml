<?php
$authNameSpace = new Zend_Session_Namespace('datamanagers');
// At the top of your controller or page
$forceProfileConfirmation = (isset($authNameSpace->forcePasswordReset) && $authNameSpace->forcePasswordReset == 1);
$step = isset($_POST['step']) ? $_POST['step'] : ($forceProfileConfirmation ? 'profile' : 'password');
$profileConfirmed = isset($_SESSION['profile_confirmed']) ? $_SESSION['profile_confirmed'] : !$forceProfileConfirmation;

// Handle cleanup session request
if (isset($_POST['action']) && $_POST['action'] == 'cleanup_session') {
	unset($_SESSION['profile_confirmed']);
	session_destroy();
	exit();
}

// Handle reset profile confirmation
if (isset($_POST['action']) && $_POST['action'] == 'reset_profile_confirmation') {
	unset($_SESSION['profile_confirmed']);
	header('Location: ' . $this->url(array("controller" => "auth", "action" => "logout"), null, true));
	exit();
}

// Handle profile confirmation
if (isset($_POST['confirm_profile'])) {
	$_SESSION['profile_confirmed'] = true;
	$profileConfirmed = true;
	$step = 'password';
}

// Handle password change
if (isset($_POST['submitbtn']) && $profileConfirmed) {
	try {
		// Your existing password change logic here
		// ... your password change logic ...

		// After successful password change, clear the session and redirect
		if ($forceProfileConfirmation) {
			unset($_SESSION['profile_confirmed']);
		}
		// Redirect to success page or dashboard
		header('Location: ' . $this->url(array("controller" => "participant", "action" => "dashboard"), null, true));
		exit();
	} catch (Exception $e) {
		// If password change fails, logout for security
		error_log("Password change failed for user: " . $this->rsUser['dm_id'] . " Error: " . $e->getMessage());
		if ($forceProfileConfirmation) {
			unset($_SESSION['profile_confirmed']);
		}
		header('Location: ' . $this->url(array("controller" => "auth", "action" => "logout"), null, true));
		exit();
	}
}

// Auto-logout if user tries to access password change without profile confirmation (only when forced)
if ($forceProfileConfirmation && $step == 'password' && !$profileConfirmed) {
	header('Location: ' . $this->url(array("controller" => "auth", "action" => "logout"), null, true));
	exit();
}

// Set session expiry for security (10 minutes) - only when profile confirmation is forced
if ($forceProfileConfirmation) {
	if (!isset($_SESSION['profile_change_start_time'])) {
		$_SESSION['profile_change_start_time'] = time();
	} elseif (time() - $_SESSION['profile_change_start_time'] > 600) { // 10 minutes
		unset($_SESSION['profile_confirmed']);
		unset($_SESSION['profile_change_start_time']);
		header('Location: ' . $this->url(array("controller" => "auth", "action" => "logout"), null, true));
		exit();
	}
}
?>

<section class="content-header">
	<h1>
		<?php if ($forceProfileConfirmation && !$profileConfirmed): ?>
			<?= $this->translate->_("Confirm Profile Details"); ?>
		<?php else: ?>
			<?= $this->translate->_("Change Password"); ?>
		<?php endif; ?>
	</h1>
</section>

<section class="content">
	<div class="box">
		<div class="box-body">

			<?php if ($forceProfileConfirmation && !$profileConfirmed): ?>
				<!-- STEP 1: Profile Confirmation -->
				<div class="alert alert-info">
					<strong><?= $this->translate->_("Please confirm your profile details before changing your password"); ?></strong>
				</div>

				<form name="profileConfirm" id="profileConfirm" method="post" action="">
					<input type="hidden" name="step" value="profile" />

					<table style="width: 95%;margin: auto;" class="table table-striped table-hover">
						<?php if (isset($this->rsUser['new_email']) && $this->rsUser['new_email'] != "") { ?>
							<tr align="left" class="dark">
								<td colspan="2" style=" text-align: center; padding: 25px; ">
									<?= $this->translate->_("Please verify your primary email change to"); ?>
									<b>"<?php echo $this->rsUser['new_email']; ?>"</b>
									<?= $this->translate->_("by clicking on the verification link sent to your email."); ?>
									<br>
									<a href="javascript:void(0);" onclick="reSentVerifyMail('<?php echo $this->rsUser['new_email']; ?>');">
										<?= $this->translate->_("Click here to resend the verification mail"); ?>
									</a>
								</td>
							</tr>
							<tr align="left" class="alert-success" style="display: none;">
								<td colspan="2" style=" text-align: center; background:lightgreen; color:darkgreen;">
									<?= $this->translate->_("Please check your email for the verification link."); ?>
								</td>
							</tr>
						<?php } ?>

						<tr align="left" class="dark">
							<td><?= $this->translate->_("Primary e-mail address (used for login)"); ?></td>
							<td>
								<input id="pemail" type="text" name="pemail" size="50" maxlength="45"
									value="<?php echo $this->rsUser['primary_email']; ?>"
									class="isRequired form-control"
									title="Please enter a primary email id here"
									placeholder="Please enter a primary email id here"
									onblur="checkDuplicate('data_manager', 'primary_email', this, '<?php echo "dm_id##" . $this->rsUser['dm_id']; ?>', 'Entered email already exists. Please enter another email id.')"
									<?php echo (isset($this->rsUser['data_manager_type']) && !empty($this->rsUser['data_manager_type']) && $this->rsUser['data_manager_type'] == 'participant') ? "readonly='readonly'" : ''; ?> readonly />
								<input type="hidden" id="oldpemail" name="oldpemail" value="<?php echo $this->rsUser['primary_email']; ?>" />
								<input type="hidden" id="userSystemId" name="userSystemId" value="<?php echo $this->rsUser['dm_id']; ?>" />
							</td>
						</tr>

						<tr align="left" class="light">
							<td><?= $this->translate->_("First Name"); ?></td>
							<td>
								<input <?php echo (isset($this->participantEditName) && !empty($this->participantEditName) && $this->participantEditName == 'no') ? 'readonly' : ''; ?>
									id="fname" type="text" name="fname" size="50" maxlength="45"
									value="<?php echo $this->rsUser['first_name']; ?>"
									class="form-control"
									title="Please enter your first name here"
									placeholder="Please enter your first name here" readonly />
							</td>
						</tr>

						<tr align="left" class="dark">
							<td><?= $this->translate->_("Last Name"); ?></td>
							<td>
								<input <?php echo (isset($this->participantEditName) && !empty($this->participantEditName) && $this->participantEditName == 'no') ? 'readonly' : ''; ?>
									id="lname" type="text" name="lname" size="50" maxlength="45"
									class=" form-control"
									value="<?php echo $this->rsUser['last_name']; ?>"
									title="Please enter your last name here"
									placeholder="Please enter your last name here" readonly />
							</td>
						</tr>

						<tr align="left" class="light">
							<td><?= $this->translate->_("Secondary e-mail address"); ?></td>
							<td>
								<input id="semail" type="text" name="semail" size="50" maxlength="45"
									value="<?php echo $this->rsUser['secondary_email']; ?>"
									class="form-control"
									title="Please enter a secondary email id here"
									placeholder="Please enter a secondary email id here" readonly />
							</td>
						</tr>

						<tr align="left" class="dark">
							<td><?= $this->translate->_("Cell Phone Number"); ?></td>
							<td>
								<input id="phone1" type="text" name="phone1" size="50" maxlength="45"
									value="<?php echo $this->rsUser['mobile']; ?>"
									class="isNumeric form-control"
									title="Please enter your contact number here"
									placeholder="Please enter your contact number here" readonly />
							</td>
						</tr>

						<tr align="left" class="light">
							<td><?= $this->translate->_("Phone Number"); ?></td>
							<td>
								<input id="phone2" type="text" name="phone2" size="50" maxlength="45"
									value="<?php echo $this->rsUser['phone']; ?>"
									class="isNumeric form-control" readonly />
							</td>
						</tr>

						<tr align="left" class="light">
							<td><?= $this->translate->_("Language"); ?></td>
							<td>
								<select id="language" name="language" class="form-control" title="Please select the language" disabled>
									<option value="">-- <?= $this->translate->_("Select"); ?> --</option>
									<option value="en_US" <?php echo (isset($this->rsUser['language']) && $this->rsUser['language'] == "en_US") ? "selected='selected'" : ""; ?>>
										<?= $this->translate->_("English"); ?>
									</option>
									<option value="fr_FR" <?php echo (isset($this->rsUser['language']) &&  $this->rsUser['language'] == "fr_FR") ? "selected='selected'" : ""; ?>>
										<?= $this->translate->_("French"); ?>
									</option>
									<option value="lo_LA" <?php echo (isset($this->rsUser['language']) &&  $this->rsUser['language'] == "lo_LA") ? "selected='selected'" : ""; ?>>
										<?= $this->translate->_("Austronesian"); ?>
									</option>
								</select>
							</td>
						</tr>
					</table>

					<br>
					<div id="respond" style="margin: 0px auto 0px auto; text-align: center;">
						<p>
							<input name="confirm_profile" class="btn btn-primary" type="submit" tabindex="7"
								value="<?= $this->translate->_("Confirm Profile & Continue to Password Change"); ?>" onclick="location.reload();" />
							&nbsp;&nbsp;&nbsp;
							<input name="cancel" class="btn btn-warning" type="button" tabindex="8"
								value="<?= $this->translate->_("Cancel"); ?>"
								onclick="cancelProfileConfirmation();" />
						</p>
					</div>
				</form>

			<?php else: ?>
				<!-- PASSWORD CHANGE (Either Step 2 after profile confirmation OR Direct access when not forced) -->
				<?php if ($forceProfileConfirmation): ?>
					<div class="alert alert-success">
						<strong><?= $this->translate->_("Profile confirmed! Now you can change your password."); ?></strong>
					</div>
				<?php endif; ?>

				<form name="passwordChange" id="passwordChange" method="post" action="<?php echo $this->url(array("controller" => "participant", "action" => "password"), null, true) ?>">
					<input type="hidden" name="step" value="password" />

					<table class="table table-striped">
						<tr align="left" class="light">
							<td><?= $this->translate->_("Old Password"); ?></td>
							<td>
								<input id="oldpassword" type="password" name="oldpassword" size="50" maxlength="45"
									value="" class="isRequired form-control"
									title="Please enter your current password"
									placeholder="Please enter your current password" />
							</td>
						</tr>

						<tr align="left" class="light">
							<td><?= $this->translate->_("New Password"); ?></td>
							<td>
								<input id="newpassword1" type="password"
									pattern=".{<?php echo $this->passLength ?? 8; ?>,}"
									name="newpassword" size="50" maxlength="45" value=""
									class="isRequired form-control"
									title="<?= $this->translate->_("Please enter a valid password and should minimum length of " . ($this->passLength ?? 8)); ?>"
									placeholder="Please enter your new password" />
							</td>
						</tr>

						<tr align="left" class="light">
							<td><?= $this->translate->_("Confirm New Password"); ?></td>
							<td>
								<input type="password" id="newpassword2" name="newpassword2" size="50" maxlength="45"
									value="" class="isRequired confirmPassword form-control"
									title="Please repeat the same password"
									placeholder="Please repeat the same password" />
							</td>
						</tr>
					</table>

					<br>
					<div id="respond" style="margin: 0px auto 0px auto; text-align: center;">
						<p>
							<input name="submitbtn" class="btn btn-primary" type="button" tabindex="7"
								value="<?= $this->translate->_("Change Password"); ?>"
								onclick="validPassword();return false;" />
							&nbsp;&nbsp;&nbsp;
							<input name="cancel" class="btn btn-warning" type="button" tabindex="9"
								value="<?= $this->translate->_("Cancel"); ?>"
								onclick="cancelPasswordChange();" />
						</p>
					</div>
				</form>
			<?php endif; ?>
		</div>
	</div>
</section>

<script>
	// Password validation function (your existing function)
	function validateChangePassword() {
		if ($('#oldpassword').val() == $('#newpassword1').val()) {
			alert('<?= $this->translate->_("You are typed old password. Kindly enter something else."); ?>');
			return false;
		}

		if ($('#newpassword1').val() != $('#newpassword2').val()) {
			alert('<?= $this->translate->_("New passwords do not match. Please try again."); ?>');
			return false;
		}

		var flag = deforayValidator.init({
			formId: 'passwordChange'
		});

		if (flag) {
			$.blockUI();
			// Add timeout for password change submission
			var submitTimeout = setTimeout(function() {
				$.unblockUI();
				alert('<?= $this->translate->_("Password change timed out. You will be logged out for security reasons."); ?>');
				window.location.href = '<?php echo $this->url(array("controller" => "auth", "action" => "logout"), null, true) ?>';
			}, 30000); // 30 second timeout

			document.getElementById('passwordChange').submit();

			// Clear timeout if form submits successfully
			$(document).ajaxComplete(function() {
				clearTimeout(submitTimeout);
			});
		}
	}

	// Password validation with server check (your existing function)
	function validPassword() {
		if ($('#newpassword1').val() != '') {
			$.post("<?php echo $this->url(array('module' => 'default', 'controller' => 'common', 'action' => 'validate-password')); ?>", {
						name: "",
						email: "",
						password: $('#newpassword1').val(),
						format: "html"
					},
					function(data) {
						if (data == 'success') {
							validateChangePassword();
						}
						if (data != 'success') {
							alert(data);
							return false;
						}
					})
				.fail(function() {
					alert('<?= $this->translate->_("Password validation failed. You will be logged out for security reasons."); ?>');
					setTimeout(function() {
						window.location.href = '<?php echo $this->url(array("controller" => "auth", "action" => "logout"), null, true) ?>';
					}, 2000);
				});
		} else {
			validateChangePassword();
		}
	}

	// Cancel password change
	function cancelPasswordChange() {
		<?php if ($forceProfileConfirmation): ?>
			if (confirm('<?= $this->translate->_("Are you sure you want to cancel password change? If yes then you need to login with your PT account."); ?>')) {
				window.location.href = '<?php echo $this->url(array("controller" => "auth", "action" => "logout"), null, true) ?>';
			}
		<?php else: ?>
			if (confirm('<?= $this->translate->_("Are you sure you want to cancel password change?"); ?>')) {
				window.history.back();
			}
		<?php endif; ?>
	}

	// Cancel profile confirmation
	function cancelProfileConfirmation() {
		<?php if ($forceProfileConfirmation): ?>
			if (confirm('<?= $this->translate->_("Are you sure you want to cancel profile confirmation? If yes then you need to login with your PT account."); ?>')) {
				window.location.href = '<?php echo $this->url(array("controller" => "auth", "action" => "logout"), null, true) ?>';
			}
		<?php else: ?>
			window.history.back();
		<?php endif; ?>
	}

	// Resend verification email function (your existing function)
	function reSentVerifyMail(email) {
		// Your existing resend verification logic
		$.post("<?php echo $this->url(array('controller' => 'participant', 'action' => 'resend-verification')); ?>", {
				email: email
			}, function(data) {
				if (data.status == 'success') {
					$('.alert-success').show();
				}
			}, 'json')
			.fail(function() {
				alert('<?= $this->translate->_("Failed to resend verification email. Please try again later."); ?>');
			});
	}

	// Auto logout on page unload if profile not confirmed (security measure) - only when forced
	<?php if ($forceProfileConfirmation): ?>
		window.addEventListener('beforeunload', function(e) {
			if (!<?php echo $profileConfirmed ? 'true' : 'false'; ?>) {
				// Clean up session on page leave
				navigator.sendBeacon("<?php echo $this->url(array('controller' => 'participant', 'action' => 'cleanup-session')); ?>",
					new FormData());
			}
		});

		// Session timeout for security
		var sessionTimeout;
		var timeoutDuration = 10 * 60 * 1000; // 10 minutes

		function resetSessionTimeout() {
			clearTimeout(sessionTimeout);
			sessionTimeout = setTimeout(function() {
				alert('<?= $this->translate->_("Session expired for security reasons. You will be logged out."); ?>');
				window.location.href = '<?php echo $this->url(array("controller" => "auth", "action" => "logout"), null, true) ?>';
			}, timeoutDuration);
		}

		// Initialize session timeout
		resetSessionTimeout();

		// Reset timeout on user activity
		document.addEventListener('click', resetSessionTimeout);
		document.addEventListener('keypress', resetSessionTimeout);
		document.addEventListener('scroll', resetSessionTimeout);
	<?php endif; ?>
</script>