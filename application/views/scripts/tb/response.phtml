<?php
$authNameSpace = new Zend_Session_Namespace('datamanagers');

if (isset($this->shipment["shipment_test_report_date"]) && trim($this->shipment["shipment_test_report_date"]) != "") {
	$expTestReceiptDate = explode(" ", $this->shipment["shipment_test_report_date"]);
	$participantResponseDate = $this->dateFormat($expTestReceiptDate[0]);
} else {
	$participantResponseDate = date('d-M-Y');
}
$asayExpiryDate = "";
if (isset($this->shipment['attributes']['expiry_date']) && $this->shipment['attributes']['expiry_date'] != "") {
	$asayExpiryDate = $this->dateFormat($this->shipment['attributes']['expiry_date']);
}
$adminAccess = false;
if ($this->reqFrom == "admin") {
	$adminAccess = true;
}
?>
<style>
	th {
		text-align: center;
	}

	table,
	th,
	td {
		border-color: #ccc !important;
	}

	.hideOtherAssay,
	.dna-hidden {
		display: none;
	}

	select.readonly {
		cursor: not-allowed;
		background-color: #ddd;
	}
</style>
<link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
<section class="content-header">
	<h1><?php echo $this->shipment['scheme_name']; ?></h1>
</section>
<section class="content">
	<div class="box">
		<form name="tbResponseForm" id="tbResponseForm" method="post" action="<?php echo $this->url(array("controller" => "tb", "action" => "response"), null, true) ?>" onsubmit="return validateNow('submit');return false;">
			<div class="box-body">
				<input type="hidden" id="hdLastDate" name="hdLastDate" value="<?php echo $this->shipment['lastdate_response']; ?>" />
				<input type="hidden" id="smid" name="smid" value="<?php echo $this->shipment['map_id']; ?>" />
				<input type="hidden" id="shipmentId" name="shipmentId" value="<?php echo $this->shipId; ?>" />
				<input type="hidden" id="participantId" name="participantId" value="<?php echo $this->participantId; ?>" />
				<input type="hidden" id="evId" name="evId" value="<?php echo $this->eID; ?>" />
				<input type="hidden" id="isDraft" name="isDraft" value="no" />
				<div id="view-content">
					<?php
					$date = (new DateTime())->setTime(0, 0, 0);
					$lastDate = (new DateTime($this->shipment['lastdate_response']))->setTime(0, 0, 0);
					$message = "";

					if (!$this->isEditable) {
						$message = "Responding for this shipment is not allowed at this time. Please contact your PT Provider for any clarifications.";
					} elseif ($this->shipment['status'] == 'finalized') {
						$message = "This shipment has been finalized. Your result will not be evaluated. Please contact your PT Provider for any clarifications.";
					} elseif ($date > $lastDate) {
						$message = "Your response is late.";
					}

					if ($message) {
						echo "<h4 style='color:red;text-align:center;'>{$this->translate->_($message)}</h4>";
					}
					?>

					<br>
					<div id=error></div>
					<table class="table table-bordered table-striped" style="width:100%;margin:10px auto;">
						<tr class="dark">
							<th style="width:20%;"><?= $this->translate->_("Shipment Code"); ?></th>
							<th style="width:20%;"><?= $this->translate->_("Scheme Name"); ?></th>
							<th style="width:20%;"><?= $this->translate->_("PT Shipment Date"); ?></th>
							<th style="width:20%;"><?= $this->translate->_("Result Submission Deadline"); ?></th>
						</tr>
						<tr class="light" style="text-align: center;">
							<td style="width:20%;">
								<?php echo $this->shipment['shipment_code']; ?>
							</td>
							<td style="width:20%;">
								<?php echo $this->shipment['scheme_name']; ?>
							</td>
							<td style="width:20%;">
								<?php echo $this->dateFormat($this->shipment['shipment_date']); ?>
							</td>
							<td style="width:20%;">
								<?php echo $this->dateFormat($this->shipment['lastdate_response']); ?>
							</td>
						</tr>
						<tr class="dark">
							<th style="width:20%;"><?= $this->translate->_("Participant Site Name"); ?></th>
							<th style="width:20%;"><?= $this->translate->_("Participant Code"); ?></th>
							<th style="width:20%;"><?= $this->translate->_("Country"); ?></th>
							<th style="width:20%;"></th>
						</tr>
						<tr class="light" style="text-align: center;">
							<td style="width:20%;">
								<?php echo $this->participant['first_name'] . ' ' . $this->participant['last_name']; ?>
							</td>
							<td style="width:20%;">
								<?php echo $this->participant['unique_identifier']; ?>
							</td>
							<td style="width:20%;">
								<?php echo $this->participant['iso_name']; ?>
							</td>
							<td style="width:20%;">
							</td>
						</tr>
					</table>
					<hr>
					<div style="width:100%;padding-left:0;">
						<label style="font-size:16px;" for="isPtTestNotPerformed"><?= $this->translate->_("Were you able to test the Panel?"); ?>&nbsp; &nbsp;<label>
								<select name="isPtTestNotPerformed" id="isPtTestNotPerformed" class="form-control">
									<option value="no" <?php echo (isset($this->shipment['is_pt_test_not_performed']) && $this->shipment['is_pt_test_not_performed'] == 'yes') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Able to Test Panel"); ?></option>
									<option value="yes" <?php echo (isset($this->shipment['is_pt_test_not_performed']) && $this->shipment['is_pt_test_not_performed'] == 'yes') ? 'selected="selected"' : ''; ?>><?= $this->translate->_("Unable to Test Panel"); ?></option>
								</select>
					</div>

					<table class="ptNotPerformedSection table table-bordered table-striped" style="<?php echo (isset($this->shipment['is_pt_test_not_performed']) && $this->shipment['is_pt_test_not_performed'] == 'yes') ? '' : 'display:none;'; ?>background:none;width:100%;margin:10px auto;">
						<tr class="ptNotPerformedSection">
							<td colspan="2">
								<label><?= $this->translate->_("Reason for not testing the PT Panel"); ?></label> <span class="mandatory">*</span> :
								<select id="vlNotTestedReason" name="vlNotTestedReason" class="form-control" title="Please select reason" onchange="checkComments(this.value);">
									<option value="">--<?= $this->translate->_("Select"); ?>--</option>
									<?php
									foreach ($this->allNotTestedReason as $reason) {
									?>
										<option data-collect-panel-receipt-date="<?= $reason['collect_panel_receipt_date']; ?>" value="<?= $reason['ntr_id']; ?>" <?php echo ($this->shipment['vl_not_tested_reason'] == $reason['ntr_id']) ? 'selected="selected"' : ''; ?>><?php echo ($reason['ntr_reason']); ?></option>
									<?php } ?>
									<option value="other"><?= $this->translate->_("Other"); ?></option>
								</select>
							</td>
						</tr>
						<tr class="ptNotPerformedSection" style="<?php echo (isset($this->shipment['is_pt_test_not_performed']) && $this->shipment['is_pt_test_not_performed'] == 'yes') ? '' : 'display:none;'; ?>background:none;">
							<td colspan="4"><label><?= $this->translate->_("Comments"); ?><span class="mandatory ptNotTestedCommentsAsterisk" style="display: none;">*</span></label> : <textarea id="ptNotTestedComments" name="ptNotTestedComments" class="form-control" title="Please enter comments"><?php echo $this->shipment['pt_test_not_performed_comments']; ?></textarea></td>
						</tr>
					</table>

					<table class="vlResultSection table table-bordered table-striped" style="<?php echo (isset($this->shipment['is_pt_test_not_performed']) && $this->shipment['is_pt_test_not_performed'] == 'yes') ? 'display:none;' : ''; ?>width:100%;margin:10px auto;">
						<tr class="dark">
							<td style="width:20%;"> <label class="control-lable" for="receiptDate"><?= $this->translate->_("Panel Received Date"); ?> <span class="mandatory vlResultValuesAsterisk">*</span></label></td>
							<td style="width:30%;">
								<input type="text" id="receiptDate" name="receiptDate" size="11" placeholder="Panel Receipt Date" maxlength="11" style="width:180px;float:left;" value="<?php echo $this->dateFormat($this->shipment["shipment_receipt_date"]);  ?>" class="form-control vlResultValues isRequired datepicker" readonly="readonly" title="Panel choose Received Date" />
								<i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date" onclick="clearDate('receiptDate')"> Clear</i>
							</td>
							<td><label><?= $this->translate->_("Submission Date"); ?> <span class='mandatory vlResultValuesAsterisk'>*</span></label></td>
							<td>
								<input type="text" id="shipmentTestDate" name="shipmentTestDate" size="11" maxlength="11" style="width:180px;float:left;" placeholder="Enter the panel test date" value="<?php echo (isset($this->shipment["shipment_test_date"]) && !empty($this->shipment["shipment_test_date"]) && $this->shipment["shipment_test_date"] != "0000-00-00") ? $this->dateFormat($this->shipment["shipment_test_date"]) : date('d-M-Y'); ?>" class="form-control vlResultValues receiptDate isRequired" readonly="readonly" title="Please enter Shipment Test Date" />
								<i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date" onclick="clearDate('shipmentTestDate')"> <?= $this->translate->_("Clear"); ?></i>
							</td>
						</tr>
						<tr class="light">
							<td style="width:20%;"> <label class="control-lable" for="assayName"><?= $this->translate->_("Assay Name"); ?> <span class="mandatory vlResultValuesAsterisk">*</span></label></td>
							<td style="width:30%;">
								<select class="form-control vlResultValues isRequired" name="assayName" id="assayName" title="Please select the assay name" onchange="loadAssayFields(this);">
									<option value="">--<?= $this->translate->_("Select"); ?>--</option>
									<?php if (isset($this->assay) && !empty($this->assay)) {
										foreach ($this->assay as $row) { ?>
											<option value="<?php echo $row['id']; ?>" data-type="<?php echo $row['assay_type']; ?>" data-drug="<?php echo $row['drug_resistance_test']; ?>" data-short="<?php echo $row['short_name']; ?>" <?php if (isset($this->shipment['attributes']['assay_name']) && $this->shipment['attributes']['assay_name'] == $row['id']) echo " selected "; ?>><?php echo ucwords($row['name']); ?></option>
									<?php }
									} ?>
								</select>
							</td>
							<td style="width: 20%;<?php echo (isset($this->shipment['attributes']['other_assay_name']) && !empty($this->shipment['attributes']['other_assay_name'])) ? '' : 'display: none;'; ?>" class="generic-tb-assay"> <label class="control-lable" for="otherAssayName"><?= $this->translate->_("Other Assay/Method Name"); ?></label></td>
							<td style="width: 30%;<?php echo (isset($this->shipment['attributes']['other_assay_name']) && !empty($this->shipment['attributes']['other_assay_name'])) ? '' : 'display: none;'; ?>" class="generic-tb-assay">
								<select id="otherAssayName" style="width:100%;" name="otherAssayName" class="form-control" tittle="Please type or select other assay/method">
									<option value="">--Select--</option>
									<option value="Microscopy" <?php if (isset($this->shipment['attributes']['other_assay_name']) && $this->shipment['attributes']['other_assay_name'] == "Microscopy") echo " selected "; ?>>Microscopy</option>
								</select>
							</td>
						</tr>
						<tr>
							<td style="width:20%;"> <label class="control-lable" for="mtbRifKitLotNo"><?= $this->translate->_("Cartridge/Assay Lot"); ?> <span class="mandatory vlResultValuesAsterisk">*</span></label></td>
							<td style="width:30%;">
								<input type="text" id="assayLot" name="assayLot" style="float:left;" value="<?php echo (isset($this->shipment['attributes']['assay_lot_number']) && !empty($this->shipment['attributes']['assay_lot_number'])) ? $this->shipment['attributes']['assay_lot_number'] : ""; ?>" class="form-control vlResultValues isRequired" placeholder="Enter Cartridge/Assay lot" title="Please enter the Assay Lot number" />
							</td>
							<td style="width:20%;"> <label class="control-lable" for="expiryDate"><?= $this->translate->_("Cartridge/Assay Expiration"); ?> <span class="mandatory vlResultValuesAsterisk">*</span></label></td>
							<td style="width:30%;">
								<input type="text" id="expiryDate" name="expiryDate" style="width:180px;float:left;" placeholder="Assay Expiration" title="Please select the assay expiration" class="form-control vlResultValues isRequired expDatepicker" value="<?php echo $asayExpiryDate; ?>" readonly="readonly" />
								<i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date" onclick="clearDate('expiryDate')"> <?= $this->translate->_("Clear"); ?></i>
							</td>
						</tr>
						<tr>
							<td style="width:20%;"> <label class="control-lable" for="geneXpertInstrument"><?= $this->translate->_("Date of Last GeneXpert Instrument Calibration"); ?></label></td>
							<td style="width:30%;">
								<input type="text" id="geneXpertInstrument" name="geneXpertInstrument" style="float:left;" value="<?php echo (isset($this->shipment['attributes']['date_of_xpert_instrument_calibration']) && !empty($this->shipment['attributes']['date_of_xpert_instrument_calibration'])) ? $this->dateFormat($this->shipment['attributes']['date_of_xpert_instrument_calibration']) : ""; ?>" readonly="readonly" class="form-control expDatepicker" placeholder="Date of Xpert Instrument Calibration" title="Please enter gene Xpert instrument" />
							</td>
							<td style="width:20%;"> <label class="control-lable" for="instrumentSn"><?= $this->translate->_("Instrument Serial Number"); ?></label></td>
							<td style="width:30%;">
								<input type="text" id="instrumentSn" name="instrumentSn" style="float:left;" value="<?php echo (isset($this->shipment['attributes']['instrument_sn']) && !empty($this->shipment['attributes']['instrument_sn'])) ? $this->shipment['attributes']['instrument_sn'] : ""; ?>" class="form-control" placeholder="Instrument SN" title="Please enter Instrument Serial Number" />
							</td>
						</tr>
						<?php
						$canEnterResponseDate = (isset($authNameSpace->enable_adding_test_response_date) && $authNameSpace->enable_adding_test_response_date != null && $authNameSpace->enable_adding_test_response_date != '' && $authNameSpace->enable_adding_test_response_date == 'yes') || $adminAccess;
						if ($canEnterResponseDate) { ?>
							<tr>
								<td><label><?= $this->translate->_("Response Date"); ?> <span class='mandatory vlResultValuesAsterisk'>*</span></label></td>
								<td>
									<input type="text" id="responseDate" name="responseDate" size="11" maxlength="11" style="width:180px;float:left;" value="<?php echo $participantResponseDate; ?>" class="form-control vlResultValues isRequired" readonly="readonly" title="Please enter Shipment Test Response Date " />
									<i class="icon-remove-sign" style="cursor:pointer;margin-top:10px;margin-left:10px;float:left;" alt="Clear Date" title="Clear Date" onclick="clearDate('responseDate')"> <?= $this->translate->_("Clear"); ?></i>
								</td>
							</tr>
						<?php } ?>
					</table>
					<div class="vlResultSection vlResultBlock loadAssay">

					</div>
					<br>
					<hr>
					<table class="table table-bordered table-striped vlResultValuesTable" style="width:100%;margin:10px auto;">
						<tr>
							<td colspan="4">ATTESTATION <span class="mandatory vlResultValuesAsterisk">*</span><br>
								<p>We the undersigned, recognizing that some special handling may be
									required due to the nature of Proﬁciency Test (PT) materials, have as
									closely as is practical, performed the analyses on these specimens in the
									same manner as regular patient specimens. We conﬁrm that results were
									not shared, nor PT specimens referred or tested, outside of our facility.
								</p>
								<br>
								<div class="form-check" style="margin-left: 10px;">
									<input type="radio" style="margin-right: 5px;" class="form-check-input" id="attestation-yes" name="attestation" value="yes" <?php echo (isset($this->shipment['attributes']['attestation']) && $this->shipment['attributes']['attestation'] == 'yes') ? "checked" : ""; ?>><label class="form-check-label" for="attestation-yes">Yes</label>
									<input type="radio" style="margin-right: 5px;margin-left: 5px;" class="form-check-input" id="attestation-no" name="attestation" value="no" <?php echo (isset($this->shipment['attributes']['attestation']) && $this->shipment['attributes']['attestation'] == 'no') ? "checked" : ""; ?>><label class="form-check-label" for="attestation-no">No</label>
								</div>
								(Please select one)
							</td>
						</tr>
						<tr>
							<th style="width:20%;"><?= $this->translate->_("Supervisor Review"); ?> <span class="mandatory vlResultValuesAsterisk">*</span></th>
							<td style="width:20%;">
								<select name="supervisorApproval" id="supervisorApproval" class="form-control vlResultValues isRequired">
									<option value="">--<?= $this->translate->_("Select"); ?>--</option>
									<option value="yes" <?php if ($this->shipment['supervisor_approval'] == 'yes') echo " selected "; ?>><?= $this->translate->_("Yes"); ?></option>
									<option value="no" <?php if ($this->shipment['supervisor_approval'] == 'no') echo " selected "; ?>><?= $this->translate->_("No"); ?></option>
								</select>
							</td>
							<th class="participantSupervisor" <?php echo (isset($this->shipment['supervisor_approval']) && $this->shipment['supervisor_approval'] == 'yes') ? "" : "style='display:none;'" ?>><label for="participantSupervisor"><?= $this->translate->_("Supervisor Name"); ?> <span class="mandatory vlResultValuesAsterisk ">*</span></label></th>
							<td class="participantSupervisor" <?php echo (isset($this->shipment['supervisor_approval']) && $this->shipment['supervisor_approval'] == 'yes') ? "" : "style='display:none;'" ?>><input name="participantSupervisor" id="participantSupervisor" type="text" class="form-control" value="<?php echo $this->shipment['participant_supervisor']; ?>" /></td>
						</tr>
						<tr>
							<th><?= $this->translate->_("Comments"); ?> </th>
							<td colspan="3">
								<textarea name="userComments" id="userComments" class="form-control" size="120" maxlength="40"><?php echo $this->shipment['user_comment']; ?></textarea>
							</td>
						</tr>
					</table>
				</div>
				<?php
				$genderHelper = $this->getHelper('DateFormat');
				$dtFormat =  $genderHelper->getDateFormat();
				if ($adminAccess) {
					/* $this->partial('partials/evaluate-form.phtml', "default", array(
						'shipment' => $this->shipment
					)); */ ?>
					<table class="table table-bordered table-striped table-hover" style="margin:30px auto 0 auto;">
						<tr>
							<td style="width:5%;vertical-align: middle"><?= $this->translate->_("Notes"); ?></td>
							<td style="width:95%;" colspan="2">
								<?php if (isset($this->evaluateData['shipment']['failure_reason']) && $this->evaluateData['shipment']['failure_reason'] != "[]") { ?>
									<?php $warnings = json_decode($this->evaluateData['shipment']['failure_reason'], true);
									if ($warnings != "" && $warnings != null) {
										echo "<table class='table table-bordered'>";
										echo "<tr><th>Failure Reasons (or) Warnings</th><th>Corrective Actions (if any)</th><th>Manual Override</th></tr>";
										foreach ($warnings as $key => $warning) { ?>
						<tr>
							<td class="text-danger"><?php echo (isset($warning['warning']) ? $warning['warning'] : $warning); ?></td>
							<td><?php echo (isset($warning['correctiveAction']) ? $warning['correctiveAction'] : ""); ?></td>
							<!-- Manual result override changes -->
							<td class="manualOverrideRow" style="display: <?php echo $show; ?>;"><input type="checkbox" id="manualCorrective<?php echo $key; ?>" name="manualCorrective[<?php echo $warning['warning']; ?>]" value="<?php echo $warning['correctiveAction']; ?>" checked><label for="manualCorrective<?php echo $key; ?>"> </label></td>
						</tr>
				<?php }
										echo "</table>";
									} else {
										echo " No Warnings or Corrective Actions ";
									}
								} else {
									echo " No Warnings or Corrective Actions "; ?>
			<?php } ?>
			</td>
			</tr>
			<tr>
				<td style="width:50%;vertical-align: middle;" colspan="2">
					<label style="float: left;margin-top:10px;"><?= $this->translate->_("Do you want to exclude this response from evaluation?"); ?> </label>
					<div style="float:left;margin-left:10px;">
						<select name="isExcluded" id="isExcluded" class="form-control isRequired" title="Please choose whether this response is excluded from evaluation or not">
							<option <?php echo (isset($this->shipment['is_excluded']) && $this->shipment['is_excluded'] == "no") ? " selected='selected' " : ""; ?> value="no"><?= $this->translate->_("No"); ?></option>
							<option <?php echo (isset($this->shipment['is_excluded']) && $this->shipment['is_excluded'] == "yes") ? " selected='selected' " : ""; ?> value="yes"><?= $this->translate->_("Yes"); ?></option>
						</select>
					</div>
				</td>
				<td style="width:50%;vertical-align: middle"><label style="color: #ff6163;" class="form-label" for="manualOverride"><?= $this->translate->_("Manually Override Results"); ?></label>
					<select name="manualOverride" id="manualOverride" class="form-control" title="Please choose manual override yes or no" onchange="manualOverrideChange(this.value)">
						<option value="">-- <?= $this->translate->_("Select"); ?> --</option>
						<option <?php echo (isset($this->shipment['manual_override']) && $this->shipment['manual_override'] == "no") ? " selected='selected' " : ""; ?> value="no"><?= $this->translate->_("No"); ?></option>
						<option <?php echo (isset($this->shipment['manual_override']) && $this->shipment['manual_override'] == "yes") ? " selected='selected' " : ""; ?> value="yes"><?= $this->translate->_("Yes"); ?></option>
					</select>
				</td>
			</tr>
			<?php if (isset($this->shipment['manual_override']) && $this->shipment['manual_override'] == "yes") {
						$show = "display";
					} else {
						$show = "none";
					} ?>
			<tr class="manualOverrideRow" style="display: <?php echo $show; ?>;">
				<td style="width:25%;vertical-align: middle"><label style="color: #ff6163;" class="form-label" for="shipmentScore"><?= $this->translate->_("Shipement Score"); ?> <span class="mandatory">*</span></label></td>
				<td style="vertical-align: middle" colspan="2">
					<input type="text" value="<?php echo $this->shipment['shipment_score']; ?>" name="shipmentScore" id="shipmentScore" class="form-control" placeholder="Enter the shipment score" title="Please enter the shipment score">
				</td>
			</tr>
			<tr>
				<td style="vertical-align: middle"><?= $this->translate->_("Evaluation Comment"); ?></td>
				<td colspan="2"><select class="form-control" name="comment" id="comment">
						<?php echo $this->dropdownSelection($evalComments, $this->shipment['evaluation_comment'], true); ?>
					</select>
				</td>
			</tr>
			<tr>
				<input type="hidden" name="reqAccessFrom" value="admin" id="reqAccessFrom" />
				<td style="vertical-align: middle;" colspan="4">
					<?= $this->translate->_("Optional Extra Comments"); ?>
					<textarea class="form-control" name="optionalComments" id="optionalComments"><?php echo $this->shipment['optional_eval_comment']; ?></textarea>
				</td>
			</tr>
					</table>
				<?php }
				if ($this->isEditable) { ?>
					<div id="respond" style="margin: 0px auto 0px auto; text-align: center;">
						<p>

							<input name="submitbtn" class="btn btn-primary" type="submit" value="Submit for Evaluation" />
							&nbsp;&nbsp;&nbsp;
							<input name="draftbtn" class="btn btn-warning" type="button" onclick="return saveAsDraft();return false;" value="Save as Draft" />
							&nbsp;&nbsp;&nbsp;
							<input name="cancel" class="btn btn-danger" type="button" id="reset" value="Cancel" onclick="javascript:goto_dashboard()" />

						</p>
					</div>
				<?php } ?>
			</div>
		</form>
	</div>
</section>
<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
<script type="text/javascript" src="/js/datalist-css.min.js"></script>
<script>
	let _detacted = false;

	function goto_dashboard() {
		window.history.back();
	}

	let timeOut;

	$(function() {


		// Using mousedown to prevent the dropdown from being shown
		$(document).on('mousedown', 'select.readonly', function(e) {
			e.preventDefault();
		});

		// Store the current value when focused
		$(document).on('focus', 'select.readonly', function() {
			$(this).data('current', $(this).val());
		});

		// If value is changed, revert it back to the stored value
		$(document).on('change', 'select.readonly', function() {
			$(this).val($(this).data('current'));
		});

		$("#receiptDate, .receiptDate").datepicker({
			dateFormat: '<?php echo $dtFormat; ?>',
			minDate: new Date('<?php echo $this->shipment['shipment_date']; ?>'),
			maxDate: 'today'
		});

		<?php if ($canEnterResponseDate) { ?>
			$("#responseDate").datepicker({
				dateFormat: '<?php echo $dtFormat; ?>',
				minDate: new Date('<?php echo $this->shipment['shipment_date']; ?>'),
				maxDate: 'today'
			});
		<?php } else { ?>

			$("#responseDate").datepicker({
				dateFormat: '<?php echo $dtFormat; ?>',
				minDate: 'today',
				maxDate: 'today'
			});

		<?php } ?>

		$(".datepicker").datepicker({
			dateFormat: '<?php echo $dtFormat; ?>',
			// maxDate: '0',
			minDate: 'today',
			// maxDate: new Date('<?php echo $this->shipment['shipment_date']; ?>')
		});

		$(".expDatepicker").datepicker({
			dateFormat: '<?php echo $dtFormat; ?>'
		});
		<?php if (!$this->isEditable) { ?>
			$("#tbResponseForm").find("input:enabled, select:enabled, textarea:enabled").attr("disabled", true);
		<?php } ?>

		loadAssayFields($('#assayName'));
		isPtTestNotPerformed($('#isPtTestNotPerformed').val());
	});

	$('.oneDecimal').keypress(function() {
		var $this = $(this);
		$this.val($this.val().replace(/[^\d.]/g, ''));
	});

	$(".oneDecimal").on("blur", function(el) {
		clearTimeout(timeOut)
		timeOut = setTimeout(function() {
			var newVal = Number($(el.target).val()).toFixed(1);
			if ($.isNumeric(newVal)) {
				$(el.target).val(newVal);
			} else {
				$(el.target).val(0);
			}

		}, 600)
	});


	function saveAsDraft() {
		return validateNow('draft');
	}

	function validateNow(mode) {

		var dates = [];
		let proceed = true;
		var maxDate = new Date(Math.max.apply(null, dates));
		// $("#shipmentTestDate").val(moment(maxDate).format('DD-MMM-YYYY'));
		if (moment($("#receipt_date").val()).isAfter($("#test_date").val())) {
			alert('Testing Date has to come after the Panel Receipt Date');
			return false;
		}
		$(".oneDecimal").css('background-color', '');
		$(".oneDecimal").each(function() {
			if ($(this).val() != "" && !$.isNumeric($(this).val())) {
				$(this).css('background-color', 'yellow');
				proceed = false;
			}
		});

		if (proceed === false) {
			alert('Please ensure all numeric field values are valid numbers');
			return false;
		} else if (proceed === true && mode == 'submit') {
			$("#isDraft").val('no');
			return deforayValidator.init({
				formId: 'tbResponseForm'
			});
		} else if (proceed === true && mode == 'draft') {
			$("#isDraft").val('yes');
			document.getElementById('tbResponseForm').submit();
		}
	}
	$('#supervisorApproval').change(function() {
		if ($('#supervisorApproval').val() == 'yes') {
			$('#labSupervisor').show();
			$('#labSupervisor').addClass('isRequired');
			$('#participantSupervisor').val('');
			$('.participantSupervisor').show();
		} else {
			$('#labSupervisor').hide();
			$('#labSupervisor').removeClass('isRequired');
			$('#participantSupervisor').val('');
			$('.participantSupervisor').hide();
		}
	});

	$('#attestation').change(function() {
		if ($('#attestation').val() == 'yes') {
			$('.attestation-statement').show();
			$('#attestationStatement').addClass('isRequired');
		} else {
			$('.attestation-statement').hide();
			$('#attestationStatement').removeClass('isRequired');
		}
	});

	function rifDetectionChange(obj, id) {
		if ($(obj).val() == 'detected') {
			$(".input-probe" + id).attr("readonly", false);
			$("#rifResistance" + id).removeClass("readonly");
			$('.input-probe' + id).addClass('isRequired');
			$("#errorCode" + id).removeClass('isRequired');
		} else if ($(obj).val() == 'not-detected') {
			$("#rifResistance" + id).val("na");
			$("#rifResistance" + id).addClass("readonly");
			$(".input-probe" + id).attr("readonly", false);
			$('.input-probe' + id).addClass('isRequired');
			$("#errorCode" + id).removeClass('isRequired');
		} else if ($(obj).val() == 'error' || $(obj).val() == 'invalid') {
			$("#errorCode" + id).addClass('isRequired');
			$("#rifResistance" + id).val("na");
			$("#rifResistance" + id).addClass("readonly");
			$(".input-probe" + id).attr("readonly", true);
			$('.input-probe' + id).val('');
			$('.input-probe' + id).removeClass('isRequired');

		}
	}
	$('#isPtTestNotPerformed').change(function() {
		isPtTestNotPerformed(this.value);
	});

	function isPtTestNotPerformed(val) {
		if (val == 'yes') {
			$('.vlResultSection,.ptTestPerformed,.vlResultValuesAsterisk,.vlResultValuesTable').hide();
			$('.vlResultValues').val('');
			$('.vlResultBlock').html('');
			$('.ptNotPerformedSection').show();
			$('.vlResultMandatory').css('visibility', 'hidden');
			$('#shipmentTestDate,#receiptDate,#sampleRehydrationDate,#supervisorApproval,.vlResultValues,#supervisorApproval').removeClass('isRequired');
			$('#vlNotTestedReason').addClass('isRequired');
		} else {
			$('.vlResultSection,.ptTestPerformed,.vlResultValuesAsterisk,.vlResultValuesTable').show();
			$('.ptNotPerformedSection').hide();
			$('.vlResultMandatory').css('visibility', 'visible');
			$('#vlNotTestedReason').removeClass('isRequired');
			$('#shipmentTestDate,#receiptDate,#sampleRehydrationDate,#supervisorApproval,.vlResultValues,#supervisorApproval').addClass('isRequired');
		}
	}

	function loadAssayFields(obj) {
		let _short = $(obj).find(':selected').data('short');
		let _type = $(obj).find(':selected').data('type');
		let _assayId = $(obj).val();
		let _drug = $(obj).find(':selected').data('drug');
		// return false;
		if ($(obj).find(':selected').data('type') == "generic") {
			$(".generic-tb-assay").show();
		} else {
			$(".generic-tb-assay").hide();
		}
		_reqF = 'participant';
		<?php if ($adminAccess) { ?>
			_reqF = 'admin';
		<?php } ?>
		if (obj.value != "") {
			$.get("/tb/assay-formats?assayId=" + _assayId + "&type=" + _short + "&sid=<?php echo $this->shipId; ?>&pid=<?php echo $this->participantId; ?>&eid=<?php echo $this->eID; ?>&assayType=" + _type + "&assayDrug=" + _drug + "&requestFrom=" + _reqF, {
					format: "html"
				},
				function(data) {
					if (data != "") {
						$(".loadAssay").html(data);
						detectedResultChange();
					}
					if (_short == "molbio-truenat-tb" || _short == "molbio-truenat-plus") {
						$('#tb-plus').hide();
					} else {
						$('#tb-plus').show();
					}
				});
		}
	}



	function clearDate(id) {
		$("#" + id).val('');
	}

	function checkComments(val) {
		if (val == 'other') {
			$('#ptNotTestedComments').addClass('isRequired');
			$('.ptNotTestedCommentsAsterisk').show();
		} else {
			$('.ptNotTestedCommentsAsterisk').hide();
			$('#ptNotTestedComments').removeClass('isRequired');
		}
	}
</script>
