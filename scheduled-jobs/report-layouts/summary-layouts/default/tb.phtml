<?php
require_once('tcpdf/tcpdf.php');
require_once(CRON_PATH . '/Common.php');
$general = new Common();

$config = new Zend_Config_Ini(APPLICATION_PATH . DIRECTORY_SEPARATOR . "configs" . DIRECTORY_SEPARATOR . "config.ini", APPLICATION_ENV);
if ($resultArray['shipment'] != "") {
    $shipmentAttributes = json_decode($resultArray['shipment']['shipment_attributes'], true);

    if (!file_exists(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports') && !is_dir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports')) {
        mkdir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports');
    }
    if (!file_exists(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $resultArray['shipment']['shipment_code']) && !is_dir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $resultArray['shipment']['shipment_code'])) {
        mkdir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $resultArray['shipment']['shipment_code']);
    }

    // create new PDF document
    $pdf = new SummaryPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

    // set default header data
    $pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);

    // set header and footer fonts
    $pdf->setHeaderFont(array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
    $pdf->setFooterFont(array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

    // set default monospaced font
    $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);

    $pdf->SetMargins(PDF_MARGIN_LEFT, 40, PDF_MARGIN_RIGHT);

    $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
    $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

    // set auto page breaks
    $pdf->SetAutoPageBreak(TRUE, PDF_MARGIN_BOTTOM);

    // set image scale factor
    $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

    // set some language-dependent strings (optional)
    if (@file_exists(dirname(__FILE__) . '/lang/eng.php')) {
        require_once(dirname(__FILE__) . '/lang/eng.php');
        $pdf->setLanguageArray($l);
    }

    $pdf->setSchemeName($header, $resultArray['shipment']['scheme_name'], $logo, $logoRight, $resultStatus, $resultArray['shipment']['scheme_type'], $evalRow['date_finalised'], $config, $trainingInstanceText, "", $instituteAddressPosition);

    $pdf->AddPage('P', 'A4');
    $pdf->SetFont('helvetica', 'B', 11);

    $htmlTitle = '<span style="font-weight: bold;text-align:center;font-size:11;">Proficiency Testing Program for Tuberculosis</span><br><br><span style="font-weight: bold; font-size:10;text-align:center;">All Participants Results Report</span><br>';

    $pdf->writeHTML($htmlTitle, true, false, true, false, '');

    $referenceRes = '<table style="text-align:center;width:100%" align="left">';
    $referenceRes .= '<tr>';
    $referenceRes .= '<td style="font-weight:normal;width:100%;"><strong>PT Panel Name and Due Date : </strong><span style="font-weight:normal;">' . $resultArray['shipment']['distribution_code'] . ' (' . $general->humanDateFormat($resultArray['shipment']['lastdate_response']) . ')</span></td>';
    $referenceRes .= '</tr>';
    $referenceRes .= '</table>';

    $pdf->writeHTML($referenceRes, true, false, true, false, '');

    $participantCount = '';

    if (isset($resultArray['shipment']['participant_count'])) {
        $participantCount = $resultArray['shipment']['participant_count'];
    }

    $referenceResultContent = '';
    if (isset($resultArray['shipment']['referenceResult']) && !empty($resultArray['shipment']['referenceResult'])) {

        // set font
        $pdf->SetFont('helvetica', 'B', 10);
        $referenceResultContent .= '<div style="border:1px solid #333;">';

        $referenceResultContent .= '<table border="1" cellpadding="3">';
        $referenceResultContent .= '<tr><td colspan="3"><strong>Expected Results</strong></td></tr>';

        $referenceResultContent .= '<tr style="background-color:#D9E0F2;">';
        $referenceResultContent .= '<td style="text-align:center;">Sample ID</td>';
        $referenceResultContent .= '<td style="text-align:center;">Expected TB Detection Result</td>';
        $referenceResultContent .= '<td style="text-align:center;">Expected Rifampicin Resistance Detection</td>';
        $referenceResultContent .= '</tr>';

        foreach ($resultArray['shipment']['referenceResult'] as $ref) {

            $referenceResultContent .= '<tr>';
            $referenceResultContent .= '<td style="text-align:center;">' . $ref['sample_label'] . '</td>';
            $referenceResultContent .= '<td style="text-align:center;">' . $ref['mtb_detection']  . '</td>';
            $referenceResultContent .= '<td style="text-align:center;">' . $ref['rif_resistance']  . '</td>';
            $referenceResultContent .= '</tr>';
        }

        $referenceResultContent .= '</table>';
        $referenceResultContent .= '</div>';
    }

    $pdf->writeHTML($referenceResultContent, true, false, true, false, '');


    $aggregateCountsContent = '';
    if (isset($resultArray['shipment']['aggregateCounts']) && !empty($resultArray['shipment']['aggregateCounts'])) {

        // set font
        $pdf->SetFont('helvetica', 'B', 10);
        $aggregateCountsContent .= '<div style="border:1px solid #333;">';








        $aggregateCountsRes = $general->array_group_by($resultArray['shipment']['aggregateCounts'], "tb_assay", "sample_label");

        foreach ($aggregateCountsRes as $assayName => $samplesUnderAssay) {


            $aggregateCountsContent .= '<h3>Summary of All Reporting Sites Testing ' . $assayName . '</h3>';

            $aggregateCountsContent .= '<table border="1" cellpadding="3">';
            $tableContent = [];
            foreach ($samplesUnderAssay as $singleSampleLabel => $singleSampleArray) {
                $singleSample = $singleSampleArray[0];
                $tableContent[]['Total number of reporting sites'] = $singleSample['numberOfSites'];
                $tableContent[]['Sites detecting TB (%)'] = $singleSample['mtbDetected'] . "(" . (100 * ($singleSample['mtbDetected'] / $singleSample['numberOfSites'])) . ")";
                $tableContent[]['Sites not detecting TB (%)'] = $singleSample['mtbNotDetected'] . "(" . (100 * ($singleSample['mtbNotDetected'] / $singleSample['numberOfSites'])) . ")";
                $tableContent[]['Sites reporting uninterpretable TB result*(%)'] = $singleSample['mtbInvalid'] . "(" . (100 * ($singleSample['mtbInvalid'] / $singleSample['numberOfSites'])) . ")";
                $tableContent[]['Sites detecting Rif resistance (%)'] = $singleSample['rifDetected'] . "(" . (100 * ($singleSample['rifDetected'] / $singleSample['numberOfSites'])) . ")";
                $tableContent[]['Sites not detecting Rif resistance (%)'] = $singleSample['rifNotDetected'] . "(" . (100 * ($singleSample['rifNotDetected'] / $singleSample['numberOfSites'])) . ")";
                $tableContent[]['Sites reporting indeterminate Rif result (%)'] = $singleSample['rifInvalid'] . "(" . (100 * ($singleSample['rifInvalid'] / $singleSample['numberOfSites'])) . ")";
            }
            $aggregateCountsContent .= '</table>';
        }

        Zend_Debug::dump($tableContent);
        die;

        $referenceResultContent .= '</table>';
        $referenceResultContent .= '</div>';
    }

    $pdf->writeHTML($referenceResultContent, true, false, true, false, '');



    if ($assay != "") {
        $html = "";
        $html .= '<h4>Number of Participants for each platform using other platforms and In-House Assays (Total ' . $assayCount . '):</h4>';
        $html .= '<span style="text-align:justify;font-size:10;font-weight:normal;">' . $assay . '</span>';
        $pdf->writeHTML($html, true, false, true, false, '');
    }

    $note = '<br><h4 style="font-size:12;">Information with respect to compliance with standards ISO 13528:2015(E) </h4>';

    $note .= '<h5 style="font-size:10;">Preparation of Proficiency Test items:</h5>';
    $note .= '<span style="text-align:justify;font-size:9;font-weight:normal;">Dried Blood Spots were issued with instructions to report on detection using routine laboratory methods. Samples were tested for
            homogeneity prior to shipment and met program requirements.</span>';

    $note .= '<h5 style="font-size:10;">Procedures used to establish the assigned value:</h5>';
    $note .= '<span style="text-align:justify;font-size:9;font-weight:normal;">The results of participating laboratories were evaluated by comparing to the assigned values determined by the VL and EID Team using
            COBAS Ampliprep/Taqman HIV-1 Qualitative Test.</span>';

    $note .= '<h5 style="font-size:10;">Subcontracting:</h5>';
    $note .= '<span style="text-align:justify;font-size:9;font-weight:normal;">Only the transport of PT items and the ePT site administration are subcontracted.</span>';
    $note .= '<h5 style="font-size:10;">Confidentiality:</h5>';
    $note .= '<span style="text-align:justify;font-size:9;font-weight:normal;">The identity of participants is kept confidential and known only to the staff involved in the Proficiency Testing Program. Each participant
            has been assigned a unique identification number for database management purposes.</span>';

    if (isset($resultArray['shipment']['shipment_comment']) && $resultArray['shipment']['shipment_comment'] != "") {
        $note .= '<br><br><table border="1" cellpadding="3">
                            <tr>
                                <td style="text-align:left;font-size:10;font-weight:bold;">' . $resultArray['shipment']['shipment_comment'] . '</td>
                            </tr>
                        </table>';
    }
    $pdf->writeHTML($note, true, false, true, false, '');
    $html = "";
    if (isset($resultArray['shipment']['pt_co_ordinator_name']) && $resultArray['shipment']['pt_co_ordinator_name'] != "") {
        $html .= '<hr>';
        $html .= '<span style="text-align:center;font-weight:normal;"><small>Report approved by ' . $resultArray['shipment']['pt_co_ordinator_name'] . '</small></span>';
    }

    $html .= '<br/><span style="text-align:center;font-weight:normal;"><small>Date of approval: ' . (isset($pdf->dateTime) ? $general->humanDateFormat($pdf->dateTime) : date('d M Y')) . '</small></span>';
    $html .= '<br/><span style="text-align:center;font-weight:normal;"><small>This is a system generated report. No signature required</small></span>';
    $html .= '<br/><span style="text-align:center;font-weight:normal;"><small>- End of final report -</small></span>';
    $pdf->writeHTML($html, true, false, true, false, '');







    //Close and output PDF document
    $fileName = $resultArray['shipment']['shipment_code'] . "-summary.pdf";
    $filePath = DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $resultArray['shipment']['shipment_code'] . DIRECTORY_SEPARATOR . $fileName;
    //$pdf->Output('example_003.pdf', 'I');
    $pdf->Output($filePath, "F");
    if ($trainingInstance == "yes") {
        //Watermark section
        $pdf = new PDF_Rotate();
    }
    //============================================================+
    // END OF FILE
    //============================================================+
}
