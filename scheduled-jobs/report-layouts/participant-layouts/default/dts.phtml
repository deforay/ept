<?php

$schemeType = $resultArray['shipment'][0]['scheme_type'];

$shipmentCode = '';

$rtriResultsMap = $dtsResultsMap = $dtsResults = [];

$possibleDtsResults = $schemeService->getPossibleResults('dts');
$possibleRecencyResults = $schemeService->getPossibleResults('recency');

foreach ($possibleDtsResults as $pr) {
    $dtsResults[$pr['id']] = $pr['response'];
    if (in_array($pr['scheme_sub_group'], array('DTS_TEST', 'DTS_FINAL'))) {
        $dtsResultsMap[$pr['response']] = $pr['result_code'];
    }
}
foreach ($possibleRecencyResults as $pr) {
    if ($pr['scheme_sub_group'] == 'RECENCY_FINAL') {
        $rtriResultsMap[$pr['id']] = $pr['response'];
    }
}


if (!empty($resultArray['shipment'])) {
    $totalPages = count($resultArray['shipment']);
    $j = 1;

    foreach ($resultArray['shipment'] as $result) {
        $attributes = json_decode($result['attributes'], true);
        /* for Shipment attributes functionality start */
        $shipmentAttributes = json_decode($result['shipment_attributes'], true);
        $shipmentAttributes['shipment_id'] = $result['shipment_id'];
        if ( /*(isset($result['responseResult'][0]['is_excluded']) && $result['responseResult'][0]['is_excluded'] == 'yes') || */
            (isset($result['responseResult'][0]['is_pt_test_not_performed']) && $result['responseResult'][0]['is_pt_test_not_performed'] == 'yes')
        ) {
            continue;
        }


        if (!file_exists($reportsPath . DIRECTORY_SEPARATOR . $result['shipment_code']) && !is_dir($reportsPath . DIRECTORY_SEPARATOR . $result['shipment_code'])) {
            mkdir($reportsPath . DIRECTORY_SEPARATOR . $result['shipment_code']);
        }
        //error_log($i);
        // Extend the TCPDF class to create custom Header and Footer

        // create new PDF document
        $approveTxt = $result['issuing_authority'] ?? ($resultArray['shipment'][0]['issuing_authority'] ?? ($evalRow['saname'] ?? null));
        $reportFormat = $reportService->getReportConfigValue('report-format');
        if (isset($reportFormat) && !empty($reportFormat)) {
            $pdf = new Pt_Reports_FpdiReport(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
            $pdf->setParams($resultStatus, $evalRow['date_finalised'], "", $watermark ?? '', "INDIVIDUAL", $layout, $result['scheme_name'], $result['scheme_type'], $approveTxt, "", $shipmentAttributes);
        } else {
            $pdf = new Pt_Reports_IndividualPdf(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
            $dtsPanelType = $attributes['dts_test_panel_type'] ?? null;
            $pdf->setSchemeName($header, $result['scheme_name'], $logo, $logoRight, $resultStatus, $schemeType, $layout, $evalRow['date_finalised'], "", $watermark ?? '', "", $instituteAddressPosition, "", $dtsPanelType);
        }
        // set default header data
        $pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);

        // set header and footer fonts
        $pdf->setHeaderFont(['freesans', '', PDF_FONT_SIZE_MAIN]);
        $pdf->setFooterFont(['freesans', '', PDF_FONT_SIZE_DATA]);

        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);

        // set margins
        $mt = 40;
        if (isset($templateTopMargin) && !empty($templateTopMargin)) {
            $mt = $templateTopMargin;
        }
        $pdf->SetMargins(PDF_MARGIN_LEFT, $mt, PDF_MARGIN_RIGHT);
        $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

        // set auto page breaks
        $pdf->SetAutoPageBreak(true, 8);

        // set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

        // add a page
        $pdf->AddPage('P', 'A4');
        $pdf->SetFont('freesans', '', 12);


        if (trim($result['shipment_date']) != "") {
            $result['shipment_date'] = Pt_Commons_DateUtility::humanReadableDateFormat($result['shipment_date']);
        }
        if (trim($result['lastdate_response']) != "") {
            $result['lastdate_response'] = Pt_Commons_DateUtility::humanReadableDateFormat($result['lastdate_response']);
        }


        $responseDate = "";
        $shipmentTestDate = "";
        $shipmentScore = 0;
        $documentationScore = 0;
        $score = 0;
        $testThreeHidden = false;
        $testTwoHidden = false;
        $screeningTest = false;
        $noTest = 1;
        $noOfCol = 8;

        // $dtsResultsMap = array(
        //     'Positive'      => 'P',
        //     'Negative'      => 'N',
        //     'Reactive'      => 'R',
        //     'Nonreactive'   => 'NR',
        //     'Invalid'       => 'I',
        //     'Indeterminate' => 'Ind'
        // );

        $flag = UPLOAD_PATH . '/../images/red-flag.png';
        if (!Application_Service_Common::fileExists($flag)) {
            $flag = null;
        }
        $testThreeOptionalDisplay = "";
        $dtsOptionalTest3 = Pt_Commons_SchemeConfig::get('dts.dtsOptionalTest3');
        if (isset($attributes['dts_test_panel_type']) && $attributes['dts_test_panel_type'] == 'confirmatory') {
            $testThreeOptionalDisplay = "";
            $testThreeHidden = false;
        } elseif (isset($dtsOptionalTest3) && $dtsOptionalTest3 == 'yes') {
            $testThreeOptionalDisplay = "display:none;";
            $testThreeHidden = true;
            $noOfCol = 7;
        }
        $shipmentAttributesScreeningTestDisplay = "";
        if ((isset($shipmentAttributes["screeningTest"]) && $shipmentAttributes["screeningTest"] == 'yes') || (isset($attributes['dts_test_panel_type']) && $attributes['dts_test_panel_type'] == 'screening')) {
            $shipmentAttributesScreeningTestDisplay = "display:none;";
            $testThreeOptionalDisplay = "display:none;";
            $testTwoHidden = true;
            $noOfCol = 6;
        }

        if (isset($shipmentAttributes['noOfTestsInPanel']) && $shipmentAttributes['noOfTestsInPanel'] == 2) {
            $testThreeHidden = true;
            $testThreeOptionalDisplay = "display:none;";
            $noOfCol = 7;
        }

        $allowRepeatTests = Pt_Commons_SchemeConfig::get('dts.allowRepeatTests');
        if ($allowRepeatTests == "yes") {
            $noOfCol = 9;
            if ($shipmentAttributesScreeningTestDisplay != "" || $testThreeOptionalDisplay != "") {
                $noOfCol = 7;
            }
        }
        /* Addition testkit field */
        $infoJson = false;
        if (isset($result['responseResult'][0]['kit_additional_info']) && !empty($result['responseResult'][0]['kit_additional_info'])) {
            $infoJson = (array) json_decode($result['responseResult'][0]['kit_additional_info']);
        }
        $testkit3Colspan = $testkit2Colspan = $testkit1Colspan = 1;
        if (isset($infoJson['test1']) && !empty($infoJson['test1'])) {
            $noOfCol += 1;
            $testkit1Colspan = 2;
        }
        if (isset($infoJson['test2']) && !empty($infoJson['test2'])) {
            $noOfCol += 1;
            $testkit2Colspan = 2;
        }
        if (isset($infoJson['test3']) && !empty($infoJson['test3'])) {
            $noOfCol += 1;
            $testkit3Colspan = 2;
        }
        $width = number_format((100 / $noOfCol), 2);
        if (($testTwoHidden)) {
            $noTest = 1;
        } elseif ($testThreeHidden) {
            $noTest = 2;
        } else {
            $noTest = 3;
        }
        /* Addition testkit field */
        $dtsModel = new Application_Model_Dts();
        $allTestKits = $dtsModel->getAllDtsTestKitList();
        $kitAttributes = [];
        foreach ($allTestKits as $kit) {
            if (isset($kit['attributes']) && !empty($kit['attributes'])) {
                $kitAttributes[$kit['TESTKITNAMEID']] = json_decode($kit['attributes'], true);
            }
        }

        $shipmentAttributesSampleTypeDisplay = "";
        if (isset($shipmentAttributes["sampleType"]) && ($shipmentAttributes["sampleType"] == 'serum' || $shipmentAttributes["sampleType"] == 'plasma')) {
            $shipmentAttributesSampleTypeDisplay = "display:none;";
        }

        /* for Shipment attributes functionality end */
        if (isset($result['responseResult'][0]['responseDate']) && trim($result['responseResult'][0]['responseDate']) != "") {
            $splitDate = explode(" ", $result['responseResult'][0]['responseDate']);
            $responseDate = Pt_Commons_DateUtility::humanReadableDateFormat($splitDate[0]);
        }
        $attributes = '';
        if (isset($result['attributes'])) {
            $attributes = json_decode($result['attributes'], true);
        }

        $sampleRehydrationDate = "";
        if (isset($attributes['sample_rehydration_date']) && trim($attributes['sample_rehydration_date']) != "") {
            $sampleRehydrationDate = Pt_Commons_DateUtility::humanReadableDateFormat($attributes['sample_rehydration_date']);
        }

        $srDate = new DateTime($attributes['sample_rehydration_date']);
        $testedOnDate = new DateTime($result['responseResult'][0]['shipment_test_date']);
        $interval = $srDate->diff($testedOnDate);
        $sampleRehydrateDays = Pt_Commons_SchemeConfig::get('dts.sampleRehydrateDays') ?? 0;
        $displaySampleConditionFields = Pt_Commons_SchemeConfig::get('dts.displaySampleConditionFields');
        $passPercentage = Pt_Commons_SchemeConfig::get('dts.passPercentage');
        // Testing should be done within 24*($sampleRehydrateDays) hours of rehydration.
        $rehydrateHours = $sampleRehydrateDays * 24;
        $sampleConditionFields = $displaySampleConditionFields ?? 'no';

        $shipmentReceiptDate = "";
        if (isset($result['responseResult'][0]['shipment_receipt_date']) && trim($result['responseResult'][0]['shipment_receipt_date']) != "") {
            $shipmentReceiptDate = Pt_Commons_DateUtility::humanReadableDateFormat($result['responseResult'][0]['shipment_receipt_date']);
        }

        if (isset($result['responseResult'][0]['shipment_test_date']) && trim($result['responseResult'][0]['shipment_test_date']) != "") {
            $shipmentTestDate = Pt_Commons_DateUtility::humanReadableDateFormat($result['responseResult'][0]['shipment_test_date']);
        }

        $labInfo = '<table cellpadding="3" style="font-size:11px;">';

        $labInfo .= '<tr>';
        $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Participant Code') . '</strong><br>' . $result['unique_identifier'] . '</td>';
        $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Performing Participant') . '</strong><br>' . $result['first_name'] . " " . $result['last_name'] . '</td>';
        $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('PT Panel Name and Date') . '</strong><br>' . $result['distribution_code'] . '(' . $result['shipment_date'] . ')</td>';
        $labInfo .= '</tr>';

        $labInfo .= '<tr>';
        $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Shipment Date') . '</strong><br>' . $result['shipment_date'] . '</td>';
        $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Shipment Code') . '</strong><br>' . $result['shipment_code'] . '</td>';
        $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Shipment Type') . '</strong><br>' . $result['scheme_name'] . '</td>';
        $labInfo .= '</tr>';

        $labInfo .= '<tr>';
        $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Panel Receipt Date') . '</strong><br>' . $shipmentReceiptDate . '</td>';
        $labInfo .= '	<td style="' . $shipmentAttributesSampleTypeDisplay . '"><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Rehydration Date') . '</strong>';
        if (!empty($flag) && (empty($sampleRehydrationDate) || ($interval->days < $sampleRehydrateDays || $interval->days > ($sampleRehydrateDays + 1)))) {
            $labInfo .= '<img style="width:10px;" src="' . $flag . '"/>';
        }
        if (isset($sampleRehydrationDate) && $sampleRehydrationDate != "") {
            $labInfo .= '<br>' . $sampleRehydrationDate;
        }

        $labInfo .= '</td>';
        $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Result Due Date') . '</strong><br>' . $result['lastdate_response'] . '</td>';
        $labInfo .= '</tr>';

        $labInfo .= '<tr>';
        $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Response Date') . '</strong><br>' . $responseDate . '</td>';
        $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Shipment Test Date') . '</strong><br>' . $shipmentTestDate . '</td>';
        if ($attributes['dts_test_panel_type'] != "screening") {
            $labInfo .= '	<td>';
            if (isset($attributes['algorithm'])) {
                if ($attributes['algorithm'] == 'myanmarNationalDtsAlgo') {
                    $labInfo .= '	<strong>' . Pt_Commons_TranslateUtility::safeTranslate('Algorithm') . '</strong><br>' . Pt_Commons_TranslateUtility::safeTranslate('Myanmar National Algorithm');
                } elseif ($attributes['algorithm'] == 'malawiNationalDtsAlgo') {
                    $labInfo .= '	<strong>' . Pt_Commons_TranslateUtility::safeTranslate('Algorithm') . '</strong><br>' . Pt_Commons_TranslateUtility::safeTranslate('Malawi National Algorithm');
                } elseif ($attributes['algorithm'] == 'ghanaNationalDtsAlgo') {
                    $labInfo .= '	<strong>' . Pt_Commons_TranslateUtility::safeTranslate('Algorithm') . '</strong><br>' . Pt_Commons_TranslateUtility::safeTranslate('Ghana National Algorithm');
                } else {
                    $labInfo .= '	<strong>' . Pt_Commons_TranslateUtility::safeTranslate('Algorithm') . '</strong><br>' . ucwords($attributes['algorithm']);
                }
            }
            $labInfo .= ' </td>';
        } else {
            if (isset($attributes['dts_test_panel_type']) && $attributes['dts_test_panel_type'] != "") {
                $labInfo .= '<td>';
                $labInfo .= '	<strong>' . Pt_Commons_TranslateUtility::safeTranslate('Test Type') . '</strong>';
                $labInfo .= '<br>' . ucwords($attributes['dts_test_panel_type']);
                $labInfo .= '</td>';
            } else {
                $labInfo .= '<td></td>';
            }
        }
        $labInfo .= '</tr>';

        if ($sampleConditionFields == 'yes') {
            $conditionOfPTSamples = (isset($attributes['condition_pt_samples']) && $attributes['condition_pt_samples'] != "") ? ucwords(str_replace('-', ' ', $attributes['condition_pt_samples'])) : "";
            $refridgerator = (isset($attributes['refridgerator']) && $attributes['refridgerator'] != "") ? ucwords(str_replace('-', ' ', $attributes['refridgerator'])) : "";
            $roomTemperature = (isset($attributes['room_temperature']) && $attributes['room_temperature'] != "") ? $attributes['room_temperature'] : "";
            $stopWatch = (isset($attributes['stop_watch']) && $attributes['stop_watch'] != "") ? ucwords(str_replace('-', ' ', $attributes['stop_watch'])) : "";

            $labInfo .= '<tr>';
            $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Condition of PT Samples') . '</strong><br>' . $conditionOfPTSamples . '</td>';
            $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Refridgerator') . '</strong><br>' . $refridgerator . '</td>';
            $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Room Temperature') . '</strong><br>' . $roomTemperature . '</td>';
            $labInfo .= '</tr>';

            $labInfo .= '<tr>';
            $labInfo .= '	<td><strong>' . Pt_Commons_TranslateUtility::safeTranslate('Stop Watch') . '</strong><br>' . $stopWatch . '</td>';
        } else {
            $labInfo .= '<tr>';
        }


        $labInfo .= '	<td>';
        $labInfo .= '<strong>' . Pt_Commons_TranslateUtility::safeTranslate('Supervisor Review') . '</strong>';
        if (isset($result['supervisor_approval']) && $result['supervisor_approval'] == "yes") {
            $labInfo .= '<br>' . ucwords($result['supervisor_approval']);
        } elseif (isset($result['supervisor_approval']) && $result['supervisor_approval'] == "no") {
            if (!empty($flag)) {
                $labInfo .= '<img style="width:10px;" src="' . $flag . '"/>';
            }

            $labInfo .= '<br>' . ucwords($result['supervisor_approval']);
        } else {
            if (!empty($flag)) {
                $labInfo .= '<img style="width:10px;" src="' . $flag . '"/>';
            }
        }
        $labInfo .= '</td><td>';
        $labInfo .= '	<strong>' . Pt_Commons_TranslateUtility::safeTranslate('Supervisor Name') . '</strong>';
        if (isset($result['participant_supervisor']) && $result['participant_supervisor'] != "") {
            $labInfo .= '<br>' . ($result['participant_supervisor']);
        } else {
            if (!empty($flag)) {
                $labInfo .= '<img style="width:10px;" src="' . $flag . '"/>';
            }
        }
        $labInfo .= '</td>';
        $labInfo .= '<td></td>';
        $labInfo .= '</tr>';
        $labInfo .= '<tr>';
        $labInfo .= '	<td>';
        if (isset($haveCustom) && $haveCustom == 'yes' && !empty($customField1)) {
            $labInfo .= '	<strong>' . $customField1 . '</strong> <br>' . (!empty($result['custom_field_1']) ? $result['custom_field_1'] : '');
        }
        $labInfo .= ' </td>';
        $labInfo .= '	<td>';
        if (isset($haveCustom) && $haveCustom == 'yes' && !empty($customField2)) {
            $labInfo .= '<strong>' . $customField2 . '</strong> <br>' . (!empty($result['custom_field_2']) ? $result['custom_field_2'] : '');
        }
        $labInfo .= ' </td>';
        $labInfo .= ' <td></td>';
        $labInfo .= '</tr>';

        $labInfo .= '</table>';
        //shipment_test_date
        $pdf->writeHTML($labInfo, true, false, true, false, '');
        $panelScore = Pt_Commons_SchemeConfig::get('dts.panelScore');

        if (!empty($result['responseResult'])) {
            $labRes = '<span style="font-weight: bold;font-size:12px;">' . Pt_Commons_TranslateUtility::safeTranslate('Your HIV Proficiency results') . ' <span style="font-size:11px;">(' . Pt_Commons_TranslateUtility::safeTranslate('maximum possible score') . ' : ' . $panelScore . ')</span><br/></span>
            <table border="1" style="font-size:12px;">';

            /* Addition testkit field */
            $testkit1W = $testkit2W = $testkit3W = $width;
            if ($testkit1Colspan > 1) {
                $testkit1W = $width * 2;
            }
            if ($testkit2Colspan > 1) {
                $testkit2W = $width * 2;
            }
            if ($testkit3Colspan > 1) {
                $testkit3W = $width * 2;
            }
            $labRes .= '<tr style="background-color:#dbe4ee;">
                                <td style="width:' . $width . '%;"></td>
                                <th colspan="' . $testkit1Colspan . '" style="text-align:center;font-weight:bold;width:' . $testkit1W . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Test-1') . '</th>';
            if ($shipmentAttributesScreeningTestDisplay == "") {
                $labRes .= '<th colspan="' . $testkit2Colspan . '" style="text-align:center;font-weight:bold;' . $shipmentAttributesScreeningTestDisplay . 'width:' . $testkit2W . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Test-2') . '</th>';
            }
            if ($testThreeOptionalDisplay == "") {
                $labRes .= '<th colspan="' . $testkit3Colspan . '" style="text-align:center;font-weight:bold;' . $testThreeOptionalDisplay . 'width:' . $testkit3W . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Test-3') . '</th>';
            }
            if ($allowRepeatTests == 'yes') {
                $labRes .= '<th colspan="' . ($noTest + 2) . '" style="border:none;width:' . ($width * ($noTest + 2)) . '%;"></th>';
            } else {
                $labRes .= '<th colspan="4" style="border:none;width:' . ($width * 4) . '%;"></th>';
            }
            $labRes .= '</tr>';
            $labRes .= '<tr>
                                <td style="text-align:center;font-weight:bold;background-color:#dbe4ee;">' . Pt_Commons_TranslateUtility::safeTranslate('Kit Name') . '</td>
                                <td colspan="' . $testkit1Colspan . '">' . $result['responseResult'][0]['testkit1'] . '</td>';
            if ($shipmentAttributesScreeningTestDisplay == "") {
                $labRes .= '<td colspan="' . $testkit2Colspan . '" style="' . $shipmentAttributesScreeningTestDisplay . '">' . $result['responseResult'][0]['testkit2'] . '</td>';
            }
            if ($testThreeOptionalDisplay == "") {
                $labRes .= '<td colspan="' . $testkit3Colspan . '" style="' . $testThreeOptionalDisplay . '">' . $result['responseResult'][0]['testkit3'] . '</td>';
            }
            if ($allowRepeatTests == 'yes') {
                $labRes .= '<td colspan="' . ($noTest + 4) . '"></td>';
            } else {
                $labRes .= '<td colspan="4"></td>';
            }
            $labRes .= '</tr>';
            $labRes .= '<tr>
                                <td style="text-align:center;font-weight:bold;background-color:#dbe4ee;">' . Pt_Commons_TranslateUtility::safeTranslate('Lot No.') . '</td>
                                <td colspan="' . $testkit1Colspan . '">' . $result['responseResult'][0]['lot_no_1'] . '</td>';
            if ($shipmentAttributesScreeningTestDisplay == "") {
                $labRes .= '<td colspan="' . $testkit2Colspan . '" style="' . $shipmentAttributesScreeningTestDisplay . '">' . $result['responseResult'][0]['lot_no_2'] . '</td>';
            }
            if ($testThreeOptionalDisplay == "") {
                $labRes .= '<td colspan="' . $testkit3Colspan . '" style="' . $testThreeOptionalDisplay . '">' . $result['responseResult'][0]['lot_no_3'] . '</td>';
            }
            if ($allowRepeatTests == 'yes') {
                $labRes .= '<td colspan="' . ($noTest + 4) . '"></td>';
            } else {
                $labRes .= '<td colspan="4"></td>';
            }
            $labRes .= '</tr>';
            $labRes .= '<tr>
                                <td style="text-align:center;font-weight:bold;background-color:#dbe4ee;">' . Pt_Commons_TranslateUtility::safeTranslate('Expiry Date') . '</td>
                                <td colspan="' . $testkit1Colspan . '">' . Pt_Commons_DateUtility::humanReadableDateFormat($result['responseResult'][0]['exp_date_1']) . '</td>';
            if ($shipmentAttributesScreeningTestDisplay == "") {
                $labRes .= '<td colspan="' . $testkit2Colspan . '" style="' . $shipmentAttributesScreeningTestDisplay . '">' . Pt_Commons_DateUtility::humanReadableDateFormat($result['responseResult'][0]['exp_date_2']) . '</td>';
            }
            if ($testThreeOptionalDisplay == "") {
                $labRes .= '<td colspan="' . $testkit3Colspan . '" style="' . $testThreeOptionalDisplay . '">' . Pt_Commons_DateUtility::humanReadableDateFormat($result['responseResult'][0]['exp_date_3']) . '</td>';
            }
            if ($allowRepeatTests == 'yes') {
                $labRes .= '<td colspan="' . ($noTest + 4) . '"></td>';
            } else {
                $labRes .= '<td colspan="4"></td>';
            }
            $labRes .= '</tr>';

            if ($allowRepeatTests == 'yes') {
                $labRes .= '<tr style="background-color:#dbe4ee;">
                            <th colspan="' . ($noTest + 1) . '" style="width:' . ($width * ($noTest + 1)) . '%;"></th>
                            <th colspan="' . $noTest . '" style="text-align:center;font-weight:bold;width:' . ($width * $noTest) . '%;"><b>' . Pt_Commons_TranslateUtility::safeTranslate('Repeat Test') . '</b></th>
                            <th colspan="4" style="width:' . $width . '%;"></th>
                        </tr>';
            }

            $labRes .= '<tr style="background-color:#dbe4ee;">
                                <th style="text-align:center;font-weight:bold;width:' . $width . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Specimen Panel ID') . ' </th>
                                <th style="text-align:center;font-weight:bold;width:' . $width . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Result-1') . '</th>';
            /* Addition testkit field */
            if (isset($infoJson['test1']) && !empty($infoJson['test1'])) {
                $labRes .= '<th style="text-align:center;font-weight:bold;width:' . $width . '%;">' . $kitAttributes[$result['responseResult'][0]['test_kit_name_1']]['additional_info_label'] . '</th>';
            }
            if ($shipmentAttributesScreeningTestDisplay == "") {
                $labRes .= '<th style="text-align:center;font-weight:bold;' . $shipmentAttributesScreeningTestDisplay . 'width:' . $width . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Result-2') . '</th>';
            }
            /* Addition testkit field */
            if (isset($infoJson['test2']) && !empty($infoJson['test2'])) {
                $labRes .= '<th style="text-align:center;font-weight:bold;width:' . $width . '%;">' . $kitAttributes[$result['responseResult'][0]['test_kit_name_2']] . '-2</th>';
            }
            if ($testThreeOptionalDisplay == "") {
                $labRes .= '<th style="text-align:center;font-weight:bold;' . $testThreeOptionalDisplay . 'width:' . $width . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Result-3') . '</th>';
            }
            /* Addition testkit field */
            if (isset($infoJson['test3']) && !empty($infoJson['test3'])) {
                $labRes .= '<th style="text-align:center;font-weight:bold;width:' . $width . '%;">' . $kitAttributes[$result['responseResult'][0]['test_kit_name_3']] . '-3</th>';
            }
            if ($allowRepeatTests == 'yes') {
                $labRes .= '<th style="text-align:center;font-weight:bold;width:' . $width . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Result-1') . '</th>';
                if ($shipmentAttributesScreeningTestDisplay == "") {
                    $labRes .= '<th style="text-align:center;font-weight:bold;' . $shipmentAttributesScreeningTestDisplay . 'width:' . $width . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Result-2') . '</th>';
                }
                if ($testThreeOptionalDisplay == "") {
                    $labRes .= '<th style="text-align:center;font-weight:bold;' . $testThreeOptionalDisplay . 'width:' . $width . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Result-3') . '</th>';
                }
            }
            $labRes .= '<th style="text-align:center;font-weight:bold;width:' . $width . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Reference Result') . '</th>
                        <th style="text-align:center;font-weight:bold;width:' . $width . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Your Result') . '</th>';
            $labRes .= '<th style="text-align:center;font-weight:bold;width:' . $width . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Evaluation') . '</th>';
            $labRes .= '<th style="text-align:center;font-weight:bold;width:' . $width . '%;">' . Pt_Commons_TranslateUtility::safeTranslate('Score') . '</th>';
            $labRes .= '</tr>';

            $nonMandatorySamples = [];
            $controlSamples = [];
            $correctSamples = [];
            $totalProperSamples = 0;
            $correctSamplesCount = 0;
            $wrongSamples = [];
            $otherSamples = [];
            $allSamples = [];
            $mandatorySampleCount = 0;
            foreach ($result['responseResult'] as $response) {
                $allSamples[] = $response['sample_label'];
                if ($response['control'] == 1) {
                    $controlSamples[] = $response['sample_label'];
                }

                if ($response['mandatory'] == 0) {
                    $nonMandatorySamples[] = $response['sample_label'];
                } else {
                    $mandatorySampleCount++;
                    if ($response['calculated_score'] == 'Pass') {
                        $correctSamples[] = $response['sample_label'];
                    } elseif ($response['calculated_score'] == 'Fail') {
                        $wrongSamples[] = $response['sample_label'];
                    } else {
                        $otherSamples[] = $response['sample_label'];
                    }
                }
            }
            $correctSamplesCount = count($correctSamples);
            $documentationScore = Pt_Commons_SchemeConfig::get('dts.documentationScore');
            $totalProperSamples = $correctSamplesCount + count($wrongSamples);
            $maxDocumentationPoints = $documentationScore ?? 0;
            $maximumResponseScore = 100 - $maxDocumentationPoints;
            // $scorePerCorrectSample = round($maximumResponseScore / (count($allSamples) - count($nonMandatorySamples) - count($controlSamples)), 2);
            // $scorePerCorrectSample = round($maximumResponseScore / (count($numberOfMandatorySamples)), 2);
            $scorePerCorrectSample = round($maximumResponseScore / $mandatorySampleCount, 2);

            $dtsRtriIsEditable = false;
            foreach ($result['responseResult'] as $response) {
                $errMsg = '';
                if ($response['calculated_score'] == 'Pass') {
                    $img = WEB_ROOT . '/images/check.jpg';

                    $score = ($response['control'] == 0) ? $scorePerCorrectSample : "N.A.";
                } elseif ($response['calculated_score'] == 'Fail') {
                    $errMsg = (isset($response['algorithm_result']) && !empty($response['algorithm_result']) && $response['algorithm_result'] == 'Fail') ? '(Algorithm)' : '(Interpretation)';
                    $img = WEB_ROOT . '/images/cross.jpg';
                    $score = ($response['control'] == 0) ? 0 : "N.A.";
                } else {
                    $img = WEB_ROOT . '/images/minus.jpg';
                    $score = "N.A.";
                }
                /* Addition testkit field */
                $infoInnerJson = false;
                if (isset($response['kit_additional_info']) && !empty($response['kit_additional_info'])) {
                    $infoInnerJson = (array) json_decode($response['kit_additional_info']);
                }

                $labRes .= '<tr>
							<td style="text-align:center;">' . $response['sample_label'] . '</td>
							<td style="text-align:center;">' . (isset($response['test_result_1']) && $response['test_result_1'] != "" ? $dtsResultsMap[$dtsResults[$response['test_result_1']]] : "") . '</td>';
                /* Addition testkit field */
                if (isset($infoInnerJson['test1']) && !empty($infoInnerJson['test1'])) {
                    $labRes .= '<td style="text-align:center;width:' . $width . '%;">' . $infoInnerJson['test1'] . '</td>';
                }
                if ($shipmentAttributesScreeningTestDisplay == "") {
                    $labRes .= '<td style="' . $shipmentAttributesScreeningTestDisplay . ';text-align:center;">' . (isset($response['test_result_2']) && $response['test_result_2'] != "" ? $dtsResultsMap[$dtsResults[$response['test_result_2']]] : "") . '</td>';
                }
                /* Addition testkit field */
                if (isset($infoInnerJson['test2']) && !empty($infoInnerJson['test2'])) {
                    $labRes .= '<td style="text-align:center;width:' . $width . '%;">' . $infoInnerJson['test2'] . '</td>';
                }
                if ($testThreeOptionalDisplay == "") {
                    $labRes .= '<td style="' . $testThreeOptionalDisplay . ';text-align:center;">' . (isset($response['test_result_3']) && $response['test_result_3'] != "" ? $dtsResultsMap[$dtsResults[$response['test_result_3']]] : "") . '</td>';
                }
                /* Addition testkit field */
                if (isset($infoInnerJson['test3']) && !empty($infoInnerJson['test3'])) {
                    $labRes .= '<td style="text-align:center;width:' . $width . '%;">' . $infoInnerJson['test3'] . '</td>';
                }
                if ($allowRepeatTests == 'yes') {
                    $labRes .= '<td style="text-align:center;">' . (isset($response['repeat_test_result_1']) && $response['repeat_test_result_1'] != "" ? $dtsResultsMap[$dtsResults[$response['repeat_test_result_1']]] : "") . '</td>';
                    if ($shipmentAttributesScreeningTestDisplay == "") {
                        $labRes .= '<td style="' . $shipmentAttributesScreeningTestDisplay . ';text-align:center;">' . (isset($response['repeat_test_result_2']) && $response['repeat_test_result_2'] != "" ? $dtsResultsMap[$dtsResults[$response['repeat_test_result_2']]] : "") . '</td>';
                    }
                    if ($testThreeOptionalDisplay == "") {
                        $labRes .= '<td style="' . $testThreeOptionalDisplay . '">' . (isset($response['repeat_test_result_3']) && $response['repeat_test_result_3'] != "" ? $dtsResultsMap[$dtsResults[$response['repeat_test_result_3']]] : "") . '</td>';
                    }
                }
                $labRes .= '<td style="text-align:center;">' . $response['referenceResultCode'] . '</td>
                            <td style="text-align:center;">' . $dtsResultsMap[$response['labResult']] . '</td>';
                $labRes .= '<td style="text-align:center;"><img style="width:10px;" src="' . $img . '" />  <span style="font-size:8px;">' . $errMsg . '</span></td>';
                $labRes .= '<td style="text-align:center;">' . $score . '</td>';
                $labRes .= '</tr>';
                if (isset($response['dts_rtri_is_editable']) && $response['dts_rtri_is_editable'] == 'yes') {
                    $dtsRtriIsEditable = true;
                }
            }
            $labRes .= '</table>';
            $labRes .= '<span style="font-size:10px;">' . Pt_Commons_TranslateUtility::safeTranslate('(R = Reactive, NR = Non Reactive, P = Positive, N = Negative, I = Invalid, Ind = Indeterminate)') . '</span><br/>';
            if (isset($shipmentAttributes['enableRtri']) && $shipmentAttributes['enableRtri'] == 'yes' && $dtsRtriIsEditable) {
                /* RTRI Panel section */
                $labRes .= '<br><span style="font-weight: bold;font-size:12px;"> ' . Pt_Commons_TranslateUtility::safeTranslate('RTRI Results') . ' : <br/></span>
                <table border="1" style="font-size:12px;">';
                $labRes .= '<tr style="background-color:#dbe4ee;">
                                    <th style="text-align:center;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Control/Sample') . '</th>
                                    <th style="text-align:center;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Control Line') . '</th>
                                    <th style="text-align:center;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Verification Line') . '</th>
                                    <th style="text-align:center;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Longterm Line') . '</th>
                                    <th style="text-align:center;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Expected Result') . '</th>
                                    <th style="text-align:center;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Your RTRI Interpretation') . '</th>
                            </tr>';
                foreach ($result['responseResult'] as $response) {
                    if (isset($response['dts_rtri_is_editable']) && $response['dts_rtri_is_editable'] == 'yes') {
                        $labRes .= '<tr>
                                        <td style="text-align:center;">' . ucwords($response['sample_label']) . '</td>
                                        <td style="text-align:center;">' . ucwords($response['dts_rtri_control_line']) . '</td>
                                        <td style="text-align:center;">' . ucwords($response['dts_rtri_diagnosis_line']) . '</td>
                                        <td style="text-align:center;">' . ucwords($response['dts_rtri_longterm_line']) . '</td>
                                        <td style="text-align:center;">' . $rtriResultsMap[$response['dts_rtri_reference_result']] . '</td>
                                        <td style="text-align:center;">' . $rtriResultsMap[$response['dts_rtri_reported_result']] . '</td>
                                    </tr>';
                    }
                }
                $labRes .= '</table>';
            }

            $pdf->SetLeftMargin(15);
            $pdf->writeHTML($labRes, true, false, true, false, '');

            if (!empty($nonMandatorySamples)) {

                $nmsTable = Pt_Commons_TranslateUtility::safeTranslate("The following samples have been excluded from this evaluation") . " : " . implode(", ", $nonMandatorySamples);
                $nmsTable .= "<br/>";
                $pdf->writeHTML($nmsTable, true, false, true, false, '');
            }

            //Let us now calculate documentation score
            $totalDocumentationItems = 0;

            if (isset($shipmentAttributes['sampleType']) && $shipmentAttributes['sampleType'] == 'dried') {
                // for Dried Samples, we will have rehydration as one of the documentation scores
                // for Dried Samples, we will have 2 documentation checks for rehydration - Rehydration Date and Date Diff between Rehydration and Testing
                $totalDocumentationItems = 5;
            } else {
                // for Non Dried Samples, we will NOT have rehydration documentation scores
                // there are 2 conditions for rehydration so 5 - 2 = 3
                $totalDocumentationItems = 3;
                // Myanmar does not have Supervisor scoring so it has one less documentation item
                if ($attributes['algorithm'] == 'myanmarNationalDtsAlgo') {
                    $totalDocumentationItems -= 1;
                }
            }

            if ($attributes['algorithm'] == 'malawiNationalDtsAlgo') {
                // For Malawi we have 4 more documentation items to consider - Sample Condition, Fridge, Stop Watch and Room Temp
                $totalDocumentationItems += 4;
            }

            $documentationScorePerItem = (!empty($documentationScore) && (int) $documentationScore > 0) ? round(($documentationScore / $totalDocumentationItems), 2) : 'N.A.';
            $scoreText = (isset($documentationScore) && !empty($documentationScore) && $documentationScore == 0) ? Pt_Commons_TranslateUtility::safeTranslate("Your Response") : Pt_Commons_TranslateUtility::safeTranslate("Score");
            $img = [];
            $imgPass = WEB_ROOT . '/images/check.jpg';
            $imgFail = WEB_ROOT . '/images/cross.jpg';
            $docRes = '<span style="font-weight:bold;font-size:12px;">' . Pt_Commons_TranslateUtility::safeTranslate('Your documentation score') . ' <span style="font-size:11px;">(' . Pt_Commons_TranslateUtility::safeTranslate('maximum possible score') . ' : ' . $documentationScore . ')</span></span> <br/>
					<table border="1" style="font-size:12px;width:100%;">
						<tr style="background-color:#dbe4ee;">
							<td style="text-align:center;font-weight:bold;width:70%;">' . Pt_Commons_TranslateUtility::safeTranslate('Documentation Item') . '</td>
							<td style="text-align:center;font-weight:bold;width:15%;">' . Pt_Commons_TranslateUtility::safeTranslate('Response') . '</td>';
            $docRes .= '<td style="text-align:center;font-weight:bold;width:15%;">' . $scoreText . '</td>';
            $docRes .= '</tr>';


            if (isset($result['responseResult'][0]['shipment_receipt_date']) && trim($result['responseResult'][0]['shipment_receipt_date']) != "") {
                $scoreDoc = $documentationScorePerItem;
                $img = $imgPass;
            } else {
                $scoreDoc = 0;
                $img = $imgFail;
            }

            $docRes .= '<tr>
							<td style="text-align:left;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Panel/Shipment Receipt Date Specified') . '</td>';
            $docRes .= '<td style="text-align:center;"><img style="width:9px;" src="' . $img . '" /></td>
            <td style="text-align:center;">' . $scoreDoc . '</td>';
            $docRes .= '</tr>';

            if (isset($attributes['sample_rehydration_date']) && trim($attributes['sample_rehydration_date']) != "" && $shipmentAttributesSampleTypeDisplay == "") {
                $scoreDoc = $documentationScorePerItem;
                $img = $imgPass;
            } else {
                $scoreDoc = 0;
                $img = $imgFail;
            }

            $docRes .= '<tr style="' . $shipmentAttributesSampleTypeDisplay . '">
							<td style="text-align:left;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Reporting of the Sample Rehydration Date') . '</td>';
            $docRes .= '<td style="text-align:center;"><img style="width:9px;" src="' . $img . '" /></td>
            <td style="text-align:center;">' . $scoreDoc . '</td>';
            $docRes .= '</tr>';

            if (isset($result['responseResult'][0]['shipment_test_date']) && trim($result['responseResult'][0]['shipment_test_date']) != "") {
                $scoreDoc = $documentationScorePerItem;
                $img = $imgPass;
            } else {
                $scoreDoc = 0;
                $img = $imgFail;
            }

            $docRes .= '<tr>
							<td style="text-align:left;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Reporting of the Shipment Test Date') . '</td>';
            $docRes .= '<td style="text-align:center;"><img style="width:9px;" src="' . $img . '" /></td>
            <td style="text-align:center;">' . $scoreDoc . '</td>';
            $docRes .= '</tr>';


            if ($interval->days < $sampleRehydrateDays || $interval->days > ($sampleRehydrateDays + 1)) {
                $scoreDoc = 0;
                $img = $imgFail;
            } else {
                $scoreDoc = $documentationScorePerItem;
                $img = $imgPass;
            }

            $docRes .= '<tr style="' . $shipmentAttributesSampleTypeDisplay . '">
							<td style="text-align:left;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Testing to be done within') . ' ' . $rehydrateHours . ' ' . Pt_Commons_TranslateUtility::safeTranslate('hours of rehydration.') . '</td>';
            $docRes .= '<td style="text-align:center;"><img style="width:11px;" src="' . $img . '" /></td>
            <td style="text-align:center;">' . $scoreDoc . '</td>';
            $docRes .= '</tr>';

            // For Myanmar National Algorithm, they do not want to check for Supervisor Approval
            if ($attributes['algorithm'] != 'myanmarNationalDtsAlgo') {
                if (strtolower($result['responseResult'][0]['supervisor_approval']) == 'yes' && trim($result['responseResult'][0]['participant_supervisor']) != "") {
                    $scoreDoc = $documentationScorePerItem;
                    $img = $imgPass;
                } else {
                    $scoreDoc = 0;
                    $img = $imgFail;
                }

                $docRes .= '<tr>
                <td style="text-align:left;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Supervisor Approval') . '</td>';
                $docRes .= '<td style="text-align:center;"><img style="width:9px;" src="' . $img . '" /></td>
                <td style="text-align:center;">' . $scoreDoc . '</td>';
                $docRes .= '</tr>';
            }

            if ($attributes['algorithm'] == 'malawiNationalDtsAlgo') {
                if (!empty($attributes['condition_pt_samples'])) {
                    $scoreDoc = $documentationScorePerItem;
                    $img = $imgPass;
                } else {
                    $scoreDoc = 0;
                    $img = $imgFail;
                }

                $docRes .= '<tr>
                <td style="text-align:left;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Reporting the Condition of PT Samples') . '</td>';
                $docRes .= '<td style="text-align:center;"><img style="width:9px;" src="' . $img . '" /></td>
                <td style="text-align:center;">' . $scoreDoc . '</td>';
                $docRes .= '</tr>';

                if (!empty($attributes['refridgerator'])) {
                    $scoreDoc = $documentationScorePerItem;
                    $img = $imgPass;
                } else {
                    $scoreDoc = 0;
                    $img = $imgFail;
                }

                $docRes .= '<tr>
                <td style="text-align:left;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Reporting the availability of Refridgerator') . '</td>';
                $docRes .= '<td style="text-align:center;"><img style="width:9px;" src="' . $img . '" /></td>
                <td style="text-align:center;">' . $scoreDoc . '</td>';
                $docRes .= '</tr>';

                if (!empty($attributes['room_temperature'])) {
                    $scoreDoc = $documentationScorePerItem;
                    $img = $imgPass;
                } else {
                    $scoreDoc = 0;
                    $img = $imgFail;
                }

                $docRes .= '<tr>
                <td style="text-align:left;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Reporting the Room Temperature') . '</td>';
                $docRes .= '<td style="text-align:center;"><img style="width:9px;" src="' . $img . '" /></td>
                <td style="text-align:center;">' . $scoreDoc . '</td>';
                $docRes .= '</tr>';


                if (!empty($attributes['stop_watch'])) {
                    $scoreDoc = $documentationScorePerItem;
                    $img = $imgPass;
                } else {
                    $scoreDoc = 0;
                    $img = $imgFail;
                }

                $docRes .= '<tr>
                <td style="text-align:left;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Reporting the availability of Stop Watch') . '</td>';
                $docRes .= '<td style="text-align:center;"><img style="width:9px;" src="' . $img . '" /></td>
                <td style="text-align:center;">' . $scoreDoc . '</td>';
                $docRes .= '</tr>';
            }


            $docRes .= '</table>';
            $pdf->writeHTML($docRes, true, false, true, false, '');

            if (isset($result['responseResult'][0]['failure_reason']) && $result['responseResult'][0]['failure_reason'] != "" && $result['responseResult'][0]['failure_reason'] != "[]" && $result['responseResult'][0]['failure_reason'] != null) {
                $failRes = '<span style="font-weight:bold;font-size:12px;">' . Pt_Commons_TranslateUtility::safeTranslate('Suggested Corrective actions for your response') . ' :</span> <br/>';
                $failRes .= '<table border="1" style="font-size:11px;">';
                $failRes .= '<tr style="background-color:#dbe4ee;"><td style="text-align:center;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Failure Reasons (or) Warnings') . '</td><td style="text-align:center;font-weight:bold;">' . Pt_Commons_TranslateUtility::safeTranslate('Corrective Actions (if any)') . '</td></tr>';
                $warnings = json_decode($result['responseResult'][0]['failure_reason'], true);
                foreach ($warnings as $warning) {
                    $failRes .= '<tr>';
                    $failRes .= '<td> ' . (isset($warning['warning']) ? $warning['warning'] : "") . ' </td>';
                    $failRes .= '<td> ' . (isset($warning['correctiveAction']) ? $warning['correctiveAction'] : "") . ' </td>';
                    $failRes .= '</tr>';
                }
                $failRes .= '</table>';
                $pdf->writeHTML($failRes, true, false, true, false, '');
            }
        }

        $totalScore = $result['shipment_score'] + $result['documentation_score'];
        if ($result['is_excluded'] == 'yes') {
            $wishes = '<p>' . Pt_Commons_TranslateUtility::safeTranslate('Your response was not considered for evaluation') . '</p>';
            $pdf->SetLeftMargin(15);
            $pdf->writeHTML($wishes, true, false, true, false, '');
        } elseif ($schemeType == 'dts' && $result['is_excluded'] != 'yes') {

            if ($totalScore >= $passPercentage && $instance != 'philippines') {
                $wishes = '<p style="font-size:14px;">' . Pt_Commons_TranslateUtility::safeTranslate('Congratulations! You have received a satisfactory score of') . ' ' . round($totalScore, 2) . '%.</p>';
            } elseif ($totalScore == 0 || $totalScore == '') {
                $wishes = '<p style="font-size:14px;">' . Pt_Commons_TranslateUtility::safeTranslate('Your response was not evaluated') . '</p>';
            } else {
                $wishes = '<p style="font-size:14px;">' . Pt_Commons_TranslateUtility::safeTranslate('You have received a score of') . ' ' . round($totalScore, 2) . '%.</p>';
            }

            $pdf->SetLeftMargin(15);

            $pdf->writeHTML($wishes, true, false, true, false, '');
        }

        //if(trim($result['distribution_date'])!=""){
        //    $result['distribution_date']=Pt_Commons_DateUtility::humanReadableDateFormat($result['distribution_date']);
        //}
        if (trim($result['shipment_comment']) != "" || trim($result['evaluationComments']) != "" || trim($result['optional_eval_comment']) != "") {
            $comment = '<br><br><table border="1" style="width:100%;font-size:12px;" cellpadding="3">';

            if (trim($result['evaluationComments']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;width:30%;">' . Pt_Commons_TranslateUtility::safeTranslate('Evaluation Comments') . ' </td>';
                $comment .= '<td style="width:70%;">' . $result['evaluationComments'] . '</td>';
                $comment .= '</tr>';
            }

            if (trim($result['optional_eval_comment']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;width:30%;">' . Pt_Commons_TranslateUtility::safeTranslate('Specific Comments/Feedback') . '</td>';
                $comment .= '<td style="width:70%;">' . $result['optional_eval_comment'] . '</td>';
                $comment .= '</tr>';
            }

            if (trim($result['shipment_comment']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;" colspan="2">' . $result['shipment_comment'] . '</td>';
                $comment .= '</tr>';
            }

            $comment .= '</table>';
            //$pdf->SetTopMargin(13);
            $pdf->writeHTML($comment, true, false, true, false, '');
        }

        $html = '<br/><hr>';

        $pdf->writeHTML($html, true, false, true, false, '');

        if (ob_get_contents()) {
            ob_end_clean();
        }

        //Close and output PDF document
        if (isset($result['last_name']) && trim($result['last_name']) != "") {
            $result['last_name'] = "_" . $result['last_name'];
        }

        $nameParts = [];
        $keys = ['shipment_code', 'unique_identifier', 'region', 'state', 'district', 'city'];

        foreach ($keys as $key) {
            if (!empty($result[$key]) && strtoupper($result[$key]) != 'NULL') {
                $nameParts[] = ($key == 'shipment_code') ? $result[$key] : strtoupper($result[$key]);
            }
        }

        $fileName = implode("-", $nameParts) . "-" . $result['map_id'];
        $fileName = Application_Service_Common::makeFileNameFriendly($fileName) . ".pdf";
        $filePath = $reportsPath . DIRECTORY_SEPARATOR . $result['shipment_code'] . DIRECTORY_SEPARATOR . $fileName;
        $created = $pdf->Output($filePath, "F");

        $shipmentCode = $result['shipment_code'];
        $j++;
    }
}
