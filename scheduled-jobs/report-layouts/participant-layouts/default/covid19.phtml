<?php
require_once 'tcpdf/tcpdf.php';
require_once(CRON_PATH . DIRECTORY_SEPARATOR . 'General.php');
$general = new General();
$schemeType = $resultArray['shipment'][0]['scheme_type'];
// Zend_Debug::dump($resultArray['shipment']);die;
//var_dump($resultArray['shipment'][0]['responseResult'][0]['testType1']);die;
$pdfNew = new Zend_Pdf();
$extractor = new Zend_Pdf_Resource_Extractor();
$font = Zend_Pdf_Font::fontWithName(Zend_Pdf_Font::FONT_HELVETICA);
$shipmentCode = '';
$possibleCovid19Results = $schemeService->getPossibleResults('covid19');
$covid19Results = array();
foreach ($possibleCovid19Results as $pr) {
    $covid19Results[$pr['id']] = ucfirst(strtolower($pr['response']));
}


if (sizeof($resultArray['shipment']) > 0) {
    if (!file_exists(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports') && !is_dir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports')) {
        mkdir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports');
    }
    $totalPages = count($resultArray['shipment']);
    $j = 1;
    //$resultArray['dmResult'];

    foreach ($resultArray['shipment'] as $result) {
        // Zend_Debug::dump($result);die;
        $geneIdentifiedTypes = $schemeService->getAllCovid19IdentifiedGeneTypeResponseWise($result['map_id']);

        $geneDetails = array();
        foreach($geneIdentifiedTypes as $gene){
            $geneDetails[$gene['sample_id']][] = $allGeneTypes[$gene['gene_id']]." = ".$gene['ct_value'];
        }

        
        if ( /*(isset($result['responseResult'][0]['is_excluded']) && $result['responseResult'][0]['is_excluded'] == 'yes') || */
            (isset($result['responseResult'][0]['is_pt_test_not_performed']) && $result['responseResult'][0]['is_pt_test_not_performed'] == 'yes')
        ) {
            continue;
        }

        //Zend_Debug::dump($result['responseResult'][0]);die;

        if (!file_exists(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $result['shipment_code']) && !is_dir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $result['shipment_code'])) {
            mkdir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $result['shipment_code']);
        }
        //error_log($i);
        // Extend the TCPDF class to create custom Header and Footer

        // create new PDF document
        $pdf = new IndividualPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);

        $pdf->setSchemeName($header, $result['scheme_name'], $logo, $logoRight, $resultStatus, $schemeType, $layout, $evalRow['date_finalised'],"",$trainingInstanceText);
        // set document information
        //$pdf->SetCreator(PDF_CREATOR);
        //$pdf->SetAuthor('ePT');
        //$pdf->SetTitle('DEPARTMENT OF HEALTH AND HUMAN SERVICES');
        //
        //

        // set default header data
        $pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);

        // set header and footer fonts
        $pdf->setHeaderFont(array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
        $pdf->setFooterFont(array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);

        // set margins

        $pdf->SetMargins(PDF_MARGIN_LEFT, 50, PDF_MARGIN_RIGHT);
        $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

        // set auto page breaks
        $pdf->SetAutoPageBreak(true, PDF_MARGIN_BOTTOM);

        // set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

        // set some language-dependent strings (optional)
        if (@file_exists(dirname(__FILE__) . '/lang/eng.php')) {
            require_once dirname(__FILE__) . '/lang/eng.php';
            $pdf->setLanguageArray($l);
        }

        // ---------------------------------------------------------

        // set font
        $pdf->SetFont('helvetica', '', 11);

        // add a page
        $pdf->AddPage();
        // ---------------------------------------------------------

        if (trim($result['shipment_date']) != "") {
            $result['shipment_date'] = $general->humanDateFormat($result['shipment_date']);
        }
        if (trim($result['lastdate_response']) != "") {
            $result['lastdate_response'] = $general->humanDateFormat($result['lastdate_response']);
        }

        $config = new Zend_Config_Ini(APPLICATION_PATH . DIRECTORY_SEPARATOR . "configs" . DIRECTORY_SEPARATOR . "config.ini", APPLICATION_ENV);
        $responseDate = "";
        $shipmentTestDate = "";
        $shipmentScore = 0;
        $documentationScore = 0;
        $score = 0;
        $testThreeOptionalDisplay = "";
        $testTwoDisplay = "";
        
        if (isset($config->evaluation->covid19->covid19MaximumTestAllowed) && ($config->evaluation->covid19->covid19MaximumTestAllowed == '1' || $config->evaluation->covid19->covid19MaximumTestAllowed == '2')) {
            $testThreeOptionalDisplay = "display:none;";
        }
        
        if (isset($config->evaluation->covid19->covid19MaximumTestAllowed) && $config->evaluation->covid19->covid19MaximumTestAllowed != '3' && $config->evaluation->covid19->covid19MaximumTestAllowed != '2') {
            $testTwoDisplay = "display:none;";
        }
        
        /* for Shipment attributes functionality start */
        $shipmentAttributes = json_decode($result['shipment_attributes'], true);
       
        /* for Shipment attributes functionality end */
        if (isset($result['responseResult'][0]['responseDate']) && trim($result['responseResult'][0]['responseDate']) != "") {
            $splitDate = explode(" ", $result['responseResult'][0]['responseDate']);
            $responseDate = $general->humanDateFormat($splitDate[0]);
        }
        $attributes = '';
        if (isset($result['attributes'])) {
            $attributes = json_decode($result['attributes'], true);
        }

        $sampleRehydrationDate = "";
        if (isset($attributes['sample_rehydration_date']) && trim($attributes['sample_rehydration_date']) != "") {
            $sampleRehydrationDate = $general->humanDateFormat($attributes['sample_rehydration_date']);
        }
        $shipmentReceiptDate = "";
        if (isset($result['responseResult'][0]['shipment_receipt_date']) && trim($result['responseResult'][0]['shipment_receipt_date']) != "") {
            $shipmentReceiptDate = $general->humanDateFormat($result['responseResult'][0]['shipment_receipt_date']);
        }

        if (isset($result['responseResult'][0]['shipment_test_date']) && trim($result['responseResult'][0]['shipment_test_date']) != "") {
            $shipmentTestDate = $general->humanDateFormat($result['responseResult'][0]['shipment_test_date']);
        }

        //Comment Details
        $labInfo = '<table cellpadding="3" style="font-size:11px;">';

        $labInfo .= '<tr>';
        $labInfo .= '	<td><strong>Participant Code</strong><br>' . $result['unique_identifier'] . '</td>';
        $labInfo .= '	<td><strong>Performing Participant</strong><br>' . $result['first_name'] . " " . $result['last_name'] . '</td>';
        $labInfo .= '	<td><strong>PT Panel Name and Date</strong><br>' . $result['distribution_code'] . '(' . $result['shipment_date'] . ')</td>';
        $labInfo .= '</tr>';

        $labInfo .= '<tr>';
        $labInfo .= '	<td><strong>Shipment Date</strong><br>' . $result['shipment_date'] . '</td>';
        $labInfo .= '	<td><strong>Shipment Code</strong><br>' . $result['shipment_code'] . '</td>';
        $labInfo .= '	<td><strong>Shipment Type</strong><br>' . $result['scheme_name'] . '</td>';
        $labInfo .= '</tr>';

        $labInfo .= '<tr>';
        $labInfo .= '	<td><strong>Panel Receipt Date</strong><br>' . $shipmentReceiptDate . '</td>';
        $labInfo .= '	<td><strong>Rehydration Date</strong><br>' . $sampleRehydrationDate . '</td>';

        $labInfo .= '	<td><strong>Result Due Date</strong><br>' . $result['lastdate_response'] . '</td>';
        $labInfo .= '</tr>';

        $labInfo .= '<tr>';
        $labInfo .= '	<td><strong>Response Date</strong><br>' . $responseDate . '</td>';
        $labInfo .= '	<td><strong>Shipment Test Date</strong><br>' . $shipmentTestDate . '</td>';
        $labInfo .= '	<td><strong>Specimen Volume</strong><br>' . $result['specimen_volume'] . '</td>';
        $labInfo .= '	<td>';
        
        $labInfo .= ' </td>';
        $labInfo .= '</tr>';
        $labInfo .= '<tr>';
        $labInfo .= '	<td>';
        $labInfo .= '	<strong>Supervisor Name</strong><br>' . ($result['participant_supervisor']);
        $labInfo .= ' </td>';
        $labInfo .= '	<td>';
        if (isset($haveCustom) && $haveCustom == 'yes') {
            $labInfo .= '	<strong>' . $customField1 . '</strong> <br>' . $totParticipantsRes['custom_field_1'];
        }
        $labInfo .= ' </td>';
        $labInfo .= '	<td>';
        if (isset($haveCustom) && $haveCustom == 'yes') {
            $labInfo .= '	<strong>' . $customField2 . '</strong> <br>' . $totParticipantsRes['custom_field_2'];
        }
        $labInfo .= ' </td>';
        $labInfo .= '</tr>';

        $labInfo .= '</table>';
        //shipment_test_date
        $pdf->writeHTML($labInfo, true, false, true, false, '');


        if (sizeof($result['responseResult']) > 0) {

            $labRes = '<span style="font-weight: bold;font-size:12px;">Your HIV Proficiency results : <br/></span><table border="1" style="font-size:12px;">';
            $labRes .= '<tr style="background-color:#dbe4ee;">
                            <td></td>';
                            if ($testTwoDisplay == "" && $testThreeOptionalDisplay == "") {
                                $labRes .= '<th style="text-align:center;font-weight:bold;">Test</th>';
                            } else{
                                $labRes .= '<th style="text-align:center;font-weight:bold;">Test-1</th>';
                            }
                            if ($testTwoDisplay != "") {
                                $labRes .= '<th style="text-align:center;font-weight:bold;' . $testTwoDisplay . '">Test-2</th>';
                            }
                            if ($testThreeOptionalDisplay != "") {
                                $labRes .= '<th style="text-align:center;font-weight:bold;' . $testThreeOptionalDisplay . '">Test-3</th>';
                            }
                            $labRes .= '<th colspan="5" style="border:none;"></th>
                        </tr>';
            $labRes .= '<tr>
                            <td style="text-align:center;font-weight:bold;background-color:#dbe4ee;">Test Type</td>
                            <td>' . $result['responseResult'][0]['testType1'] . '</td>';
                            if ($testTwoDisplay != "") {
                                $labRes .= '<td style="' . $testTwoDisplay . '">' . $result['responseResult'][0]['testType2'] . '</td>';
                            }
                            if ($testThreeOptionalDisplay != "") {
                                $labRes .= '<td style="' . $testThreeOptionalDisplay . '">' . $result['responseResult'][0]['testType3'] . '</td>';
                            }
                            $labRes .= '<td colspan="5"></td>
                                            </tr>';
                            $labRes .= '<tr>
                                                <td style="text-align:center;font-weight:bold;background-color:#dbe4ee;">Lot No.</td>
                                                <td>' . $result['responseResult'][0]['lot_no_1'] . '</td>';
                            if ($testTwoDisplay != "") {
                                $labRes .= '<td style="' . $testTwoDisplay . '">' . $result['responseResult'][0]['lot_no_2'] . '</td>';
                            }
                            if ($testThreeOptionalDisplay != "") {
                                $labRes .= '<td style="' . $testThreeOptionalDisplay . '">' . $result['responseResult'][0]['lot_no_3'] . '</td>';
                            }
                            $labRes .= '<td colspan="5"></td>
                        </tr>';
            $labRes .= '<tr>
                            <td style="text-align:center;font-weight:bold;background-color:#dbe4ee;">Expiry Date</td>
                            <td>' . $general->humanDateFormat($result['responseResult'][0]['exp_date_1']) . '</td>';
                            if ($testTwoDisplay != "") {
                                $labRes .= '<td style="' . $testTwoDisplay . '">' . $general->humanDateFormat($result['responseResult'][0]['exp_date_2']) . '</td>';
                            }
                            if ($testThreeOptionalDisplay != "") {
                                $labRes .= '<td style="' . $testThreeOptionalDisplay . '">' . $general->humanDateFormat($result['responseResult'][0]['exp_date_3']) . '</td>';
                            }
                            $labRes .= '<td colspan="5"></td>
                        </tr>';
            $labRes .= '<tr style="background-color:#dbe4ee;">
                            <th style="text-align:center;font-weight:bold;">Specimen Panel ID </th>';
                            if ($testTwoDisplay == "" && $testThreeOptionalDisplay == "") {
                                $labRes .= '<th style="text-align:center;font-weight:bold;">Result</th>';
                            } else{
                                $labRes .= '<th style="text-align:center;font-weight:bold;">Result-1</th>';
                            }
                            if ($testTwoDisplay != "") {
                                $labRes .= '<th style="text-align:center;font-weight:bold;' . $testTwoDisplay . '">Result-2</th>';
                            }
                            if ($testThreeOptionalDisplay != "") {
                                $labRes .= '<th style="text-align:center;font-weight:bold;' . $testThreeOptionalDisplay . '">Result-3</th>';
                            }
                            $labRes .= '<th style="text-align:center;font-weight:bold;">Expected Final Interpretation</th>
                            <th style="text-align:center;font-weight:bold;">Your Final Interpretation</th>
                            <th style="text-align:center;font-weight:bold;" colspan="2">Score</th>
                            <th style="text-align:center;font-weight:bold;">Gene Types</th>
                        </tr>';

            $nonMandatorySamples = array();
            $controlSamples = array();
            $correctSamples = array();
            $totalProperSamples = 0;
            $correctSamplesCount = 0;
            $wrongSamples = array();
            $otherSamples = array();
            $allSamples = array();

            foreach ($result['responseResult'] as $response) {
                $allSamples[] = $response['sample_label'];
                if ($response['control'] == 1) {
                    $controlSamples[] = $response['sample_label'];
                }

                if ($response['mandatory'] == 0) {
                    $nonMandatorySamples[] = $response['sample_label'];
                } else if ($response['calculated_score'] == 'Pass') {
                    $correctSamples[] = $response['sample_label'];
                } else if ($response['calculated_score'] == 'Fail') {
                    $wrongSamples[] = $response['sample_label'];
                } else {
                    $otherSamples[] = $response['sample_label'];
                }
            }

            $correctSamplesCount = count($correctSamples);
            $totalProperSamples = $correctSamplesCount + count($wrongSamples);
            $maxDocumentationPoints = (isset($config->evaluation->covid19->documentationScore) && $config->evaluation->covid19->documentationScore > 0) ? ($config->evaluation->covid19->documentationScore) : 0;
            $maximumResponseScore = 100 - $maxDocumentationPoints;
            $scorePerCorrectSample = round($maximumResponseScore / (count($allSamples) - count($nonMandatorySamples) - count($controlSamples)), 2);

            foreach ($result['responseResult'] as $response) {

                // echo (var_export($geneDetails, true));
                // echo (var_export($geneDetails[$response['sample_id']], true));

                if ($response['calculated_score'] == 'Pass') {
                    $img = UPLOAD_PATH . '/../images/check.jpg';

                    $score = ($response['control'] == 0) ? $scorePerCorrectSample : "N.A.";
                } else if ($response['calculated_score'] == 'Fail') {
                    $img = UPLOAD_PATH . '/../images/cross.jpg';
                    $score = ($response['control'] == 0) ? 0 : "N.A.";
                } else {
                    $img = UPLOAD_PATH . '/../images/minus.jpg';
                    $score = "N.A.";
                }
                $labRes .= '<tr>
							<td style="text-align:center;">' . $response['sample_label'] . '</td>
							<td>' . (isset($response['test_result_1']) && $response['test_result_1'] != "" ? $covid19Results[$response['test_result_1']] : "") . '</td>';
                if ($testTwoDisplay != "") {
                    $labRes .= '<td style="' . $testTwoDisplay . '">' . (isset($response['test_result_2']) && $response['test_result_2'] != "" ? $covid19Results[$response['test_result_2']] : "") . '</td>';
                }
                if ($testThreeOptionalDisplay != "") {
                    $labRes .= '<td style="' . $testThreeOptionalDisplay . '">' . (isset($response['test_result_3']) && $response['test_result_3'] != "" ? $covid19Results[$response['test_result_3']] : "") . '</td>';
                }
                $labRes .= '<td>' . ucfirst(strtolower($response['referenceResult'])) . '</td>
                            <td>' . ucfirst(strtolower($response['labResult'])) . '</td>
                            <td style="text-align:center;"><img style="width:10px;" src="' . $img . '" /></td>
							<td style="text-align:center;">' . $score . '</td>
							<td style="text-align:center;">'.(!empty($geneDetails[$response['sample_id']]) ? implode(", ", $geneDetails[$response['sample_id']]) : '').'</td>
						  </tr>';
            }
            $labRes .= '</table>';
            $pdf->SetLeftMargin(15);
            $pdf->writeHTML($labRes, true, false, true, false, '');

            if (count($nonMandatorySamples) > 0) {

                $nmsTable = "The following samples have been excluded from this evaluation : " . implode(", ", $nonMandatorySamples);
                $nmsTable .= "<br/>";
                $pdf->writeHTML($nmsTable, true, false, true, false, '');
            }

            if (isset($result['responseResult'][0]['failure_reason']) && $result['responseResult'][0]['failure_reason'] != "" && $result['responseResult'][0]['failure_reason'] != "[]" && $result['responseResult'][0]['failure_reason'] != null) {
                $failRes = '<span style="font-weight:bold;font-size:12px;">Suggested Corrective actions for your response :</span> <br/>';
                $failRes .= '<table border="1" style="font-size:11px;">';
                $failRes .= '<tr style="background-color:#dbe4ee;"><td style="text-align:center;font-weight:bold;">Failure Reasons (or) Warnings</td><td style="text-align:center;font-weight:bold;">Corrective Actions (if any)</td></tr>';
                $warnings = json_decode($result['responseResult'][0]['failure_reason'], true);
                foreach ($warnings as $warning) {
                    $failRes .= '<tr>';
                    $failRes .= '<td> ' . (isset($warning['warning']) ? $warning['warning'] : "") . ' </td>';
                    $failRes .= '<td> ' . (isset($warning['correctiveAction']) ? $warning['correctiveAction'] : "") . ' </td>';
                    $failRes .= '</tr>';
                }
                $failRes .= '</table>';
                $pdf->writeHTML($failRes, true, false, true, false, '');
            }
        }

        $totalScore = $result['shipment_score'] + $result['documentation_score'];
        if ($result['is_excluded'] == 'yes') {
            $wishes = '<p>Your response was not considered for evaluation</p>';
            $pdf->SetLeftMargin(15);
            $pdf->writeHTML($wishes, true, false, true, false, '');
        } else if ($schemeType == 'covid19' && $result['is_excluded'] != 'yes') {

            if ($totalScore >= $passPercentage) {
                $wishes = '<p style="font-size:12px;">Congratulations! You have received a satisfactory score of ' . round($totalScore, 2) . '%.</p>';
            } else {
                $wishes = '<p style="font-size:12px;">You have received a score of ' . round($totalScore, 2) . '%.</p>';
            }

            $pdf->SetLeftMargin(15);

            $pdf->writeHTML($wishes, true, false, true, false, '');
        }
        // Zend_Debug::dump("came");die;
        if (trim($result['shipment_comment']) != "" || trim($result['evaluationComments']) != "" || trim($result['optional_eval_comment']) != "") {
            $comment = '<br><br><table border="1" style="width:100%;font-size:12px;" cellpadding="3">';

            if (trim($result['evaluationComments']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;width:30%;">Evaluation Comments </td>';
                $comment .= '<td style="width:70%;">' . $result['evaluationComments'] . '</td>';
                $comment .= '</tr>';
            }

            if (trim($result['optional_eval_comment']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;width:30%;">Specific Comments/Feedback</td>';
                $comment .= '<td style="width:70%;">' . $result['optional_eval_comment'] . '</td>';
                $comment .= '</tr>';
            }

            if (trim($result['shipment_comment']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;" colspan="2">' . $result['shipment_comment'] . '</td>';
                $comment .= '</tr>';
            }

            $comment .= '</table>';
            $pdf->writeHTML($comment, true, false, true, false, '');
        }

        $html = '<p style="font-size:12px;">Thank you for participating in the ' . ($result['scheme_name']) . ' Proficiency Testing Program.</p>';


        $pdf->writeHTML($html, true, false, true, false, '');

        if (ob_get_contents()) {
            ob_end_clean();
        }

        //Close and output PDF document
        if (isset($result['last_name']) && trim($result['last_name']) != "") {
            $result['last_name'] = "_" . $result['last_name'];
        }
        $fileName = $result['shipment_code'] . "-" . $result['map_id'] . ".pdf";
        $fileName = preg_replace('/[^A-Za-z0-9.]/', '-', $fileName);
        $fileName = str_replace(" ", "-", $fileName);
        $filePath = DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $result['shipment_code'] . DIRECTORY_SEPARATOR . $fileName;
        $created = $pdf->Output($filePath, "F");
        if($trainingInstance == "yes"){
            //Watermark section
            $pdf= new PDF_Rotate();
        }

        $loadpdf = Zend_Pdf::load($filePath);

        foreach ($loadpdf->pages as $page) {
            $pdfExtract = $extractor->clonePage($page);
            //$pdfExtract->setFont($font, 8) ->drawText('Page '.$j.' / '.$totalPages, 280, 50);
            $pdfNew->pages[] = $pdfExtract;
        }
        $shipmentCode = $result['shipment_code'];
        $j++;
    }

    //============================================================+
    // END OF FILE
    //============================================================+
}
