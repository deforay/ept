<?php

require_once(CRON_PATH . DIRECTORY_SEPARATOR . 'Common.php');
$general = new Common();
$schemeType = $resultArray['shipment'][0]['scheme_type'];
// Zend_Debug::dump($resultArray);die;
$pdfNew = new Zend_Pdf();
$extractor = new Zend_Pdf_Resource_Extractor();
$font = Zend_Pdf_Font::fontWithName(Zend_Pdf_Font::FONT_HELVETICA);
$shipmentCode = '';

$config = new Zend_Config_Ini(APPLICATION_PATH . DIRECTORY_SEPARATOR . "configs" . DIRECTORY_SEPARATOR . "config.ini", APPLICATION_ENV);
if (sizeof($resultArray['shipment']) > 0) {
    if (!file_exists(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports') && !is_dir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports')) {
        mkdir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports');
    }
    $totalPages = count($resultArray['shipment']);
    $j = 1;
    //$resultArray['dmResult'];
    // Zend_Debug::dump($resultArray['shipment']);die;

    foreach ($resultArray['shipment'] as $result) {
        $shipmentAttributes = json_decode($result['shipment_attributes'], true);

        if (!file_exists(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $result['shipment_code']) && !is_dir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $result['shipment_code'])) {
            mkdir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $result['shipment_code']);
        }
        //error_log($i);
        // Extend the TCPDF class to create custom Header and Footer

        // create new PDF document
        $pdf = new IndividualPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $panelName = (isset($shipmentAttributes['panelName']) && !empty($shipmentAttributes['panelName'])) ? $shipmentAttributes['panelName'] : $result['shipment_code'];
        $pdf->setSchemeName($header, $panelName, $logo, $logoRight, $resultStatus, $schemeType, $layout, $evalRow['date_finalised'], $config, $trainingInstanceText, "", $instituteAddressPosition, $resultArray['shipment'][0]['issuing_authority']);


        // set default header data
        $pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);

        // set header and footer fonts
        $pdf->setHeaderFont(array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
        $pdf->setFooterFont(array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);
        // set margins
        if ($layout == 'zimbabwe') {
            $pdf->SetMargins(PDF_MARGIN_LEFT, 55, PDF_MARGIN_RIGHT);
        } else {
            $pdf->SetMargins(PDF_MARGIN_LEFT, 25, PDF_MARGIN_RIGHT);
        }
        $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

        // set auto page breaks
        $pdf->SetAutoPageBreak(true, PDF_MARGIN_BOTTOM);

        // set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

        // set some language-dependent strings (optional)
        if (@file_exists(dirname(__FILE__) . '/lang/eng.php')) {
            require_once dirname(__FILE__) . '/lang/eng.php';
            $pdf->setLanguageArray($l);
        }

        // ---------------------------------------------------------

        // set font
        $pdf->SetFont('freesans', '', 11);

        // add a page
        $pdf->AddPage();


        // ---------------------------------------------------------

        if (trim($result['shipment_date']) != "") {
            $result['shipment_date'] = Pt_Commons_General::humanReadableDateFormat($result['shipment_date']);
        }
        if (trim($result['lastdate_response']) != "") {
            $result['lastdate_response'] = Pt_Commons_General::humanReadableDateFormat($result['lastdate_response']);
        }

        $responseDate = "";
        $shipmentTestDate = "";
        $shipmentTestReportDate = "";
        $shipmentScore = 0;
        $documentationScore = 0;
        $score = 0;

        if (isset($result['responseResult'][0]['responseDate']) && trim($result['responseResult'][0]['responseDate']) != "") {
            $responseDate = Pt_Commons_General::humanReadableDateFormat($result['responseResult'][0]['responseDate']);
        }
        $attributes = '';
        if (isset($result['attributes'])) {
            $attributes = json_decode($result['attributes'], true);
        }

        $shipmentReceiptDate = "";
        if (isset($result['responseResult'][0]['shipment_receipt_date']) && trim($result['responseResult'][0]['shipment_receipt_date']) != "") {
            $shipmentReceiptDate = Pt_Commons_General::humanReadableDateFormat($result['responseResult'][0]['shipment_receipt_date']);
        }

        if (isset($result['responseResult'][0]['shipment_test_date']) && trim($result['responseResult'][0]['shipment_test_date']) != "") {
            $shipmentTestDate = Pt_Commons_General::humanReadableDateFormat($result['responseResult'][0]['shipment_test_date']);
        }

        if (isset($result['responseResult'][0]['responseDate']) && trim($result['responseResult'][0]['responseDate']) != "") {
            $shipmentTestReportDate = Pt_Commons_General::humanReadableDateFormat($result['responseResult'][0]['responseDate']);
        }
        if ($layout == 'zimbabwe') {
            $htmlTitle = '<span style="font-weight: bold;text-align:center;font-size:10;">Individual Participant Results Report</span><br>';
            $pdf->writeHTML($htmlTitle, true, false, true, false, '');
        }
        $htmlTitle = '<span style="font-weight: bold;text-align:center;font-size:12;">' . ucwords($panelName) . '</span><br>';
        $pdf->writeHTML($htmlTitle, true, false, true, false, '');

        $labInfo = '<table cellpadding="4" style="font-size:12px;width:100%;">';
        $labInfo .= '<tr style="background-color:#595959;color:#FFFFFF;">';
        $labInfo .= '	<td style="text-align:center;"><strong>Country </strong></td>';
        $labInfo .= '	<td style="text-align:center;"><strong>Testing Site </strong></td>';
        $labInfo .= '	<td style="text-align:center;"><strong>PT-ID Number </strong></td>';
        $labInfo .= '	<td style="text-align:center;"><strong>Page Number </strong></td>';
        $labInfo .= '</tr>';
        $labInfo .= '<tr>';
        $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['iso_name'] . '</td>';
        $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['first_name'] . ' ' . $result['last_name'] . '</td>';
        $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['unique_identifier'] . '</td>';
        $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">1/3</td>';
        $labInfo .= '</tr>';
        $labInfo .= '</table>';
        $labInfo .= '<br><br><br>';


        $labInfo .= '<table cellpadding="4" style="font-size:12px;width:100%;">';
        $labInfo .= '<tr style="background-color:#595959;color:#FFFFFF;">';
        if(!isset($result['assayShortName']) || $result['assayShortName'] != 'microscopy'){
            $labInfo .= '	<td style="text-align:center;"><strong>Instrument Serial number </strong></td>';
            $labInfo .= '	<td style="text-align:center;"><strong>Last Calibration Date </strong></td>';
            $labInfo .= '	<td style="text-align:center;"><strong>Result Submission Date </strong></td>';
        }else{
            $labInfo .= '	<td style="text-align:center;"><strong>Result Submission Date </strong></td>';
            $labInfo .= '<td style="text-align:center;"></td>
                        <td style="text-align:center;"></td>';
        }
        $labInfo .= '</tr>';

        $labInfo .= '<tr>';
        if(!isset($result['assayShortName']) || $result['assayShortName'] != 'microscopy'){
            $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $attributes['instrument_sn'] . '</td>';
            $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $attributes['date_of_xpert_instrument_calibration'] . '</td>';
            $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['lastdate_response'] . '</td>';
        }else{
            $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['lastdate_response'] . '</td>';
            $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;"></td>';
            $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;"></td>';
        }
        $labInfo .= '</tr>';
        $labInfo .= '</table>';
        $pdf->writeHTML($labInfo, true, false, true, false, '');

        if (!isset($result['is_pt_test_not_performed']) || empty($result['is_pt_test_not_performed']) || $result['is_pt_test_not_performed'] != "yes") {

            if (!empty($result['responseResult'])) {
                $colspan = "2";
                if ($result['responseResult'][0]['drug_resistance_test'] != "yes") {
                    $colspan = "1";
                }
                $labRes = '<span style="font-weight: bold;font-size:13px;">Your laboratory test results : <br/></span>';
                $labRes .= '<table style="font-size:11px;" border="1" cellpadding="3" style="width:100%;border-color: #b7dde7;">';
                $labRes .= '<tr style="background-color:#b7dde7;width:100%;">';
                $labRes .= '<td style="text-align:center;font-weight:bold;"></td>';
                $labRes .= '<td style="text-align:center;font-weight:bold;" colspan="' . $colspan . '">Expected Results</td>';
                $labRes .= '<td style="text-align:center;font-weight:bold;" colspan="' . $colspan . '">Your Results</td>';
                $labRes .= '<td style="text-align:center;font-weight:bold;"></td>';
                $labRes .= '</tr>';
                $labRes .= '<tr style="background-color:#b7dde7;">';
                $labRes .= '<td style="text-align:center;font-weight:bold;">Sample ID</td>';
                $labRes .= '<td style="text-align:center;font-weight:bold;">MTB Detected</td>';
                if ($result['responseResult'][0]['drug_resistance_test'] == "yes") {
                    $labRes .= '<td style="text-align:center;font-weight:bold;">RIF Resistance</td>';
                }
                $labRes .= '<td style="text-align:center;font-weight:bold;">MTB Detected</td>';
                if ($result['responseResult'][0]['drug_resistance_test'] == "yes") {
                    $labRes .= '<td style="text-align:center;font-weight:bold;">RIF Resistance</td>';
                }
                $labRes .= '<td style="text-align:center;font-weight:bold;">Score</td>';
                $labRes .= '</tr>';
                //Sample codes
                $testerName = '';
                foreach ($result['responseResult'] as $response) {
                    $labRes .= '<tr>';
                    $labRes .= '<td style="text-align:center;font-weight:bold;border-bottom:solid 2px #b7dde7;">' . $response['sample_label'] . '</td>';
                    $labRes .= '<td style="text-align:center;border-bottom:solid 2px #b7dde7;">' . ucwords(str_replace("-", " ", $response['refMtbDetected'])) . '</td>';
                    if ($response['drug_resistance_test'] == "yes") {
                        $labRes .= '<td style="text-align:center;border-bottom:solid 2px #b7dde7;">' . ucwords(str_replace("-", " ", $response['refRifResistance'])) . '</td>';
                    }
                    $labRes .= '<td style="text-align:center;border-bottom:solid 2px #b7dde7;">' . ucwords(str_replace("-", " ", $response['mtb_detected'])) . '</td>';
                    if ($response['drug_resistance_test'] == "yes") {
                        $labRes .= '<td style="text-align:center;border-bottom:solid 2px #b7dde7;">' . ucwords(str_replace("-", " ", $response['rif_resistance'])) . '</td>';
                    }
                    $labRes .= '<td style="text-align:center;border-bottom:solid 2px #b7dde7;">' . $response['calculated_score'] . '</td>';
                    $labRes .= '</tr>';
                    if (empty($testerName)) {
                        $testerName = $response['tester_name'] ?? null;
                    }
                }
                if (empty($testerName)) {
                    $testerName = $result['first_name'] . ' ' . $result['last_name'];
                }

                $labRes .= '</table>';

                $pdf->SetLeftMargin(15);
                $pdf->writeHTML($labRes, true, false, true, false, '');
            }

            $finalScore = (isset($result['final_result']) && !empty($result['final_result']) && $result['final_result'] == 1) ? 'Satisfactory' : 'Unsatisfactory';

            $finalInfo = '<table cellpadding="4" style="font-size:12px;width:100%;border: 1px soild gray;">';
            $finalInfo .= '<tr style="text-align:center;">';
            $finalInfo .= '	<th style="border: 1px soild gray;"></th>';
            $finalInfo .= '	<td style="border: 1px soild gray;"><strong>Percentage</strong></td>';
            $finalInfo .= '	<td style="border: 1px soild gray;"><strong>Satisfactory/Unsatisfactory</strong></td>';
            $finalInfo .= '</tr>';

            $finalInfo .= '<tr style="background-color:#b7dde7;border: 1px soild gray;">';
            $finalInfo .= '	<td style="border: 1px soild gray;"><strong>FINAL SCORE</strong></td>';
            $finalInfo .= '	<td style="text-align:center;border: 1px soild gray;">' . ($result['shipment_score'] + $result['documentation_score']) . '%</td>';
            $finalInfo .= '	<td style="text-align:center;border: 1px soild gray;">' . $finalScore . '</td>';
            $finalInfo .= '</tr>';
            $finalInfo .= '</table>';

            $pdf->writeHTML($finalInfo, true, false, true, false, '');
        }
        // add a page
        $pdf->AddPage();
        $htmlTitle = '<span style="font-weight: bold;text-align:center;font-size:12;">' . ucwords($panelName) . '</span><br>';
        $pdf->writeHTML($htmlTitle, true, false, true, false, '');

        $htmlSubTitle = '<table cellpadding="4" style="font-size:12px;width:100%;">';
        $htmlSubTitle .= '<tr style="background-color:#595959;width:100%;color:#FFFFFF;">';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>Country </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>Testing Site </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>PT-ID Number </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>Page Number </strong></td>';
        $htmlSubTitle .= '</tr>';
        $htmlSubTitle .= '<tr>';
        $htmlSubTitle .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['iso_name'] . '</td>';
        $htmlSubTitle .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['first_name'] . ' ' . $result['last_name'] . '</td>';
        $htmlSubTitle .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['unique_identifier'] . '</td>';
        $htmlSubTitle .= '	<td style="text-align:center;border-bottom:solid 2px;">2/3</td>';
        $htmlSubTitle .= '</tr>';
        $htmlSubTitle .= '</table>';

        $pdf->writeHTML($htmlSubTitle, true, false, true, false, '');

        if (trim($result['shipment_comment']) != "" || trim($result['evaluationComments']) != "" || trim($result['optional_eval_comment']) != "") {
            $comment = '<br><br><table border="1" style="width:100%;font-size:12px;" cellpadding="3">';

            if (trim($result['evaluationComments']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;width:30%;">Evaluation Comments </td>';
                $comment .= '<td style="width:70%;">' . $result['evaluationComments'] . '</td>';
                $comment .= '</tr>';
            }

            if (trim($result['optional_eval_comment']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;width:30%;">Specific Comments/Feedback</td>';
                $comment .= '<td style="width:70%;">' . $result['optional_eval_comment'] . '</td>';
                $comment .= '</tr>';
            }

            if (trim($result['shipment_comment']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;" colspan="2">' . $result['shipment_comment'] . '</td>';
                $comment .= '</tr>';
            }

            $comment .= '</table>';
            //$pdf->SetTopMargin(13);
            $pdf->writeHTML($comment, true, false, true, false, '');
        }

        if (isset($result['ntr_reason']) && !empty($result['ntr_reason'])) {
            $notTestedInfo = '<table cellpadding="4" style="font-size:12px;width:100%;">';
            $notTestedInfo .= '<tr>';
            $notTestedInfo .= '	<td colspan="2" style="color:red;">Xpert testing site was unable to participate in ' . $panelName . ' due to following reason(s)</td>';
            $notTestedInfo .= '</tr>';

            $notTestedInfo .= '<tr>';
            $notTestedInfo .= '	<td style="width:25%;"><strong>Reason for not testing</strong></td>';
            $notTestedInfo .= '	<td style="width:75%;">' . (isset($result['ntr_reason']) && !empty($result['ntr_reason'])) ? $result['ntr_reason'] : '' . '</td>';
            $notTestedInfo .= '</tr>';
            $notTestedInfo .= '<tr>';
            $notTestedInfo .= '	<td style="width:25%;"><strong>Not testing comments</strong></td>';
            $notTestedInfo .= '	<td style="width:75%;">' . (isset($result['pt_test_not_performed_comments']) && !empty($result['pt_test_not_performed_comments'])) ? $result['pt_test_not_performed_comments'] : '' . '</td>';
            $notTestedInfo .= '</tr>';
            $notTestedInfo .= '</table>';

            $pdf->writeHTML($notTestedInfo, true, false, true, false, '');
        }

        if (isset($result['previous_six_shipments']) && !empty($result['previous_six_shipments'])) {

            $longitudinalPerformanceSvg = '<?xml version="1.0" encoding="UTF-8"?>';
            $longitudinalPerformanceSvg .= '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 160">';
            $longitudinalPerformanceSvg .= '    <rect width="400" height="150" x="0" y="0" stroke="#E4E4E4" stroke-width="1" fill="white" />';
            $longitudinalPerformanceSvg .= '    <text x="200" y="12" dominant-baseline="middle" text-anchor="middle" style="fill:#666666;font-family:helvetica;font-size:8pt">' . htmlspecialchars($result['lab_name'] ?? '', ENT_XML1) . ' Performance Over Time</text>';
            $longitudinalPerformanceSvg .= '    <text x="15" y="22" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">100</text>';
            $longitudinalPerformanceSvg .= '    <line x1="30" x2="390" y1="20" y2="20" stroke="#E4E4E4" stroke-width="1" />';
            $longitudinalPerformanceSvg .= '    <text x="15" y="42" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">80</text>';
            $longitudinalPerformanceSvg .= '    <line x1="30" x2="390" y1="40" y2="40" stroke="#E4E4E4" stroke-width="1" />';
            $longitudinalPerformanceSvg .= '    <text x="15" y="62" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">60</text>';
            $longitudinalPerformanceSvg .= '    <line x1="30" x2="390" y1="60" y2="60" stroke="#E4E4E4" stroke-width="1" />';
            $longitudinalPerformanceSvg .= '    <text x="15" y="82" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">40</text>';
            $longitudinalPerformanceSvg .= '    <line x1="30" x2="390" y1="80" y2="80" stroke="#E4E4E4" stroke-width="1" />';
            $longitudinalPerformanceSvg .= '    <text x="15" y="102" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">20</text>';
            $longitudinalPerformanceSvg .= '    <line x1="30" x2="390" y1="100" y2="100" stroke="#E4E4E4" stroke-width="1" />';
            $longitudinalPerformanceSvg .= '    <text x="15" y="122" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">0</text>';
            $longitudinalPerformanceSvg .= '    <line x1="30" x2="390" y1="120" y2="120" stroke="#E4E4E4" stroke-width="1" />';
            for ($participantPreviousSixShipmentIndex = 0; $participantPreviousSixShipmentIndex < 6; $participantPreviousSixShipmentIndex++) {
                $previousShipment = $result['previous_six_shipments'][$participantPreviousSixShipmentIndex];
                if ($previousShipment['shipment_score'] != null && $previousShipment['shipment_score'] > 0) {
                    $longitudinalPerformanceSvg .= '    <rect width="30" height="' . $previousShipment['shipment_score'] . '" x="' . (($participantPreviousSixShipmentIndex * 60) + 15 + 30) . '" y="' . (100 - $previousShipment['shipment_score'] + 20) . '" fill="#4F81BD" />';
                }
                if ($participantPreviousSixShipmentIndex > 0) {
                    $previousShipmentBefore = $result['previous_six_shipments'][$participantPreviousSixShipmentIndex - 1];
                    $longitudinalPerformanceSvg .= '    <line x1="' . (($participantPreviousSixShipmentIndex * 60) - 30 + 30) . '" x2="' . (($participantPreviousSixShipmentIndex * 60) + 30 + 30) . '" y1="' . (100 - $previousShipmentBefore['mean_shipment_score'] + 20) . '" y2="' . (100 - $previousShipment['mean_shipment_score'] + 20) . '" stroke="#C0504D" stroke-width="2" />';
                }
                $longitudinalPerformanceSvg .= '    <text x="' . (($participantPreviousSixShipmentIndex * 60) + 60) . '" y="130" dominant-baseline="middle" text-anchor="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">' . $previousShipment['shipment_code'] . '</text>';
            }
            $longitudinalPerformanceSvg .= '    <rect width="4" height="4" x="120" y="139" fill="#4F81BD"  />';
            $longitudinalPerformanceSvg .= '    <text x="125" y="143" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">Site Score</text>';
            $longitudinalPerformanceSvg .= '    <line x1="160" x2="166" y1="141" y2="141" stroke="#C0504D" stroke-width="2" />';
            $longitudinalPerformanceSvg .= '    <text x="168" y="143" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">Mean Score of All Participating Sites</text>';
            $longitudinalPerformanceSvg .= '</svg>';
            $pdf->ImageSVG('@' . $longitudinalPerformanceSvg, 15, 70, 180, 130);
        }

        if ($result['is_excluded'] == 'yes') {
            $wishes = '<p>Your response was not considered for evaluation</p>';
            $pdf->SetLeftMargin(15);
            $pdf->writeHTML($wishes, true, false, true, false, '');
        }

        if (trim($result['evaluationComments']) != "" || trim($result['optional_eval_comment']) != "") {
            $comment = '<table border="1" style="width:100%;font-size:12px;" cellpadding="3">';

            if (trim($result['evaluationComments']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;width:30%;">Evaluation Comments </td>';
                $comment .= '<td style="width:70%;">' . $result['evaluationComments'] . '</td>';
                $comment .= '</tr>';
            }

            if (trim($result['optional_eval_comment']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;width:30%;">Specific Comments/Feedback</td>';
                $comment .= '<td style="width:70%;">' . $result['optional_eval_comment'] . '</td>';
                $comment .= '</tr>';
            }

            $comment .= '</table>';
            //$pdf->SetTopMargin(13);
            $pdf->writeHTML($comment, true, false, true, false, '');
        }
        $pdf->AddPage();
        $htmlTitle = '<span style="font-weight: bold;text-align:center;font-size:12;">' . ($panelName) . '</span><br>';
        $pdf->writeHTML($htmlTitle, true, false, true, false, '');
        $htmlSubTitle = '<table cellpadding="4" style="font-size:12px;width:100%;">';
        $htmlSubTitle .= '<tr style="background-color:#595959;width:100%;color:#FFFFFF;">';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>Country </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>Testing Site </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>PT-ID Number </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>Page Number </strong></td>';
        $htmlSubTitle .= '</tr>';
        $htmlSubTitle .= '<tr>';
        $htmlSubTitle .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['iso_name'] . '</td>';
        $htmlSubTitle .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['first_name'] . ' ' . $result['last_name'] . '</td>';
        $htmlSubTitle .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['unique_identifier'] . '</td>';
        $htmlSubTitle .= '	<td style="text-align:center;border-bottom:solid 2px;">3/3</td>';
        $htmlSubTitle .= '</tr>';
        $htmlSubTitle .= '</table>';
        // if (isset($result['previous_six_shipments']) && !empty($result['previous_six_shipments'])) {
        //     $htmlSubTitle .= "<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>";
        // }
        $pdf->writeHTML($htmlSubTitle, true, false, true, false, '');
        // $pdf->SetTopMargin(140);
        // Zend_Debug::dump($result);die;
        $html = '';
        $html .= '<h5>Documentation of Report Review:</h5>';
        $html .= '<p style="text-align:justify;font-size:10;font-weight:normal;">We the undersigned, have read and reviewed the above Xpert TB Proficiency Test Individual Performance Report. Expected results for which testing site’s submitted results are scored against are determined by the PT Provider’s sample validation testing procedures prior to panel shipment. If the final score was less than 100%, we completed a root cause analysis. * The Individual Final Report and any attachments must be filed and retained as documentation. If needed, corrective action documentation should also be completed and filed alongside the Individual Performance Report for reference.</p>';
        $html .= '<p style="text-align:justify;font-size:10;font-weight:normal;">Our identifiable individual site results are confidential and are only shared with our Proficiency Test Country Coordinators (PTCC) at the National or Regional level, the testing site, or other PTCC-designated stakeholders. Each PTCC serves as a subcontractor to the Xpert TB Proficiency Test Program for the following duties: site enrollment, panel receipt, panel distribution to individual testing sites, result submission assistance, report distribution assistance and corrective action follow-up in accordance with the country’s National TB Program guidelines. Unidentified site results may be shared for XTPT program review and improvement purposes upon request to, and with approval from, the PT Provider. Questions or comments concerning this report may be submitted to the PTCC or to the PT Provider using the Contact Information listed below.</p>';
        
        $authorised = $evalRow['saname'] ?? $result['participant_supervisor'];
        $html .= '<table cellpadding="4" style="width:100%;">';
        if (isset($result['shipment_test_date']) && !empty($result['shipment_test_date']) && isset($testerName) && !empty($testerName)) {
            $html .= '<tr>';
                $html .= '	<td style="width:60%;"><strong>Testing Personnel : </strong>' . ucwords($testerName) . '</td>';
                $html .= '	<td style="width:60%;"><strong>Date : </strong>' . Pt_Commons_General::humanReadableDateFormat($result['shipment_test_date']) . '</td>';
            $html .= '</tr>';
        } if(isset($result['shipment_test_report_date']) && !empty($result['shipment_test_report_date']) && isset($result['participant_supervisor']) && !empty($result['participant_supervisor'])){
            $html .= '<tr>';
            $html .= '	<td style="width:60%;"><strong>Laboratory Manager (or Designee) : </strong>' . ucwords($result['participant_supervisor']) . '</td>';
            $html .= '	<td style="width:60%;"><strong>Date : </strong>' . Pt_Commons_General::humanReadableDateFormat($result['shipment_test_report_date']) . '</td>';
            $html .= '</tr>';
        } if(isset($authorised) && !empty($authorised)){
            $html .= '<tr>';
                $html .= '	<td style="width:60%;"><strong>Report Authorized by : </strong>' . ($authorised) . '</td>';
                $html .= '	<td style="width:40%;"><strong>Date: : </strong>' . date('d-M-Y') . '</td>';
            $html .= '</tr>';    
        }
        $html .= '</table>';
        $pdf->writeHTML($html, true, false, true, false, '');

        $address = !empty($config->evaluation->tb->contactInfo) ? htmlspecialchars_decode($config->evaluation->tb->contactInfo) : null;
        if (isset($address) && !empty(trim($address)) && !empty(trim(strip_tags($address)))) {
            $pdf->writeHTML('<table style="width:100%" border="1"><tr><td style="width:100%">' . $address . '</td></tr></table>', true, false, true, false, '');
        }

        if (ob_get_contents()) {
            ob_end_clean();
        }

        //Close and output PDF document
        if (isset($result['last_name']) && trim($result['last_name']) != "") {
            $result['last_name'] = "_" . $result['last_name'];
        }

        $nameParts = [];
        $keys = ['shipment_code', 'unique_identifier', 'region', 'state', 'district', 'city'];

        foreach ($keys as $key) {
            if (!empty($result[$key]) && strtoupper($result[$key]) != 'NULL') {
                $nameParts[] = ($key == 'shipment_code') ? $result[$key] : strtoupper($result[$key]);
            }
        }

        $fileName = implode("-", $nameParts) . "-" . $result['map_id'];
        $fileName = $general->makeFileNameFriendly($fileName) . ".pdf";
        $filePath = DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $result['shipment_code'] . DIRECTORY_SEPARATOR . $fileName;
        $created = $pdf->Output($filePath, "F");

        //$pdf->Output($fileName, 'I');

        $loadpdf = Zend_Pdf::load($filePath);

        foreach ($loadpdf->pages as $page) {
            $pdfExtract = $extractor->clonePage($page);
            //$pdfExtract->setFont($font, 8) ->drawText('Page '.$j.' / '.$totalPages, 280, 50);
            $pdfNew->pages[] = $pdfExtract;
        }
        $shipmentCode = $result['shipment_code'];
        $j++;
    }
}
