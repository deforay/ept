<?php

$schemeType = 'tb';
$pdfNew = new Zend_Pdf();
$extractor = new Zend_Pdf_Resource_Extractor();
$font = Zend_Pdf_Font::fontWithName(Zend_Pdf_Font::FONT_HELVETICA);
$shipmentCode = '';


$isCli = php_sapi_name() === 'cli';

if ($isCli) {
    echo "Running in CLI mode\n";
}

if (!empty($resultArray['shipment'])) {

    $totalPages = count($resultArray['shipment']);
    $j = 1;

    foreach ($resultArray['shipment'] as $result) {

        if ($isCli) {
            echo "Processing for:" . $result['first_name'] . ' ' . $result['last_name'] . PHP_EOL;
        }

        /* for Shipment attributes functionality start */
        $shipmentAttributes = json_decode($result['shipment_attributes'], true);
        $shipmentAttributes['shipment_id'] = $result['shipment_id'];
        if (!file_exists($reportsPath . DIRECTORY_SEPARATOR . $result['shipment_code']) && !is_dir($reportsPath . DIRECTORY_SEPARATOR . $result['shipment_code'])) {
            mkdir($reportsPath . DIRECTORY_SEPARATOR . $result['shipment_code']);
        }
        // create new PDF document
        $panelName = (isset($shipmentAttributes['panelName']) && !empty($shipmentAttributes['panelName'])) ? $shipmentAttributes['panelName'] : $result['shipment_code'];
        $tbTestType = (isset($shipmentAttributes['tb_test_type']) && !empty($shipmentAttributes['tb_test_type'])) ? $shipmentAttributes['tb_test_type'] : 'molecular';
        $reportFormat = $reportService->getReportConfigValue('report-format');
        if (isset($reportFormat) && !empty($reportFormat)) {
            $pdf = new Pt_Reports_FpdiReport(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
            $pdf->setParams($resultStatus, $evalRow['date_finalised'], "", $watermark, "INDIVIDUAL", $layout, $panelName, $result['scheme_type'], "", "", $shipmentAttributes);
        } else {
            $pdf = new Pt_Reports_IndividualPdf(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
            $pdf->setSchemeName($header, $panelName, $logo, $logoRight, $resultStatus, $schemeType, $layout, $evalRow['date_finalised'], "", $watermark, "", $instituteAddressPosition, $resultArray['shipment'][0]['issuing_authority']);
        }


        // set default header data
        $pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);

        // set header and footer fonts
        $pdf->setHeaderFont(array('freesans', '', PDF_FONT_SIZE_MAIN));
        $pdf->setFooterFont(array('freesans', '', PDF_FONT_SIZE_DATA));

        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);
        // set margins
        $mt = ($layout == 'zimbabwe') ? 55 : 18;
        if (isset($templateTopMargin) && !empty($templateTopMargin)) {
            $mt = $templateTopMargin;
        }
        $pdf->SetMargins(PDF_MARGIN_LEFT, $mt, PDF_MARGIN_RIGHT);
        $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

        // set auto page breaks
        $pdf->SetAutoPageBreak(true, PDF_MARGIN_BOTTOM);

        // set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);



        // ---------------------------------------------------------

        // set font
        $pdf->SetFont('freesans', '', 11);

        // add a page
        $pdf->AddPage();



        // ---------------------------------------------------------

        if (trim($result['shipment_date']) != "") {
            $result['shipment_date'] = Pt_Commons_DateUtility::humanReadableDateFormat($result['shipment_date']);
        }
        if (trim($result['lastdate_response']) != "") {
            $result['lastdate_response'] = Pt_Commons_DateUtility::humanReadableDateFormat($result['lastdate_response']);
        }

        $responseDate = "";
        $shipmentTestDate = "";
        $shipmentTestReportDate = "";
        $shipmentScore = 0;
        $documentationScore = 0;
        $score = 0;

        if (isset($result['responseResult'][0]['responseDate']) && trim($result['responseResult'][0]['responseDate']) != "") {
            $responseDate = Pt_Commons_DateUtility::humanReadableDateFormat($result['responseResult'][0]['responseDate']);
        }
        $attributes = '';
        if (isset($result['attributes'])) {
            $attributes = json_decode($result['attributes'], true);
        }

        $shipmentReceiptDate = "";
        if (isset($result['responseResult'][0]['shipment_receipt_date']) && trim($result['responseResult'][0]['shipment_receipt_date']) != "") {
            $shipmentReceiptDate = Pt_Commons_DateUtility::humanReadableDateFormat($result['responseResult'][0]['shipment_receipt_date']);
        }

        if (isset($result['responseResult'][0]['shipment_test_date']) && trim($result['responseResult'][0]['shipment_test_date']) != "") {
            $shipmentTestDate = Pt_Commons_DateUtility::humanReadableDateFormat($result['responseResult'][0]['shipment_test_date']);
        }

        if (isset($result['responseResult'][0]['responseDate']) && trim($result['responseResult'][0]['responseDate']) != "") {
            $shipmentTestReportDate = Pt_Commons_DateUtility::humanReadableDateFormat($result['responseResult'][0]['responseDate']);
        }
        if ($layout == 'zimbabwe') {
            $htmlTitle = '<span style="font-weight: bold;text-align:center;font-size:10;">Individual Participant Results Report</span><br>';
            $pdf->writeHTML($htmlTitle, true, false, true, false, '');
        }
        $htmlTitle = '<span style="font-weight: bold;text-align:center;font-size:12px;">' . ucwords($panelName) . '</span><br>';
        $pdf->writeHTML($htmlTitle, true, false, true, false, '');

        $labInfo = '<table cellpadding="4" style="font-size:12px;width:100%;">';
        $labInfo .= '<tr style="background-color:#595959;color:#FFFFFF;">';
        $labInfo .= '	<td style="text-align:center;"><strong>Country </strong></td>';
        $labInfo .= '	<td style="text-align:center;"><strong>Testing Site </strong></td>';
        $labInfo .= '	<td style="text-align:center;"><strong>Participant ID </strong></td>';
        if (!isset($result['assayShortName']) || $result['assayShortName'] != 'microscopy') {
            $labInfo .= '	<td style="text-align:center;"><strong>Instrument SN</strong></td>';
            $labInfo .= '	<td style="text-align:center;"><strong>Last Calibration Date </strong></td>';
            $labInfo .= '	<td style="text-align:center;"><strong>Result Submission Date </strong></td>';
        } else {
            $labInfo .= '	<td style="text-align:center;"><strong>Result Submission Date </strong></td>';
        }
        $labInfo .= '</tr>';

        $labInfo .= '<tr>';
        $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['iso_name'] . '</td>';
        $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['first_name'] . ' ' . $result['last_name'] . '</td>';
        $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['unique_identifier'] . '</td>';


        if (!isset($result['assayShortName']) || $result['assayShortName'] != 'microscopy') {
            $serialSN = (isset($attributes['instrument_sn']) && !empty($attributes['instrument_sn']) && trim($attributes['instrument_sn']) != '') ? $attributes['instrument_sn'] : "NO SERIAL ENTERED";
            $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $serialSN . '</td>';
            $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $attributes['date_of_xpert_instrument_calibration'] ?? null . '</td>';
            $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['lastdate_response'] . '</td>';
        } else {
            $labInfo .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['lastdate_response'] . '</td>';
        }
        $labInfo .= '</tr>';
        $result['assayName'] = $result['assayName'] ?? 'Unspecified';
        if ($result['assayName'] != 'Unspecified' && $tbTestType != 'microscopy') {
            $labInfo .= '<tr>';
            $labInfo .= '<td style="line-height:0px;"></td>';
            $labInfo .= '</tr>';

            $labInfo .= '<tr style="background-color:#595959;color:#FFFFFF;">';
            $labInfo .= '	<td style="text-align:center;" colspan="4"><strong> Site Results Testing with ' . $result['assayName'] . '</strong></td>';
            $labInfo .= '</tr>';
        }

        $labInfo .= '</table>';
        $pdf->writeHTML($labInfo, false, false, true, false, '');
        // if (!isset($result['is_pt_test_not_performed']) || empty($result['is_pt_test_not_performed']) || $result['is_pt_test_not_performed'] != "yes") {
        if (!empty($result['responseResult'])) {
            if ($tbTestType == 'microscopy') {
                $labRes = '<span style="font-size:13px;font-weight:bold;">Your laboratory test results :</span><br/>';
                $labRes .= '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<table style="font-size:11px;" border="1" cellpadding="3">';
                $labRes .= '    <tr>';
                $labRes .= '        <th style="font-size:11px;width:20%;text-align:center;font-weight:bold;background-color:#b7dde7;"></th>';
                $labRes .= '        <th style="font-size:11px;width:35%;text-align:center;font-weight:bold;background-color:#b7dde7;">Expected Results</th>';
                $labRes .= '        <th style="font-size:11px;width:35%;text-align:center;font-weight:bold;background-color:#b7dde7;">Your Results</th>';
                $labRes .= '        <th style="font-size:11px;width:10%;text-align:center;font-weight:bold;background-color:#b7dde7;"></th>';
                $labRes .= '    </tr>';
                $labRes .= '    <tr>';
                $labRes .= '        <th style="font-size:11px;width:20%;text-align:center;font-weight:bold;background-color:#b7dde7;">Sample ID</th>';
                $labRes .= '        <th style="font-size:11px;width:35%;text-align:center;font-weight:bold;background-color:#b7dde7;">MTB Detected</th>';
                $labRes .= '        <th style="font-size:11px;width:35%;text-align:center;font-weight:bold;background-color:#b7dde7;">MTB Detected</th>';
                $labRes .= '        <th style="font-size:11px;width:10%;text-align:center;font-weight:bold;background-color:#b7dde7;">Score</th>';
                $labRes .= '    </tr>';
                foreach ($result['responseResult'] as $key => $response) {
                    $labRes .= '    <tr>';
                    $labRes .= '        <td style="font-size:11px;width:20%;text-align:center;border-bottom-color:#b7dde7;border-top-color:white;border-right-color:white;">' . ($response['sample_label'] ?? '') . '</td>';
                    $labRes .= '        <td style="font-size:11px;width:35%;text-align:center;border-bottom-color:#b7dde7;border-top-color:white;border-left-color:white;border-right-color:white;">' . strtoupper(str_replace("-", " ", $response['reference_mtb_detected'] ?? '')) . '</td>';
                    $labRes .= '        <td style="font-size:11px;width:35%;text-align:center;border-bottom-color:#b7dde7;border-top-color:white;border-left-color:white;border-right-color:white;">' . strtoupper(str_replace("-", " ", $response['mtb_detected'] ?? '')) . '</td>';
                    $labRes .= '        <td style="font-size:11px;width:10%;text-align:center;border-bottom-color:#b7dde7;border-top-color:white;border-left-color:white;">' . round($response['calculated_score'] ?? 0) . '</td>';
                    $labRes .= '    </tr>';
                }
                $labRes .= '</table>';
            } else {

                $labRes = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<table style="font-size:11px;width:100%;" border="0" cellpadding="1">';
                $labRes .= '    <tr>';
                $labRes .= '        <th style="font-size:11px;width:40%;text-align:center;font-weight:bold;"></th>';
                $labRes .= '        <th style="font-size:11px;width:25%;text-align:center;font-weight:bold;">MTB Detected</th>';
                $labRes .= '        <th style="font-size:11px;width:25%;text-align:center;font-weight:bold;">RIF Resistance</th>';
                $labRes .= '        <th style="font-size:11px;width:10%;text-align:center;font-weight:bold;">Score</th>';
                $labRes .= '    </tr>';
                foreach ($result['responseResult'] as $key => $response) {
                    $i = ($key + 5);
                    $testerName = $response['tester_name'] ?? $result['first_name'] . ' ' . $result['last_name'];

                    $labRes .= '    <tr style="width:100%;">';
                    $labRes .= '        <td colspan="4" style="font-size:11px;text-align:left;background-color:lightgray;width:100%;font-weight:bold;">Sample ID : ' . $response['sample_label'] . '</td>';
                    $labRes .= '    </tr>';
                    $labRes .= '    <tr style="width:100%;">';
                    $labRes .= '        <td style="font-size:11px;width:40%;text-align:left;">Expected Results-MTB/RIF</td>';
                    $labRes .= '        <td style="font-size:11px;width:25%;text-align:center;">' . ucwords(str_replace("-", " ", $response['reference_mtb_detected'] ?? '')) . '</td>';
                    $labRes .= '        <td style="font-size:11px;width:25%;text-align:center;">' . ucwords(str_replace("-", " ", $response['reference_rif_resistance'] ?? '')) . '</td>';
                    $labRes .= '        <td style="width:10%;text-align:center;"></td>';
                    $labRes .= '    </tr>';
                    $labRes .= '    <tr style="width:100%;">';
                    $labRes .= '        <td style="font-size:11px;width:40%;text-align:left;">Expected Results-Ultra</td>';
                    $labRes .= '        <td style="font-size:11px;width:25%;text-align:center;">' . ucwords(str_replace("-", " ", $response['reference_mtb_detected'] ?? '')) . '</td>';
                    $labRes .= '        <td style="font-size:11px;width:25%;text-align:center;">' . ucwords(str_replace("-", " ", $response['reference_rif_resistance'] ?? '')) . '</td>';
                    $labRes .= '        <td style="width:10%;text-align:center;"></td>';
                    $labRes .= '    </tr>';

                    $mtdResponse = ($result['is_pt_test_not_performed'] == 'yes') ? '' : $response['mtb_detected'];
                    $rifResponse = ($result['is_pt_test_not_performed'] == 'yes') ? '' : $response['rif_resistance'];
                    $resScore = ($result['is_pt_test_not_performed'] == 'yes') ? '0' : $response['calculated_score'];
                    if (isset($result['assayName']) && !empty($result['assayName'])) {
                        $nameColor = "black";
                        if ($resScore <= 5) {
                            $nameColor = "red";
                        }
                    } else {
                        $result['assayName'] = "Unspecified";
                        $nameColor = "red";
                    }
                    $labRes .= '    <tr style="width:100%;">';
                    $labRes .= '        <td style="color:' . $nameColor . ';font-size:11px;width:40%;text-align:left;font-weight:bold;">' . $testerName . '</td>';
                    $labRes .= '        <td style="color:' . $nameColor . ';font-size:11px;width:25%;text-align:center;font-weight:bold;">' . ucwords(str_replace("-", " ", $mtdResponse)) . '</td>';
                    $labRes .= '        <td style="color:' . $nameColor . ';font-size:11px;width:25%;text-align:center;font-weight:bold;">' . ucwords(str_replace("-", " ", $rifResponse)) . '</td>';
                    $labRes .= '        <td style="color:' . $nameColor . ';font-size:11px;width:10%;text-align:center;font-weight:bold;">' . round($resScore) . '</td>';
                    $labRes .= '    </tr>';
                }
                $labRes .= '</table>';
            }






            /* $colspan = "2";
                if ($result['responseResult'][0]['drug_resistance_test'] != "yes") {
                    $colspan = "1";
                }
                $labRes = '<span style="font-weight: bold;font-size:13px;">Your laboratory test results : <br/></span>';
                $labRes .= '<table style="font-size:11px;" border="1" cellpadding="3" style="width:100%;border-color: #b7dde7;">';
                $labRes .= '<tr style="background-color:#b7dde7;width:100%;">';
                $labRes .= '<td style="text-align:center;font-weight:bold;"></td>';
                $labRes .= '<td style="text-align:center;font-weight:bold;" colspan="' . $colspan . '">Expected Results</td>';
                $labRes .= '<td style="text-align:center;font-weight:bold;" colspan="' . $colspan . '">Your Results</td>';
                $labRes .= '<td style="text-align:center;font-weight:bold;"></td>';
                $labRes .= '</tr>';
                $labRes .= '<tr style="background-color:#b7dde7;">';
                $labRes .= '<td style="text-align:center;font-weight:bold;">Sample ID</td>';
                $labRes .= '<td style="text-align:center;font-weight:bold;">MTB Detected</td>';
                if ($result['responseResult'][0]['drug_resistance_test'] == "yes") {
                    $labRes .= '<td style="text-align:center;font-weight:bold;">RIF Resistance</td>';
                }
                $labRes .= '<td style="text-align:center;font-weight:bold;">MTB Detected</td>';
                if ($result['responseResult'][0]['drug_resistance_test'] == "yes") {
                    $labRes .= '<td style="text-align:center;font-weight:bold;">RIF Resistance</td>';
                }
                $labRes .= '<td style="text-align:center;font-weight:bold;">Score</td>';
                $labRes .= '</tr>';
                //Sample codes
                $testerName = '';
                foreach ($result['responseResult'] as $response) {
                    $labRes .= '<tr>';
                    $labRes .= '<td style="text-align:center;font-weight:bold;border-bottom:solid 2px #b7dde7;">' . $response['sample_label'] . '</td>';
                    $labRes .= '<td style="text-align:center;border-bottom:solid 2px #b7dde7;">' . ucwords(str_replace("-", " ", $response['reference_mtb_detected'])) . '</td>';
                    if ($response['drug_resistance_test'] == "yes") {
                        $labRes .= '<td style="text-align:center;border-bottom:solid 2px #b7dde7;">' . ucwords(str_replace("-", " ", $response['reference_rif_resistance'])) . '</td>';
                    }
                    $labRes .= '<td style="text-align:center;border-bottom:solid 2px #b7dde7;">' . ucwords(str_replace("-", " ", $response['mtb_detected'])) . '</td>';
                    if ($response['drug_resistance_test'] == "yes") {
                        $labRes .= '<td style="text-align:center;border-bottom:solid 2px #b7dde7;">' . ucwords(str_replace("-", " ", $response['rif_resistance'])) . '</td>';
                    }
                    $labRes .= '<td style="text-align:center;border-bottom:solid 2px #b7dde7;">' . $response['calculated_score'] . '</td>';
                    $labRes .= '</tr>';
                    if (empty($testerName)) {
                        $testerName = $response['tester_name'] ?? null;
                    }
                }

                $labRes .= '</table>'; */

            if (empty($testerName)) {
                $testerName = $result['first_name'] . ' ' . $result['last_name'];
            }
            $pdf->SetLeftMargin(10);
            $pdf->writeHTML($labRes, true, false, true, false, '');
        }

        $finalScore = (isset($result['final_result']) && !empty($result['final_result']) && $result['final_result'] == 1) ? 'Satisfactory' : 'Unsatisfactory';
        $border = ($tbTestType == 'microscopy') ? 'border="1"' : '';
        $finalInfo = '&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<table ' . $border . ' cellpadding="4" style="font-size:11px;width:100%;">';
        $finalInfo .= '<tr style="text-align:center;">';
        $finalInfo .= '	<th style="width:40%;font-size:11px;"></th>';
        $finalInfo .= '	<td style="width:25%;font-size:11px;border-bottom:1px solid black;"><strong>Percentage</strong></td>';
        $finalInfo .= '	<td style="width:25%;font-size:11px;border-bottom:1px solid black;"><strong>Satisfactory/Unsatisfactory</strong></td>';
        $finalInfo .= '	<td style="width:10%;font-size:11px;border-bottom:1px solid black;"></td>';
        $finalInfo .= '</tr>';

        $finalInfo .= '<tr style="background-color:#b7dde7;">';
        $finalInfo .= '	<td style="width:40%;font-size:11px;border-bottom:1px solid black;"><strong>FINAL SCORE</strong></td>';
        $finalInfo .= '	<td style="width:25%;font-size:11px;text-align:center;border-bottom:1px solid black;">' . ($result['shipment_score'] + $result['documentation_score']) . '%</td>';
        $finalInfo .= '	<td style="width:25%;font-size:11px;text-align:center;border-bottom:1px solid black;">' . $finalScore . '</td>';
        $finalInfo .= '	<td style="width:10%;font-size:11px;text-align:center;border-bottom:1px solid black;"></td>';
        $finalInfo .= '</tr>';
        $finalInfo .= '</table>';

        $pdf->writeHTML($finalInfo, true, false, true, false, '');
        // }
        // add a page

        if (isset($result['ntr_reason']) && !empty($result['ntr_reason']) || isset($result['pt_test_not_performed_comments']) && !empty($result['pt_test_not_performed_comments'])) {
            $notTestedInfo = '<hr>';
            $notTestedInfo .= '<table cellpadding="4" style="font-size:12px;width:100%;">';
            /*$notTestedInfo .= '<tr style="background-color:#595959;color:#FFFFFF;">';
            $notTestedInfo .= '	<td style="text-align:center;">Xpert testing site was unable to participate in <strong>' . $panelName . '</strong> due to following reason(s)</td>';
            $notTestedInfo .= '</tr>'; */
            if (isset($result['ntr_reason']) && !empty($result['ntr_reason']) && (!isset($result['pt_test_not_performed_comments']) || empty($result['pt_test_not_performed_comments']))) {
                $notTestedInfo .= '<tr style="background-color:#595959;color:#FFFFFF;">';
                $notTestedInfo .= '	<td style="width:100%;text-align:center;"><strong>Comments</strong></td>';
                $notTestedInfo .= '</tr>';
                $notTestedInfo .= '<tr>';
                $ntrReason = (isset($result['ntr_reason']) && !empty($result['ntr_reason'])) ? $result['ntr_reason'] : '';
                $notTestedInfo .= '	<td style="width:100%;">Xpert testing site was unable to participate in ' . $result['shipment_code'] . ' due to the following reason(s): ' . $ntrReason . '</td>';
                $notTestedInfo .= '</tr>';
            }
            if ((isset($result['pt_test_not_performed_comments']) && !empty($result['pt_test_not_performed_comments']))) {
                $notTestedInfo .= '<tr style="background-color:#595959;color:#FFFFFF;">';
                $notTestedInfo .= '	<td style="width:100%;text-align:center;"><strong>Comments</strong></td>';
                $notTestedInfo .= '</tr>';
                $notTestedInfo .= '<tr>';
                $ptntrcmnts = (isset($result['pt_test_not_performed_comments']) && !empty($result['pt_test_not_performed_comments'])) ? $result['pt_test_not_performed_comments'] : '';
                $notTestedInfo .= '	<td style="width:100%;"><p style="text-align:justify;">Xpert testing site was unable to participate in ' . $result['shipment_code'] . ' due to the following reason(s): ' . $ptntrcmnts . '</p></td>';
                $notTestedInfo .= '</tr>';
            }
            $notTestedInfo .= '</table>';

            $pdf->writeHTML($notTestedInfo, true, false, true, false, '');
        }

        // Comments section - always show heading (no border, just header bar)
        $comment = '<table style="width:100%;font-size:12px;" cellpadding="3">';
        $comment .= '<tr style="background-color:#595959;color:#FFFFFF;">';
        $comment .= '	<td style="text-align:center;"><strong>Comments</strong></td>';
        $comment .= '</tr>';

        if (trim($result['evaluationComments'] ?? '') != "" || trim($result['optional_eval_comment'] ?? '') != "") {
            if (trim($result['evaluationComments'] ?? '') != "") {
                $comment .= '<tr>';
                $comment .= '   <td style="width:100%;text-align:justify;font-size:11px;">' . nl2br($result['evaluationComments']) . '</td>';
                $comment .= '</tr>';
            }

            if (trim($result['optional_eval_comment'] ?? '') != "") {
                $comment .= '<tr>';
                $comment .= '   <td style="width:100%;text-align:justify;font-size:11px;">' . nl2br($result['optional_eval_comment']) . '</td>';
                $comment .= '</tr>';
            }
        }

        $comment .= '</table>';
        $pdf->writeHTML($comment, true, false, true, false, '');



        // Report Issued by - at bottom of page 1
        $authorised = "_____________________";
        $datetxt = "_____________________";

        if ($evalRow['report_type'] == 'finalized') {
            $authorised = $resultArray['shipment'][0]['pt_co_ordinator_name'] ?? $evalRow['saname'];
            $datetxt = Pt_Commons_DateUtility::humanReadableDateFormat($evalRow['date_finalised'] ?? date('Y-m-d'));
        }

        // Position at bottom of page 1
        $pdf->SetY(-40);

        $reportIssuedHtml = '<table cellpadding="4" style="width:100%;">';
        $reportIssuedHtml .= '<tr>';
        $reportIssuedHtml .= '	<td style="width:60%;"><strong>Report Issued by : </strong>' . $authorised . '</td>';
        $reportIssuedHtml .= '	<td style="width:40%;"><strong>Date : </strong>' . $datetxt . '</td>';
        $reportIssuedHtml .= '</tr>';
        $reportIssuedHtml .= '</table>';
        $pdf->writeHTML($reportIssuedHtml, true, false, true, false, '');

        $pdf->AddPage();

        $htmlTitle = '<span style="font-weight: bold;text-align:center;font-size:12px;">' . ($panelName) . '</span><br>';
        $pdf->writeHTML($htmlTitle, true, false, true, false, '');
        $htmlSubTitle = '<table cellpadding="4" style="font-size:12px;width:100%;">';
        $htmlSubTitle .= '<tr style="background-color:#595959;width:100%;color:#FFFFFF;">';
        $htmlSubTitle .= '	<td style="text-align:center;width:25%;"><strong>Country </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;width:50%;"><strong>Testing Site </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;width:25%;"><strong>Participant ID </strong></td>';
        $htmlSubTitle .= '</tr>';
        $htmlSubTitle .= '<tr>';
        $htmlSubTitle .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['iso_name'] . '</td>';
        $htmlSubTitle .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['first_name'] . ' ' . $result['last_name'] . '</td>';
        $htmlSubTitle .= '	<td style="text-align:center;border-bottom:solid 2px;">' . $result['unique_identifier'] . '</td>';
        $htmlSubTitle .= '</tr>';
        $htmlSubTitle .= '</table>';

        $pdf->writeHTML($htmlSubTitle, true, false, true, false, '');

        $html = '<br><table cellpadding="4" style="width:100%;">';
        $html .= '<tr>';
        $html .= '	<td style="width:40%;"><strong>Testing Personnel : </strong></td>';
        $html .= '	<td style="width:28%;">____________________</td>';
        $html .= '	<td style="width:32%;"><strong>Date : </strong>__________________</td>';
        $html .= '</tr>';
        $html .= '<tr>';
        $html .= '	<td style="width:40%;"></td>';
        $html .= '	<td style="width:28%;">____________________</td>';
        $html .= '	<td style="width:32%;"><strong>Date : </strong>__________________</td>';
        $html .= '</tr>';
        $html .= '<tr>';
        $html .= '	<td style="width:40%;"><strong>Laboratory Manager (or Designee) : </strong></td>';
        $html .= '	<td style="width:28%;">____________________</td>';
        $html .= '	<td style="width:32%;"><strong>Date : </strong>__________________</td>';
        $html .= '</tr>';
        $html .= '</table>';
        $pdf->writeHTML($html, true, false, true, false, '');

        $address = Pt_Commons_SchemeConfig::get('tb.contactInfo');
        if (isset($address) && !empty(trim($address)) && !empty(trim(strip_tags($address)))) {
            $pdf->writeHTML('<table style="width:100%" border="1"><tr><td style="width:100%;">' . $address . '</td></tr></table>', true, false, true, false, '');
        }

        if (ob_get_contents()) {
            ob_end_clean();
        }

        //Close and output PDF document
        if (isset($result['last_name']) && trim($result['last_name']) != "") {
            $result['last_name'] = "_" . $result['last_name'];
        }

        $nameParts = [];
        $keys = ['shipment_code', 'unique_identifier', 'region', 'state', 'district', 'city'];

        foreach ($keys as $key) {
            if (!empty($result[$key]) && strtoupper($result[$key]) != 'NULL') {
                $nameParts[] = ($key == 'shipment_code') ? $result[$key] : strtoupper($result[$key]);
            }
        }

        $fileName = implode("-", $nameParts) . "-" . $result['map_id'];
        $fileName = Application_Service_Common::makeFileNameFriendly($fileName) . ".pdf";
        $filePath = $reportsPath . DIRECTORY_SEPARATOR . $result['shipment_code'] . DIRECTORY_SEPARATOR . $fileName;
        $created = $pdf->Output($filePath, "F");

        //$pdf->Output($fileName, 'I');

        $loadpdf = Zend_Pdf::load($filePath);

        foreach ($loadpdf->pages as $page) {
            $pdfExtract = $extractor->clonePage($page);
            //$pdfExtract->setFont($font, 8) ->drawText('Page '.$j.' / '.$totalPages, 280, 50);
            $pdfNew->pages[] = $pdfExtract;
        }
        $shipmentCode = $result['shipment_code'];
        $j++;
    }
}
