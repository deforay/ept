<?php

require_once(CRON_PATH . DIRECTORY_SEPARATOR . 'Common.php');
$general = new Common();
$schemeType = $resultArray['shipment'][0]['scheme_type'];
// Zend_Debug::dump($resultArray);die;
$pdfNew = new Zend_Pdf();
$extractor = new Zend_Pdf_Resource_Extractor();
$font = Zend_Pdf_Font::fontWithName(Zend_Pdf_Font::FONT_HELVETICA);
$shipmentCode = '';


$mtbFullText = array(
    'detected' => 'Detected',
    'not-detected' => 'Not Detected',
    'indeterminate' => 'Indeterminate',
    'invalid' => 'Invalid',
    'error' => 'Error'
);

$rifFullText = array(
    'na' => 'N/A',
    'detected' => 'Detected',
    'not-detected' => 'Not Detected',
    'indeterminate' => 'Indeterminate',
    'invalid' => 'Invalid',
    'error' => 'Error'
);

$config = new Zend_Config_Ini(APPLICATION_PATH . DIRECTORY_SEPARATOR . "configs" . DIRECTORY_SEPARATOR . "config.ini", APPLICATION_ENV);
if (sizeof($resultArray['shipment']) > 0) {
    if (!file_exists(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports') && !is_dir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports')) {
        mkdir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports');
    }
    $totalPages = count($resultArray['shipment']);
    $j = 1;
    //$resultArray['dmResult'];
    // Zend_Debug::dump($resultArray['shipment']);die;

    foreach ($resultArray['shipment'] as $result) {
        $shipmentAttributes = json_decode($result['shipment_attributes'], true);

        if (!file_exists(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $result['shipment_code']) && !is_dir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $result['shipment_code'])) {
            mkdir(DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $result['shipment_code']);
        }
        //error_log($i);
        // Extend the TCPDF class to create custom Header and Footer

        // create new PDF document
        $pdf = new IndividualPDF(PDF_PAGE_ORIENTATION, PDF_UNIT, PDF_PAGE_FORMAT, true, 'UTF-8', false);
        $panelName = (isset($shipmentAttributes['panelName']) && !empty($shipmentAttributes['panelName'])) ? $shipmentAttributes['panelName'] : $result['shipment_code'];
        $pdf->setSchemeName($header, $panelName, $logo, $logoRight, $resultStatus, $schemeType, $layout, $evalRow['date_finalised'], $config, $trainingInstanceText, "", $instituteAddressPosition, $resultArray['shipment'][0]['issuing_authority']);


        // set default header data
        $pdf->SetHeaderData(PDF_HEADER_LOGO, PDF_HEADER_LOGO_WIDTH, PDF_HEADER_TITLE, PDF_HEADER_STRING);

        // set header and footer fonts
        $pdf->setHeaderFont(array(PDF_FONT_NAME_MAIN, '', PDF_FONT_SIZE_MAIN));
        $pdf->setFooterFont(array(PDF_FONT_NAME_DATA, '', PDF_FONT_SIZE_DATA));

        // set default monospaced font
        $pdf->SetDefaultMonospacedFont(PDF_FONT_MONOSPACED);

        // set margins

        $pdf->SetMargins(PDF_MARGIN_LEFT, 40, PDF_MARGIN_RIGHT);
        $pdf->SetHeaderMargin(PDF_MARGIN_HEADER);
        $pdf->SetFooterMargin(PDF_MARGIN_FOOTER);

        // set auto page breaks
        $pdf->SetAutoPageBreak(true, PDF_MARGIN_BOTTOM);

        // set image scale factor
        $pdf->setImageScale(PDF_IMAGE_SCALE_RATIO);

        // set some language-dependent strings (optional)
        if (@file_exists(dirname(__FILE__) . '/lang/eng.php')) {
            require_once dirname(__FILE__) . '/lang/eng.php';
            $pdf->setLanguageArray($l);
        }

        // ---------------------------------------------------------

        // set font
        $pdf->SetFont('freesans', '', 11);

        // add a page
        $pdf->AddPage();


        // ---------------------------------------------------------

        if (trim($result['shipment_date']) != "") {
            $result['shipment_date'] = $general->humanDateFormat($result['shipment_date']);
        }
        if (trim($result['lastdate_response']) != "") {
            $result['lastdate_response'] = $general->humanDateFormat($result['lastdate_response']);
        }

        $responseDate = "";
        $shipmentTestDate = "";
        $shipmentTestReportDate = "";
        $shipmentScore = 0;
        $documentationScore = 0;
        $score = 0;

        if (isset($result['responseResult'][0]['responseDate']) && trim($result['responseResult'][0]['responseDate']) != "") {
            $splitDate = explode(" ", $result['responseResult'][0]['responseDate']);
            $responseDate = $general->humanDateFormat($splitDate[0]);
        }
        $attributes = '';
        if (isset($result['attributes'])) {
            $attributes = json_decode($result['attributes'], true);
        }

        $shipmentReceiptDate = "";
        if (isset($result['responseResult'][0]['shipment_receipt_date']) && trim($result['responseResult'][0]['shipment_receipt_date']) != "") {
            $shipmentReceiptDate = $general->humanDateFormat($result['responseResult'][0]['shipment_receipt_date']);
        }

        if (isset($result['responseResult'][0]['shipment_test_date']) && trim($result['responseResult'][0]['shipment_test_date']) != "") {
            $shipmentTestDate = $general->humanDateFormat($result['responseResult'][0]['shipment_test_date']);
        }

        if (isset($result['responseResult'][0]['responseDate']) && trim($result['responseResult'][0]['responseDate']) != "") {
            $shipmentTestReportDate = $general->humanDateFormat($result['responseResult'][0]['responseDate']);
        }

        $htmlTitle = '<span style="font-weight: bold;text-align:center;font-size:12;">' . ucwords($panelName) . '</span><br>';
        $pdf->writeHTML($htmlTitle, true, false, true, false, '');

        $labInfo = '<table cellpadding="4" border="1" style="font-size:12px;width:100%;">';
        $labInfo .= '<tr style="background-color:#595959;color:#FFFFFF;">';
        $labInfo .= '	<td style="text-align:center;"><strong>Country </strong></td>';
        $labInfo .= '	<td style="text-align:center;"><strong>Testing Site </strong></td>';
        $labInfo .= '	<td style="text-align:center;"><strong>PT-ID Number </strong></td>';
        $labInfo .= '	<td style="text-align:center;"><strong>Page Number </strong></td>';
        $labInfo .= '</tr>';
        $labInfo .= '<tr>';
        $labInfo .= '	<td>' . $result['region'] . '</td>';
        $labInfo .= '	<td>' . $result['first_name'] . ' ' . $result['last_name'] . '</td>';
        $labInfo .= '	<td>' . $result['unique_identifier'] . '</td>';
        $labInfo .= '	<td>1/3</td>';
        $labInfo .= '</tr>';
        $labInfo .= '</table>';
        $labInfo .= '<br><br><br>';


        $labInfo .= '<table cellpadding="4" border="1" style="font-size:12px;width:100%;">';
        $labInfo .= '<tr style="background-color:#595959;color:#FFFFFF;">';
        $labInfo .= '	<td style="text-align:center;"><strong>Instrument Serial number </strong></td>';
        $labInfo .= '	<td style="text-align:center;"><strong>Last Calibration Date </strong></td>';
        $labInfo .= '	<td style="text-align:center;"><strong>Result Submission Date </strong></td>';
        $labInfo .= '</tr>';

        $labInfo .= '<tr>';
        $labInfo .= '	<td>' . $attributes['instrument_sn'] . '</td>';
        $labInfo .= '	<td>' . $attributes['date_of_xpert_instrument_calibration'] . '</td>';
        $labInfo .= '	<td>' . $result['lastdate_response'] . '</td>';
        $labInfo .= '</tr>';
        $labInfo .= '</table>';
        $pdf->writeHTML($labInfo, true, false, true, false, '');

        if (!isset($result['is_pt_test_not_performed']) || empty($result['is_pt_test_not_performed']) || $result['is_pt_test_not_performed'] != "yes") {

            if (!empty($result['responseResult'])) {
                $colspan = "2";
                if ($result['responseResult'][0]['drug_resistance_test'] != "yes") {
                    $colspan = "1";
                }
                $labRes = '<span style="font-weight: bold;font-size:13px;">Your laboratory test results : <br/></span>';
                $labRes .= '<table border="1" style="font-size:11px;" cellpadding="3" style="width:100%;">';
                $labRes .= '<tr style="background-color:#dbe4ee;width:100%;">';
                $labRes .= '<td style="text-align:center;font-weight:bold;"></td>';
                $labRes .= '<td style="text-align:center;font-weight:bold;" colspan="' . $colspan . '">Expected Results</td>';
                $labRes .= '<td style="text-align:center;font-weight:bold;" colspan="' . $colspan . '">Your Results</td>';
                $labRes .= '<td style="text-align:center;font-weight:bold;"></td>';
                $labRes .= '</tr>';
                $labRes .= '<tr style="background-color:#dbe4ee;">';
                $labRes .= '<td style="text-align:center;font-weight:bold;">Sample ID</td>';
                $labRes .= '<td style="text-align:center;font-weight:bold;">MTB Detected</td>';
                if ($result['responseResult'][0]['drug_resistance_test'] == "yes") {
                    $labRes .= '<td style="text-align:center;font-weight:bold;">RIF Resistance</td>';
                }
                $labRes .= '<td style="text-align:center;font-weight:bold;">MTB Detected</td>';
                if ($result['responseResult'][0]['drug_resistance_test'] == "yes") {
                    $labRes .= '<td style="text-align:center;font-weight:bold;">RIF Resistance</td>';
                }
                $labRes .= '<td style="text-align:center;font-weight:bold;">Score</td>';
                $labRes .= '</tr>';
                //Sample codes
                foreach ($result['responseResult'] as $response) {
                    $labRes .= '<tr>';
                    $labRes .= '<td style="text-align:center;font-weight:bold;">' . $response['sample_label'] . '</td>';
                    $labRes .= '<td style="text-align:center;">' . $mtbFullText[$response['refMtbDetected']] . '</td>';
                    if ($response['drug_resistance_test'] == "yes") {
                        $labRes .= '<td style="text-align:center;">' . $rifFullText[$response['refRifResistance']] . '</td>';
                    }
                    $labRes .= '<td style="text-align:center;">' . $mtbFullText[$response['mtb_detected']] . '</td>';
                    if ($response['drug_resistance_test'] == "yes") {
                        $labRes .= '<td style="text-align:center;">' . $rifFullText[$response['rif_resistance']] . '</td>';
                    }
                    $labRes .= '<td style="text-align:center;">' . $response['calculated_score'] . '</td>';
                    $labRes .= '</tr>';
                }

                $labRes .= '</table>';

                $pdf->SetLeftMargin(15);
                $pdf->writeHTML($labRes, true, false, true, false, '');
            }

            $finalScore = (isset($result['final_result']) && !empty($result['final_result']) && $result['final_result'] == 1) ? 'Satisfactory' : 'Unsatisfactory';

            $finalInfo = '<table cellpadding="4" border="1" style="font-size:12px;width:100%;">';
            $finalInfo .= '<tr>';
            $finalInfo .= '	<th></th>';
            $finalInfo .= '	<td><strong>Percentage</strong></td>';
            $finalInfo .= '	<td><strong>Satisfactory/Unsatisfactory</strong></td>';
            $finalInfo .= '</tr>';

            $finalInfo .= '<tr style="background-color:#595959;color:#FFFFFF;">';
            $finalInfo .= '	<td><strong>FINAL SCORE</strong></td>';
            $finalInfo .= '	<td>' . ($result['shipment_score'] + $result['documentation_score']) . '%</td>';
            $finalInfo .= '	<td>' . $finalScore . '</td>';
            $finalInfo .= '</tr>';
            $finalInfo .= '</table>';

            $pdf->writeHTML($finalInfo, true, false, true, false, '');
        }
        $pdf->AddPage();
        $htmlTitle = '<span style="font-weight: bold;text-align:center;font-size:12;">' . ucwords($panelName) . '</span><br>';
        $pdf->writeHTML($htmlTitle, true, false, true, false, '');
        $htmlSubTitle = '<table cellpadding="4" border="1" style="font-size:12px;width:100%;">';
        $htmlSubTitle .= '<tr style="background-color:#595959;color:#FFFFFF;">';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>Country </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>Testing Site </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>PT-ID Number </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>Page Number </strong></td>';
        $htmlSubTitle .= '</tr>';
        $htmlSubTitle .= '<tr>';
        $htmlSubTitle .= '	<td>' . $result['region'] . '</td>';
        $htmlSubTitle .= '	<td>' . $result['first_name'] . ' ' . $result['last_name'] . '</td>';
        $htmlSubTitle .= '	<td>' . $result['unique_identifier'] . '</td>';
        $htmlSubTitle .= '	<td>2/3</td>';
        $htmlSubTitle .= '</tr>';
        $htmlSubTitle .= '</table>';

        $pdf->writeHTML($htmlSubTitle, true, false, true, false, '');

        if (trim($result['shipment_comment']) != "" || trim($result['evaluationComments']) != "" || trim($result['optional_eval_comment']) != "") {
            $comment = '<br><br><table border="1" style="width:100%;font-size:12px;" cellpadding="3">';

            if (trim($result['evaluationComments']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;width:30%;">Evaluation Comments </td>';
                $comment .= '<td style="width:70%;">' . $result['evaluationComments'] . '</td>';
                $comment .= '</tr>';
            }

            if (trim($result['optional_eval_comment']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;width:30%;">Specific Comments/Feedback</td>';
                $comment .= '<td style="width:70%;">' . $result['optional_eval_comment'] . '</td>';
                $comment .= '</tr>';
            }

            if (trim($result['shipment_comment']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;" colspan="2">' . $result['shipment_comment'] . '</td>';
                $comment .= '</tr>';
            }

            $comment .= '</table>';
            //$pdf->SetTopMargin(13);
            $pdf->writeHTML($comment, true, false, true, false, '');
        }

        if (isset($result['ntr_reason']) && !empty($result['ntr_reason'])) {
            $notTestedInfo = '<table cellpadding="4" style="font-size:12px;width:100%;">';
            $notTestedInfo .= '<tr>';
            $notTestedInfo .= '	<td colspan="2" style="color:red;">Xpert testing site was unable to participate in ' . $panelName . ' due to following reason(s)</td>';
            $notTestedInfo .= '</tr>';

            $notTestedInfo .= '<tr>';
            $notTestedInfo .= '	<td style="width:25%;"><strong>Reason for not testing</strong></td>';
            $notTestedInfo .= '	<td style="width:75%;">' . (isset($result['ntr_reason']) && !empty($result['ntr_reason'])) ? $result['ntr_reason'] : '' . '</td>';
            $notTestedInfo .= '</tr>';
            $notTestedInfo .= '<tr>';
            $notTestedInfo .= '	<td style="width:25%;"><strong>Not testing comments</strong></td>';
            $notTestedInfo .= '	<td style="width:75%;">' . (isset($result['pt_test_not_performed_comments']) && !empty($result['pt_test_not_performed_comments'])) ? $result['pt_test_not_performed_comments'] : '' . '</td>';
            $notTestedInfo .= '</tr>';
            $notTestedInfo .= '</table>';

            $pdf->writeHTML($notTestedInfo, true, false, true, false, '');
        }

        if (isset($result['previous_six_shipments']) && !empty($result['previous_six_shipments'])) {

            $longitudinalPerformanceSvg = '<?xml version="1.0" encoding="UTF-8"?>';
            $longitudinalPerformanceSvg .= '<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 400 160">';
            $longitudinalPerformanceSvg .= '    <rect width="400" height="150" x="0" y="0" stroke="#E4E4E4" stroke-width="1" fill="white" />';
            $longitudinalPerformanceSvg .= '    <text x="200" y="12" dominant-baseline="middle" text-anchor="middle" style="fill:#666666;font-family:helvetica;font-size:8pt">' . htmlspecialchars($result['lab_name'], ENT_XML1) . ' Performance Over Time</text>';
            $longitudinalPerformanceSvg .= '    <text x="15" y="22" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">100</text>';
            $longitudinalPerformanceSvg .= '    <line x1="30" x2="390" y1="20" y2="20" stroke="#E4E4E4" stroke-width="1" />';
            $longitudinalPerformanceSvg .= '    <text x="15" y="42" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">80</text>';
            $longitudinalPerformanceSvg .= '    <line x1="30" x2="390" y1="40" y2="40" stroke="#E4E4E4" stroke-width="1" />';
            $longitudinalPerformanceSvg .= '    <text x="15" y="62" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">60</text>';
            $longitudinalPerformanceSvg .= '    <line x1="30" x2="390" y1="60" y2="60" stroke="#E4E4E4" stroke-width="1" />';
            $longitudinalPerformanceSvg .= '    <text x="15" y="82" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">40</text>';
            $longitudinalPerformanceSvg .= '    <line x1="30" x2="390" y1="80" y2="80" stroke="#E4E4E4" stroke-width="1" />';
            $longitudinalPerformanceSvg .= '    <text x="15" y="102" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">20</text>';
            $longitudinalPerformanceSvg .= '    <line x1="30" x2="390" y1="100" y2="100" stroke="#E4E4E4" stroke-width="1" />';
            $longitudinalPerformanceSvg .= '    <text x="15" y="122" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">0</text>';
            $longitudinalPerformanceSvg .= '    <line x1="30" x2="390" y1="120" y2="120" stroke="#E4E4E4" stroke-width="1" />';
            for ($participantPreviousSixShipmentIndex = 0; $participantPreviousSixShipmentIndex < 6; $participantPreviousSixShipmentIndex++) {
                $previousShipment = $result['previous_six_shipments'][$participantPreviousSixShipmentIndex];
                if ($previousShipment['shipment_score'] != null && $previousShipment['shipment_score'] > 0) {
                    $longitudinalPerformanceSvg .= '    <rect width="30" height="' . $previousShipment['shipment_score'] . '" x="' . (($participantPreviousSixShipmentIndex * 60) + 15 + 30) . '" y="' . (100 - $previousShipment['shipment_score'] + 20) . '" fill="#4F81BD" />';
                }
                if ($participantPreviousSixShipmentIndex > 0) {
                    $previousShipmentBefore = $result['previous_six_shipments'][$participantPreviousSixShipmentIndex - 1];
                    $longitudinalPerformanceSvg .= '    <line x1="' . (($participantPreviousSixShipmentIndex * 60) - 30 + 30) . '" x2="' . (($participantPreviousSixShipmentIndex * 60) + 30 + 30) . '" y1="' . (100 - $previousShipmentBefore['mean_shipment_score'] + 20) . '" y2="' . (100 - $previousShipment['mean_shipment_score'] + 20) . '" stroke="#C0504D" stroke-width="2" />';
                }
                $longitudinalPerformanceSvg .= '    <text x="' . (($participantPreviousSixShipmentIndex * 60) + 60) . '" y="130" dominant-baseline="middle" text-anchor="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">' . $previousShipment['shipment_code'] . '</text>';
            }
            $longitudinalPerformanceSvg .= '    <rect width="4" height="4" x="120" y="139" fill="#4F81BD"  />';
            $longitudinalPerformanceSvg .= '    <text x="125" y="143" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">Site Score</text>';
            $longitudinalPerformanceSvg .= '    <line x1="160" x2="166" y1="141" y2="141" stroke="#C0504D" stroke-width="2" />';
            $longitudinalPerformanceSvg .= '    <text x="168" y="143" dominant-baseline="middle" style="fill:#666666;font-family:helvetica;font-size:5pt">Mean Score of All Participating Sites</text>';
            $longitudinalPerformanceSvg .= '</svg>';
            $pdf->ImageSVG('@' . $longitudinalPerformanceSvg, 15, 70, 180, 130);
        }

        if ($result['is_excluded'] == 'yes') {
            $wishes = '<p>Your response was not considered for evaluation</p>';
            $pdf->SetLeftMargin(15);
            $pdf->writeHTML($wishes, true, false, true, false, '');
        }

        if (trim($result['evaluationComments']) != "" || trim($result['optional_eval_comment']) != "") {
            $comment = '<table border="1" style="width:100%;font-size:12px;" cellpadding="3">';

            if (trim($result['evaluationComments']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;width:30%;">Evaluation Comments </td>';
                $comment .= '<td style="width:70%;">' . $result['evaluationComments'] . '</td>';
                $comment .= '</tr>';
            }

            if (trim($result['optional_eval_comment']) != "") {
                $comment .= '<tr>';
                $comment .= '<td style="font-weight:bold;width:30%;">Specific Comments/Feedback</td>';
                $comment .= '<td style="width:70%;">' . $result['optional_eval_comment'] . '</td>';
                $comment .= '</tr>';
            }

            $comment .= '</table>';
            //$pdf->SetTopMargin(13);
            $pdf->writeHTML($comment, true, false, true, false, '');
        }
        $pdf->AddPage();
        $htmlTitle = '<span style="font-weight: bold;text-align:center;font-size:12;">' . ($panelName) . '</span><br>';
        $pdf->writeHTML($htmlTitle, true, false, true, false, '');
        $htmlSubTitle = '<table cellpadding="4" border="1" style="font-size:12px;width:100%;">';
        $htmlSubTitle .= '<tr style="background-color:#595959;color:#FFFFFF;">';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>Country </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>Testing Site </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>PT-ID Number </strong></td>';
        $htmlSubTitle .= '	<td style="text-align:center;"><strong>Page Number </strong></td>';
        $htmlSubTitle .= '</tr>';
        $htmlSubTitle .= '<tr>';
        $htmlSubTitle .= '	<td>' . $result['region'] . '</td>';
        $htmlSubTitle .= '	<td>' . $result['first_name'] . ' ' . $result['last_name'] . '</td>';
        $htmlSubTitle .= '	<td>' . $result['unique_identifier'] . '</td>';
        $htmlSubTitle .= '	<td>3/3</td>';
        $htmlSubTitle .= '</tr>';
        $htmlSubTitle .= '</table>';
        // if (isset($result['previous_six_shipments']) && !empty($result['previous_six_shipments'])) {
        //     $htmlSubTitle .= "<br><br><br><br><br><br><br><br><br><br><br><br><br><br><br><br>";
        // }
        $pdf->writeHTML($htmlSubTitle, true, false, true, false, '');
        // $pdf->SetTopMargin(140);
        // Zend_Debug::dump($result);die;
        $html = '';
        $html .= '<h5>Documentation of Report Review:</h5>';
        $html .= '<p style="text-align:justify;font-size:10;font-weight:normal;">We the undersigned, have read and reviewed the above Xpert TB Proficiency Test Individual Performance Report. Expected results for which testing site’s submitted results are scored against are determined by the US Centers for Disease Control and Prevention (CDC)/ International Laboratory Branch (ILB) sample validation testing procedures prior to panel shipment. If the final score was less than 100%, we completed a root cause analysis. * The Individual Final Report and any attachments must be filed and retained as documentation. If needed, corrective action documentation should also be completed and filed alongside the Individual Performance Report for reference.</p>';
        $html .= '<p style="text-align:justify;font-size:10;font-weight:normal;">Our identifiable individual site results are confidential and are only shared with our Proficiency Test Country Coordinators (PTCC) at the National or Regional level, the testing site, or other PTCC-designated stakeholders. Each PTCC serves as a subcontractor to the Xpert TB Proficiency Test Program for the following duties: site enrollment, panel receipt, panel distribution to individual testing sites, result submission assistance, report distribution assistance and corrective action follow-up in accordance with the country’s National TB Program guidelines. Unidentified site results may be shared for XTPT program review and improvement purposes upon request to, and with approval from, CDC/ ILB. Questions or comments concerning this report may be submitted to the PTCC or to the CDC/ ILB using the Contact Information listed below.</p>';

        $html .= '<p><strong>Testing Personnel:____________________________ Date:_________________________________</strong></p>';
        $html .= '<p><strong>____________________________________________ Date:_________________________________</strong></p>';
        $html .= '<p><strong>Laboratory Manager (or Designee):______________________  Date:_________________________</strong></p>';



        $pdf->writeHTML($html, true, false, true, false, '');


        $content3 = '<br><br><table cellpadding="4" style="width:100%;">';
        $content3 .= '<tr>';
        $content3 .= '	<td style="width:60%;"><strong>Report Authorized by : </strong>' . ($result['participant_supervisor']) . ' (CDC/ ILB)</td>';
        $content3 .= '	<td style="width:40%;"><strong>Date: : </strong>' . date('d-M-Y') . '</td>';
        $content3 .= '</tr>';
        $content3 .= '</table>';
        $pdf->writeHTML($content3, true, false, true, false, '');
        $address = !empty($config->evaluation->tb->contactInfo) ? htmlspecialchars_decode($config->evaluation->tb->contactInfo) : null;
        if (isset($address) && !empty($address)) {
            $pdf->writeHTML('<table style="width:100%" border="1"><tr><td style="width:100%">' . $address . '</td></tr></table>', true, false, true, false, '');
        }

        if (ob_get_contents()) {
            ob_end_clean();
        }

        //Close and output PDF document
        if (isset($result['last_name']) && trim($result['last_name']) != "") {
            $result['last_name'] = "_" . $result['last_name'];
        }

        $nameParts = [];
        if (!empty($result['shipment_code'])) {
            $nameParts[] = $result['shipment_code'];
        }
        if (!empty($result['unique_identifier']) && $result['unique_identifier'] != 'NULL') {
            $nameParts[] = ucfirst($result['unique_identifier']);
        }
        if (!empty($result['state']) && $result['state'] != 'NULL') {
            $nameParts[] = ucfirst($result['state']);
        }
        if (!empty($result['region']) && $result['region'] != 'NULL') {
            $nameParts[] = ucfirst($result['region']);
        }
        if (!empty($result['city']) && $result['city'] != 'NULL') {
            $nameParts[] = ucfirst($result['city']);
        }

        $fileName = implode("-", $nameParts) . "-" . $result['map_id'] . ".pdf";
        $fileName = preg_replace('/[^A-Za-z0-9.]/', '-', $fileName);
        $fileName = str_replace(" ", "-", $fileName);
        $fileName = trim(preg_replace('/-+/', '-', $fileName), '-');
        $filePath = DOWNLOADS_FOLDER . DIRECTORY_SEPARATOR . 'reports' . DIRECTORY_SEPARATOR . $result['shipment_code'] . DIRECTORY_SEPARATOR . $fileName;
        $created = $pdf->Output($filePath, "F");

        //$pdf->Output($fileName, 'I');

        $loadpdf = Zend_Pdf::load($filePath);

        foreach ($loadpdf->pages as $page) {
            $pdfExtract = $extractor->clonePage($page);
            //$pdfExtract->setFont($font, 8) ->drawText('Page '.$j.' / '.$totalPages, 280, 50);
            $pdfNew->pages[] = $pdfExtract;
        }
        $shipmentCode = $result['shipment_code'];
        $j++;
    }
}
